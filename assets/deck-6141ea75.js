var e,t,n=Object.defineProperty,i=(e,t,i)=>(((e,t,i)=>{t in e?n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i),s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var o={exports:{}},a={},l=Symbol.for("react.element"),c=Symbol.for("react.portal"),u=Symbol.for("react.fragment"),h=Symbol.for("react.strict_mode"),d=Symbol.for("react.profiler"),f=Symbol.for("react.provider"),p=Symbol.for("react.context"),g=Symbol.for("react.forward_ref"),m=Symbol.for("react.suspense"),_=Symbol.for("react.memo"),y=Symbol.for("react.lazy"),v=Symbol.iterator;var b={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},E=Object.assign,x={};function w(e,t,n){this.props=e,this.context=t,this.refs=x,this.updater=n||b}function T(){}function A(e,t,n){this.props=e,this.context=t,this.refs=x,this.updater=n||b}w.prototype.isReactComponent={},w.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},w.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},T.prototype=w.prototype;var S=A.prototype=new T;S.constructor=A,E(S,w.prototype),S.isPureReactComponent=!0;var R=Array.isArray,P=Object.prototype.hasOwnProperty,C={current:null},I={key:!0,ref:!0,__self:!0,__source:!0};function L(e,t,n){var i,s={},r=null,o=null;if(null!=t)for(i in void 0!==t.ref&&(o=t.ref),void 0!==t.key&&(r=""+t.key),t)P.call(t,i)&&!I.hasOwnProperty(i)&&(s[i]=t[i]);var a=arguments.length-2;if(1===a)s.children=n;else if(1<a){for(var c=Array(a),u=0;u<a;u++)c[u]=arguments[u+2];s.children=c}if(e&&e.defaultProps)for(i in a=e.defaultProps)void 0===s[i]&&(s[i]=a[i]);return{$$typeof:l,type:e,key:r,ref:o,props:s,_owner:C.current}}function M(e){return"object"==typeof e&&null!==e&&e.$$typeof===l}var k=/\/+/g;function O(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function N(e,t,n,i,s){var r=typeof e;"undefined"!==r&&"boolean"!==r||(e=null);var o=!1;if(null===e)o=!0;else switch(r){case"string":case"number":o=!0;break;case"object":switch(e.$$typeof){case l:case c:o=!0}}if(o)return s=s(o=e),e=""===i?"."+O(o,0):i,R(s)?(n="",null!=e&&(n=e.replace(k,"$&/")+"/"),N(s,t,n,"",(function(e){return e}))):null!=s&&(M(s)&&(s=function(e,t){return{$$typeof:l,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(s,n+(!s.key||o&&o.key===s.key?"":(""+s.key).replace(k,"$&/")+"/")+e)),t.push(s)),1;if(o=0,i=""===i?".":i+":",R(e))for(var a=0;a<e.length;a++){var u=i+O(r=e[a],a);o+=N(r,t,n,u,s)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=v&&e[v]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),a=0;!(r=e.next()).done;)o+=N(r=r.value,t,n,u=i+O(r,a++),s);else if("object"===r)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return o}function F(e,t,n){if(null==e)return e;var i=[],s=0;return N(e,i,"","",(function(e){return t.call(n,e,s++)})),i}function B(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var D={current:null},U={transition:null},G={ReactCurrentDispatcher:D,ReactCurrentBatchConfig:U,ReactCurrentOwner:C};function z(){throw Error("act(...) is not supported in production builds of React.")}a.Children={map:F,forEach:function(e,t,n){F(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return F(e,(function(){t++})),t},toArray:function(e){return F(e,(function(e){return e}))||[]},only:function(e){if(!M(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},a.Component=w,a.Fragment=u,a.Profiler=d,a.PureComponent=A,a.StrictMode=h,a.Suspense=m,a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=G,a.act=z,a.cloneElement=function(e,t,n){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var i=E({},e.props),s=e.key,r=e.ref,o=e._owner;if(null!=t){if(void 0!==t.ref&&(r=t.ref,o=C.current),void 0!==t.key&&(s=""+t.key),e.type&&e.type.defaultProps)var a=e.type.defaultProps;for(c in t)P.call(t,c)&&!I.hasOwnProperty(c)&&(i[c]=void 0===t[c]&&void 0!==a?a[c]:t[c])}var c=arguments.length-2;if(1===c)i.children=n;else if(1<c){a=Array(c);for(var u=0;u<c;u++)a[u]=arguments[u+2];i.children=a}return{$$typeof:l,type:e.type,key:s,ref:r,props:i,_owner:o}},a.createContext=function(e){return(e={$$typeof:p,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:f,_context:e},e.Consumer=e},a.createElement=L,a.createFactory=function(e){var t=L.bind(null,e);return t.type=e,t},a.createRef=function(){return{current:null}},a.forwardRef=function(e){return{$$typeof:g,render:e}},a.isValidElement=M,a.lazy=function(e){return{$$typeof:y,_payload:{_status:-1,_result:e},_init:B}},a.memo=function(e,t){return{$$typeof:_,type:e,compare:void 0===t?null:t}},a.startTransition=function(e){var t=U.transition;U.transition={};try{e()}finally{U.transition=t}},a.unstable_act=z,a.useCallback=function(e,t){return D.current.useCallback(e,t)},a.useContext=function(e){return D.current.useContext(e)},a.useDebugValue=function(){},a.useDeferredValue=function(e){return D.current.useDeferredValue(e)},a.useEffect=function(e,t){return D.current.useEffect(e,t)},a.useId=function(){return D.current.useId()},a.useImperativeHandle=function(e,t,n){return D.current.useImperativeHandle(e,t,n)},a.useInsertionEffect=function(e,t){return D.current.useInsertionEffect(e,t)},a.useLayoutEffect=function(e,t){return D.current.useLayoutEffect(e,t)},a.useMemo=function(e,t){return D.current.useMemo(e,t)},a.useReducer=function(e,t,n){return D.current.useReducer(e,t,n)},a.useRef=function(e){return D.current.useRef(e)},a.useState=function(e){return D.current.useState(e)},a.useSyncExternalStore=function(e,t,n){return D.current.useSyncExternalStore(e,t,n)},a.useTransition=function(){return D.current.useTransition()},a.version="18.3.1",o.exports=a;var V=o.exports;const W=r(V);function j(e,t){if(!e)throw new Error(t||"loader assertion failed.")}const H=Boolean("object"!=typeof process||"[object process]"!==String(process)||process.browser),$="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);$&&parseFloat($[1]);const X=globalThis,Y=globalThis.process||{},K=globalThis.navigator||{};function q(e){var t,n;if("undefined"!=typeof window&&"renderer"===(null==(t=window.process)?void 0:t.type))return!0;if("undefined"!=typeof process&&Boolean(null==(n=process.versions)?void 0:n.electron))return!0;const i="undefined"!=typeof navigator&&navigator.userAgent,s=e||i;return Boolean(s&&s.indexOf("Electron")>=0)}function Z(){return!("object"==typeof process&&"[object process]"===String(process)&&!(null==process?void 0:process.browser))||q()}const Q="4.1.0";class J{constructor(e,t,n="sessionStorage"){this.storage=function(e){try{const t=window[e],n="__storage_test__";return t.setItem(n,n),t.removeItem(n),t}catch(Fs){return null}}(n),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}var ee,te;(te=ee||(ee={}))[te.BLACK=30]="BLACK",te[te.RED=31]="RED",te[te.GREEN=32]="GREEN",te[te.YELLOW=33]="YELLOW",te[te.BLUE=34]="BLUE",te[te.MAGENTA=35]="MAGENTA",te[te.CYAN=36]="CYAN",te[te.WHITE=37]="WHITE",te[te.BRIGHT_BLACK=90]="BRIGHT_BLACK",te[te.BRIGHT_RED=91]="BRIGHT_RED",te[te.BRIGHT_GREEN=92]="BRIGHT_GREEN",te[te.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",te[te.BRIGHT_BLUE=94]="BRIGHT_BLUE",te[te.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",te[te.BRIGHT_CYAN=96]="BRIGHT_CYAN",te[te.BRIGHT_WHITE=97]="BRIGHT_WHITE";function ne(e){return"string"!=typeof e?e:(e=e.toUpperCase(),ee[e]||ee.WHITE)}function ie(e,t){if(!e)throw new Error(t||"Assertion failed")}function se(){var e,t,n;let i;if(Z()&&X.performance)i=null==(t=null==(e=null==X?void 0:X.performance)?void 0:e.now)?void 0:t.call(e);else if("hrtime"in Y){const e=null==(n=null==Y?void 0:Y.hrtime)?void 0:n.call(Y);i=1e3*e[0]+e[1]/1e6}else i=Date.now();return i}const re={debug:Z()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},oe={enabled:!0,level:0};function ae(){}const le={},ce={once:!0};class ue{constructor({id:e}={id:""}){this.VERSION=Q,this._startTs=se(),this._deltaTs=se(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new J(`__probe-${this.id}__`,oe),this.timeStamp(`${this.id} started`),function(e,t=["constructor"]){const n=Object.getPrototypeOf(e),i=Object.getOwnPropertyNames(n),s=e;for(const r of i){const n=s[r];"function"==typeof n&&(t.find((e=>r===e))||(s[r]=n.bind(e)))}}(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((se()-this._startTs).toPrecision(10))}getDelta(){return Number((se()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,re.warn,arguments,ce)}error(e){return this._getLogFunction(0,e,re.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,re.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,re.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,re.debug||re.info,arguments,ce)}table(e,t,n){return t?this._getLogFunction(e,t,console.table||ae,n&&[n],{tag:fe(t)}):ae}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||ae)}group(e,t,n={collapsed:!1}){const i=de({logLevel:e,message:t,opts:n}),{collapsed:s}=n;return i.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,t,n={}){return this.group(e,t,Object.assign({},n,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||ae)}withGroup(e,t,n){this.group(e,t)();try{n()}finally{this.groupEnd(e)()}}trace(){console.trace}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=he(e)}_getLogFunction(e,t,n,i,s){if(this._shouldLog(e)){s=de({logLevel:e,message:t,args:i,opts:s}),ie(n=n||s.method),s.total=this.getTotal(),s.delta=this.getDelta(),this._deltaTs=se();const r=s.tag||s.message;if(s.once&&r){if(le[r])return ae;le[r]=se()}return t=function(e,t,n){if("string"==typeof t){const i=n.time?function(e,t=8){const n=Math.max(t-e.length,0);return`${" ".repeat(n)}${e}`}(function(e){let t;return t=e<10?`${e.toFixed(2)}ms`:e<100?`${e.toFixed(1)}ms`:e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(2)}s`,t}(n.total)):"";t=function(e,t,n){Z||"string"!=typeof e||(t&&(e=`[${ne(t)}m${e}[39m`),n&&(e=`[${ne(n)+10}m${e}[49m`));return e}(t=n.time?`${e}: ${i}  ${t}`:`${e}: ${t}`,n.color,n.background)}return t}(this.id,s.message,s),n.bind(console,t,...s.args)}return ae}}function he(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return ie(Number.isFinite(t)&&t>=0),t}function de(e){const{logLevel:t,message:n}=e;e.logLevel=he(t);const i=e.args?Array.from(e.args):[];for(;i.length&&i.shift()!==n;);switch(typeof t){case"string":case"function":void 0!==n&&i.unshift(n),e.message=t;break;case"object":Object.assign(e,t)}"function"==typeof e.message&&(e.message=e.message());const s=typeof e.message;return ie("string"===s||"object"===s),Object.assign(e,{args:i},e.opts)}function fe(e){for(const t in e)for(const n in e[t])return n||"untitled";return"empty"}ue.VERSION=Q;const pe="4.3.2",ge=pe[0]>="0"&&pe[0]<="9"?`v${pe}`:"";const me=function(){const e=new ue({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=e,globalThis.loaders.version=ge,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=e,e}();function _e(e,t){return ye(e||{},t)}function ye(e,t,n=0){if(n>3)return t;const i={...e};for(const[s,r]of Object.entries(t))r&&"object"==typeof r&&!Array.isArray(r)?i[s]=ye(i[s]||{},t[s],n+1):i[s]=t[s];return i}(null==(ve=globalThis._loadersgl_)?void 0:ve.version)||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version;var ve;function be(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}const Ee="object"!=typeof process||"[object process]"!==String(process)||process.browser,xe="undefined"!=typeof window&&void 0!==window.orientation,we="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);we&&parseFloat(we[1]);class Te{constructor(e,t){i(this,"name"),i(this,"workerThread"),i(this,"isRunning",!0),i(this,"result"),i(this,"_resolve",(()=>{})),i(this,"_reject",(()=>{})),this.name=e,this.workerThread=t,this.result=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){be(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){be(this.isRunning),this.isRunning=!1,this._reject(e)}}class Ae{terminate(){}}const Se=new Map;function Re(e){be(e.source&&!e.url||!e.source&&e.url);let t=Se.get(e.source||e.url);return t||(e.url&&(t=function(e){if(!e.startsWith("http"))return e;return Pe((t=e,`try {\n  importScripts('${t}');\n} catch (error) {\n  console.error(error);\n  throw error;\n}`));var t}(e.url),Se.set(e.url,t)),e.source&&(t=Pe(e.source),Se.set(e.source,t))),be(t),t}function Pe(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function Ce(e,t=!0,n){const i=n||new Set;if(e){if(Ie(e))i.add(e);else if(Ie(e.buffer))i.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"==typeof e)for(const s in e)Ce(e[s],t,i)}else;return void 0===n?Array.from(i):[]}function Ie(e){return!!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}const Le=()=>{};class Me{constructor(e){i(this,"name"),i(this,"source"),i(this,"url"),i(this,"terminated",!1),i(this,"worker"),i(this,"onMessage"),i(this,"onError"),i(this,"_loadableURL","");const{name:t,source:n,url:s}=e;be(n||s),this.name=t,this.source=n,this.url=s,this.onMessage=Le,this.onError=e=>{},this.worker=Ee?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return"undefined"!=typeof Worker&&Ee||void 0!==Ae&&!Ee}destroy(){this.onMessage=Le,this.onError=Le,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||Ce(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=Re({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},e.onmessageerror=e=>{},e}_createNodeWorker(){let e;if(this.url){const t=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Ae(t,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new Ae(this.source,{eval:!0})}return e.on("message",(e=>{this.onMessage(e)})),e.on("error",(e=>{this.onError(e)})),e.on("exit",(e=>{})),e}}class ke{constructor(e){i(this,"name","unnamed"),i(this,"source"),i(this,"url"),i(this,"maxConcurrency",1),i(this,"maxMobileConcurrency",1),i(this,"onDebug",(()=>{})),i(this,"reuseWorkers",!0),i(this,"props",{}),i(this,"jobQueue",[]),i(this,"idleQueue",[]),i(this,"count",0),i(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return Me.isSupported()}destroy(){this.idleQueue.forEach((e=>e.destroy())),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e,t=(e,t,n)=>e.done(n),n=(e,t)=>e.error(t)){const i=new Promise((i=>(this.jobQueue.push({name:e,onMessage:t,onError:n,onStart:i}),this)));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const i=new Te(t.name,e);e.onMessage=e=>t.onMessage(i,e.type,e.payload),e.onError=e=>t.onError(i,e),t.onStart(i);try{await i.result}catch(n){}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Ee||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Me({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return xe?this.maxMobileConcurrency:this.maxConcurrency}}const Oe={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},Ne=class e{constructor(e){i(this,"props"),i(this,"workerPools",new Map),this.props={...Oe},this.setProps(e),this.workerPools=new Map}static isSupported(){return Me.isSupported()}static getWorkerFarm(t={}){return e._workerFarm=e._workerFarm||new e({}),e._workerFarm.setProps(t),e._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:n,url:i}=e;let s=this.workerPools.get(t);return s||(s=new ke({name:t,source:n,url:i}),s.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,s)),s}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};i(Ne,"_workerFarm");let Fe=Ne;async function Be(e,t,n,i,s){const r=e.id,o=function(e,t={}){const n=t[e.id]||{},i=Ee?`${e.id}-worker.js`:`${e.id}-worker-node.js`;let s=n.workerUrl;if(s||"compression"!==e.id||(s=t.workerUrl),"test"===t._workerType&&(s=Ee?`modules/${e.module}/dist/${i}`:`modules/${e.module}/src/workers/${e.id}-worker-node.ts`),!s){let t=e.version;"latest"===t&&(t="latest");const n=t?`@${t}`:"";s=`https://unpkg.com/@loaders.gl/${e.module}${n}/dist/${i}`}return be(s),s}(e,n),a=Fe.getWorkerFarm(n).getWorkerPool({name:r,url:o});n=JSON.parse(JSON.stringify(n)),i=JSON.parse(JSON.stringify(i||{}));const l=await a.startJob("process-on-worker",De.bind(null,s));l.postMessage("process",{input:t,options:n,context:i});const c=await l.result;return await c.result}async function De(e,t,n,i){switch(n){case"done":t.done(i);break;case"error":t.error(new Error(i.error));break;case"process":const{id:n,input:r,options:o}=i;try{const i=await e(r,o);t.postMessage("done",{id:n,result:i})}catch(s){const e=s instanceof Error?s.message:"unknown error";t.postMessage("error",{id:n,error:e})}}}function Ue(...e){return function(e){const t=e.map((e=>e instanceof ArrayBuffer?new Uint8Array(e):e)),n=t.reduce(((e,t)=>e+t.byteLength),0),i=new Uint8Array(n);let s=0;for(const r of t)i.set(r,s),s+=r.byteLength;return i.buffer}(e)}function Ge(){let e;if("undefined"!=typeof window&&window.performance)e=window.performance.now();else if("undefined"!=typeof process&&process.hrtime){const t=process.hrtime();e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}class ze{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Ge(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Ge()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class Ve{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach((t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}})),e}_initializeStats(e=[]){e.forEach((e=>this._getOrCreate(e)))}_getOrCreate(e){const{name:t,type:n}=e;let i=this.stats[t];return i||(i=e instanceof ze?e:new ze(t,n),this.stats[t]=i),i}}const We={};function je(e){if((t=e)&&"object"==typeof t&&t.isBuffer)return e;var t;if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if("string"==typeof e){const t=e;return(new TextEncoder).encode(t).buffer}if(e&&"object"==typeof e&&e._toArrayBuffer)return e._toArrayBuffer();throw new Error("toArrayBuffer")}function He(e){const t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(t+1):""}const $e=e=>"function"==typeof e,Xe=e=>null!==e&&"object"==typeof e,Ye=e=>Xe(e)&&e.constructor==={}.constructor,Ke=e=>"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json,qe=e=>"undefined"!=typeof Blob&&e instanceof Blob,Ze=e=>(e=>"undefined"!=typeof ReadableStream&&e instanceof ReadableStream||Xe(e)&&$e(e.tee)&&$e(e.cancel)&&$e(e.getReader))(e)||(e=>Xe(e)&&$e(e.read)&&$e(e.pipe)&&(e=>"boolean"==typeof e)(e.readable))(e);class Qe extends Error{constructor(e,t){super(e),i(this,"reason"),i(this,"url"),i(this,"response"),this.reason=t.reason,this.url=t.url,this.response=t.response}}const Je=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,et=/^([-\w.]+\/[-\w.+]+)/;function tt(e,t){return e.toLowerCase()===t.toLowerCase()}function nt(e){const t=Je.exec(e);return t?t[1]:""}const it=/\?.*/;function st(e){return e.replace(it,"")}function rt(e){if(Ke(e)){return e.url}if(qe(e)){return e.name||""}return"string"==typeof e?e:""}function ot(e){if(Ke(e)){const t=e,n=t.headers.get("content-type")||"",i=st(t.url);return function(e){const t=et.exec(e);return t?t[1]:e}(n)||nt(i)}if(qe(e)){return e.type||""}return"string"==typeof e?nt(e):""}async function at(e){if(Ke(e))return e;const t={},n=function(e){if(Ke(e))return e.headers["content-length"]||-1;if(qe(e))return e.size;return"string"==typeof e?e.length:e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}(e);n>=0&&(t["content-length"]=String(n));const i=rt(e),s=ot(e);s&&(t["content-type"]=s);const r=await async function(e){const t=5;if("string"==typeof e)return`data:,${e.slice(0,t)}`;if(e instanceof Blob){const t=e.slice(0,5);return await new Promise((e=>{const n=new FileReader;n.onload=t=>{var n;return e(null==(n=null==t?void 0:t.target)?void 0:n.result)},n.readAsDataURL(t)}))}if(e instanceof ArrayBuffer){return`data:base64,${function(e){let t="";const n=new Uint8Array(e);for(let i=0;i<n.byteLength;i++)t+=String.fromCharCode(n[i]);return btoa(t)}(e.slice(0,t))}`}return null}(e);r&&(t["x-first-bytes"]=r),"string"==typeof e&&(e=(new TextEncoder).encode(e));const o=new Response(e,{headers:t});return Object.defineProperty(o,"url",{value:i}),o}async function lt(e){if(!e.ok){const t=await async function(e){const n=function(e){if(e.length<50)return e;const t=e.slice(e.length-15);return`${e.substr(0,32)}...${t}`}(e.url);let i=`Failed to fetch resource (${e.status}) ${e.statusText}: ${n}`;i=i.length>100?`${i.slice(0,100)}...`:i;const s={reason:e.statusText,url:e.url,response:e};try{const t=e.headers.get("Content-Type");s.reason=!e.bodyUsed&&(null==t?void 0:t.includes("application/json"))?await e.json():await e.text()}catch(t){}return new Qe(i,s)}(e);throw t}}async function ct(e,t){var n,i;if("string"==typeof e){const s=function(e){for(const t in We)if(e.startsWith(t)){const n=We[t];e=e.replace(t,n)}return e.startsWith("http://")||e.startsWith("https://")||(e=`${e}`),e}(e);return function(e){return!function(e){return e.startsWith("http:")||e.startsWith("https:")}(e)&&!function(e){return e.startsWith("data:")}(e)}(s)&&(null==(n=globalThis.loaders)?void 0:n.fetchNode)?null==(i=globalThis.loaders)?void 0:i.fetchNode(s,t):await fetch(s,t)}return await at(e)}const ut=new ue({id:"loaders.gl"});class ht{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const dt={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){i(this,"console"),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}},useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:H,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},ft={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function pt(){globalThis.loaders=globalThis.loaders||{};const{loaders:e}=globalThis;return e._state||(e._state={}),e._state}function gt(){const e=pt();return e.globalOptions=e.globalOptions||{...dt},e.globalOptions}function mt(e,t,n,i){return n=n||[],function(e,t){_t(e,null,dt,ft,t);for(const n of t){const i=e&&e[n.id]||{},s=n.options&&n.options[n.id]||{},r=n.deprecatedOptions&&n.deprecatedOptions[n.id]||{};_t(i,n.id,s,r,t)}}(e,n=Array.isArray(n)?n:[n]),function(e,t,n){const i=e.options||{},s={...i};(function(e,t){t&&!("baseUri"in e)&&(e.baseUri=t)})(s,n),null===s.log&&(s.log=new ht);return vt(s,gt()),vt(s,t),s}(t,e,i)}function _t(e,t,n,i,s){const r=t||"Top level",o=t?`${t}.`:"";for(const a in e){const l=!t&&Xe(e[a]);if(!(a in n)&&!("baseUri"===a&&!t)&&!("workerUrl"===a&&t))if(a in i)ut.warn(`${r} loader option '${o}${a}' no longer supported, use '${i[a]}'`)();else if(!l){const e=yt(a,s);ut.warn(`${r} loader option '${o}${a}' not recognized. ${e}`)()}}}function yt(e,t){const n=e.toLowerCase();let i="";for(const s of t)for(const t in s.options){if(e===t)return`Did you mean '${s.id}.${t}'?`;const r=t.toLowerCase();(n.startsWith(r)||r.startsWith(n))&&(i=i||`Did you mean '${s.id}.${t}'?`)}return i}function vt(e,t){for(const n in t)if(n in t){const i=t[n];Ye(i)&&Ye(e[n])?e[n]={...e[n],...t[n]}:e[n]=t[n]}}function bt(e){if(!e)return!1;Array.isArray(e)&&(e=e[0]);return Array.isArray(null==e?void 0:e.extensions)}function Et(e){let t;return j(e,"null loader"),j(bt(e),"invalid loader"),Array.isArray(e)&&(t=e[1],e=e[0],e={...e,options:{...e.options,...t}}),((null==e?void 0:e.parseTextSync)||(null==e?void 0:e.parseText))&&(e.text=!0),e.text||(e.binary=!0),e}const xt=()=>{const e=pt();return e.loaderRegistry=e.loaderRegistry||[],e.loaderRegistry};const wt=/\.([^.]+)$/;function Tt(e,t=[],n,i){if(!At(e))return null;if(t&&!Array.isArray(t))return Et(t);let s=[];t&&(s=s.concat(t)),(null==n?void 0:n.ignoreRegisteredLoaders)||s.push(...xt()),function(e){for(const t of e)Et(t)}(s);const r=function(e,t,n,i){const s=rt(e),r=ot(e),o=st(s)||(null==i?void 0:i.url);let a=null,l="";(null==n?void 0:n.mimeType)&&(a=Rt(t,null==n?void 0:n.mimeType),l=`match forced by supplied MIME type ${null==n?void 0:n.mimeType}`);a=a||function(e,t){const n=t&&wt.exec(t),i=n&&n[1];return i?function(e,t){t=t.toLowerCase();for(const n of e)for(const e of n.extensions)if(e.toLowerCase()===t)return n;return null}(e,i):null}(t,o),l=l||(a?`matched url ${o}`:""),a=a||Rt(t,r),l=l||(a?`matched MIME type ${r}`:""),a=a||function(e,t){if(!t)return null;for(const n of e)if("string"==typeof t){if(Pt(t,n))return n}else if(ArrayBuffer.isView(t)){if(Ct(t.buffer,t.byteOffset,n))return n}else if(t instanceof ArrayBuffer){if(Ct(t,0,n))return n}return null}(t,e),l=l||(a?`matched initial data ${It(e)}`:""),(null==n?void 0:n.fallbackMimeType)&&(a=a||Rt(t,null==n?void 0:n.fallbackMimeType),l=l||(a?`matched fallback MIME type ${r}`:""));l&&me.log(1,`selectLoader selected ${null==a?void 0:a.name}: ${l}.`);return a}(e,s,n,i);if(!r&&!(null==n?void 0:n.nothrow))throw new Error(St(e));return r}function At(e){return!(e instanceof Response&&204===e.status)}function St(e){const t=rt(e),n=ot(e);let i="No valid loader found (";i+=t?`${He(t)}, `:"no url provided, ",i+=`MIME type: ${n?`"${n}"`:"not provided"}, `;const s=e?It(e):"";return i+=s?` first bytes: "${s}"`:"first bytes: not available",i+=")",i}function Rt(e,t){var n;for(const i of e){if(null==(n=i.mimeTypes)?void 0:n.some((e=>tt(t,e))))return i;if(tt(t,`application/x.${i.id}`))return i}return null}function Pt(e,t){if(t.testText)return t.testText(e);return(Array.isArray(t.tests)?t.tests:[t.tests]).some((t=>e.startsWith(t)))}function Ct(e,t,n){return(Array.isArray(n.tests)?n.tests:[n.tests]).some((n=>function(e,t,n,i){if(i instanceof ArrayBuffer)return function(e,t,n){if(n=n||e.byteLength,e.byteLength<n||t.byteLength<n)return!1;const i=new Uint8Array(e),s=new Uint8Array(t);for(let r=0;r<i.length;++r)if(i[r]!==s[r])return!1;return!0}(i,e,i.byteLength);switch(typeof i){case"function":return i(e);case"string":return i===Lt(e,t,i.length);default:return!1}}(e,t,0,n)))}function It(e,t=5){if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return Lt(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer){return Lt(e,0,t)}return""}function Lt(e,t,n){if(e.byteLength<t+n)return"";const i=new DataView(e);let s="";for(let r=0;r<n;r++)s+=String.fromCharCode(i.getUint8(t+r));return s}const Mt=262144;function kt(e,t){return H?async function*(e,t){const n=e.getReader();let i;try{for(;;){const e=i||n.read();(null==t?void 0:t._streamReadAhead)&&(i=n.read());const{done:s,value:r}=await e;if(s)return;yield je(r)}}catch(s){n.releaseLock()}}(e,t):async function*(e){for await(const t of e)yield je(t)}(e)}function Ot(e,t){if("string"==typeof e)return function*(e,t){const n=(null==t?void 0:t.chunkSize)||262144;let i=0;const s=new TextEncoder;for(;i<e.length;){const t=Math.min(e.length-i,n),r=e.slice(i,i+t);i+=t,yield s.encode(r)}}(e,t);if(e instanceof ArrayBuffer)return function*(e,t={}){const{chunkSize:n=Mt}=t;let i=0;for(;i<e.byteLength;){const t=Math.min(e.byteLength-i,n),s=new ArrayBuffer(t),r=new Uint8Array(e,i,t);new Uint8Array(s).set(r),i+=t,yield s}}(e,t);if(qe(e))return async function*(e,t){const n=(null==t?void 0:t.chunkSize)||1048576;let i=0;for(;i<e.size;){const t=i+n,s=await e.slice(i,t).arrayBuffer();i=t,yield s}}(e,t);if(Ze(e))return kt(e,t);if(Ke(e)){return kt(e.body,t)}throw new Error("makeIterator")}const Nt="Cannot convert supplied data type";async function Ft(e,t,n){const i=e instanceof ArrayBuffer||ArrayBuffer.isView(e);if("string"==typeof e||i)return function(e,t){if(t.text&&"string"==typeof e)return e;var n;if((n=e)&&"object"==typeof n&&n.isBuffer&&(e=e.buffer),e instanceof ArrayBuffer){const n=e;return t.text&&!t.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(e)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(e);let n=e.buffer;const i=e.byteLength||e.length;return 0===e.byteOffset&&i===n.byteLength||(n=n.slice(e.byteOffset,e.byteOffset+i)),n}throw new Error(Nt)}(e,t);if(qe(e)&&(e=await at(e)),Ke(e)){const n=e;return await lt(n),t.binary?await n.arrayBuffer():await n.text()}if(Ze(e)&&(e=Ot(e,n)),s=e,Boolean(s)&&"function"==typeof s[Symbol.iterator]||(e=>e&&"function"==typeof e[Symbol.asyncIterator])(e))return async function(e){const t=[];for await(const n of e)t.push(n);return Ue(...t)}(e);var s;throw new Error(Nt)}function Bt(e,t){const n=gt(),i=e||n;return"function"==typeof i.fetch?i.fetch:Xe(i.fetch)?e=>ct(e,i.fetch):(null==t?void 0:t.fetch)?null==t?void 0:t.fetch:ct}function Dt(e,t,n){if(n)return n;const i={fetch:Bt(t,e),...e};if(i.url){const e=st(i.url);i.baseUrl=e,i.queryString=function(e){const t=e.match(it);return t&&t[0]}(i.url),i.filename=He(e),i.baseUrl=function(e){const t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(0,t):""}(e)}return Array.isArray(i.loaders)||(i.loaders=null),i}async function Ut(e,t,n,i){!t||Array.isArray(t)||bt(t)||(i=void 0,n=t,t=void 0),n=n||{};const s=rt(e=await e),r=function(e,t){if(e&&!Array.isArray(e))return e;let n;if(e&&(n=Array.isArray(e)?e:[e]),t&&t.loaders){const e=Array.isArray(t.loaders)?t.loaders:[t.loaders];n=n?[...n,...e]:e}return n&&n.length?n:void 0}(t,i),o=await async function(e,t=[],n,i){if(!At(e))return null;let s=Tt(e,t,{...n,nothrow:!0},i);if(s)return s;if(qe(e)&&(s=Tt(e=await e.slice(0,10).arrayBuffer(),t,n,i)),!s&&!(null==n?void 0:n.nothrow))throw new Error(St(e));return s}(e,r,n);return o?(i=Dt({url:s,_parse:Ut,loaders:r},n=mt(n,o,r,s),i||null),await async function(e,t,n,i){if(function(e){be(e,"no worker provided");const t=e.version}(e),n=_e(e.options,n),Ke(t)){const e=t,{ok:n,redirected:s,status:r,statusText:o,type:a,url:l}=e,c=Object.fromEntries(e.headers.entries());i.response={headers:c,ok:n,redirected:s,status:r,statusText:o,type:a,url:l}}t=await Ft(t,e,n);const s=e;if(s.parseTextSync&&"string"==typeof t)return s.parseTextSync(t,n,i);if(function(e,t){return!!Fe.isSupported()&&!(!Ee&&!(null==t?void 0:t._nodeWorkers))&&e.worker&&(null==t?void 0:t.worker)}(e,n))return await Be(e,t,n,i,Ut);if(s.parseText&&"string"==typeof t)return await s.parseText(t,n,i);if(s.parse)return await s.parse(t,n,i);throw be(!s.parseSync),new Error(`${e.id} loader - no parser found and worker is disabled`)}(o,e,n,i)):null}async function Gt(e,t,n,i){let s,r;Array.isArray(t)||bt(t)?(s=t,r=n):(s=[],r=t);const o=Bt(r);let a=e;return"string"==typeof e&&(a=await o(e)),qe(e)&&(a=await o(e)),Array.isArray(s),await Ut(a,s,r)}const zt=null==(e=globalThis.loaders)?void 0:e.parseImageNode,Vt="undefined"!=typeof Image,Wt="undefined"!=typeof ImageBitmap,jt=Boolean(zt),Ht=!!H||jt;function $t(e){const t=function(e){if("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)return"imagebitmap";if("undefined"!=typeof Image&&e instanceof Image)return"image";if(e&&"object"==typeof e&&e.data&&e.width&&e.height)return"data";return null}(e);if(!t)throw new Error("Not an image");return t}const Xt=/^data:image\/svg\+xml/,Yt=/\.svg((\?|#).*)?$/;function Kt(e){return e&&(Xt.test(e)||Yt.test(e))}function qt(e,t){if(Kt(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}async function Zt(e,t,n){const i=function(e,t){if(Kt(t)){let t=(new TextDecoder).decode(e);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(t=unescape(encodeURIComponent(t)))}catch(n){throw new Error(n.message)}return`data:image/svg+xml;base64,${btoa(t)}`}return qt(e,t)}(e,n),s=self.URL||self.webkitURL,r="string"!=typeof i&&s.createObjectURL(i);try{return await async function(e,t){const n=new Image;if(n.src=e,t.image&&t.image.decode&&n.decode)return await n.decode(),n;return await new Promise(((e,t)=>{try{n.onload=()=>e(n),n.onerror=e=>{const n=e instanceof Error?e.message:"error";t(new Error(n))}}catch(i){t(i)}}))}(r||i,t)}finally{r&&s.revokeObjectURL(r)}}const Qt={};let Jt=!0;async function en(e,t,n){let i;if(Kt(n)){i=await Zt(e,t,n)}else i=qt(e,n);const s=t&&t.imagebitmap;return await async function(e,t=null){!function(e){for(const t in e||Qt)return!1;return!0}(t)&&Jt||(t=null);if(t)try{return await createImageBitmap(e,t)}catch(n){Jt=!1}return await createImageBitmap(e)}(i,s)}function tn(e){return function(e,t,n=0){const i=(s=t,[...s].map((e=>e.charCodeAt(0))));var s;for(let r=0;r<i.length;++r)if(i[r]!==e[r+n])return!1;return!0}(e,"ftyp",4)&&96&e[8]?function(e){switch((t=e,n=8,i=12,String.fromCharCode(...t.slice(n,i))).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}var t,n,i}(e):null}const nn=!1,sn=!0;function rn(e){const t=on(e);return function(e){const t=on(e),n=t.byteLength>=24&&2303741511===t.getUint32(0,nn);if(!n)return null;return{mimeType:"image/png",width:t.getUint32(16,nn),height:t.getUint32(20,nn)}}(t)||function(e){const t=on(e),n=t.byteLength>=3&&65496===t.getUint16(0,nn)&&255===t.getUint8(2);if(!n)return null;const{tableMarkers:i,sofMarkers:s}=function(){const e=new Set([65499,65476,65484,65501,65534]);for(let n=65504;n<65520;++n)e.add(n);const t=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return{tableMarkers:e,sofMarkers:t}}();let r=2;for(;r+9<t.byteLength;){const e=t.getUint16(r,nn);if(s.has(e))return{mimeType:"image/jpeg",height:t.getUint16(r+5,nn),width:t.getUint16(r+7,nn)};if(!i.has(e))return null;r+=2,r+=t.getUint16(r,nn)}return null}(t)||function(e){const t=on(e),n=t.byteLength>=10&&1195984440===t.getUint32(0,nn);if(!n)return null;return{mimeType:"image/gif",width:t.getUint16(6,sn),height:t.getUint16(8,sn)}}(t)||function(e){const t=on(e),n=t.byteLength>=14&&16973===t.getUint16(0,nn)&&t.getUint32(2,sn)===t.byteLength;if(!n)return null;return{mimeType:"image/bmp",width:t.getUint32(18,sn),height:t.getUint32(22,sn)}}(t)||function(e){const t=new Uint8Array(e instanceof DataView?e.buffer:e),n=tn(t);if(!n)return null;return{mimeType:n.mimeType,width:0,height:0}}(t)}function on(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw new Error("toDataView")}const an={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:"4.3.2",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:async function(e,t,n){const i=((t=t||{}).image||{}).type||"auto",{url:s}=n||{};let r;switch(function(e){switch(e){case"auto":case"data":return function(){if(Wt)return"imagebitmap";if(Vt)return"image";if(Ht)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(e){switch(e){case"auto":return Wt||Vt||Ht;case"imagebitmap":return Wt;case"image":return Vt;case"data":return Ht;default:throw new Error(`@loaders.gl/images: image ${e} not supported in this environment`)}}(e),e}}(i)){case"imagebitmap":r=await en(e,t,s);break;case"image":r=await Zt(e,t,s);break;case"data":r=await async function(e){var t;const{mimeType:n}=rn(e)||{},i=null==(t=globalThis.loaders)?void 0:t.parseImageNode;return j(i),await i(e,n)}(e);break;default:j(!1)}return"data"===i&&(r=function(e){switch($t(e)){case"data":return e;case"image":case"imagebitmap":const t=document.createElement("canvas"),n=t.getContext("2d");if(!n)throw new Error("getImageData");return t.width=e.width,t.height=e.height,n.drawImage(e,0,0),n.getImageData(0,0,e.width,e.height);default:throw new Error("getImageData")}}(r)),r},tests:[e=>Boolean(rn(new DataView(e)))],options:{image:{type:"auto",decode:!0}}},ln=new ue({id:"deck"});let cn={};function un(e){cn=e}function hn(e,t,n,i){ln.level>0&&cn[e]&&cn[e].call(null,t,n,i)}const dn={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:function(e){const t=e[0],n=e[e.length-1];return"{"===t&&"}"===n||"["===t&&"]"===n},parseTextSync:JSON.parse};const fn=function(){const e="9.1.9",t=globalThis.deck&&globalThis.deck.VERSION;if(t&&t!==e)throw new Error(`deck.gl - multiple versions detected: ${t} vs ${e}`);return t||(ln.log(1,`deck.gl ${e}`)(),globalThis.deck={...globalThis.deck,VERSION:e,version:e,log:ln,_registerLoggers:un},function(e){const t=xt();e=Array.isArray(e)?e:[e];for(const n of e){const e=Et(n);t.find((t=>e===t))||t.unshift(e)}}([dn,[an,{imagebitmap:{premultiplyAlpha:"none"}}]])),e}();function pn(e,t){if(!e)throw new Error(t||"shadertools: assertion failed.")}const gn={number:{type:"number",validate:(e,t)=>Number.isFinite(e)&&"object"==typeof t&&(void 0===t.max||e<=t.max)&&(void 0===t.min||e>=t.min)},array:{type:"array",validate:(e,t)=>Array.isArray(e)||ArrayBuffer.isView(e)}};function mn(e){let t=_n(e);if("object"!==t)return{value:e,...gn[t],type:t};if("object"==typeof e)return e?void 0!==e.type?{...e,...gn[e.type],type:e.type}:void 0===e.value?{type:"object",value:e}:(t=_n(e.value),{...e,...gn[t],type:t}):{type:"object",value:null};throw new Error("props")}function _n(e){return Array.isArray(e)||ArrayBuffer.isView(e)?"array":typeof e}const yn={vertex:"#ifdef MODULE_LOGDEPTH\n  logdepth_adjustPosition(gl_Position);\n#endif\n",fragment:"#ifdef MODULE_MATERIAL\n  fragColor = material_filterColor(fragColor);\n#endif\n\n#ifdef MODULE_LIGHTING\n  fragColor = lighting_filterColor(fragColor);\n#endif\n\n#ifdef MODULE_FOG\n  fragColor = fog_filterColor(fragColor);\n#endif\n\n#ifdef MODULE_PICKING\n  fragColor = picking_filterHighlightColor(fragColor);\n  fragColor = picking_filterPickingColor(fragColor);\n#endif\n\n#ifdef MODULE_LOGDEPTH\n  logdepth_setFragDepth();\n#endif\n"},vn=/void\s+main\s*\([^)]*\)\s*\{\n?/,bn=/}\n?[^{}]*$/,En=[],xn="__LUMA_INJECT_DECLARATIONS__";function wn(e){const t={vertex:{},fragment:{}};for(const n in e){let i=e[n];"string"==typeof i&&(i={order:0,injection:i}),t[Tn(n)][n]=i}return t}function Tn(e){const t=e.slice(0,2);switch(t){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(t)}}function An(e,t,n,i=!1){const s="vertex"===t;for(const r in n){const t=n[r];t.sort(((e,t)=>e.order-t.order)),En.length=t.length;for(let e=0,n=t.length;e<n;++e)En[e]=t[e].injection;const i=`${En.join("\n")}\n`;switch(r){case"vs:#decl":s&&(e=e.replace(xn,i));break;case"vs:#main-start":s&&(e=e.replace(vn,(e=>e+i)));break;case"vs:#main-end":s&&(e=e.replace(bn,(e=>i+e)));break;case"fs:#decl":s||(e=e.replace(xn,i));break;case"fs:#main-start":s||(e=e.replace(vn,(e=>e+i)));break;case"fs:#main-end":s||(e=e.replace(bn,(e=>i+e)));break;default:e=e.replace(r,(e=>e+i))}}return e=e.replace(xn,""),i&&(e=e.replace(/\}\s*$/,(e=>e+yn[t]))),e}function Sn(e){e.map((e=>function(e){if(e.instance)return;Sn(e.dependencies||[]);const{propTypes:t={},deprecations:n=[],inject:i={}}=e,s={normalizedInjections:wn(i),parsedDeprecations:Pn(n)};t&&(s.propValidators=function(e){const t={};for(const[n,i]of Object.entries(e))t[n]=mn(i);return t}(t));e.instance=s;let r={};t&&(r=Object.entries(t).reduce(((e,[t,n])=>{const i=null==n?void 0:n.value;return i&&(e[t]=i),e}),{}));e.defaultUniforms={...e.defaultUniforms,...r}}(e)))}function Rn(e,t,n){var i;null==(i=e.deprecations)||i.forEach((e=>{var i;(null==(i=e.regex)?void 0:i.test(t))&&(e.deprecated?n.deprecated(e.old,e.new)():n.removed(e.old,e.new)())}))}function Pn(e){return e.forEach((e=>{if("function"===e.type)e.regex=new RegExp(`\\b${e.old}\\(`);else e.regex=new RegExp(`${e.type} ${e.old};`)})),e}function Cn(e){Sn(e);const t={},n={};In({modules:e,level:0,moduleMap:t,moduleDepth:n});const i=Object.keys(n).sort(((e,t)=>n[t]-n[e])).map((e=>t[e]));return Sn(i),i}function In(e){const{modules:t,level:n,moduleMap:i,moduleDepth:s}=e;if(n>=5)throw new Error("Possible loop in shader dependency graph");for(const r of t)i[r.name]=r,(void 0===s[r.name]||s[r.name]<n)&&(s[r.name]=n);for(const r of t)r.dependencies&&In({modules:r.dependencies,level:n+1,moduleMap:i,moduleDepth:s})}const Ln=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,"#version 300 es\n"],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],Mn=[...Ln,[Nn("attribute"),"in $1"],[Nn("varying"),"out $1"]],kn=[...Ln,[Nn("varying"),"in $1"]];function On(e,t){for(const[n,i]of t)e=e.replace(n,i);return e}function Nn(e){return new RegExp(`\\b${e}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function Fn(e,t){let n="";for(const i in e){const s=e[i];if(n+=`void ${s.signature} {\n`,s.header&&(n+=`  ${s.header}`),t[i]){const e=t[i];e.sort(((e,t)=>e.order-t.order));for(const t of e)n+=`  ${t.injection}\n`}s.footer&&(n+=`  ${s.footer}`),n+="}\n"}return n}function Bn(e){const t={vertex:{},fragment:{}};for(const n of e){let e,i;"string"!=typeof n?(e=n,i=e.hook):(e={},i=n),i=i.trim();const[s,r]=i.split(":"),o=i.replace(/\(.+/,""),a=Object.assign(e,{signature:r});switch(s){case"vs":t.vertex[o]=a;break;case"fs":t.fragment[o]=a;break;default:throw new Error(s)}}return t}function Dn(e,t="unnamed"){const n=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(e);return n?n[1]:t}function Un(e){let t=100;const n=e.match(/[^\s]+/g);if(n&&n.length>=2&&"#version"===n[0]){const e=parseInt(n[1],10);Number.isFinite(e)&&(t=e)}if(100!==t&&300!==t)throw new Error(`Invalid GLSL version ${t}`);return t}const Gn=`\n\n${xn}\n`;function zn(e,t){var n;const{source:i,stage:s,modules:r,hookFunctions:o=[],inject:a={},log:l}=t;pn("string"==typeof i,"shader source must be a string");const c=i;let u="";const h=Bn(o),d={},f={},p={};for(const m in a){const e="string"==typeof a[m]?{injection:a[m],order:0}:a[m],t=/^(v|f)s:(#)?([\w-]+)$/.exec(m);if(t){const n=t[2],i=t[3];n?"decl"===i?f[m]=[e]:p[m]=[e]:d[m]=[e]}else p[m]=[e]}const g=r;for(const m of g){l&&Rn(m,c,l);u+=jn(m,"wgsl");const e=(null==(n=m.injections)?void 0:n[s])||{};for(const t in e){const n=/^(v|f)s:#([\w-]+)$/.exec(t);if(n){const i="decl"===n[2]?f:p;i[t]=i[t]||[],i[t].push(e[t])}else d[t]=d[t]||[],d[t].push(e[t])}}return u+=Gn,u=An(u,s,f),u+=Fn(h[s],d),u+=c,u=An(u,s,p),u}function Vn(e,t){var n;const{id:i,source:s,stage:r,language:o="glsl",modules:a,defines:l={},hookFunctions:c=[],inject:u={},prologue:h=!0,log:d}=t;pn("string"==typeof s,"shader source must be a string");const f="glsl"===o?function(e,t){return{name:Dn(e,t),language:"glsl",version:Un(e)}}(s).version:-1,p=e.shaderLanguageVersion,g=100===f?"#version 100":"#version 300 es",m=s.split("\n").slice(1).join("\n"),_={};a.forEach((e=>{Object.assign(_,e.defines)})),Object.assign(_,l);let y="";switch(o){case"wgsl":break;case"glsl":y=h?`${g}\n\n// ----- PROLOGUE -------------------------\n${function(e){const{id:t,source:n,stage:i}=e,s=t&&-1===n.indexOf("SHADER_NAME");return s?`\n#define SHADER_NAME ${t}_${i}`:""}({id:i,source:s,stage:r})}\n#define SHADER_TYPE_${r.toUpperCase()}\n\n${function(e){switch(null==e?void 0:e.gpu.toLowerCase()){case"apple":return"#define APPLE_GPU\n// Apple optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n";case"nvidia":return"#define NVIDIA_GPU\n// Nvidia optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n";case"intel":return"#define INTEL_GPU\n// Intel optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n";case"amd":return"#define AMD_GPU\n";default:return"#define DEFAULT_GPU\n// Prevent driver from optimizing away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Headless Chrome's software shader 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// If the GPU doesn't have full 32 bits precision, will causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n"}}(e)}\n${"fragment"===r?"precision highp float;\n":""}\n\n// ----- APPLICATION DEFINES -------------------------\n\n${function(e={}){let t="";for(const n in e){const i=e[n];(i||Number.isFinite(i))&&(t+=`#define ${n.toUpperCase()} ${e[n]}\n`)}return t}(_)}\n\n`:`${g}\n`}const v=Bn(c),b={},E={},x={};for(const w in u){const e="string"==typeof u[w]?{injection:u[w],order:0}:u[w],t=/^(v|f)s:(#)?([\w-]+)$/.exec(w);if(t){const n=t[2],i=t[3];n?"decl"===i?E[w]=[e]:x[w]=[e]:b[w]=[e]}else x[w]=[e]}for(const w of a){d&&Rn(w,m,d);y+=jn(w,r);const e=(null==(n=w.instance)?void 0:n.normalizedInjections[r])||{};for(const t in e){const n=/^(v|f)s:#([\w-]+)$/.exec(t);if(n){const i="decl"===n[2]?E:x;i[t]=i[t]||[],i[t].push(e[t])}else b[t]=b[t]||[],b[t].push(e[t])}}return y+="// ----- MAIN SHADER SOURCE -------------------------",y+=Gn,y=An(y,r,E),y+=Fn(v[r],b),y+=m,y=An(y,r,x),"glsl"===o&&f!==p&&(y=function(e,t){var n;if(300!==Number((null==(n=e.match(/^#version[ \t]+(\d+)/m))?void 0:n[1])||100))throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(t){case"vertex":return On(e,Mn);case"fragment":return On(e,kn);default:throw new Error(t)}}(y,r)),y.trim()}function Wn(e){return function(t){var n;const i={};for(const s of e){const e=null==(n=s.getUniforms)?void 0:n.call(s,t,i);Object.assign(i,e)}return i}}function jn(e,t){let n;switch(t){case"vertex":n=e.vs||"";break;case"fragment":n=e.fs||"";break;case"wgsl":n=e.source||"";break;default:pn(!1)}if(!e.name)throw new Error("Shader module must have a name");const i=e.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let s=`// ----- MODULE ${e.name} ---------------\n\n`;return"wgsl"!==t&&(s+=`#define MODULE_${i}\n`),s+=`${n}\n`,s}const Hn=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,$n=/^\s*\#\s*endif\s*$/;const Xn=class e{constructor(){i(this,"_hookFunctions",[]),i(this,"_defaultModules",[])}static getDefaultShaderAssembler(){return e.defaultShaderAssembler=e.defaultShaderAssembler||new e,e.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find((t=>t.name===("string"==typeof e?e:e.name)))||this._defaultModules.push(e)}removeDefaultModule(e){const t="string"==typeof e?e:e.name;this._defaultModules=this._defaultModules.filter((e=>e.name!==t))}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),n=this._hookFunctions,{source:i,getUniforms:s}=function(e){const t=Cn(e.modules||[]);return{source:zn(e.platformInfo,{...e,source:e.source,stage:"vertex",modules:t}),getUniforms:Wn(t)}}({...e,source:e.source,modules:t,hookFunctions:n}),r="wgsl"===e.platformInfo.shaderLanguage?function(e,t){var n;const i=e.split("\n"),s=[];let r=!0,o=null;for(const a of i){const e=a.match(Hn),i=a.match($n);e?(o=e[1],r=Boolean(null==(n=null==t?void 0:t.defines)?void 0:n[o])):i?r=!0:r&&s.push(a)}return s.join("\n")}(i):i;return{source:r,getUniforms:s,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),n=this._hookFunctions,i=function(e){const{vs:t,fs:n}=e,i=Cn(e.modules||[]);return{vs:Vn(e.platformInfo,{...e,source:t,stage:"vertex",modules:i}),fs:Vn(e.platformInfo,{...e,source:n,stage:"fragment",modules:i}),getUniforms:Wn(i)}}({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:n});return{...i,modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),n={};let i=0;for(let s=0,r=this._defaultModules.length;s<r;++s){const e=this._defaultModules[s],r=e.name;t[i++]=e,n[r]=!0}for(let s=0,r=e.length;s<r;++s){const r=e[s],o=r.name;n[o]||(t[i++]=r,n[o]=!0)}return t.length=i,Sn(t),t}};i(Xn,"defaultShaderAssembler");let Yn=Xn;function Kn(e){const{input:t,inputChannels:n,output:i}=e||{};if(!t)return"#version 300 es\nout vec4 transform_output;\nvoid main() {\n  transform_output = vec4(0);\n}";if(!n)throw new Error("inputChannels");return`#version 300 es\nin ${function(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${e}`)}}(n)} ${t};\nout vec4 ${i};\nvoid main() {\n  ${i} = ${function(e,t){switch(t){case 1:return`vec4(${e}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${e}, 0.0, 1.0)`;case 3:return`vec4(${e}, 1.0)`;case 4:return e;default:throw new Error(`invalid channels: ${t}`)}}(t,n)};\n}`}const qn=new class{constructor(){i(this,"stats",new Map)}getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new Ve({id:e})),this.stats.get(e)}},Zn=new ue({id:"luma.gl"}),Qn={};function Jn(e="id"){Qn[e]=Qn[e]||1;return`${e}-${Qn[e]++}`}let ei=(t=class{constructor(e,t,n){if(i(this,"id"),i(this,"props"),i(this,"userData",{}),i(this,"_device"),i(this,"destroyed",!1),i(this,"allocatedBytes",0),i(this,"_attachedResources",new Set),!e)throw new Error("no device");this._device=e,this.props=function(e,t){const n={...t};for(const i in e)void 0!==e[i]&&(n[i]=e[i]);return n}(t,n);const s="undefined"!==this.props.id?this.props.id:Jn(this[Symbol.toStringTag]);this.props.id=s,this.id=s,this.userData=this.props.userData||{},this.addStats()}toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const n=this._device.statsManager.getStats("Resource Counts");n.get("GPU Memory").addCount(e),n.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}},i(t,"defaultProps",{id:"undefined",handle:void 0,userData:void 0}),t);const ti=class e extends ei{constructor(t,n){const s={...n};(n.usage||0)&e.INDEX&&!n.indexType&&(n.data instanceof Uint32Array?s.indexType="uint32":n.data instanceof Uint16Array&&(s.indexType="uint16")),delete s.data,super(t,s,e.defaultProps),i(this,"usage"),i(this,"indexType"),i(this,"updateTimestamp"),i(this,"debugData",new ArrayBuffer(0)),this.usage=s.usage||0,this.indexType=s.indexType,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Buffer"}clone(e){return this.device.createBuffer({...this.props,...e})}readSyncWebGL(e,t){throw new Error("not implemented")}_setDebugData(t,n,i){const s=ArrayBuffer.isView(t)?t.buffer:t,r=Math.min(t?t.byteLength:i,e.DEBUG_DATA_MAX_LENGTH);null===s?this.debugData=new ArrayBuffer(r):0===n&&i===s.byteLength?this.debugData=s.slice(0,r):this.debugData=s.slice(n,n+r)}};i(ti,"defaultProps",{...ei.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1}),i(ti,"MAP_READ",1),i(ti,"MAP_WRITE",2),i(ti,"COPY_SRC",4),i(ti,"COPY_DST",8),i(ti,"INDEX",16),i(ti,"VERTEX",32),i(ti,"UNIFORM",64),i(ti,"STORAGE",128),i(ti,"INDIRECT",256),i(ti,"QUERY_RESOLVE",512),i(ti,"DEBUG_DATA_MAX_LENGTH",32);let ni=ti;function ii(e){const t=function(e){const t=ri[e];return t}(si[e]),n=e.includes("norm"),i=!n&&!e.startsWith("float"),s=e.startsWith("s");return{dataType:si[e],byteLength:t,integer:i,signed:s,normalized:n}}const si={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},ri={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},oi="texture-compression-bc",ai="texture-compression-astc",li="texture-compression-etc2",ci="texture-compression-pvrtc-webgl",ui="texture-compression-atc-webgl",hi="float32-renderable-webgl",di="float16-renderable-webgl",fi="snorm8-renderable-webgl",pi="norm16-renderable-webgl",gi="snorm16-renderable-webgl",mi="float32-filterable",_i="float16-filterable-webgl";function yi(e){const t=vi[e];if(!t)throw new Error(`Unsupported texture format ${e}`);return t}const vi={r8unorm:{},r8snorm:{render:fi},r8uint:{},r8sint:{},rg8unorm:{},rg8snorm:{render:fi},rg8uint:{},rg8sint:{},r16uint:{},r16sint:{},r16float:{render:di,filter:"float16-filterable-webgl"},"r16unorm-webgl":{f:pi},"r16snorm-webgl":{f:gi},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{},"rgb8snorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},rgba8snorm:{render:fi},rgba8uint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{},rg16sint:{},rg16float:{render:di,filter:_i},"rg16unorm-webgl":{render:pi},"rg16snorm-webgl":{render:gi},r32uint:{},r32sint:{},r32float:{render:hi,filter:mi},rgb9e5ufloat:{channels:"rgb",packed:!0,render:"rgb9e5ufloat-renderable-webgl"},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:hi},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{f:pi},"rgb16snorm-webgl":{f:pi},rg32uint:{},rg32sint:{},rg32float:{render:!1,filter:mi},rgba16uint:{},rgba16sint:{},rgba16float:{render:di,filter:_i},"rgba16unorm-webgl":{render:pi},"rgba16snorm-webgl":{render:gi},"rgb32float-webgl":{render:hi,filter:mi},rgba32uint:{},rgba32sint:{},rgba32float:{render:hi,filter:mi},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:oi},"bc1-rgb-unorm-srgb-webgl":{f:oi},"bc1-rgba-unorm":{f:oi},"bc1-rgba-unorm-srgb":{f:oi},"bc2-rgba-unorm":{f:oi},"bc2-rgba-unorm-srgb":{f:oi},"bc3-rgba-unorm":{f:oi},"bc3-rgba-unorm-srgb":{f:oi},"bc4-r-unorm":{f:oi},"bc4-r-snorm":{f:oi},"bc5-rg-unorm":{f:oi},"bc5-rg-snorm":{f:oi},"bc6h-rgb-ufloat":{f:oi},"bc6h-rgb-float":{f:oi},"bc7-rgba-unorm":{f:oi},"bc7-rgba-unorm-srgb":{f:oi},"etc2-rgb8unorm":{f:li},"etc2-rgb8unorm-srgb":{f:li},"etc2-rgb8a1unorm":{f:li},"etc2-rgb8a1unorm-srgb":{f:li},"etc2-rgba8unorm":{f:li},"etc2-rgba8unorm-srgb":{f:li},"eac-r11unorm":{f:li},"eac-r11snorm":{f:li},"eac-rg11unorm":{f:li},"eac-rg11snorm":{f:li},"astc-4x4-unorm":{f:ai},"astc-4x4-unorm-srgb":{f:ai},"astc-5x4-unorm":{f:ai},"astc-5x4-unorm-srgb":{f:ai},"astc-5x5-unorm":{f:ai},"astc-5x5-unorm-srgb":{f:ai},"astc-6x5-unorm":{f:ai},"astc-6x5-unorm-srgb":{f:ai},"astc-6x6-unorm":{f:ai},"astc-6x6-unorm-srgb":{f:ai},"astc-8x5-unorm":{f:ai},"astc-8x5-unorm-srgb":{f:ai},"astc-8x6-unorm":{f:ai},"astc-8x6-unorm-srgb":{f:ai},"astc-8x8-unorm":{f:ai},"astc-8x8-unorm-srgb":{f:ai},"astc-10x5-unorm":{f:ai},"astc-10x5-unorm-srgb":{f:ai},"astc-10x6-unorm":{f:ai},"astc-10x6-unorm-srgb":{f:ai},"astc-10x8-unorm":{f:ai},"astc-10x8-unorm-srgb":{f:ai},"astc-10x10-unorm":{f:ai},"astc-10x10-unorm-srgb":{f:ai},"astc-12x10-unorm":{f:ai},"astc-12x10-unorm-srgb":{f:ai},"astc-12x12-unorm":{f:ai},"astc-12x12-unorm-srgb":{f:ai},"pvrtc-rgb4unorm-webgl":{f:ci},"pvrtc-rgba4unorm-webgl":{f:ci},"pvrtc-rbg2unorm-webgl":{f:ci},"pvrtc-rgba2unorm-webgl":{f:ci},"etc1-rbg-unorm-webgl":{f:"texture-compression-etc1-webgl"},"atc-rgb-unorm-webgl":{f:ui},"atc-rgba-unorm-webgl":{f:ui},"atc-rgbai-unorm-webgl":{f:ui}},bi=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],Ei=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function xi(e){return bi.some((t=>e.startsWith(t)))}function wi(e){let t=function(e){var t;const n=yi(e),i=n.bytesPerPixel||1,s=n.bitsPerChannel||[8,8,8,8];delete n.bitsPerChannel,delete n.bytesPerPixel,delete n.f,delete n.render,delete n.filter,delete n.blend,delete n.store;const r={...n,format:e,attachment:n.attachment||"color",channels:n.channels||"r",components:n.components||(null==(t=n.channels)?void 0:t.length)||1,bytesPerPixel:i,bitsPerChannel:s,dataType:n.dataType||"uint8",srgb:n.srgb??!1,packed:n.packed??!1,webgl:n.webgl??!1,integer:n.integer??!1,signed:n.signed??!1,normalized:n.normalized??!1,compressed:n.compressed??!1};return r}(e);if(xi(e)){t.channels="rgb",t.components=3,t.bytesPerPixel=1,t.srgb=!1,t.compressed=!0;const n=function(e){const t=/.*-(\d+)x(\d+)-.*/.exec(e);if(t){const[,e,n]=t;return{blockWidth:Number(e),blockHeight:Number(n)}}return null}(e);n&&(t.blockWidth=n.blockWidth,t.blockHeight=n.blockHeight)}const n=Ei.exec(e);if(n){const[,i,s,r,o,a]=n,l=ii(`${r}${s}`),c=8*l.byteLength,u=i.length,h=[c,u>=2?c:0,u>=3?c:0,u>=4?c:0];t={format:e,attachment:t.attachment,dataType:l.dataType,components:u,channels:i,integer:l.integer,signed:l.signed,normalized:l.normalized,bitsPerChannel:h,bytesPerPixel:l.byteLength*i.length,packed:t.packed,srgb:t.srgb},"-webgl"===a&&(t.webgl=!0),"-srgb"===o&&(t.srgb=!0)}return e.endsWith("-webgl")&&(t.webgl=!0),e.endsWith("-srgb")&&(t.srgb=!0),t}class Ti{}class Ai{constructor(e=[],t){i(this,"features"),i(this,"disabledFeatures"),this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){var t;return!(null==(t=this.disabledFeatures)?void 0:t[e])&&this.features.has(e)}}const Si=class e{constructor(t){i(this,"id"),i(this,"props"),i(this,"userData",{}),i(this,"statsManager",qn),i(this,"timestamp",0),i(this,"_reused",!1),i(this,"_lumaData",{}),this.props={...e.defaultProps,...t},this.id=this.props.id||Jn(this[Symbol.toStringTag].toLowerCase())}get[Symbol.toStringTag](){return"Device"}getTextureFormatCapabilities(e){const t=function(e){const t=yi(e),n={format:e,create:t.f??!0,render:t.render??!0,filter:t.filter??!0,blend:t.blend??!0,store:t.store??!0},i=wi(e),s=e.startsWith("depth")||e.startsWith("stencil"),r=null==i?void 0:i.signed,o=null==i?void 0:i.integer,a=null==i?void 0:i.webgl;return n.render&&(n.render=!r),n.filter&&(n.filter=!(s||r||o||a)),n}(e),n=e=>("string"==typeof e?this.features.has(e):e)??!0,i=n(t.create),s={format:e,create:i,render:i&&n(t.render),filter:i&&n(t.filter),blend:i&&n(t.blend),store:i&&n(t.store)};return this._getDeviceSpecificTextureFormatCapabilities(s)}isTextureFormatSupported(e,t){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return xi(e)}loseDevice(){return!1}reportError(e){this.props.onError(e)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(e={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return!0===e.createCanvasContext?{}:e.createCanvasContext}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};return(e.usage||0)&ni.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array?t.indexType="uint16":Zn.warn("indices buffer content must be of integer type")()),t}};i(Si,"defaultProps",{id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:e=>Zn.error(e.message)(),_reuseDevices:!1,_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:Zn.get("debug")||void 0,debugShaders:Zn.get("debug-shaders")||void 0,debugFramebuffers:Boolean(Zn.get("debug-framebuffers")),debugWebGL:Boolean(Zn.get("debug-webgl")),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0});let Ri=Si;const Pi=Z()&&"undefined"!=typeof document,Ci="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.",Ii=class e{constructor(){if(i(this,"stats",qn),i(this,"log",Zn),i(this,"VERSION","9.1.7"),i(this,"spector"),i(this,"preregisteredAdapters",new Map),globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw Zn.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),Zn.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");Zn.error("This version of luma.gl has already been initialized")()}Zn.log(1,`${this.VERSION} - set luma.log.level=1 (or higher) to trace rendering`)(),globalThis.luma=this}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this.getAdapterMap(e);return Array.from(t).map((([,e])=>e)).filter((e=>{var t;return null==(t=e.isSupported)?void 0:t.call(e)})).map((e=>e.type))}getBestAvailableAdapter(e=[]){var t,n,i,s;const r=this.getAdapterMap(e);return(null==(n=null==(t=r.get("webgpu"))?void 0:t.isSupported)?void 0:n.call(t))?"webgpu":(null==(s=null==(i=r.get("webgl"))?void 0:i.isSupported)?void 0:s.call(i))?"webgl":null}setDefaultDeviceProps(t){Object.assign(e.defaultProps,t)}async createDevice(t={}){var n;(t={...e.defaultProps,...t}).waitForPageLoad&&await e.pageLoaded;const i=this.getAdapterMap(t.adapters);let s=t.type||"";"best-available"===s&&(s=this.getBestAvailableAdapter(t.adapters)||s);const r=(this.getAdapterMap(t.adapters)||i).get(s),o=await(null==(n=null==r?void 0:r.create)?void 0:n.call(r,t));if(o)return o;throw new Error(Ci)}async attachDevice(t){var n;const i=this.getAdapterMap(t.adapters);let s="";t.handle instanceof WebGL2RenderingContext&&(s="webgl"),t.createCanvasContext&&await e.pageLoaded,null===t.handle&&(s="unknown");const r=i.get(s),o=await(null==(n=null==r?void 0:r.attach)?void 0:n.call(r,null));if(o)return o;throw new Error(Ci)}enforceWebGL2(e=!0,t=[]){var n;const i=this.getAdapterMap(t).get("webgl");i||Zn.warn("enforceWebGL2: webgl adapter not found")(),null==(n=null==i?void 0:i.enforceWebGL2)||n.call(i,e)}getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const n of e)t.set(n.type,n);return t}registerDevices(e){Zn.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const t of e){const e=t.adapter;e&&this.preregisteredAdapters.set(e.type,e)}}};i(Ii,"defaultProps",{...Ri.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0}),i(Ii,"pageLoaded",function(){if(Pi&&"complete"===document.readyState||"undefined"==typeof window)return Promise.resolve();return new Promise((e=>{window.addEventListener("load",(()=>e()))}))}().then((()=>{Zn.probe(2,"DOM is loaded")()})));const Li=new Ii;class Mi{}const ki=class e{constructor(t){if(i(this,"id"),i(this,"props"),i(this,"canvas"),i(this,"htmlCanvas"),i(this,"offscreenCanvas"),i(this,"type"),i(this,"width",1),i(this,"height",1),i(this,"resizeObserver"),i(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1}),this.props={...e.defaultProps,...t},t=this.props,!Z())return this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,void(this.canvas=null);if(t.canvas)"string"==typeof t.canvas?this.canvas=function(e){const t=document.getElementById(e);if(!(t instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return t}(t.canvas):this.canvas=t.canvas;else{const e=function(e){const{width:t,height:n}=e,i=document.createElement("canvas");return i.id=Jn("lumagl-auto-created-canvas"),i.width=t||1,i.height=n||1,i.style.width=Number.isFinite(t)?`${t}px`:"100%",i.style.height=Number.isFinite(n)?`${n}px`:"100%",i}(t),n=function(e){if("string"==typeof e){const t=document.getElementById(e);if(!t)throw new Error(`${e} is not an HTML element`);return t}if(e)return e;return document.body}((null==t?void 0:t.container)||null);n.insertBefore(e,n.firstChild),this.canvas=e,(null==t?void 0:t.visible)||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&t.autoResize&&(this.resizeObserver=new ResizeObserver((e=>{for(const t of e)t.target===this.canvas&&this.update()})),this.resizeObserver.observe(this.canvas))}toString(){return`${this[Symbol.toStringTag]}(${this.id})`}getDevicePixelRatio(e){if("undefined"!=typeof OffscreenCanvas&&this.canvas instanceof OffscreenCanvas)return 1;if(!(e=void 0===e?this.props.useDevicePixels:e)||e<=0)return 1;if(!0===e){return"undefined"!=typeof window&&window.devicePixelRatio||1}return e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),t=this.canvas;return t.parentElement?[t.clientWidth*e,t.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,t]=this.getPixelSize();return e/t}cssToDeviceRatio(){var e;try{const[t]=this.getDrawingBufferSize(),n=this._canvasSizeInfo.clientWidth||(null==(e=this.htmlCanvas)?void 0:e.clientWidth);return n?t/n:1}catch{return 1}}cssToDevicePixels(e,t=!0){const n=this.cssToDeviceRatio(),[i,s]=this.getDrawingBufferSize();return function(e,t,n,i,s){const r=e,o=Ni(r[0],t,n);let a=Fi(r[1],t,i,s),l=Ni(r[0]+1,t,n);const c=l===n-1?l:l-1;let u;l=Fi(r[1]+1,t,i,s),s?(l=0===l?l:l+1,u=a,a=l):u=l===i-1?l:l-1;return{x:o,y:a,width:Math.max(c-o+1,1),height:Math.max(u-a+1,1)}}(e,n,i,s,t)}setDevicePixelRatio(e,t={}){if(!this.htmlCanvas)return;let n="width"in t?t.width:this.htmlCanvas.clientWidth,i="height"in t?t.height:this.htmlCanvas.clientHeight;n&&i||(Zn.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,n=this.htmlCanvas.width||1,i=this.htmlCanvas.height||1);const s=this._canvasSizeInfo;if(s.clientWidth!==n||s.clientHeight!==i||s.devicePixelRatio!==e){let t=e;const s=Math.floor(n*t),r=Math.floor(i*t);this.htmlCanvas.width=s,this.htmlCanvas.height=r;if(this.device.gl){const[o,a]=this.getDrawingBufferSize();o===s&&a===r||(t=Math.min(o/n,a/i),this.htmlCanvas.width=Math.floor(n*t),this.htmlCanvas.height=Math.floor(i*t),Zn.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=n,this._canvasSizeInfo.clientHeight=i,this._canvasSizeInfo.devicePixelRatio=e}}}getDrawingBufferSize(){const e=this.device.gl;return e?[e.drawingBufferWidth,e.drawingBufferHeight]:this.getPixelSize()}_setAutoCreatedCanvasId(e){var t;"lumagl-auto-created-canvas"===(null==(t=this.htmlCanvas)?void 0:t.id)&&(this.htmlCanvas.id=e)}};i(ki,"defaultProps",{canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"});let Oi=ki;function Ni(e,t,n){return Math.min(Math.round(e*t),n-1)}function Fi(e,t,n,i){return i?Math.max(0,n-1-Math.round(e*t)):Math.min(Math.round(e*t),n-1)}const Bi=class e extends ei{constructor(t,n){if(super(t,n=e.normalizeProps(t,n),e.defaultProps),i(this,"dimension"),i(this,"format"),i(this,"width"),i(this,"height"),i(this,"depth"),i(this,"mipLevels"),i(this,"updateTimestamp"),this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,void 0===this.props.width||void 0===this.props.height){const t=e.getTextureDataSize(this.props.data);this.width=(null==t?void 0:t.width)||1,this.height=(null==t?void 0:t.height)||1}this.props.mipmaps&&void 0===this.props.mipLevels&&(this.props.mipLevels="pyramid"),this.mipLevels="pyramid"===this.props.mipLevels?e.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=t.incrementTimestamp()}get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}clone(e){return this.device.createTexture({...this.props,...e})}static isExternalImage(e){return"undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas}static getExternalImageSize(e){if("undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)return{width:e.width,height:e.height};if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement)return{width:e.naturalWidth,height:e.naturalHeight};if("undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement)return{width:e.videoWidth,height:e.videoHeight};if("undefined"!=typeof VideoFrame&&e instanceof VideoFrame)return{width:e.displayWidth,height:e.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(e){const t=null==e?void 0:e.data;return ArrayBuffer.isView(t)}static getTextureDataSize(t){if(!t)return null;if(ArrayBuffer.isView(t))return null;if(Array.isArray(t))return e.getTextureDataSize(t[0]);if(e.isExternalImage(t))return e.getExternalImageSize(t);if(t&&"object"==typeof t&&t.constructor===Object){const e=Object.values(t)[0];return{width:e.width,height:e.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(e,t){let n;return n=ArrayBuffer.isView(e)?[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?e:[e],n}static getMipLevelCount(e,t){return Math.floor(Math.log2(Math.max(e,t)))+1}static getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(e)}}static normalizeProps(e,t){var n,i;const s={...t},r=(null==(i=null==(n=null==e?void 0:e.props)?void 0:n._resourceDefaults)?void 0:i.texture)||{};Object.assign(s,r);const{width:o,height:a}=s;return"number"==typeof o&&(s.width=Math.max(1,Math.ceil(o))),"number"==typeof a&&(s.height=Math.max(1,Math.ceil(a))),s}};i(Bi,"COPY_SRC",1),i(Bi,"COPY_DST",2),i(Bi,"TEXTURE",4),i(Bi,"STORAGE",8),i(Bi,"RENDER_ATTACHMENT",16),i(Bi,"CubeFaces",["+X","-X","+Y","-Y","+Z","-Z"]),i(Bi,"defaultProps",{...ei.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0}),i(Bi,"defaultCopyExternalImageOptions",{image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1});let Di=Bi;const Ui=class e extends ei{get[Symbol.toStringTag](){return"TextureView"}constructor(t,n){super(t,n,e.defaultProps)}};i(Ui,"defaultProps",{...ei.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0});let Gi=Ui;function zi(e,t,n,i){if(null==i?void 0:i.inlineSource){const i=function(e,t,n){let i="";for(let s=t-2;s<=t;s++){const r=e[s-1];void 0!==r&&(i+=Vi(r,t,n))}return i}(t,n);return`\n${i}${e.linePos>0?`${" ".repeat(e.linePos+5)}^^^\n`:""}${e.type.toUpperCase()}: ${e.message}\n\n`}const s="error"===e.type?"red":"#8B4000";return(null==i?void 0:i.html)?`<div class='luma-compiler-log-error' style="color:${s};"><b> ${e.type.toUpperCase()}: ${e.message}</b></div>`:`${e.type.toUpperCase()}: ${e.message}`}function Vi(e,t,n){const i=(null==n?void 0:n.html)?e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"):e;return`${function(e,t){let n="";for(let i=e.length;i<t;++i)n+=" ";return n+e}(String(t),4)}: ${i}${(null==n?void 0:n.html)?"<br/>":"\n"}`}const Wi=class e extends ei{constructor(t,n){super(t,{id:Hi(n={...n,debugShaders:n.debugShaders||t.props.debugShaders||"errors"}),...n},e.defaultProps),i(this,"stage"),i(this,"source"),i(this,"compilationStatus","pending"),this.stage=this.props.stage,this.source=this.props.source}get[Symbol.toStringTag](){return"Shader"}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const e=this.props.debugShaders;switch(e){case"never":return;case"errors":if("success"===this.compilationStatus)return}const t=await this.getCompilationInfo();"warnings"===e&&0===(null==t?void 0:t.length)||this._displayShaderLog(t)}_displayShaderLog(e){var t;if("undefined"==typeof document||!(null==document?void 0:document.createElement))return;const n=$i(this.source),i=`${this.stage} ${n}`;let s=function(e,t,n){let i="";const s=t.split(/\r?\n/),r=e.slice().sort(((e,t)=>e.lineNum-t.lineNum));switch((null==n?void 0:n.showSourceCode)||"no"){case"all":let t=0;for(let e=1;e<=s.length;e++)for(i+=Vi(s[e-1],e,n);r.length>t&&r[t].lineNum===e;){const e=r[t++];i+=zi(e,s,e.lineNum,{...n,inlineSource:!1})}return i;case"issues":case"no":for(const r of e)i+=zi(r,s,r.lineNum,{inlineSource:"no"!==(null==n?void 0:n.showSourceCode)});return i}}(e,this.source,{showSourceCode:"all",html:!0});const r=this.getTranslatedSource();r&&(s+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${r}</pre></code>`);const o=document.createElement("Button");o.innerHTML=`\n<h1>Shader Compilation Error in ${i}</h1><br /><br />\n<code style="user-select:text;"><pre>\n${s}\n</pre></code>`,o.style.top="10px",o.style.left="10px",o.style.position="absolute",o.style.zIndex="9999",o.style.width="100%",o.style.textAlign="left",document.body.appendChild(o);null==(t=document.getElementsByClassName("luma-compiler-log-error")[0])||t.scrollIntoView(),o.onclick=()=>{const e=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(e)}}};i(Wi,"defaultProps",{...ei.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0});let ji=Wi;function Hi(e){return $i(e.source)||e.id||Jn(`unnamed ${e.stage}-shader`)}function $i(e,t="unnamed"){const n=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(e);return n?n[1]:t}const Xi=class e extends ei{get[Symbol.toStringTag](){return"Sampler"}constructor(t,n){super(t,n=e.normalizeProps(t,n),e.defaultProps)}static normalizeProps(e,t){var n,i;return{...t,...(null==(i=null==(n=null==e?void 0:e.props)?void 0:n._resourceDefaults)?void 0:i.sampler)||{}}}};i(Xi,"defaultProps",{...ei.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1});let Yi=Xi;const Ki=class e extends ei{constructor(t,n={}){super(t,n,e.defaultProps),i(this,"width"),i(this,"height"),this.width=this.props.width,this.height=this.props.height}get[Symbol.toStringTag](){return"Framebuffer"}clone(e){const t=this.colorAttachments.map((t=>t.texture.clone(e))),n=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(e);return this.device.createFramebuffer({...this.props,colorAttachments:t,depthStencilAttachment:n})}resize(e){let t=!e;if(e){const[n,i]=Array.isArray(e)?e:[e.width,e.height];t=t||i!==this.height||n!==this.width,this.width=n,this.height=i}t&&(Zn.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(0===this.props.colorAttachments.length&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map(((e,t)=>{if("string"==typeof e){const n=this.createColorTexture(e,t);return this.attachResource(n),n.view}return e instanceof Di?e.view:e}));const e=this.props.depthStencilAttachment;if(e)if("string"==typeof e){const t=this.createDepthStencilTexture(e);this.attachResource(t),this.depthStencilAttachment=t.view}else this.depthStencilAttachment=e instanceof Di?e.view:e}createColorTexture(e,t){return this.device.createTexture({id:`${this.id}-color-attachment-${t}`,usage:Di.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(e){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:Di.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(e,t){for(let n=0;n<this.colorAttachments.length;++n)if(this.colorAttachments[n]){const i=this.colorAttachments[n].texture.clone({width:e,height:t});this.destroyAttachedResource(this.colorAttachments[n]),this.colorAttachments[n]=i.view,this.attachResource(i.view)}if(this.depthStencilAttachment){const n=this.depthStencilAttachment.texture.clone({width:e,height:t});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=n.view,this.attachResource(n)}this.updateAttachments()}};i(Ki,"defaultProps",{...ei.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null});let qi=Ki;const Zi=class e extends ei{constructor(t,n){super(t,n,e.defaultProps),i(this,"shaderLayout"),i(this,"bufferLayout"),i(this,"linkStatus","pending"),i(this,"hash",""),this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}get[Symbol.toStringTag](){return"RenderPipeline"}setUniformsWebGL(e){throw new Error("Use uniform blocks")}};i(Zi,"defaultProps",{...ei.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}});let Qi=Zi;const Ji=class e extends ei{get[Symbol.toStringTag](){return"RenderPass"}constructor(t,n){super(t,n=e.normalizeProps(t,n),e.defaultProps)}static normalizeProps(e,t){var n;return{...null==(n=e.props._resourceDefaults)?void 0:n.renderPass,...t}}};i(Ji,"defaultClearColor",[0,0,0,1]),i(Ji,"defaultClearDepth",1),i(Ji,"defaultClearStencil",0),i(Ji,"defaultProps",{...ei.defaultProps,framebuffer:null,parameters:void 0,clearColor:Ji.defaultClearColor,clearColors:void 0,clearDepth:Ji.defaultClearDepth,clearStencil:Ji.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0});let es=Ji;const ts=class e extends ei{constructor(t,n){super(t,n,e.defaultProps),i(this,"hash",""),i(this,"shaderLayout"),this.shaderLayout=n.shaderLayout}get[Symbol.toStringTag](){return"ComputePipeline"}};i(ts,"defaultProps",{...ei.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0});let ns=ts;const is=class e extends ei{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(t,n){super(t,n,e.defaultProps)}};i(is,"defaultProps",{...ei.defaultProps,measureExecutionTime:void 0});let ss=is;const rs=class e extends ei{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(t,n){super(t,n,e.defaultProps)}};i(rs,"defaultProps",{...ei.defaultProps});let os=rs;const as={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},ls={f32:4,f16:2,i32:4,u32:4};function cs(e){let t;e.endsWith("-webgl")&&(e.replace("-webgl",""),t=!0);const[n,i]=e.split("x"),s=n,r=i?parseInt(i):1,o=ii(s),a={type:s,components:r,byteLength:o.byteLength*r,integer:o.integer,signed:o.signed,normalized:o.normalized};return t&&(a.webglOnly=!0),a}function us(e,t){const n={};for(const i of e.attributes){const s=hs(e,t,i.name);s&&(n[i.name]=s)}return n}function hs(e,t,n){const i=function(e,t){const n=e.attributes.find((e=>e.name===t));n||Zn.warn(`shader layout attribute "${t}" not present in shader`);return n||null}(e,n),s=function(e,t){!function(e){for(const t of e)(t.attributes&&t.format||!t.attributes&&!t.format)&&Zn.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}(e);let n=function(e,t){for(const n of e)if(n.format&&n.name===t)return{attributeName:n.name,bufferName:t,stepMode:n.stepMode,vertexFormat:n.format,byteOffset:0,byteStride:n.byteStride||0};return null}(e,t);if(n)return n;if(n=function(e,t){var n;for(const i of e){let e=i.byteStride;if("number"!=typeof i.byteStride)for(const t of i.attributes||[]){e+=cs(t.format).byteLength}const s=null==(n=i.attributes)?void 0:n.find((e=>e.attribute===t));if(s)return{attributeName:s.attribute,bufferName:i.name,stepMode:i.stepMode,vertexFormat:s.format,byteOffset:s.byteOffset,byteStride:e}}return null}(e,t),n)return n;return Zn.warn(`layout for attribute "${t}" not present in buffer layout`),null}(t,n);if(!i)return null;const r=function(e){const[t,n]=as[e],i="i32"===t||"u32"===t,s="u32"!==t,r=ls[t]*n,o=function(e,t){let n;switch(e){case"f32":n="float32";break;case"i32":n="sint32";break;case"u32":n="uint32";break;case"f16":return t<=2?"float16x2":"float16x4"}return 1===t?n:`${n}x${t}`}(t,n);return{dataType:t,components:n,defaultVertexFormat:o,byteLength:r,integer:i,signed:s}}(i.type),o=(null==s?void 0:s.vertexFormat)||r.defaultVertexFormat,a=cs(o);return{attributeName:(null==s?void 0:s.attributeName)||i.name,bufferName:(null==s?void 0:s.bufferName)||i.name,location:i.location,shaderType:i.type,shaderDataType:r.dataType,shaderComponents:r.components,vertexFormat:o,bufferDataType:a.type,bufferComponents:a.components,normalized:a.normalized,integer:r.integer,stepMode:(null==s?void 0:s.stepMode)||i.stepMode||"vertex",byteOffset:(null==s?void 0:s.byteOffset)||0,byteStride:(null==s?void 0:s.byteStride)||0}}const ds=class e extends ei{constructor(t,n){super(t,n,e.defaultProps),i(this,"maxVertexAttributes"),i(this,"attributeInfos"),i(this,"indexBuffer",null),i(this,"attributes"),this.maxVertexAttributes=t.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:s,bufferLayout:r}=n.renderPipeline||{};if(!s||!r)throw new Error("VertexArray");this.attributeInfos=function(e,t,n=16){const i=us(e,t),s=new Array(n).fill(null);for(const r of Object.values(i))s[r.location]=r;return s}(s,r,this.maxVertexAttributes)}get[Symbol.toStringTag](){return"VertexArray"}setConstantWebGL(e,t){this.device.reportError(new Error("constant attributes not supported"))}};i(ds,"defaultProps",{...ei.defaultProps,renderPipeline:null});let fs=ds;const ps=class e extends ei{get[Symbol.toStringTag](){return"TransformFeedback"}constructor(t,n){super(t,n,e.defaultProps)}};i(ps,"defaultProps",{...ei.defaultProps,layout:void 0,buffers:{}});let gs=ps;const ms=class e extends ei{get[Symbol.toStringTag](){return"QuerySet"}constructor(t,n){super(t,n,e.defaultProps)}};i(ms,"defaultProps",{...ei.defaultProps,type:void 0,count:void 0});let _s=ms;const ys={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function vs(e,t){switch(t){case 1:return e;case 2:return e+e%2;default:return e+(4-e%4)%4}}let bs;function Es(e){return(!bs||bs.byteLength<e)&&(bs=new ArrayBuffer(e)),bs}function xs(e){return Array.isArray(e)?0===e.length||"number"==typeof e[0]:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}(e)}class ws{constructor(e){i(this,"layout",{}),i(this,"byteLength");let t=0;for(const[i,s]of Object.entries(e)){const e=ys[s],{type:n,components:r}=e;t=vs(t,r);const o=t;t+=r,this.layout[i]={type:n,size:r,offset:o}}t+=(4-t%4)%4;const n=4*t;this.byteLength=Math.max(n,1024)}getData(e){const t=Es(Math.max(this.byteLength,1024)),n={i32:new Int32Array(t),u32:new Uint32Array(t),f32:new Float32Array(t),f16:new Uint16Array(t)};for(const[i,s]of Object.entries(e)){const e=this.layout[i];if(!e){Zn.warn(`Supplied uniform value ${i} not present in uniform block layout`)();continue}const{type:t,size:r,offset:o}=e,a=n[t];if(1===r){if("number"!=typeof s&&"boolean"!=typeof s){Zn.warn(`Supplied value for single component uniform ${i} is not a number: ${s}`)();continue}a[o]=Number(s)}else{if(!xs(s)){Zn.warn(`Supplied value for multi component / array uniform ${i} is not a numeric array: ${s}`)();continue}a.set(s,o)}}return new Uint8Array(t)}has(e){return Boolean(this.layout[e])}get(e){return this.layout[e]}}class Ts{constructor(e){var t;if(i(this,"name"),i(this,"uniforms",{}),i(this,"modifiedUniforms",{}),i(this,"modified",!0),i(this,"bindingLayout",{}),i(this,"needsRedraw","initialized"),this.name=(null==e?void 0:e.name)||"unnamed",(null==e?void 0:e.name)&&(null==e?void 0:e.shaderLayout)){const n=null==(t=null==e?void 0:e.shaderLayout.bindings)?void 0:t.find((t=>"uniform"===t.type&&t.name===(null==e?void 0:e.name)));if(!n)throw new Error(null==e?void 0:e.name);const i=n;for(const e of i.uniforms||[])this.bindingLayout[e.name]=e}}setUniforms(e){for(const[t,n]of Object.entries(e))this._setUniform(t,n),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${n}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){var n;(function(e,t){if(e!==t)return!1;const n=e,i=t;if(!xs(n))return!1;if(xs(i)&&n.length===i.length)for(let s=0;s<n.length;++s)if(i[s]!==n[s])return!1;return!0})(this.uniforms[e],t)||(this.uniforms[e]=xs(n=t)?n.slice():n,this.modifiedUniforms[e]=!0,this.modified=!0)}}class As{constructor(e){i(this,"uniformBlocks",new Map),i(this,"uniformBufferLayouts",new Map),i(this,"uniformBuffers",new Map);for(const[t,n]of Object.entries(e)){const e=t,i=new ws(n.uniformTypes||{});this.uniformBufferLayouts.set(e,i);const s=new Ts({name:t});s.setUniforms(n.defaultUniforms||{}),this.uniformBlocks.set(e,s)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){var t;for(const[n,i]of Object.entries(e))null==(t=this.uniformBlocks.get(n))||t.setUniforms(i);this.updateUniformBuffers()}getUniformBufferByteLength(e){var t;return(null==(t=this.uniformBufferLayouts.get(e))?void 0:t.byteLength)||0}getUniformBufferData(e){var t,n;const i=(null==(t=this.uniformBlocks.get(e))?void 0:t.getAllUniforms())||{};return null==(n=this.uniformBufferLayouts.get(e))?void 0:n.getData(i)}createUniformBuffer(e,t,n){n&&this.setUniforms(n);const i=this.getUniformBufferByteLength(t),s=e.createBuffer({usage:ni.UNIFORM|ni.COPY_DST,byteLength:i}),r=this.getUniformBufferData(t);return s.write(r),s}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const n=this.getUniformBufferByteLength(t),i=e.createBuffer({usage:ni.UNIFORM|ni.COPY_DST,byteLength:n});this.uniformBuffers.set(t,i)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const n=this.updateUniformBuffer(t);e||(e=n)}return e&&Zn.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){var t;const n=this.uniformBlocks.get(e);let i=this.uniformBuffers.get(e),s=!1;if(i&&(null==n?void 0:n.needsRedraw)){s||(s=n.needsRedraw);const r=this.getUniformBufferData(e);i=this.uniformBuffers.get(e),null==i||i.write(r);const o=null==(t=this.uniformBlocks.get(e))?void 0:t.getAllUniforms();Zn.log(4,`Writing to uniform buffer ${String(e)}`,r,o)()}return s}}function Ss(e){const t=ArrayBuffer.isView(e)?e.constructor:e;switch(t){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(t.constructor.name)}}function Rs(e){switch(e){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(e)}}function Ps(e,t,n){if(!t||t>4)throw new Error(`size ${t}`);const i=t;let s=Ss(e);if("uint8"===s&&n&&1===i)return"unorm8-webgl";if("uint8"===s&&n&&3===i)return"unorm8x3-webgl";if("uint8"===s||"sint8"===s){if(1===i||3===i)throw new Error(`size: ${t}`);return n&&(s=s.replace("int","norm")),`${s}x${i}`}if("uint16"===s||"sint16"===s){if(1===i||3===i)throw new Error(`size: ${t}`);return n&&(s=s.replace("int","norm")),`${s}x${i}`}return 1===i?s:`${s}x${i}`}class Cs{constructor(e){i(this,"bufferLayouts"),this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find((t=>t.name===e))||null}getAttributeNamesForBuffer(e){var t;return e.attributes?null==(t=e.attributes)?void 0:t.map((e=>e.attribute)):[e.name]}mergeBufferLayouts(e,t){const n=[...e];for(const i of t){const e=n.findIndex((e=>e.name===i.name));e<0?n.push(i):n[e]=i}return n}}class Is{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}getTypeName(){return this.name}}class Ls{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Ms extends Is{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class ks extends Is{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class Os extends Is{constructor(e,t,n,i){super(e,n),this.format=t,this.access=i}get isTemplate(){return!0}getTypeName(){let e=this.name;if(null!==this.format){if("vec2"===e||"vec3"===e||"vec4"===e||"mat2x2"===e||"mat2x3"===e||"mat2x4"===e||"mat3x2"===e||"mat3x3"===e||"mat3x4"===e||"mat4x2"===e||"mat4x3"===e||"mat4x4"===e){if("f32"===this.format.name)return e+="f",e;if("i32"===this.format.name)return e+="i",e;if("u32"===this.format.name)return e+="u",e;if("bool"===this.format.name)return e+="b",e;if("f16"===this.format.name)return e+="h",e}e+=`<${this.format.name}>`}else if("vec2"===e||"vec3"===e||"vec4"===e)return e;return e}}var Ns,Fs;(Fs=Ns||(Ns={}))[Fs.Uniform=0]="Uniform",Fs[Fs.Storage=1]="Storage",Fs[Fs.Texture=2]="Texture",Fs[Fs.Sampler=3]="Sampler",Fs[Fs.StorageTexture=4]="StorageTexture";class Bs{constructor(e,t,n,i,s,r,o){this.name=e,this.type=t,this.group=n,this.binding=i,this.attributes=s,this.resourceType=r,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Ds{constructor(e,t){this.name=e,this.type=t}}class Us{constructor(e,t,n,i){this.name=e,this.type=t,this.locationType=n,this.location=i,this.interpolation=null}}class Gs{constructor(e,t,n,i){this.name=e,this.type=t,this.locationType=n,this.location=i}}class zs{constructor(e,t,n,i){this.name=e,this.type=t,this.attributes=n,this.id=i}}class Vs{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}}class Ws{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}}class js{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}const Hs=new Float32Array(1),$s=new Int32Array(Hs.buffer),Xs=new Uint16Array(1);function Ys(e){Hs[0]=e;const t=$s[0],n=t>>31&1;let i=t>>23&255,s=8388607&t;if(255===i)return Xs[0]=n<<15|31744|(0!==s?512:0),Xs[0];if(0===i){if(0===s)return Xs[0]=n<<15,Xs[0];s|=8388608;let e=113;for(;!(8388608&s);)s<<=1,e--;return i=127-e,s&=8388607,i>0?(s=(s>>126-i)+(s>>127-i&1),Xs[0]=n<<15|i<<10|s>>13,Xs[0]):(Xs[0]=n<<15,Xs[0])}return i=i-127+15,i>=31?(Xs[0]=n<<15|31744,Xs[0]):i<=0?i<-10?(Xs[0]=n<<15,Xs[0]):(s=(8388608|s)>>1-i,Xs[0]=n<<15|s>>13,Xs[0]):(s>>=13,Xs[0]=n<<15|i<<10|s,Xs[0])}const Ks=new Uint32Array(1),qs=new Float32Array(Ks.buffer,0,1);function Zs(e){const t=112+(e>>6&31)<<23|(63&e)<<17;return Ks[0]=t,qs[0]}function Qs(e,t,n,i){const s=[0,0,0,0];for(let c=0;c<i;++c)switch(n){case"8unorm":s[c]=e[t]/255,t++;break;case"8snorm":s[c]=e[t]/255*2-1,t++;break;case"8uint":s[c]=e[t],t++;break;case"8sint":s[c]=e[t]-127,t++;break;case"16uint":s[c]=e[t]|e[t+1]<<8,t+=2;break;case"16sint":s[c]=(e[t]|e[t+1]<<8)-32768,t+=2;break;case"16float":s[c]=(void 0,void 0,void 0,o=(32768&(r=e[t]|e[t+1]<<8))>>15,l=1023&r,0==(a=(31744&r)>>10)?(o?-1:1)*Math.pow(2,-14)*(l/Math.pow(2,10)):31==a?l?NaN:1/0*(o?-1:1):(o?-1:1)*Math.pow(2,a-15)*(1+l/Math.pow(2,10))),t+=2;break;case"32uint":case"32sint":s[c]=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,t+=4;break;case"32float":s[c]=new Float32Array(e.buffer,t,1)[0],t+=4}var r,o,a,l;return s}function Js(e,t,n,i,s){for(let r=0;r<i;++r)switch(n){case"8unorm":e[t]=255*s[r],t++;break;case"8snorm":e[t]=.5*(s[r]+1)*255,t++;break;case"8uint":e[t]=s[r],t++;break;case"8sint":e[t]=s[r]+127,t++;break;case"16uint":new Uint16Array(e.buffer,t,1)[0]=s[r],t+=2;break;case"16sint":new Int16Array(e.buffer,t,1)[0]=s[r],t+=2;break;case"16float":{const n=Ys(s[r]);new Uint16Array(e.buffer,t,1)[0]=n,t+=2;break}case"32uint":new Uint32Array(e.buffer,t,1)[0]=s[r],t+=4;break;case"32sint":new Int32Array(e.buffer,t,1)[0]=s[r],t+=4;break;case"32float":new Float32Array(e.buffer,t,1)[0]=s[r],t+=4}return s}const er={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class tr{constructor(){this.id=tr._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(nr.instance);for(const n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(ir.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}tr._id=0;class nr extends tr{}nr.instance=new nr;class ir extends tr{}ir.instance=new ir;const sr=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class rr extends tr{constructor(){super()}}class or extends rr{constructor(e,t,n,i,s,r){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=i,this.startLine=s,this.endLine=r}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class ar extends rr{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class lr extends rr{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class cr extends rr{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class ur extends rr{constructor(e,t,n,i){super(),this.init=e,this.condition=t,this.increment=n,this.body=i}get astNodeType(){return"for"}search(e){var t,n,i;null===(t=this.init)||void 0===t||t.search(e),null===(n=this.condition)||void 0===n||n.search(e),null===(i=this.increment)||void 0===i||i.search(e),this.searchBlock(this.body,e)}}class hr extends rr{constructor(e,t,n,i,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"var"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class dr extends rr{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return"override"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class fr extends rr{constructor(e,t,n,i,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"let"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class pr extends rr{constructor(e,t,n,i,s){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=i,this.value=s}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}var gr,mr,_r,yr;(e=>{e.increment="++",e.decrement="--"})(gr||(gr={})),(e=>{e.parse=function(t){const n=t;if("parse"==n)throw new Error("Invalid value for IncrementOperator");return e[n]}})(gr||(gr={}));class vr extends rr{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(e=>{e.assign="=",e.addAssign="+=",e.subtractAssin="-=",e.multiplyAssign="*=",e.divideAssign="/=",e.moduloAssign="%=",e.andAssign="&=",e.orAssign="|=",e.xorAssign="^=",e.shiftLeftAssign="<<=",e.shiftRightAssign=">>="})(mr||(mr={})),(mr||(mr={})).parse=function(e){const t=e;if("parse"==t)throw new Error("Invalid value for AssignOperator");return t};class br extends rr{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Er extends rr{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return sr.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class xr extends rr{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class wr extends rr{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}}class Tr extends rr{constructor(e,t,n,i){super(),this.condition=e,this.body=t,this.elseif=n,this.else=i}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Ar extends rr{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Sr extends rr{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Rr extends rr{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Pr extends rr{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class Cr extends rr{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Ir extends rr{constructor(){super()}get astNodeType(){return"discard"}}class Lr extends rr{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class Mr extends rr{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class kr extends rr{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if("f32"===t.name)return t;for(let n=1;n<e.length;++n){const i=kr._priority.get(t.name);kr._priority.get(e[n].name)<i&&(t=e[n])}return"x32"===t.name?kr.i32:t}getTypeName(){return this.name}}kr.x32=new kr("x32"),kr.f32=new kr("f32"),kr.i32=new kr("i32"),kr.u32=new kr("u32"),kr.f16=new kr("f16"),kr.bool=new kr("bool"),kr.void=new kr("void"),kr._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class Or extends kr{constructor(e){super(e)}}class Nr extends kr{constructor(e,t,n,i){super(e),this.members=t,this.startLine=n,this.endLine=i}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class Fr extends kr{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(null!==this.format){if("vec2"===e||"vec3"===e||"vec4"===e||"mat2x2"===e||"mat2x3"===e||"mat2x4"===e||"mat3x2"===e||"mat3x3"===e||"mat3x4"===e||"mat4x2"===e||"mat4x3"===e||"mat4x4"===e){if("f32"===this.format.name)return e+="f",e;if("i32"===this.format.name)return e+="i",e;if("u32"===this.format.name)return e+="u",e;if("bool"===this.format.name)return e+="b",e;if("f16"===this.format.name)return e+="h",e}e+=`<${this.format.name}>`}else if("vec2"===e||"vec3"===e||"vec4"===e)return e;return e}}Fr.vec2f=new Fr("vec2",kr.f32,null),Fr.vec3f=new Fr("vec3",kr.f32,null),Fr.vec4f=new Fr("vec4",kr.f32,null),Fr.vec2i=new Fr("vec2",kr.i32,null),Fr.vec3i=new Fr("vec3",kr.i32,null),Fr.vec4i=new Fr("vec4",kr.i32,null),Fr.vec2u=new Fr("vec2",kr.u32,null),Fr.vec3u=new Fr("vec3",kr.u32,null),Fr.vec4u=new Fr("vec4",kr.u32,null),Fr.vec2h=new Fr("vec2",kr.f16,null),Fr.vec3h=new Fr("vec3",kr.f16,null),Fr.vec4h=new Fr("vec4",kr.f16,null),Fr.vec2b=new Fr("vec2",kr.bool,null),Fr.vec3b=new Fr("vec3",kr.bool,null),Fr.vec4b=new Fr("vec4",kr.bool,null),Fr.mat2x2f=new Fr("mat2x2",kr.f32,null),Fr.mat2x3f=new Fr("mat2x3",kr.f32,null),Fr.mat2x4f=new Fr("mat2x4",kr.f32,null),Fr.mat3x2f=new Fr("mat3x2",kr.f32,null),Fr.mat3x3f=new Fr("mat3x3",kr.f32,null),Fr.mat3x4f=new Fr("mat3x4",kr.f32,null),Fr.mat4x2f=new Fr("mat4x2",kr.f32,null),Fr.mat4x3f=new Fr("mat4x3",kr.f32,null),Fr.mat4x4f=new Fr("mat4x4",kr.f32,null),Fr.mat2x2h=new Fr("mat2x2",kr.f16,null),Fr.mat2x3h=new Fr("mat2x3",kr.f16,null),Fr.mat2x4h=new Fr("mat2x4",kr.f16,null),Fr.mat3x2h=new Fr("mat3x2",kr.f16,null),Fr.mat3x3h=new Fr("mat3x3",kr.f16,null),Fr.mat3x4h=new Fr("mat3x4",kr.f16,null),Fr.mat4x2h=new Fr("mat4x2",kr.f16,null),Fr.mat4x3h=new Fr("mat4x3",kr.f16,null),Fr.mat4x4h=new Fr("mat4x4",kr.f16,null),Fr.mat2x2i=new Fr("mat2x2",kr.i32,null),Fr.mat2x3i=new Fr("mat2x3",kr.i32,null),Fr.mat2x4i=new Fr("mat2x4",kr.i32,null),Fr.mat3x2i=new Fr("mat3x2",kr.i32,null),Fr.mat3x3i=new Fr("mat3x3",kr.i32,null),Fr.mat3x4i=new Fr("mat3x4",kr.i32,null),Fr.mat4x2i=new Fr("mat4x2",kr.i32,null),Fr.mat4x3i=new Fr("mat4x3",kr.i32,null),Fr.mat4x4i=new Fr("mat4x4",kr.i32,null),Fr.mat2x2u=new Fr("mat2x2",kr.u32,null),Fr.mat2x3u=new Fr("mat2x3",kr.u32,null),Fr.mat2x4u=new Fr("mat2x4",kr.u32,null),Fr.mat3x2u=new Fr("mat3x2",kr.u32,null),Fr.mat3x3u=new Fr("mat3x3",kr.u32,null),Fr.mat3x4u=new Fr("mat3x4",kr.u32,null),Fr.mat4x2u=new Fr("mat4x2",kr.u32,null),Fr.mat4x3u=new Fr("mat4x3",kr.u32,null),Fr.mat4x4u=new Fr("mat4x4",kr.u32,null);class Br extends kr{constructor(e,t,n,i){super(e),this.storage=t,this.type=n,this.access=i}get astNodeType(){return"pointer"}}class Dr extends kr{constructor(e,t,n,i){super(e),this.attributes=t,this.format=n,this.count=i}get astNodeType(){return"array"}get isArray(){return!0}}class Ur extends kr{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"sampler"}}class Gr extends tr{constructor(){super(),this.postfix=null}}class zr extends Gr{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class Vr extends Gr{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class Wr extends Gr{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return sr.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class jr extends Gr{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class Hr extends Gr{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const t=e.evalExpression(this.initializer,e.context);return null!==t&&this.postfix?t.getSubData(e,this.postfix,e.context):t}return null}search(e){this.initializer.search(e)}}class $r extends Gr{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return void 0!==t&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof co}get isVector(){return this.value instanceof ho||this.value instanceof fo}get scalarValue(){return this.value instanceof co?this.value.value:0}get vectorValue(){return this.value instanceof ho||this.value instanceof fo?this.value.data:new Float32Array(0)}}class Xr extends Gr{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class Yr extends Gr{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Kr extends Gr{constructor(){super()}}class qr extends Kr{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Zr extends Kr{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:"f32"===e.name||"f32"===t.name?kr.f32:"u32"===e.name||"u32"===t.name?kr.u32:kr.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class Qr extends tr{constructor(e){super(),this.body=e}}class Jr extends Gr{constructor(){super()}get astNodeType(){return"default"}}class eo extends Qr{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class to extends Qr{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class no extends tr{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"argument"}}class io extends tr{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class so extends tr{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"member"}}class ro extends tr{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class oo{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=oo._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,n,i){}getSubData(e,t,n){return null}toString(){return`<${this.typeInfo.name}>`}}oo._id=0;class ao extends oo{constructor(){super(new Is("void",null),null)}toString(){return"void"}}ao.void=new ao;class lo extends oo{constructor(e){super(new Is("pointer",null),null),this.reference=e}clone(){return this}setDataValue(e,t,n,i){this.reference.setDataValue(e,t,n,i)}getSubData(e,t,n){return t?this.reference.getSubData(e,t,n):this}}class co extends oo{constructor(e,t,n=null){super(t,n),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:"x32"===this.typeInfo.name?e-Math.floor(e)!=0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):"i32"===this.typeInfo.name||"bool"===this.typeInfo.name?this.data=new Int32Array([e]):"u32"===this.typeInfo.name?this.data=new Uint32Array([e]):("f32"===this.typeInfo.name||"f16"===this.typeInfo.name)&&(this.data=new Float32Array([e]))}clone(){if(this.data instanceof Float32Array)return new co(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new co(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new co(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,n,i){if(n)return;if(!(t instanceof co))return;let s=t.data[0];"i32"===this.typeInfo.name||"u32"===this.typeInfo.name?s=Math.floor(s):"bool"===this.typeInfo.name&&(s=s?1:0),this.data[0]=s}getSubData(e,t,n){return t?null:this}toString(){return`${this.value}`}}function uo(e,t,n){const i=t.length;return 2===i?"f32"===n?new ho(new Float32Array(t),e.getTypeInfo("vec2f")):"i32"===n||"bool"===n?new ho(new Int32Array(t),e.getTypeInfo("vec2i")):"u32"===n?new ho(new Uint32Array(t),e.getTypeInfo("vec2u")):"f16"===n?new ho(new Float32Array(t),e.getTypeInfo("vec2h")):null:3===i?"f32"===n?new ho(new Float32Array(t),e.getTypeInfo("vec3f")):"i32"===n||"bool"===n?new ho(new Int32Array(t),e.getTypeInfo("vec3i")):"u32"===n?new ho(new Uint32Array(t),e.getTypeInfo("vec3u")):"f16"===n?new ho(new Float32Array(t),e.getTypeInfo("vec3h")):null:4===i?"f32"===n?new ho(new Float32Array(t),e.getTypeInfo("vec4f")):"i32"===n||"bool"===n?new ho(new Int32Array(t),e.getTypeInfo("vec4i")):"u32"===n?new ho(new Uint32Array(t),e.getTypeInfo("vec4u")):"f16"===n?new ho(new Float32Array(t),e.getTypeInfo("vec4h")):null:null}class ho extends oo{constructor(e,t,n=null){if(super(t,n),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const t=this.typeInfo.name;"vec2f"===t||"vec3f"===t||"vec4f"===t?this.data=new Float32Array(e):"vec2i"===t||"vec3i"===t||"vec4i"===t?this.data=new Int32Array(e):"vec2u"===t||"vec3u"===t||"vec4u"===t?this.data=new Uint32Array(e):"vec2h"===t||"vec3h"===t||"vec4h"===t?this.data=new Float32Array(e):"vec2b"===t||"vec3b"===t||"vec4b"===t?this.data=new Int32Array(e):("vec2"===t||"vec3"===t||"vec4"===t)&&(this.data=new Float32Array(e))}}clone(){if(this.data instanceof Float32Array)return new ho(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new ho(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new ho(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,n,i){n instanceof zr||t instanceof ho&&(this.data=t.data)}getSubData(e,t,n){if(null===t)return this;let i=e.getTypeInfo("f32");if(this.typeInfo instanceof Os)i=this.typeInfo.format||i;else{const t=this.typeInfo.name;"vec2f"===t||"vec3f"===t||"vec4f"===t?i=e.getTypeInfo("f32"):"vec2i"===t||"vec3i"===t||"vec4i"===t?i=e.getTypeInfo("i32"):"vec2b"===t||"vec3b"===t||"vec4b"===t?i=e.getTypeInfo("bool"):"vec2u"===t||"vec3u"===t||"vec4u"===t?i=e.getTypeInfo("u32"):("vec2h"===t||"vec3h"===t||"vec4h"===t)&&(i=e.getTypeInfo("f16"))}let s=this;for(;null!==t&&null!==s;){if(t instanceof Yr){const r=t.index;let o=-1;if(r instanceof $r){if(!(r.value instanceof co))return null;o=r.value.value}else{const t=e.evalExpression(r,n);if(!(t instanceof co))return null;o=t.value}if(o<0||o>=s.data.length)return null;if(s.data instanceof Float32Array){const e=new Float32Array(s.data.buffer,s.data.byteOffset+4*o,1);return new co(e,i)}if(s.data instanceof Int32Array){const e=new Int32Array(s.data.buffer,s.data.byteOffset+4*o,1);return new co(e,i)}if(s.data instanceof Uint32Array){const e=new Uint32Array(s.data.buffer,s.data.byteOffset+4*o,1);return new co(e,i)}throw"GetSubData: Invalid data type"}if(!(t instanceof zr))return null;{const n=t.value.toLowerCase();if(1===n.length){let e=0;if("x"===n||"r"===n)e=0;else if("y"===n||"g"===n)e=1;else if("z"===n||"b"===n)e=2;else{if("w"!==n&&"a"!==n)return null;e=3}if(this.data instanceof Float32Array){let t=new Float32Array(this.data.buffer,this.data.byteOffset+4*e,1);return new co(t,i,this)}if(this.data instanceof Int32Array){let t=new Int32Array(this.data.buffer,this.data.byteOffset+4*e,1);return new co(t,i,this)}if(this.data instanceof Uint32Array){let t=new Uint32Array(this.data.buffer,this.data.byteOffset+4*e,1);return new co(t,i,this)}}const r=[];for(const e of n)"x"===e||"r"===e?r.push(this.data[0]):"y"===e||"g"===e?r.push(this.data[1]):"z"===e||"b"===e?r.push(this.data[2]):("w"===e||"a"===e)&&r.push(this.data[3]);s=uo(e,r,i.name)}t=t.postfix}return s}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class fo extends oo{constructor(e,t,n=null){super(t,n),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new fo(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,n,i){n instanceof zr||t instanceof fo&&(this.data=t.data)}getSubData(e,t,n){if(null===t)return this;const i=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof Os)this.typeInfo.format;else if(i.endsWith("f"))e.getTypeInfo("f32");else if(i.endsWith("i"))e.getTypeInfo("i32");else if(i.endsWith("u"))e.getTypeInfo("u32");else{if(!i.endsWith("h"))return null;e.getTypeInfo("f16")}if(t instanceof Yr){const s=t.index;let r=-1;if(s instanceof $r){if(!(s.value instanceof co))return null;r=s.value.value}else{const t=e.evalExpression(s,n);if(!(t instanceof co))return null;r=t.value}if(r<0||r>=this.data.length)return null;const o=i.endsWith("h")?"h":"f";let a;if("mat2x2"===i||"mat2x2f"===i||"mat2x2h"===i||"mat3x2"===i||"mat3x2f"===i||"mat3x2h"===i||"mat4x2"===i||"mat4x2f"===i||"mat4x2h"===i)a=new ho(new Float32Array(this.data.buffer,this.data.byteOffset+2*r*4,2),e.getTypeInfo(`vec2${o}`));else if("mat2x3"===i||"mat2x3f"===i||"mat2x3h"===i||"mat3x3"===i||"mat3x3f"===i||"mat3x3h"===i||"mat4x3"===i||"mat4x3f"===i||"mat4x3h"===i)a=new ho(new Float32Array(this.data.buffer,this.data.byteOffset+3*r*4,3),e.getTypeInfo(`vec3${o}`));else{if("mat2x4"!==i&&"mat2x4f"!==i&&"mat2x4h"!==i&&"mat3x4"!==i&&"mat3x4f"!==i&&"mat3x4h"!==i&&"mat4x4"!==i&&"mat4x4f"!==i&&"mat4x4h"!==i)return null;a=new ho(new Float32Array(this.data.buffer,this.data.byteOffset+4*r*4,4),e.getTypeInfo(`vec4${o}`))}return t.postfix?a.getSubData(e,t.postfix,n):a}return null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class po extends oo{constructor(e,t,n=0,i=null){super(t,i),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new po(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,n,i){if(null===t)return;let s=this.offset,r=this.typeInfo;for(;n;){if(n instanceof Yr){if(r instanceof ks){const t=n.index;if(t instanceof $r){if(!(t.value instanceof co))return;s+=t.value.value*r.stride}else{const n=e.evalExpression(t,i);if(!(n instanceof co))return;s+=n.value*r.stride}r=r.format}}else{if(!(n instanceof zr))return;{const e=n.value;if(r instanceof Ms){let t=!1;for(const n of r.members)if(n.name===e){s+=n.offset,r=n.type,t=!0;break}if(!t)return}else if(r instanceof Is){const n=r.getTypeName();let i=0;if("x"===e||"r"===e)i=0;else if("y"===e||"g"===e)i=1;else if("z"===e||"b"===e)i=2;else{if("w"!==e&&"a"!==e)return;i=3}if(!(t instanceof co))return;const o=t.value;return"vec2f"===n?void(new Float32Array(this.buffer,s,2)[i]=o):"vec3f"===n?void(new Float32Array(this.buffer,s,3)[i]=o):"vec4f"===n?void(new Float32Array(this.buffer,s,4)[i]=o):"vec2i"===n?void(new Int32Array(this.buffer,s,2)[i]=o):"vec3i"===n?void(new Int32Array(this.buffer,s,3)[i]=o):"vec4i"===n?void(new Int32Array(this.buffer,s,4)[i]=o):"vec2u"===n?void(new Uint32Array(this.buffer,s,2)[i]=o):"vec3u"===n?void(new Uint32Array(this.buffer,s,3)[i]=o):"vec4u"===n?void(new Uint32Array(this.buffer,s,4)[i]=o):void 0}}}n=n.postfix}this.setData(e,t,r,s,i)}setData(e,t,n,i,s){const r=n.getTypeName();if("f32"!==r&&"f16"!==r)if("i32"!==r&&"atomic<i32>"!==r&&"x32"!==r)if("u32"!==r&&"atomic<u32>"!==r)if("bool"!==r)if("vec2f"!==r&&"vec2h"!==r)if("vec3f"!==r&&"vec3h"!==r)if("vec4f"!==r&&"vec4h"!==r)if("vec2i"!==r)if("vec3i"!==r)if("vec4i"!==r)if("vec2u"!==r)if("vec3u"!==r)if("vec4u"!==r)if("vec2b"!==r)if("vec3b"!==r)if("vec4b"!==r)if("mat2x2f"!==r&&"mat2x2h"!==r)if("mat2x3f"!==r&&"mat2x3h"!==r)if("mat2x4f"!==r&&"mat2x4h"!==r)if("mat3x2f"!==r&&"mat3x2h"!==r)if("mat3x3f"!==r&&"mat3x3h"!==r)if("mat3x4f"!==r&&"mat3x4h"!==r)if("mat4x2f"!==r&&"mat4x2h"!==r)if("mat4x3f"!==r&&"mat4x3h"!==r)if("mat4x4f"!==r&&"mat4x4h"!==r){if(t instanceof po&&n===t.typeInfo)return void new Uint8Array(this.buffer,i,t.buffer.byteLength).set(new Uint8Array(t.buffer))}else{const e=new Float32Array(this.buffer,i,16);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11],e[12]=t.data[12],e[13]=t.data[13],e[14]=t.data[14],e[15]=t.data[15]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15])}else{const e=new Float32Array(this.buffer,i,12);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11])}else{const e=new Float32Array(this.buffer,i,8);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7])}else{const e=new Float32Array(this.buffer,i,12);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11])}else{const e=new Float32Array(this.buffer,i,9);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8])}else{const e=new Float32Array(this.buffer,i,6);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5])}else{const e=new Float32Array(this.buffer,i,8);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7])}else{const e=new Float32Array(this.buffer,i,6);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5])}else{const e=new Float32Array(this.buffer,i,4);t instanceof fo?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,i,4);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,i,3);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Uint32Array(this.buffer,i,2);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Uint32Array(this.buffer,i,4);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Uint32Array(this.buffer,i,3);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Uint32Array(this.buffer,i,2);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Int32Array(this.buffer,i,4);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Int32Array(this.buffer,i,3);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Int32Array(this.buffer,i,2);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1])}else{const e=new Float32Array(this.buffer,i,4);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}else{const e=new Float32Array(this.buffer,i,3);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])}else{const e=new Float32Array(this.buffer,i,2);t instanceof ho?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1])}else t instanceof co&&(new Int32Array(this.buffer,i,1)[0]=t.value);else t instanceof co&&(new Uint32Array(this.buffer,i,1)[0]=t.value);else t instanceof co&&(new Int32Array(this.buffer,i,1)[0]=t.value);else t instanceof co&&(new Float32Array(this.buffer,i,1)[0]=t.value)}getSubData(e,t,n){var i,s;if(null===t)return this;let r=this.offset,o=this.typeInfo;for(;t;){if(t instanceof Yr){const i=t.index,s=e.evalExpression(i,n);let a=0;if(s instanceof co&&(a=s.value),o instanceof ks)r+=a*o.stride,o=o.format;else{const t=o.getTypeName();("mat4x4"===t||"mat4x4f"===t||"mat4x4h"===t)&&(r+=16*a,o=e.getTypeInfo("vec4f"))}}else{if(!(t instanceof zr))return null;{const n=t.value;if(o instanceof Ms){let e=!1;for(const t of o.members)if(t.name===n){r+=t.offset,o=t.type,e=!0;break}if(!e)return null}else if(o instanceof Is){const t=o.getTypeName();if("vec2f"===t||"vec3f"===t||"vec4f"===t||"vec2i"===t||"vec3i"===t||"vec4i"===t||"vec2u"===t||"vec3u"===t||"vec4u"===t||"vec2b"===t||"vec3b"===t||"vec4b"===t||"vec2h"===t||"vec3h"===t||"vec4h"===t||"vec2"===t||"vec3"===t||"vec4"===t){if(n.length>0&&n.length<5){let i="f";const s=[];for(let o=0;o<n.length;++o){const a=n[o].toLowerCase();let l=0;if("x"===a||"r"===a)l=0;else if("y"===a||"g"===a)l=1;else if("z"===a||"b"===a)l=2;else{if("w"!==a&&"a"!==a)return null;l=3}if(1===n.length){if(t.endsWith("f"))return this.buffer.byteLength<r+4*l+4?null:new co(new Float32Array(this.buffer,r+4*l,1),e.getTypeInfo("f32"),this);if(t.endsWith("h"))return new co(new Float32Array(this.buffer,r+4*l,1),e.getTypeInfo("f16"),this);if(t.endsWith("i"))return new co(new Int32Array(this.buffer,r+4*l,1),e.getTypeInfo("i32"),this);if(t.endsWith("b"))return new co(new Int32Array(this.buffer,r+4*l,1),e.getTypeInfo("bool"),this);if(t.endsWith("u"))return new co(new Uint32Array(this.buffer,r+4*l,1),e.getTypeInfo("i32"),this)}if("vec2f"===t)s.push(new Float32Array(this.buffer,r,2)[l]);else if("vec3f"===t){if(r+12>=this.buffer.byteLength)return null;const e=new Float32Array(this.buffer,r,3);s.push(e[l])}else if("vec4f"===t)s.push(new Float32Array(this.buffer,r,4)[l]);else if("vec2i"===t)i="i",s.push(new Int32Array(this.buffer,r,2)[l]);else if("vec3i"===t)i="i",s.push(new Int32Array(this.buffer,r,3)[l]);else if("vec4i"===t)i="i",s.push(new Int32Array(this.buffer,r,4)[l]);else if("vec2u"===t){i="u";const e=new Uint32Array(this.buffer,r,2);s.push(e[l])}else"vec3u"===t?(i="u",s.push(new Uint32Array(this.buffer,r,3)[l])):"vec4u"===t&&(i="u",s.push(new Uint32Array(this.buffer,r,4)[l]))}return 2===s.length?o=e.getTypeInfo(`vec2${i}`):3===s.length?o=e.getTypeInfo(`vec3${i}`):4===s.length&&(o=e.getTypeInfo(`vec4${i}`)),new ho(s,o,null)}return null}return null}}}t=t.postfix}const a=o.getTypeName();return"f32"===a?new co(new Float32Array(this.buffer,r,1),o,this):"i32"===a?new co(new Int32Array(this.buffer,r,1),o,this):"u32"===a?new co(new Uint32Array(this.buffer,r,1),o,this):"vec2f"===a?new ho(new Float32Array(this.buffer,r,2),o,this):"vec3f"===a?new ho(new Float32Array(this.buffer,r,3),o,this):"vec4f"===a?new ho(new Float32Array(this.buffer,r,4),o,this):"vec2i"===a?new ho(new Int32Array(this.buffer,r,2),o,this):"vec3i"===a?new ho(new Int32Array(this.buffer,r,3),o,this):"vec4i"===a?new ho(new Int32Array(this.buffer,r,4),o,this):"vec2u"===a?new ho(new Uint32Array(this.buffer,r,2),o,this):"vec3u"===a?new ho(new Uint32Array(this.buffer,r,3),o,this):"vec4u"===a?new ho(new Uint32Array(this.buffer,r,4),o,this):o instanceof Os&&"atomic"===o.name?"u32"===(null===(i=o.format)||void 0===i?void 0:i.name)?new co(new Uint32Array(this.buffer,r,1)[0],o.format,this):"i32"===(null===(s=o.format)||void 0===s?void 0:s.name)?new co(new Int32Array(this.buffer,r,1)[0],o.format,this):null:new po(this.buffer,o,r,this)}toString(){let e="";if(this.typeInfo instanceof ks)if("f32"===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if("i32"===this.typeInfo.format.name){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if("u32"===this.typeInfo.format.name){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if("vec2f"===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if("vec3f"===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if("vec4f"===this.typeInfo.format.name){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e="[...]";else this.typeInfo instanceof Ms?e+="{...}":e="[...]";return e}}class go extends oo{constructor(e,t,n,i){super(t,null),this.data=e,this.descriptor=n,this.view=i}clone(){return new go(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>0?null!==(e=n[0])&&void 0!==e?e:0:n instanceof Object&&null!==(t=n.width)&&void 0!==t?t:0}get height(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>1?null!==(e=n[1])&&void 0!==e?e:0:n instanceof Object&&null!==(t=n.height)&&void 0!==t?t:0}get depthOrArrayLayers(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>2?null!==(e=n[2])&&void 0!==e?e:0:n instanceof Object&&null!==(t=n.depthOrArrayLayers)&&void 0!==t?t:0}get format(){var e;return this.descriptor&&null!==(e=this.descriptor.format)&&void 0!==e?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&null!==(e=this.descriptor.sampleCount)&&void 0!==e?e:1}get mipLevelCount(){var e;return this.descriptor&&null!==(e=this.descriptor.mipLevelCount)&&void 0!==e?e:1}get dimension(){var e;return this.descriptor&&null!==(e=this.descriptor.dimension)&&void 0!==e?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let n=0;n<t.length;++n)t[n]=Math.max(1,t[n]>>e);return t}get texelByteSize(){const e=this.format,t=er[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=er[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=er[e],n=this.width;if(!e||n<=0||!t)return-1;const i=this.height,s=this.depthOrArrayLayers,r=this.dimension;return n/t.blockWidth*("1d"===r?1:i/t.blockHeight)*t.bytesPerBlock*s}getPixel(e,t,n=0,i=0){const s=this.texelByteSize,r=this.bytesPerRow,o=this.height,a=this.data[i];return function(e,t,n,i,s,r,o,a,l){const c=i*(o>>=s)*(r>>=s)+n*o+t*a;switch(l){case"r8unorm":return[Qs(e,c,"8unorm",1)[0]];case"r8snorm":return[Qs(e,c,"8snorm",1)[0]];case"r8uint":return[Qs(e,c,"8uint",1)[0]];case"r8sint":return[Qs(e,c,"8sint",1)[0]];case"rg8unorm":{const t=Qs(e,c,"8unorm",2);return[t[0],t[1]]}case"rg8snorm":{const t=Qs(e,c,"8snorm",2);return[t[0],t[1]]}case"rg8uint":{const t=Qs(e,c,"8uint",2);return[t[0],t[1]]}case"rg8sint":{const t=Qs(e,c,"8sint",2);return[t[0],t[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const t=Qs(e,c,"8unorm",4);return[t[0],t[1],t[2],t[3]]}case"rgba8snorm":{const t=Qs(e,c,"8snorm",4);return[t[0],t[1],t[2],t[3]]}case"rgba8uint":{const t=Qs(e,c,"8uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba8sint":{const t=Qs(e,c,"8sint",4);return[t[0],t[1],t[2],t[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const t=Qs(e,c,"8unorm",4);return[t[2],t[1],t[0],t[3]]}case"r16uint":return[Qs(e,c,"16uint",1)[0]];case"r16sint":return[Qs(e,c,"16sint",1)[0]];case"r16float":return[Qs(e,c,"16float",1)[0]];case"rg16uint":{const t=Qs(e,c,"16uint",2);return[t[0],t[1]]}case"rg16sint":{const t=Qs(e,c,"16sint",2);return[t[0],t[1]]}case"rg16float":{const t=Qs(e,c,"16float",2);return[t[0],t[1]]}case"rgba16uint":{const t=Qs(e,c,"16uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba16sint":{const t=Qs(e,c,"16sint",4);return[t[0],t[1],t[2],t[3]]}case"rgba16float":{const t=Qs(e,c,"16float",4);return[t[0],t[1],t[2],t[3]]}case"r32uint":return[Qs(e,c,"32uint",1)[0]];case"r32sint":return[Qs(e,c,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[Qs(e,c,"32float",1)[0]];case"rg32uint":{const t=Qs(e,c,"32uint",2);return[t[0],t[1]]}case"rg32sint":{const t=Qs(e,c,"32sint",2);return[t[0],t[1]]}case"rg32float":{const t=Qs(e,c,"32float",2);return[t[0],t[1]]}case"rgba32uint":{const t=Qs(e,c,"32uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba32sint":{const t=Qs(e,c,"32sint",4);return[t[0],t[1],t[2],t[3]]}case"rgba32float":{const t=Qs(e,c,"32float",4);return[t[0],t[1],t[2],t[3]]}case"rg11b10ufloat":{const t=new Uint32Array(e.buffer,c,1)[0],n=(4192256&t)>>11,i=(4290772992&t)>>22;return[Zs(2047&t),Zs(n),function(e){const t=112+(e>>5&31)<<23|(31&e)<<18;return Ks[0]=t,qs[0]}(i),1]}}return null}(new Uint8Array(a),e,t,n,i,o,r,s,this.format)}setPixel(e,t,n,i,s){const r=this.texelByteSize,o=this.bytesPerRow,a=this.height,l=this.data[i];!function(e,t,n,i,s,r,o,a,l,c){const u=i*(o>>=s)*(r>>=s)+n*o+t*a;switch(l){case"r8unorm":return void Js(e,u,"8unorm",1,c);case"r8snorm":return void Js(e,u,"8snorm",1,c);case"r8uint":return void Js(e,u,"8uint",1,c);case"r8sint":return void Js(e,u,"8sint",1,c);case"rg8unorm":return void Js(e,u,"8unorm",2,c);case"rg8snorm":return void Js(e,u,"8snorm",2,c);case"rg8uint":return void Js(e,u,"8uint",2,c);case"rg8sint":return void Js(e,u,"8sint",2,c);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void Js(e,u,"8unorm",4,c);case"rgba8snorm":return void Js(e,u,"8snorm",4,c);case"rgba8uint":return void Js(e,u,"8uint",4,c);case"rgba8sint":return void Js(e,u,"8sint",4,c);case"r16uint":return void Js(e,u,"16uint",1,c);case"r16sint":return void Js(e,u,"16sint",1,c);case"r16float":return void Js(e,u,"16float",1,c);case"rg16uint":return void Js(e,u,"16uint",2,c);case"rg16sint":return void Js(e,u,"16sint",2,c);case"rg16float":return void Js(e,u,"16float",2,c);case"rgba16uint":return void Js(e,u,"16uint",4,c);case"rgba16sint":return void Js(e,u,"16sint",4,c);case"rgba16float":return void Js(e,u,"16float",4,c);case"r32uint":return void Js(e,u,"32uint",1,c);case"r32sint":return void Js(e,u,"32sint",1,c);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void Js(e,u,"32float",1,c);case"rg32uint":return void Js(e,u,"32uint",2,c);case"rg32sint":return void Js(e,u,"32sint",2,c);case"rg32float":return void Js(e,u,"32float",2,c);case"rgba32uint":return void Js(e,u,"32uint",4,c);case"rgba32sint":return void Js(e,u,"32sint",4,c);case"rgba32float":Js(e,u,"32float",4,c)}}(new Uint8Array(l),e,t,n,i,a,o,r,this.format,s)}}(e=>{e[e.token=0]="token",e[e.keyword=1]="keyword",e[e.reserved=2]="reserved"})(yr||(yr={}));class mo{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}}class _o{}_r=_o,_o.none=new mo("",yr.reserved,""),_o.eof=new mo("EOF",yr.token,""),_o.reserved={asm:new mo("asm",yr.reserved,"asm"),bf16:new mo("bf16",yr.reserved,"bf16"),do:new mo("do",yr.reserved,"do"),enum:new mo("enum",yr.reserved,"enum"),f16:new mo("f16",yr.reserved,"f16"),f64:new mo("f64",yr.reserved,"f64"),handle:new mo("handle",yr.reserved,"handle"),i8:new mo("i8",yr.reserved,"i8"),i16:new mo("i16",yr.reserved,"i16"),i64:new mo("i64",yr.reserved,"i64"),mat:new mo("mat",yr.reserved,"mat"),premerge:new mo("premerge",yr.reserved,"premerge"),regardless:new mo("regardless",yr.reserved,"regardless"),typedef:new mo("typedef",yr.reserved,"typedef"),u8:new mo("u8",yr.reserved,"u8"),u16:new mo("u16",yr.reserved,"u16"),u64:new mo("u64",yr.reserved,"u64"),unless:new mo("unless",yr.reserved,"unless"),using:new mo("using",yr.reserved,"using"),vec:new mo("vec",yr.reserved,"vec"),void:new mo("void",yr.reserved,"void")},_o.keywords={array:new mo("array",yr.keyword,"array"),atomic:new mo("atomic",yr.keyword,"atomic"),bool:new mo("bool",yr.keyword,"bool"),f32:new mo("f32",yr.keyword,"f32"),i32:new mo("i32",yr.keyword,"i32"),mat2x2:new mo("mat2x2",yr.keyword,"mat2x2"),mat2x3:new mo("mat2x3",yr.keyword,"mat2x3"),mat2x4:new mo("mat2x4",yr.keyword,"mat2x4"),mat3x2:new mo("mat3x2",yr.keyword,"mat3x2"),mat3x3:new mo("mat3x3",yr.keyword,"mat3x3"),mat3x4:new mo("mat3x4",yr.keyword,"mat3x4"),mat4x2:new mo("mat4x2",yr.keyword,"mat4x2"),mat4x3:new mo("mat4x3",yr.keyword,"mat4x3"),mat4x4:new mo("mat4x4",yr.keyword,"mat4x4"),ptr:new mo("ptr",yr.keyword,"ptr"),sampler:new mo("sampler",yr.keyword,"sampler"),sampler_comparison:new mo("sampler_comparison",yr.keyword,"sampler_comparison"),struct:new mo("struct",yr.keyword,"struct"),texture_1d:new mo("texture_1d",yr.keyword,"texture_1d"),texture_2d:new mo("texture_2d",yr.keyword,"texture_2d"),texture_2d_array:new mo("texture_2d_array",yr.keyword,"texture_2d_array"),texture_3d:new mo("texture_3d",yr.keyword,"texture_3d"),texture_cube:new mo("texture_cube",yr.keyword,"texture_cube"),texture_cube_array:new mo("texture_cube_array",yr.keyword,"texture_cube_array"),texture_multisampled_2d:new mo("texture_multisampled_2d",yr.keyword,"texture_multisampled_2d"),texture_storage_1d:new mo("texture_storage_1d",yr.keyword,"texture_storage_1d"),texture_storage_2d:new mo("texture_storage_2d",yr.keyword,"texture_storage_2d"),texture_storage_2d_array:new mo("texture_storage_2d_array",yr.keyword,"texture_storage_2d_array"),texture_storage_3d:new mo("texture_storage_3d",yr.keyword,"texture_storage_3d"),texture_depth_2d:new mo("texture_depth_2d",yr.keyword,"texture_depth_2d"),texture_depth_2d_array:new mo("texture_depth_2d_array",yr.keyword,"texture_depth_2d_array"),texture_depth_cube:new mo("texture_depth_cube",yr.keyword,"texture_depth_cube"),texture_depth_cube_array:new mo("texture_depth_cube_array",yr.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new mo("texture_depth_multisampled_2d",yr.keyword,"texture_depth_multisampled_2d"),texture_external:new mo("texture_external",yr.keyword,"texture_external"),u32:new mo("u32",yr.keyword,"u32"),vec2:new mo("vec2",yr.keyword,"vec2"),vec3:new mo("vec3",yr.keyword,"vec3"),vec4:new mo("vec4",yr.keyword,"vec4"),bitcast:new mo("bitcast",yr.keyword,"bitcast"),block:new mo("block",yr.keyword,"block"),break:new mo("break",yr.keyword,"break"),case:new mo("case",yr.keyword,"case"),continue:new mo("continue",yr.keyword,"continue"),continuing:new mo("continuing",yr.keyword,"continuing"),default:new mo("default",yr.keyword,"default"),diagnostic:new mo("diagnostic",yr.keyword,"diagnostic"),discard:new mo("discard",yr.keyword,"discard"),else:new mo("else",yr.keyword,"else"),enable:new mo("enable",yr.keyword,"enable"),fallthrough:new mo("fallthrough",yr.keyword,"fallthrough"),false:new mo("false",yr.keyword,"false"),fn:new mo("fn",yr.keyword,"fn"),for:new mo("for",yr.keyword,"for"),function:new mo("function",yr.keyword,"function"),if:new mo("if",yr.keyword,"if"),let:new mo("let",yr.keyword,"let"),const:new mo("const",yr.keyword,"const"),loop:new mo("loop",yr.keyword,"loop"),while:new mo("while",yr.keyword,"while"),private:new mo("private",yr.keyword,"private"),read:new mo("read",yr.keyword,"read"),read_write:new mo("read_write",yr.keyword,"read_write"),return:new mo("return",yr.keyword,"return"),requires:new mo("requires",yr.keyword,"requires"),storage:new mo("storage",yr.keyword,"storage"),switch:new mo("switch",yr.keyword,"switch"),true:new mo("true",yr.keyword,"true"),alias:new mo("alias",yr.keyword,"alias"),type:new mo("type",yr.keyword,"type"),uniform:new mo("uniform",yr.keyword,"uniform"),var:new mo("var",yr.keyword,"var"),override:new mo("override",yr.keyword,"override"),workgroup:new mo("workgroup",yr.keyword,"workgroup"),write:new mo("write",yr.keyword,"write"),r8unorm:new mo("r8unorm",yr.keyword,"r8unorm"),r8snorm:new mo("r8snorm",yr.keyword,"r8snorm"),r8uint:new mo("r8uint",yr.keyword,"r8uint"),r8sint:new mo("r8sint",yr.keyword,"r8sint"),r16uint:new mo("r16uint",yr.keyword,"r16uint"),r16sint:new mo("r16sint",yr.keyword,"r16sint"),r16float:new mo("r16float",yr.keyword,"r16float"),rg8unorm:new mo("rg8unorm",yr.keyword,"rg8unorm"),rg8snorm:new mo("rg8snorm",yr.keyword,"rg8snorm"),rg8uint:new mo("rg8uint",yr.keyword,"rg8uint"),rg8sint:new mo("rg8sint",yr.keyword,"rg8sint"),r32uint:new mo("r32uint",yr.keyword,"r32uint"),r32sint:new mo("r32sint",yr.keyword,"r32sint"),r32float:new mo("r32float",yr.keyword,"r32float"),rg16uint:new mo("rg16uint",yr.keyword,"rg16uint"),rg16sint:new mo("rg16sint",yr.keyword,"rg16sint"),rg16float:new mo("rg16float",yr.keyword,"rg16float"),rgba8unorm:new mo("rgba8unorm",yr.keyword,"rgba8unorm"),rgba8unorm_srgb:new mo("rgba8unorm_srgb",yr.keyword,"rgba8unorm_srgb"),rgba8snorm:new mo("rgba8snorm",yr.keyword,"rgba8snorm"),rgba8uint:new mo("rgba8uint",yr.keyword,"rgba8uint"),rgba8sint:new mo("rgba8sint",yr.keyword,"rgba8sint"),bgra8unorm:new mo("bgra8unorm",yr.keyword,"bgra8unorm"),bgra8unorm_srgb:new mo("bgra8unorm_srgb",yr.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new mo("rgb10a2unorm",yr.keyword,"rgb10a2unorm"),rg11b10float:new mo("rg11b10float",yr.keyword,"rg11b10float"),rg32uint:new mo("rg32uint",yr.keyword,"rg32uint"),rg32sint:new mo("rg32sint",yr.keyword,"rg32sint"),rg32float:new mo("rg32float",yr.keyword,"rg32float"),rgba16uint:new mo("rgba16uint",yr.keyword,"rgba16uint"),rgba16sint:new mo("rgba16sint",yr.keyword,"rgba16sint"),rgba16float:new mo("rgba16float",yr.keyword,"rgba16float"),rgba32uint:new mo("rgba32uint",yr.keyword,"rgba32uint"),rgba32sint:new mo("rgba32sint",yr.keyword,"rgba32sint"),rgba32float:new mo("rgba32float",yr.keyword,"rgba32float"),static_assert:new mo("static_assert",yr.keyword,"static_assert")},_o.tokens={decimal_float_literal:new mo("decimal_float_literal",yr.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new mo("hex_float_literal",yr.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new mo("int_literal",yr.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new mo("uint_literal",yr.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new mo("name",yr.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new mo("ident",yr.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new mo("and",yr.token,"&"),and_and:new mo("and_and",yr.token,"&&"),arrow:new mo("arrow ",yr.token,"->"),attr:new mo("attr",yr.token,"@"),forward_slash:new mo("forward_slash",yr.token,"/"),bang:new mo("bang",yr.token,"!"),bracket_left:new mo("bracket_left",yr.token,"["),bracket_right:new mo("bracket_right",yr.token,"]"),brace_left:new mo("brace_left",yr.token,"{"),brace_right:new mo("brace_right",yr.token,"}"),colon:new mo("colon",yr.token,":"),comma:new mo("comma",yr.token,","),equal:new mo("equal",yr.token,"="),equal_equal:new mo("equal_equal",yr.token,"=="),not_equal:new mo("not_equal",yr.token,"!="),greater_than:new mo("greater_than",yr.token,">"),greater_than_equal:new mo("greater_than_equal",yr.token,">="),shift_right:new mo("shift_right",yr.token,">>"),less_than:new mo("less_than",yr.token,"<"),less_than_equal:new mo("less_than_equal",yr.token,"<="),shift_left:new mo("shift_left",yr.token,"<<"),modulo:new mo("modulo",yr.token,"%"),minus:new mo("minus",yr.token,"-"),minus_minus:new mo("minus_minus",yr.token,"--"),period:new mo("period",yr.token,"."),plus:new mo("plus",yr.token,"+"),plus_plus:new mo("plus_plus",yr.token,"++"),or:new mo("or",yr.token,"|"),or_or:new mo("or_or",yr.token,"||"),paren_left:new mo("paren_left",yr.token,"("),paren_right:new mo("paren_right",yr.token,")"),semicolon:new mo("semicolon",yr.token,";"),star:new mo("star",yr.token,"*"),tilde:new mo("tilde",yr.token,"~"),underscore:new mo("underscore",yr.token,"_"),xor:new mo("xor",yr.token,"^"),plus_equal:new mo("plus_equal",yr.token,"+="),minus_equal:new mo("minus_equal",yr.token,"-="),times_equal:new mo("times_equal",yr.token,"*="),division_equal:new mo("division_equal",yr.token,"/="),modulo_equal:new mo("modulo_equal",yr.token,"%="),and_equal:new mo("and_equal",yr.token,"&="),or_equal:new mo("or_equal",yr.token,"|="),xor_equal:new mo("xor_equal",yr.token,"^="),shift_right_equal:new mo("shift_right_equal",yr.token,">>="),shift_left_equal:new mo("shift_left_equal",yr.token,"<<=")},_o.simpleTokens={"@":_r.tokens.attr,"{":_r.tokens.brace_left,"}":_r.tokens.brace_right,":":_r.tokens.colon,",":_r.tokens.comma,"(":_r.tokens.paren_left,")":_r.tokens.paren_right,";":_r.tokens.semicolon},_o.literalTokens={"&":_r.tokens.and,"&&":_r.tokens.and_and,"->":_r.tokens.arrow,"/":_r.tokens.forward_slash,"!":_r.tokens.bang,"[":_r.tokens.bracket_left,"]":_r.tokens.bracket_right,"=":_r.tokens.equal,"==":_r.tokens.equal_equal,"!=":_r.tokens.not_equal,">":_r.tokens.greater_than,">=":_r.tokens.greater_than_equal,">>":_r.tokens.shift_right,"<":_r.tokens.less_than,"<=":_r.tokens.less_than_equal,"<<":_r.tokens.shift_left,"%":_r.tokens.modulo,"-":_r.tokens.minus,"--":_r.tokens.minus_minus,".":_r.tokens.period,"+":_r.tokens.plus,"++":_r.tokens.plus_plus,"|":_r.tokens.or,"||":_r.tokens.or_or,"*":_r.tokens.star,"~":_r.tokens.tilde,_:_r.tokens.underscore,"^":_r.tokens.xor,"+=":_r.tokens.plus_equal,"-=":_r.tokens.minus_equal,"*=":_r.tokens.times_equal,"/=":_r.tokens.division_equal,"%=":_r.tokens.modulo_equal,"&=":_r.tokens.and_equal,"|=":_r.tokens.or_equal,"^=":_r.tokens.xor_equal,">>=":_r.tokens.shift_right_equal,"<<=":_r.tokens.shift_left_equal},_o.regexTokens={decimal_float_literal:_r.tokens.decimal_float_literal,hex_float_literal:_r.tokens.hex_float_literal,int_literal:_r.tokens.int_literal,uint_literal:_r.tokens.uint_literal,ident:_r.tokens.ident},_o.storage_class=[_r.keywords.function,_r.keywords.private,_r.keywords.workgroup,_r.keywords.uniform,_r.keywords.storage],_o.access_mode=[_r.keywords.read,_r.keywords.write,_r.keywords.read_write],_o.sampler_type=[_r.keywords.sampler,_r.keywords.sampler_comparison],_o.sampled_texture_type=[_r.keywords.texture_1d,_r.keywords.texture_2d,_r.keywords.texture_2d_array,_r.keywords.texture_3d,_r.keywords.texture_cube,_r.keywords.texture_cube_array],_o.multisampled_texture_type=[_r.keywords.texture_multisampled_2d],_o.storage_texture_type=[_r.keywords.texture_storage_1d,_r.keywords.texture_storage_2d,_r.keywords.texture_storage_2d_array,_r.keywords.texture_storage_3d],_o.depth_texture_type=[_r.keywords.texture_depth_2d,_r.keywords.texture_depth_2d_array,_r.keywords.texture_depth_cube,_r.keywords.texture_depth_cube_array,_r.keywords.texture_depth_multisampled_2d],_o.texture_external_type=[_r.keywords.texture_external],_o.any_texture_type=[..._r.sampled_texture_type,..._r.multisampled_texture_type,..._r.storage_texture_type,..._r.depth_texture_type,..._r.texture_external_type],_o.texel_format=[_r.keywords.r8unorm,_r.keywords.r8snorm,_r.keywords.r8uint,_r.keywords.r8sint,_r.keywords.r16uint,_r.keywords.r16sint,_r.keywords.r16float,_r.keywords.rg8unorm,_r.keywords.rg8snorm,_r.keywords.rg8uint,_r.keywords.rg8sint,_r.keywords.r32uint,_r.keywords.r32sint,_r.keywords.r32float,_r.keywords.rg16uint,_r.keywords.rg16sint,_r.keywords.rg16float,_r.keywords.rgba8unorm,_r.keywords.rgba8unorm_srgb,_r.keywords.rgba8snorm,_r.keywords.rgba8uint,_r.keywords.rgba8sint,_r.keywords.bgra8unorm,_r.keywords.bgra8unorm_srgb,_r.keywords.rgb10a2unorm,_r.keywords.rg11b10float,_r.keywords.rg32uint,_r.keywords.rg32sint,_r.keywords.rg32float,_r.keywords.rgba16uint,_r.keywords.rgba16sint,_r.keywords.rgba16float,_r.keywords.rgba32uint,_r.keywords.rgba32sint,_r.keywords.rgba32float],_o.const_literal=[_r.tokens.int_literal,_r.tokens.uint_literal,_r.tokens.decimal_float_literal,_r.tokens.hex_float_literal,_r.keywords.true,_r.keywords.false],_o.literal_or_ident=[_r.tokens.ident,_r.tokens.int_literal,_r.tokens.uint_literal,_r.tokens.decimal_float_literal,_r.tokens.hex_float_literal,_r.tokens.name],_o.element_count_expression=[_r.tokens.int_literal,_r.tokens.uint_literal,_r.tokens.ident],_o.template_types=[_r.keywords.vec2,_r.keywords.vec3,_r.keywords.vec4,_r.keywords.mat2x2,_r.keywords.mat2x3,_r.keywords.mat2x4,_r.keywords.mat3x2,_r.keywords.mat3x3,_r.keywords.mat3x4,_r.keywords.mat4x2,_r.keywords.mat4x3,_r.keywords.mat4x4,_r.keywords.atomic,_r.keywords.bitcast,..._r.any_texture_type],_o.attribute_name=[_r.tokens.ident,_r.keywords.block,_r.keywords.diagnostic],_o.assignment_operators=[_r.tokens.equal,_r.tokens.plus_equal,_r.tokens.minus_equal,_r.tokens.times_equal,_r.tokens.division_equal,_r.tokens.modulo_equal,_r.tokens.and_equal,_r.tokens.or_equal,_r.tokens.xor_equal,_r.tokens.shift_right_equal,_r.tokens.shift_left_equal],_o.increment_operators=[_r.tokens.plus_plus,_r.tokens.minus_minus];class yo{constructor(e,t,n,i,s){this.type=e,this.lexeme=t,this.line=n,this.start=i,this.end=s}toString(){return this.lexeme}isTemplateType(){return-1!=_o.template_types.indexOf(this.type)}isArrayType(){return this.type==_o.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class vo{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new yo(_o.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if("\n"==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if("/"==e){if("/"==this._peekAhead()){for(;"\n"!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if("*"==this._peekAhead()){this._advance();let t=1;for(;t>0;){if(this._isAtEnd())return!0;if(e=this._advance(),"\n"==e)this._line++;else if("*"==e){if("/"==this._peekAhead()&&(this._advance(),t--,0==t))return!0}else"/"==e&&"*"==this._peekAhead()&&(this._advance(),t++)}return!0}}const t=_o.simpleTokens[e];if(t)return this._addToken(t),!0;let n=_o.none;const i=this._isAlpha(e),s="_"===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(i){const t=_o.keywords[e];if(t)return this._addToken(t),!0}if(i||s)return this._addToken(_o.tokens.ident),!0;for(;;){let t=this._findType(e);const i=this._peekAhead();if("-"==e&&this._tokens.length>0){if("="==i)return this._current++,e+=i,this._addToken(_o.tokens.minus_equal),!0;if("-"==i)return this._current++,e+=i,this._addToken(_o.tokens.minus_minus),!0;const n=this._tokens.length-1;if((-1!=_o.literal_or_ident.indexOf(this._tokens[n].type)||this._tokens[n].type==_o.tokens.paren_right)&&">"!=i)return this._addToken(t),!0}if(">"==e&&(">"==i||"="==i)){let e=!1,n=this._tokens.length-1;for(let t=0;t<5&&n>=0&&-1===_o.assignment_operators.indexOf(this._tokens[n].type);++t,--n)if(this._tokens[n].type===_o.tokens.less_than){n>0&&this._tokens[n-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===_o.none){let i=e,s=0;const r=2;for(let e=0;e<r;++e)if(i+=this._peekAhead(e),t=this._findType(i),t!==_o.none){s=e;break}if(t===_o.none)return n!==_o.none&&(this._current--,this._addToken(n),!0);e=i,this._current+=s+1}if(n=t,this._isAtEnd())break;e+=this._advance()}return n!==_o.none&&(this._addToken(n),!0)}_findType(e){for(const t in _o.regexTokens){const n=_o.regexTokens[t];if(this._match(e,n.rule))return n}return _o.literalTokens[e]||_o.none}_match(e,t){const n=t.exec(e);return n&&0==n.index&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&"_"!==e&&"."!==e&&"("!==e&&")"!==e&&"["!==e&&"]"!==e&&"{"!==e&&"}"!==e&&","!==e&&";"!==e&&":"!==e&&"="!==e&&"!"!==e&&"<"!==e&&">"!==e&&"+"!==e&&"-"!==e&&"*"!==e&&"/"!==e&&"%"!==e&&"&"!==e&&"|"!==e&&"^"!==e&&"~"!==e&&"@"!==e&&"#"!==e&&"?"!==e&&"'"!==e&&"`"!==e&&'"'!==e&&"\\"!==e&&"\n"!==e&&"\r"!==e&&"\t"!==e&&"\0"!==e}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||"_"===e}_isWhitespace(e){return" "==e||"\t"==e||"\r"==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new yo(e,t,this._line,this._start,this._current))}}function bo(e){return Array.isArray(e)||(null==e?void 0:e.buffer)instanceof ArrayBuffer}const Eo=new Float32Array(1),xo=new Uint32Array(Eo.buffer),wo=new Uint32Array(Eo.buffer),To=new Int32Array(1),Ao=new Float32Array(To.buffer),So=new Uint32Array(To.buffer),Ro=new Uint32Array(1),Po=new Float32Array(Ro.buffer),Co=new Int32Array(Ro.buffer);function Io(e,t,n){if(t===n)return e;if("f32"===t){if("i32"===n||"x32"===n)return Eo[0]=e,xo[0];if("u32"===n)return Eo[0]=e,wo[0]}else if("i32"===t||"x32"===t){if("f32"===n)return To[0]=e,Ao[0];if("u32"===n)return To[0]=e,So[0]}else if("u32"===t){if("f32"===n)return Ro[0]=e,Po[0];if("i32"===n||"x32"===n)return Ro[0]=e,Co[0]}return e}class Lo{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class Mo{constructor(e,t){this.align=e,this.size=t}}class ko{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new js,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return"texture_storage_1d"==e.name||"texture_storage_2d"==e.name||"texture_storage_2d_array"==e.name||"texture_storage_3d"==e.name}updateAST(e){for(const t of e)t instanceof or&&this._functions.set(t.name,new Lo(t));for(const t of e)if(t instanceof Nr){const e=this.getTypeInfo(t,null);e instanceof Ms&&this.structs.push(e)}for(const t of e)if(t instanceof Cr)this.aliases.push(this._getAliasInfo(t));else if(t instanceof dr){const e=t,n=this._getAttributeNum(e.attributes,"id",0),i=null!=e.type?this.getTypeInfo(e.type,e.attributes):null;this.overrides.push(new zs(e.name,i,e.attributes,n))}else if(this._isUniformVar(t)){const e=t,n=this._getAttributeNum(e.attributes,"group",0),i=this._getAttributeNum(e.attributes,"binding",0),s=this.getTypeInfo(e.type,e.attributes),r=new Bs(e.name,s,n,i,e.attributes,Ns.Uniform,e.access);r.access||(r.access="read"),this.uniforms.push(r)}else if(this._isStorageVar(t)){const e=t,n=this._getAttributeNum(e.attributes,"group",0),i=this._getAttributeNum(e.attributes,"binding",0),s=this.getTypeInfo(e.type,e.attributes),r=this._isStorageTexture(s),o=new Bs(e.name,s,n,i,e.attributes,r?Ns.StorageTexture:Ns.Storage,e.access);o.access||(o.access="read"),this.storage.push(o)}else if(this._isTextureVar(t)){const e=t,n=this._getAttributeNum(e.attributes,"group",0),i=this._getAttributeNum(e.attributes,"binding",0),s=this.getTypeInfo(e.type,e.attributes),r=this._isStorageTexture(s),o=new Bs(e.name,s,n,i,e.attributes,r?Ns.StorageTexture:Ns.Texture,e.access);o.access||(o.access="read"),r?this.storage.push(o):this.textures.push(o)}else if(this._isSamplerVar(t)){const e=t,n=this._getAttributeNum(e.attributes,"group",0),i=this._getAttributeNum(e.attributes,"binding",0),s=this.getTypeInfo(e.type,e.attributes),r=new Bs(e.name,s,n,i,e.attributes,Ns.Sampler,e.access);this.samplers.push(r)}else if(t instanceof or){const e=this._getAttribute(t,"vertex"),n=this._getAttribute(t,"fragment"),i=this._getAttribute(t,"compute"),s=e||n||i,r=new Ws(t.name,null==s?void 0:s.name,t.attributes);r.attributes=t.attributes,r.startLine=t.startLine,r.endLine=t.endLine,this.functions.push(r),this._functions.get(t.name).info=r,s&&(this._functions.get(t.name).inUse=!0,r.inUse=!0,r.resources=this._findResources(t,!!s),r.inputs=this._getInputs(t.args),r.outputs=this._getOutputs(t.returnType),this.entry[s.name].push(r)),r.arguments=t.args.map((e=>new Vs(e.name,this.getTypeInfo(e.type,e.attributes),e.attributes))),r.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search((e=>{var n,i,s;if(e instanceof ro){if(e.value)if(bo(e.value))for(const r of e.value)for(const e of this.overrides)r===e.name&&(null===(n=t.info)||void 0===n||n.overrides.push(e));else for(const r of this.overrides)e.value===r.name&&(null===(i=t.info)||void 0===i||i.overrides.push(r))}else if(e instanceof jr)for(const r of this.overrides)e.name===r.name&&(null===(s=t.info)||void 0===s||s.overrides.push(r))}));for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var n;for(const i of e.calls){const e=null===(n=this._functions.get(i.name))||void 0===n?void 0:n.info;e&&t.add(e)}}findResource(e,t,n){if(n){for(const i of this.entry.compute)if(i.name===n)for(const n of i.resources)if(n.group==e&&n.binding==t)return n;for(const i of this.entry.vertex)if(i.name===n)for(const n of i.resources)if(n.group==e&&n.binding==t)return n;for(const i of this.entry.fragment)if(i.name===n)for(const n of i.resources)if(n.group==e&&n.binding==t)return n}for(const i of this.uniforms)if(i.group==e&&i.binding==t)return i;for(const i of this.storage)if(i.group==e&&i.binding==t)return i;for(const i of this.textures)if(i.group==e&&i.binding==t)return i;for(const i of this.samplers)if(i.group==e&&i.binding==t)return i;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const n=[],i=this,s=[];return e.search((r=>{if(r instanceof nr)s.push({});else if(r instanceof ir)s.pop();else if(r instanceof hr){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type),s.length>0&&(s[s.length-1][e.name]=e)}else if(r instanceof Vr){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type)}else if(r instanceof fr){const e=r;t&&null!==e.type&&this._markStructsFromAST(e.type),s.length>0&&(s[s.length-1][e.name]=e)}else if(r instanceof jr){const e=r;if(s.length>0&&s[s.length-1][e.name])return;const t=i._findResource(e.name);t&&n.push(t)}else if(r instanceof Wr){const s=r,o=i._functions.get(s.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),null===o.resources&&(o.resources=i._findResources(o.node,t)),n.push(...o.resources))}else if(r instanceof Er){const s=r,o=i._functions.get(s.name);o&&(t&&(o.inUse=!0),e.calls.add(o.node),null===o.resources&&(o.resources=i._findResources(o.node,t)),n.push(...o.resources))}})),[...new Map(n.map((e=>[e.name,e]))).values()]}getBindGroups(){const e=[];function t(t,n){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),n>=e[t].length&&(e[t].length=n+1)}for(const n of this.uniforms)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.storage)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.textures)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.samplers)t(n.group,n.binding),e[n.group][n.binding]=n;return e}_getOutputs(e,t=void 0){if(void 0===t&&(t=[]),e instanceof Nr)this._getStructOutputs(e,t);else{const n=this._getOutputInfo(e);null!==n&&t.push(n)}return t}_getStructOutputs(e,t){for(const n of e.members)if(n.type instanceof Nr)this._getStructOutputs(n.type,t);else{const e=this._getAttribute(n,"location")||this._getAttribute(n,"builtin");if(null!==e){const i=this.getTypeInfo(n.type,n.type.attributes),s=this._parseInt(e.value),r=new Gs(n.name,i,e.name,s);t.push(r)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){const n=this.getTypeInfo(e,e.attributes),i=this._parseInt(t.value);return new Gs("",n,t.name,i)}return null}_getInputs(e,t=void 0){void 0===t&&(t=[]);for(const n of e)if(n.type instanceof Nr)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(const n of e.members)if(n.type instanceof Nr)this._getStructInputs(n.type,t);else{const e=this._getInputInfo(n);null!==e&&t.push(e)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){const n=this._getAttribute(e,"interpolation"),i=this.getTypeInfo(e.type,e.attributes),s=this._parseInt(t.value),r=new Us(e.name,i,t.name,s);return null!==n&&(r.interpolation=this._parseString(n.value)),r}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new Ds(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Dr){const n=e,i=n.format?this.getTypeInfo(n.format,n.attributes):null,s=new ks(n.name,t);return s.format=i,s.count=n.count,this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof Nr){const n=e,i=new Ms(n.name,t);i.startLine=n.startLine,i.endLine=n.endLine;for(const e of n.members){const t=this.getTypeInfo(e.type,e.attributes);i.members.push(new Ls(e.name,t,e.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Ur){const n=e,i=n.format instanceof kr,s=n.format?i?this.getTypeInfo(n.format,null):new Is(n.format,null):null,r=new Os(n.name,s,t,n.access);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof Fr){const n=e,i=n.format?this.getTypeInfo(n.format,null):null,s=new Os(n.name,i,t,n.access);return this._types.set(e,s),this._updateTypeInfo(s),s}const n=new Is(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var t,n,i;const s=this._getTypeSize(e);if(e.size=null!==(t=null==s?void 0:s.size)&&void 0!==t?t:0,e instanceof ks&&e.format){const t=this._getTypeSize(e.format);e.stride=Math.max(null!==(n=null==t?void 0:t.size)&&void 0!==n?n:0,null!==(i=null==t?void 0:t.align)&&void 0!==i?i:0),this._updateTypeInfo(e.format)}e instanceof Ms&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let n=0,i=0,s=0,r=0;for(let o=0,a=e.members.length;o<a;++o){const a=e.members[o],l=this._getTypeSize(a);if(!l)continue;null!==(t=this._getAlias(a.type.name))&&void 0!==t||a.type;const c=l.align,u=l.size;n=this._roundUp(c,n+i),i=u,s=n,r=Math.max(r,c),a.offset=n,a.size=u,this._updateTypeInfo(a.type)}e.size=this._roundUp(r,s+i),e.align=r}_getTypeSize(e){var t,n;if(null==e)return null;const i=this._getAttributeNum(e.attributes,"size",0),s=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Ls&&(e=e.type),e instanceof Is){const t=this._getAlias(e.name);null!==t&&(e=t)}{const n=ko._typeInfo[e.name];if(void 0!==n){const r="f16"===(null===(t=e.format)||void 0===t?void 0:t.name)?2:1;return new Mo(Math.max(s,n.align/r),Math.max(i,n.size/r))}}{const t=ko._typeInfo[e.name.substring(0,e.name.length-1)];if(t){const n="h"===e.name[e.name.length-1]?2:1;return new Mo(Math.max(s,t.align/n),Math.max(i,t.size/n))}}if(e instanceof ks){let t=e,r=8,o=8;const a=this._getTypeSize(t.format);return null!==a&&(o=a.size,r=a.align),o=t.count*this._getAttributeNum(null!==(n=null==e?void 0:e.attributes)&&void 0!==n?n:null,"stride",this._roundUp(r,o)),i&&(o=i),new Mo(Math.max(s,r),Math.max(i,o))}if(e instanceof Ms){let t=0,n=0,r=0,o=0,a=0;for(const i of e.members){const e=this._getTypeSize(i.type);null!==e&&(t=Math.max(e.align,t),r=this._roundUp(e.align,r+o),o=e.size,a=r)}return n=this._roundUp(t,a+o),new Mo(Math.max(s,t),Math.max(i,n))}return null}_isUniformVar(e){return e instanceof hr&&"uniform"==e.storage}_isStorageVar(e){return e instanceof hr&&"storage"==e.storage}_isTextureVar(e){return e instanceof hr&&null!==e.type&&-1!=ko._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof hr&&null!==e.type&&-1!=ko._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){const n=e;if(!n||!n.attributes)return null;const i=n.attributes;for(let s of i)if(s.name==t)return s;return null}_getAttributeNum(e,t,n){if(null===e)return n;for(let i of e)if(i.name==t){let e=null!==i&&null!==i.value?i.value:n;return e instanceof Array&&(e=e[0]),"number"==typeof e?e:"string"==typeof e?parseInt(e):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}}ko._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},ko._textureTypes=_o.any_texture_type.map((e=>e.name)),ko._samplerTypes=_o.sampler_type.map((e=>e.name));class Oo{constructor(e,t,n){this.name=e,this.value=t,this.node=n}clone(){return new Oo(this.name,this.value,this.node)}}class No{constructor(e){this.name=e.name,this.node=e}clone(){return new No(this.node)}}class Fo{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?null!==(t=this.variables.get(e))&&void 0!==t?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?null!==(t=this.functions.get(e))&&void 0!==t?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new Oo(e,t,null!=n?n:null))}setVariable(e,t,n){const i=this.getVariable(e);null!==i?i.value=t:this.createVariable(e,t,n)}getVariableValue(e){var t;const n=this.getVariable(e);return null!==(t=null==n?void 0:n.value)&&void 0!==t?t:null}clone(){return new Fo(this)}}class Bo{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class Do{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const n=this.exec.evalExpression(e.args[0],t);let i=!0;if(n instanceof ho)return n.data.forEach((e=>{e||(i=!1)})),new co(i?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho){const e=n.data.some((e=>e));return new co(e?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof co))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.evalExpression(n,t);if(i instanceof po&&0===i.typeInfo.size){const e=i.typeInfo,t=i.buffer.byteLength/e.stride;return new co(t,this.getTypeInfo("u32"))}return new co(i.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.abs(e))),n.typeInfo);const i=n;return new co(Math.abs(i.value),i.typeInfo)}Acos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.acos(e))),n.typeInfo);const i=n;return new co(Math.acos(i.value),n.typeInfo)}Acosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.acosh(e))),n.typeInfo);const i=n;return new co(Math.acosh(i.value),n.typeInfo)}Asin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.asin(e))),n.typeInfo);const i=n;return new co(Math.asin(i.value),n.typeInfo)}Asinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.asinh(e))),n.typeInfo);const i=n;return new co(Math.asinh(i.value),n.typeInfo)}Atan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.atan(e))),n.typeInfo);const i=n;return new co(Math.atan(i.value),n.typeInfo)}Atanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.atanh(e))),n.typeInfo);const i=n;return new co(Math.atanh(i.value),n.typeInfo)}Atan2(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho)return new ho(n.data.map(((e,t)=>Math.atan2(e,i.data[t]))),n.typeInfo);const s=n,r=i;return new co(Math.atan2(s.value,r.value),n.typeInfo)}Ceil(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.ceil(e))),n.typeInfo);const i=n;return new co(Math.ceil(i.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(n instanceof ho&&i instanceof ho&&s instanceof ho)return new ho(n.data.map(((e,t)=>this._clamp(e,i.data[t],s.data[t]))),n.typeInfo);const r=n,o=i,a=s;return new co(this._clamp(r.value,o.value,a.value),n.typeInfo)}Cos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.cos(e))),n.typeInfo);const i=n;return new co(Math.cos(i.value),n.typeInfo)}Cosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.cosh(e))),n.typeInfo);const i=n;return new co(Math.cos(i.value),n.typeInfo)}CountLeadingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.clz32(e))),n.typeInfo);const i=n;return new co(Math.clz32(i.value),n.typeInfo)}_countOneBits(e){let t=0;for(;0!==e;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>this._countOneBits(e))),n.typeInfo);const i=n;return new co(this._countOneBits(i.value),n.typeInfo)}_countTrailingZeros(e){if(0===e)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>this._countTrailingZeros(e))),n.typeInfo);const i=n;return new co(this._countTrailingZeros(i.value),n.typeInfo)}Cross(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho){if(3!==n.data.length||3!==i.data.length)return null;const e=n.data,t=i.data;return new ho([e[1]*t[2]-t[1]*e[2],e[2]*t[0]-t[2]*e[0],e[0]*t[1]-t[0]*e[1]],n.typeInfo)}return null}Degrees(e,t){const n=this.exec.evalExpression(e.args[0],t),i=180/Math.PI;return n instanceof ho?new ho(n.data.map((e=>e*i)),n.typeInfo):new co(n.value*i,this.getTypeInfo("f32"))}Determinant(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof fo){const e=n.data,t=n.typeInfo.getTypeName(),i=t.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if("mat2x2"===t||"mat2x2f"===t||"mat2x2h"===t)return new co(e[0]*e[3]-e[1]*e[2],i);if("mat2x3"===t||"mat2x3f"===t||"mat2x3h"===t)return new co(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),i);if("mat2x4"===t||"mat2x4f"===t||"mat2x4h"===t);else if("mat3x2"===t||"mat3x2f"===t||"mat3x2h"===t);else if("mat3x3"===t||"mat3x3f"===t||"mat3x3h"===t)return new co(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),i)}return null}Distance(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho){let e=0;for(let t=0;t<n.data.length;++t)e+=(n.data[t]-i.data[t])*(n.data[t]-i.data[t]);return new co(Math.sqrt(e),this.getTypeInfo("f32"))}const s=n,r=i;return new co(Math.abs(s.value-r.value),n.typeInfo)}_dot(e,t){let n=0;for(let i=0;i<e.length;++i)n+=t[i]*e[i];return n}Dot(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);return n instanceof ho&&i instanceof ho?new co(this._dot(n.data,i.data),this.getTypeInfo("f32")):null}Dot4U8Packed(e,t){return null}Dot4I8Packed(e,t){return null}Exp(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.exp(e))),n.typeInfo);const i=n;return new co(Math.exp(i.value),n.typeInfo)}Exp2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.pow(2,e))),n.typeInfo);const i=n;return new co(Math.pow(2,i.value),n.typeInfo)}ExtractBits(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if("u32"!==i.typeInfo.name&&"x32"!==i.typeInfo.name)return null;if("u32"!==s.typeInfo.name&&"x32"!==s.typeInfo.name)return null;const r=i.value,o=s.value;if(n instanceof ho)return new ho(n.data.map((e=>e>>r&(1<<o)-1)),n.typeInfo);if("i32"!==n.typeInfo.name&&"x32"!==n.typeInfo.name)return null;const a=n.value;return new co(a>>r&(1<<o)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(n instanceof ho&&i instanceof ho&&s instanceof ho){const e=this._dot(i.data,s.data);return new ho(e<0?Array.from(n.data):n.data.map((e=>-e)),n.typeInfo)}return null}_firstLeadingBit(e){return 0===e?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>this._firstLeadingBit(e))),n.typeInfo);const i=n;return new co(this._firstLeadingBit(i.value),n.typeInfo)}_firstTrailingBit(e){return 0===e?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>this._firstTrailingBit(e))),n.typeInfo);const i=n;return new co(this._firstTrailingBit(i.value),n.typeInfo)}Floor(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.floor(e))),n.typeInfo);const i=n;return new co(Math.floor(i.value),n.typeInfo)}Fma(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(n instanceof ho&&i instanceof ho&&s instanceof ho)return n.data.length!==i.data.length||n.data.length!==s.data.length?null:new ho(n.data.map(((e,t)=>e*i.data[t]+s.data[t])),n.typeInfo);const r=n,o=i,a=s;return new co(r.value*o.value+a.value,r.typeInfo)}Fract(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>e-Math.floor(e))),n.typeInfo);const i=n;return new co(i.value-Math.floor(i.value),n.typeInfo)}Frexp(e,t){return null}InsertBits(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t),r=this.exec.evalExpression(e.args[3],t);if("u32"!==s.typeInfo.name&&"x32"!==s.typeInfo.name)return null;const o=s.value,a=(1<<r.value)-1<<o,l=~a;if(n instanceof ho&&i instanceof ho)return new ho(n.data.map(((e,t)=>e&l|i.data[t]<<o&a)),n.typeInfo);const c=n.value,u=i.value;return new co(c&l|u<<o&a,n.typeInfo)}InverseSqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>1/Math.sqrt(e))),n.typeInfo);const i=n;return new co(1/Math.sqrt(i.value),n.typeInfo)}Ldexp(e,t){return null}Length(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho){let e=0;return n.data.forEach((t=>{e+=t*t})),new co(Math.sqrt(e),this.getTypeInfo("f32"))}const i=n;return new co(Math.abs(i.value),n.typeInfo)}Log(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.log(e))),n.typeInfo);const i=n;return new co(Math.log(i.value),n.typeInfo)}Log2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.log2(e))),n.typeInfo);const i=n;return new co(Math.log2(i.value),n.typeInfo)}Max(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho)return new ho(n.data.map(((e,t)=>Math.max(e,i.data[t]))),n.typeInfo);const s=n,r=i;return new co(Math.max(s.value,r.value),n.typeInfo)}Min(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho)return new ho(n.data.map(((e,t)=>Math.min(e,i.data[t]))),n.typeInfo);const s=n,r=i;return new co(Math.min(s.value,r.value),n.typeInfo)}Mix(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(n instanceof ho&&i instanceof ho&&s instanceof ho)return new ho(n.data.map(((e,t)=>n.data[t]*(1-s.data[t])+i.data[t]*s.data[t])),n.typeInfo);const r=i,o=s;return new co(n.value*(1-o.value)+r.value*o.value,n.typeInfo)}Modf(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho)return new ho(n.data.map(((e,t)=>e%i.data[t])),n.typeInfo);const s=i;return new co(n.value%s.value,n.typeInfo)}Normalize(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho){const i=this.Length(e,t).value;return new ho(n.data.map((e=>e/i)),n.typeInfo)}return null}Pow(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho)return new ho(n.data.map(((e,t)=>Math.pow(e,i.data[t]))),n.typeInfo);const s=n,r=i;return new co(Math.pow(s.value,r.value),n.typeInfo)}QuantizeToF16(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof ho?new ho(n.data.map((e=>e)),n.typeInfo):new co(n.value,n.typeInfo)}Radians(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof ho?new ho(n.data.map((e=>e*Math.PI/180)),n.typeInfo):new co(n.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(n instanceof ho&&i instanceof ho){const e=this._dot(n.data,i.data);return new ho(n.data.map(((t,n)=>t-2*e*i.data[n])),n.typeInfo)}return null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(n instanceof ho&&i instanceof ho&&s instanceof co){const e=this._dot(i.data,n.data);return new ho(n.data.map(((t,n)=>{const r=1-s.value*s.value*(1-e*e);if(r<0)return 0;const o=Math.sqrt(r);return s.value*t-(s.value*e+o)*i.data[n]})),n.typeInfo)}return null}ReverseBits(e,t){return null}Round(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.round(e))),n.typeInfo);const i=n;return new co(Math.round(i.value),n.typeInfo)}Saturate(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.min(Math.max(e,0),1))),n.typeInfo);const i=n;return new co(Math.min(Math.max(i.value,0),1),n.typeInfo)}Sign(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.sign(e))),n.typeInfo);const i=n;return new co(Math.sign(i.value),n.typeInfo)}Sin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.sin(e))),n.typeInfo);const i=n;return new co(Math.sin(i.value),n.typeInfo)}Sinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.sinh(e))),n.typeInfo);const i=n;return new co(Math.sinh(i.value),n.typeInfo)}_smoothstep(e,t,n){const i=Math.min(Math.max((n-e)/(t-e),0),1);return i*i*(3-2*i)}SmoothStep(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t),s=this.exec.evalExpression(e.args[2],t);if(s instanceof ho&&n instanceof ho&&i instanceof ho)return new ho(s.data.map(((e,t)=>this._smoothstep(n.data[t],i.data[t],e))),s.typeInfo);const r=n,o=i,a=s;return new co(this._smoothstep(r.value,o.value,a.value),s.typeInfo)}Sqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.sqrt(e))),n.typeInfo);const i=n;return new co(Math.sqrt(i.value),n.typeInfo)}Step(e,t){const n=this.exec.evalExpression(e.args[0],t),i=this.exec.evalExpression(e.args[1],t);if(i instanceof ho&&n instanceof ho)return new ho(i.data.map(((e,t)=>e<n.data[t]?0:1)),i.typeInfo);const s=n;return new co(i.value<s.value?0:1,s.typeInfo)}Tan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.tan(e))),n.typeInfo);const i=n;return new co(Math.tan(i.value),n.typeInfo)}Tanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.tanh(e))),n.typeInfo);const i=n;return new co(Math.tanh(i.value),n.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return"mat2x2f"===t||"mat2x2h"===t?e:"mat2x3f"===t?this.getTypeInfo("mat3x2f"):"mat2x3h"===t?this.getTypeInfo("mat3x2h"):"mat2x4f"===t?this.getTypeInfo("mat4x2f"):"mat2x4h"===t?this.getTypeInfo("mat4x2h"):"mat3x2f"===t?this.getTypeInfo("mat2x3f"):"mat3x2h"===t?this.getTypeInfo("mat2x3h"):"mat3x3f"===t||"mat3x3h"===t?e:"mat3x4f"===t?this.getTypeInfo("mat4x3f"):"mat3x4h"===t?this.getTypeInfo("mat4x3h"):"mat4x2f"===t?this.getTypeInfo("mat2x4f"):"mat4x2h"===t?this.getTypeInfo("mat2x4h"):"mat4x3f"===t?this.getTypeInfo("mat3x4f"):"mat4x3h"===t?this.getTypeInfo("mat3x4h"):e}Transpose(e,t){const n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof fo))return null;const i=this._getTransposeType(n.typeInfo);if("mat2x2"===n.typeInfo.name||"mat2x2f"===n.typeInfo.name||"mat2x2h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[2],e[1],e[3]],i)}if("mat2x3"===n.typeInfo.name||"mat2x3f"===n.typeInfo.name||"mat2x3h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[3],e[6],e[1],e[4],e[7]],i)}if("mat2x4"===n.typeInfo.name||"mat2x4f"===n.typeInfo.name||"mat2x4h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13]],i)}if("mat3x2"===n.typeInfo.name||"mat3x2f"===n.typeInfo.name||"mat3x2h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[3],e[1],e[4],e[2],e[5]],i)}if("mat3x3"===n.typeInfo.name||"mat3x3f"===n.typeInfo.name||"mat3x3h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]],i)}if("mat3x4"===n.typeInfo.name||"mat3x4f"===n.typeInfo.name||"mat3x4h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14]],i)}if("mat4x2"===n.typeInfo.name||"mat4x2f"===n.typeInfo.name||"mat4x2h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[4],e[1],e[5],e[2],e[6]],i)}if("mat4x3"===n.typeInfo.name||"mat4x3f"===n.typeInfo.name||"mat4x3h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]],i)}if("mat4x4"===n.typeInfo.name||"mat4x4f"===n.typeInfo.name||"mat4x4h"===n.typeInfo.name){const e=n.data;return new fo([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]],i)}return null}Trunc(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof ho)return new ho(n.data.map((e=>Math.trunc(e))),n.typeInfo);const i=n;return new co(Math.trunc(i.value),n.typeInfo)}Dpdx(e,t){return null}DpdxCoarse(e,t){return null}DpdxFine(e,t){return null}Dpdy(e,t){return null}DpdyCoarse(e,t){return null}DpdyFine(e,t){return null}Fwidth(e,t){return null}FwidthCoarse(e,t){return null}FwidthFine(e,t){return null}TextureDimensions(e,t){const n=e.args[0],i=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(n instanceof jr){const e=n.name,s=t.getVariableValue(e);if(s instanceof go){if(i<0||i>=s.mipLevelCount)return null;const e=s.getMipLevelSize(i),t=s.dimension;return"1d"===t?new co(e[0],this.getTypeInfo("u32")):"3d"===t?new ho(e,this.getTypeInfo("vec3u")):"2d"===t?new ho(e.slice(0,2),this.getTypeInfo("vec2u")):null}return null}return null}TextureGather(e,t){return null}TextureGatherCompare(e,t){return null}TextureLoad(e,t){const n=e.args[0],i=this.exec.evalExpression(e.args[1],t),s=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(i instanceof ho)||2!==i.data.length)return null;if(n instanceof jr){const e=n.name,r=t.getVariableValue(e);if(r instanceof go){const e=Math.floor(i.data[0]),t=Math.floor(i.data[1]);if(e<0||e>=r.width||t<0||t>=r.height)return null;const n=r.getPixel(e,t,0,s);return null===n?null:new ho(n,this.getTypeInfo("vec4f"))}return null}return null}TextureNumLayers(e,t){const n=e.args[0];if(n instanceof jr){const e=n.name,i=t.getVariableValue(e);return i instanceof go?new co(i.depthOrArrayLayers,this.getTypeInfo("u32")):null}return null}TextureNumLevels(e,t){const n=e.args[0];if(n instanceof jr){const e=n.name,i=t.getVariableValue(e);return i instanceof go?new co(i.mipLevelCount,this.getTypeInfo("u32")):null}return null}TextureNumSamples(e,t){const n=e.args[0];if(n instanceof jr){const e=n.name,i=t.getVariableValue(e);return i instanceof go?new co(i.sampleCount,this.getTypeInfo("u32")):null}return null}TextureSample(e,t){return null}TextureSampleBias(e,t){return null}TextureSampleCompare(e,t){return null}TextureSampleCompareLevel(e,t){return null}TextureSampleGrad(e,t){return null}TextureSampleLevel(e,t){return null}TextureSampleBaseClampToEdge(e,t){return null}TextureStore(e,t){const n=e.args[0],i=this.exec.evalExpression(e.args[1],t),s=4===e.args.length?this.exec.evalExpression(e.args[2],t).value:0,r=4===e.args.length?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(4!==r.length)return null;if(!(i instanceof ho)||2!==i.data.length)return null;if(n instanceof jr){const e=n.name,o=t.getVariableValue(e);if(o instanceof go){const e=o.getMipLevelSize(0),t=Math.floor(i.data[0]),n=Math.floor(i.data[1]);return t<0||t>=e[0]||n<0||n>=e[1]||o.setPixel(t,n,0,s,Array.from(r)),null}return null}return null}AtomicLoad(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t);return t.getVariable(i).value.getSubData(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t);return a instanceof co&&o instanceof co&&(a.value=o.value),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value+=o.value),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicSub(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value-=o.value),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicMax(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value=Math.max(a.value,o.value)),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicMin(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value=Math.min(a.value,o.value)),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicAnd(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value=a.value&o.value),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicOr(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value=a.value|o.value),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicXor(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value=a.value^o.value),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicExchange(e,t){let n=e.args[0];n instanceof qr&&(n=n.right);const i=this.exec.getVariableName(n,t),s=t.getVariable(i);let r=e.args[1];const o=this.exec.evalExpression(r,t),a=s.value.getSubData(this.exec,n.postfix,t),l=new co(a.value,a.typeInfo);return a instanceof co&&o instanceof co&&(a.value=o.value),s.value instanceof po&&s.value.setDataValue(this.exec,a,n.postfix,t),l}AtomicCompareExchangeWeak(e,t){return null}Pack4x8snorm(e,t){return null}Pack4x8unorm(e,t){return null}Pack4xI8(e,t){return null}Pack4xU8(e,t){return null}Pack4x8Clamp(e,t){return null}Pack4xU8Clamp(e,t){return null}Pack2x16snorm(e,t){return null}Pack2x16unorm(e,t){return null}Pack2x16float(e,t){return null}Unpack4x8snorm(e,t){return null}Unpack4x8unorm(e,t){return null}Unpack4xI8(e,t){return null}Unpack4xU8(e,t){return null}Unpack2x16snorm(e,t){return null}Unpack2x16unorm(e,t){return null}Unpack2x16float(e,t){return null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return null}SubgroupExclusiveAdd(e,t){return null}SubgroupInclusiveAdd(e,t){return null}SubgroupAll(e,t){return null}SubgroupAnd(e,t){return null}SubgroupAny(e,t){return null}SubgroupBallot(e,t){return null}SubgroupBroadcast(e,t){return null}SubgroupBroadcastFirst(e,t){return null}SubgroupElect(e,t){return null}SubgroupMax(e,t){return null}SubgroupMin(e,t){return null}SubgroupMul(e,t){return null}SubgroupExclusiveMul(e,t){return null}SubgroupInclusiveMul(e,t){return null}SubgroupOr(e,t){return null}SubgroupShuffle(e,t){return null}SubgroupShuffleDown(e,t){return null}SubgroupShuffleUp(e,t){return null}SubgroupShuffleXor(e,t){return null}SubgroupXor(e,t){return null}QuadBroadcast(e,t){return null}QuadSwapDiagonal(e,t){return null}QuadSwapX(e,t){return null}QuadSwapY(e,t){return null}}const Uo={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},Go={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class zo extends Bo{constructor(e,t){var n;super(),this.ast=null!=e?e:[],this.reflection=new ko,this.reflection.updateAST(this.ast),this.context=null!==(n=null==t?void 0:t.clone())&&void 0!==n?n:new Fo,this.builtins=new Do(this),this.typeInfo={bool:this.getTypeInfo(kr.bool),i32:this.getTypeInfo(kr.i32),u32:this.getTypeInfo(kr.u32),f32:this.getTypeInfo(kr.f32),f16:this.getTypeInfo(kr.f16),vec2f:this.getTypeInfo(Fr.vec2f),vec2u:this.getTypeInfo(Fr.vec2u),vec2i:this.getTypeInfo(Fr.vec2i),vec2h:this.getTypeInfo(Fr.vec2h),vec3f:this.getTypeInfo(Fr.vec3f),vec3u:this.getTypeInfo(Fr.vec3u),vec3i:this.getTypeInfo(Fr.vec3i),vec3h:this.getTypeInfo(Fr.vec3h),vec4f:this.getTypeInfo(Fr.vec4f),vec4u:this.getTypeInfo(Fr.vec4u),vec4i:this.getTypeInfo(Fr.vec4i),vec4h:this.getTypeInfo(Fr.vec4h),mat2x2f:this.getTypeInfo(Fr.mat2x2f),mat2x3f:this.getTypeInfo(Fr.mat2x3f),mat2x4f:this.getTypeInfo(Fr.mat2x4f),mat3x2f:this.getTypeInfo(Fr.mat3x2f),mat3x3f:this.getTypeInfo(Fr.mat3x3f),mat3x4f:this.getTypeInfo(Fr.mat3x4f),mat4x2f:this.getTypeInfo(Fr.mat4x2f),mat4x3f:this.getTypeInfo(Fr.mat4x3f),mat4x4f:this.getTypeInfo(Fr.mat4x4f)}}getVariableValue(e){var t,n;const i=null!==(n=null===(t=this.context.getVariable(e))||void 0===t?void 0:t.value)&&void 0!==n?n:null;if(null===i)return null;if(i instanceof co)return i.value;if(i instanceof ho)return Array.from(i.data);if(i instanceof fo)return Array.from(i.data);if(i instanceof po&&i.typeInfo instanceof ks){if("u32"===i.typeInfo.format.name)return Array.from(new Uint32Array(i.buffer,i.offset,i.typeInfo.count));if("i32"===i.typeInfo.format.name)return Array.from(new Int32Array(i.buffer,i.offset,i.typeInfo.count));if("f32"===i.typeInfo.format.name)return Array.from(new Float32Array(i.buffer,i.offset,i.typeInfo.count))}return null}execute(e){(e=null!=e?e:{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,i){const s=this.context.clone();(i=null!=i?i:{}).constants&&this._setOverrides(i.constants,s),this._execStatements(this.ast,s);const r=s.getFunction(e);if(!r)return;if("number"==typeof t)t=[t,1,1];else{if(0===t.length)return;1===t.length?t=[t[0],1,1]:2===t.length?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const o=t[0],a=t[1],l=t[2],c=this.getTypeInfo("vec3u");s.setVariable("@num_workgroups",new ho(t,c));for(const u in n)for(const e in n[u]){const t=n[u][e];s.variables.forEach((n=>{var i;const s=n.node;if(null==s?void 0:s.attributes){let r=null,o=null;for(const e of s.attributes)"binding"===e.name?r=e.value:"group"===e.name&&(o=e.value);if(e==r&&u==o)if(void 0!==t.texture&&void 0!==t.descriptor){const e=new go(t.texture,this.getTypeInfo(s.type),t.descriptor,null!==(i=t.texture.view)&&void 0!==i?i:null);n.value=e}else void 0!==t.uniform?n.value=new po(t.uniform,this.getTypeInfo(s.type)):n.value=new po(t,this.getTypeInfo(s.type))}}))}for(let u=0;u<l;++u)for(let e=0;e<a;++e)for(let t=0;t<o;++t)s.setVariable("@workgroup_id",new ho([t,e,u],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(r,[t,e,u],s)}execStatement(e,t){if(e instanceof Ar)return this.evalExpression(e.value,t);if(e instanceof Lr){if(e.condition){const n=this.evalExpression(e.condition,t);if(!(n instanceof co))throw new Error("Invalid break-if condition");if(!n.value)return null}return zo._breakObj}if(e instanceof Mr)return zo._continueObj;if(e instanceof fr)this._let(e,t);else if(e instanceof hr)this._var(e,t);else if(e instanceof pr)this._const(e,t);else if(e instanceof or)this._function(e,t);else{if(e instanceof Tr)return this._if(e,t);if(e instanceof wr)return this._switch(e,t);if(e instanceof ur)return this._for(e,t);if(e instanceof lr)return this._while(e,t);if(e instanceof xr)return this._loop(e,t);if(e instanceof cr){const n=t.clone();return n.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,n)}if(e instanceof br)this._assign(e,t);else if(e instanceof vr)this._increment(e,t);else{if(e instanceof Nr)return null;if(e instanceof dr){const n=e.name;null===t.getVariable(n)&&t.setVariable(n,new co(0,this.getTypeInfo("u32")))}else if(e instanceof Er)this._call(e,t);else{if(e instanceof Pr)return null;if(e instanceof Cr)return null}}}return null}evalExpression(e,t){return e instanceof Zr?this._evalBinaryOp(e,t):e instanceof $r?this._evalLiteral(e,t):e instanceof jr?this._evalVariable(e,t):e instanceof Wr?this._evalCall(e,t):e instanceof Vr?this._evalCreate(e,t):e instanceof Hr?this._evalConst(e,t):e instanceof Xr?this._evalBitcast(e,t):e instanceof qr?this._evalUnaryOp(e,t):null}getTypeInfo(e){var t;if(e instanceof kr){const t=this.reflection.getTypeInfo(e);if(null!==t)return t}let n=null!==(t=this.typeInfo[e])&&void 0!==t?t:null;return null!==n||(n=this.reflection.getTypeInfoByName(e)),n}_setOverrides(e,t){for(const n in e){const i=e[n],s=this.reflection.getOverrideInfo(n);null!==s&&(null===s.type&&(s.type=this.getTypeInfo("u32")),"u32"===s.type.name||"i32"===s.type.name||"f32"===s.type.name||"f16"===s.type.name?t.setVariable(n,new co(i,s.type)):"bool"===s.type.name?t.setVariable(n,new co(i?1:0,s.type)):("vec2"===s.type.name||"vec3"===s.type.name||"vec4"===s.type.name||"vec2f"===s.type.name||"vec3f"===s.type.name||"vec4f"===s.type.name||"vec2i"===s.type.name||"vec3i"===s.type.name||"vec4i"===s.type.name||"vec2u"===s.type.name||"vec3u"===s.type.name||"vec4u"===s.type.name||"vec2h"===s.type.name||"vec3h"===s.type.name||"vec4h"===s.type.name)&&t.setVariable(n,new ho(i,s.type)))}}_dispatchWorkgroup(e,t,n){const i=[1,1,1];for(const c of e.node.attributes)if("workgroup_size"===c.name){if(c.value.length>0){const e=n.getVariableValue(c.value[0]);i[0]=e instanceof co?e.value:parseInt(c.value[0])}if(c.value.length>1){const e=n.getVariableValue(c.value[1]);i[1]=e instanceof co?e.value:parseInt(c.value[1])}if(c.value.length>2){const e=n.getVariableValue(c.value[2]);i[2]=e instanceof co?e.value:parseInt(c.value[2])}}const s=this.getTypeInfo("vec3u"),r=this.getTypeInfo("u32");n.setVariable("@workgroup_size",new ho(i,s));const o=i[0],a=i[1],l=i[2];for(let c=0,u=0;c<l;++c)for(let l=0;l<a;++l)for(let a=0;a<o;++a,++u){const o=[a,l,c],h=[a+t[0]*i[0],l+t[1]*i[1],c+t[2]*i[2]];n.setVariable("@local_invocation_id",new ho(o,s)),n.setVariable("@global_invocation_id",new ho(h,s)),n.setVariable("@local_invocation_index",new co(u,r)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(const n of e.node.args)for(const e of n.attributes)if("builtin"===e.name){const i=`@${e.value}`,s=t.getVariable(i);void 0!==s&&t.variables.set(n.name,s)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof qr;)e=e.right;return e instanceof jr?e.name:null}_execStatements(e,t){for(const n of e){if(n instanceof Array){const e=t.clone(),i=this._execStatements(n,e);if(i)return i;continue}const e=this.execStatement(n,t);if(e)return e}return null}_call(e,t){const n=t.clone();n.currentFunctionName=e.name;const i=t.getFunction(e.name);if(i){for(let t=0;t<i.node.args.length;++t){const s=i.node.args[t],r=this.evalExpression(e.args[t],n);n.setVariable(s.name,r,s)}this._execStatements(i.node.body,n)}else e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const n=this.getVariableName(e.variable,t),i=t.getVariable(n);i&&("++"===e.operator?i.value instanceof co&&i.value.value++:"--"===e.operator&&i.value instanceof co&&i.value.value--)}_getVariableData(e,t){if(e instanceof jr){const n=this.getVariableName(e,t),i=t.getVariable(n);return null===i?null:i.value.getSubData(this,e.postfix,t)}if(e instanceof qr){if("*"===e.operator){const n=this._getVariableData(e.right,t);return n instanceof lo?n.reference.getSubData(this,e.postfix,t):null}if("&"===e.operator){const n=this._getVariableData(e.right,t);return new lo(n)}}return null}_assign(e,t){let n=null,i="<var>",s=null;if(e.variable instanceof qr){const n=this._getVariableData(e.variable,t),i=this.evalExpression(e.value,t),s=e.operator;if("="===s){if(n instanceof co||n instanceof ho||n instanceof fo){if(i instanceof co||i instanceof ho||i instanceof fo&&n.data.length===i.data.length)return void n.data.set(i.data)}else if(n instanceof po&&i instanceof po&&n.buffer.byteLength-n.offset>=i.buffer.byteLength-i.offset)return void(n.buffer.byteLength%4==0?new Uint32Array(n.buffer,n.offset,n.typeInfo.size/4).set(new Uint32Array(i.buffer,i.offset,i.typeInfo.size/4)):new Uint8Array(n.buffer,n.offset,n.typeInfo.size).set(new Uint8Array(i.buffer,i.offset,i.typeInfo.size)));return null}if("+="===s)return(n instanceof co||n instanceof ho||n instanceof fo)&&(i instanceof co||i instanceof ho||i instanceof fo)?void n.data.set(i.data.map(((e,t)=>n.data[t]+e))):void 0;if("-="===s)return(n instanceof co||n instanceof ho||n instanceof fo)&&(i instanceof co||i instanceof ho||i instanceof fo)?void n.data.set(i.data.map(((e,t)=>n.data[t]-e))):void 0}if(e.variable instanceof qr){if("*"===e.variable.operator){i=this.getVariableName(e.variable.right,t);const s=t.getVariable(i);if(!(s&&s.value instanceof lo))return;n=s.value.reference;let r=e.variable.postfix;if(!r){let t=e.variable.right;for(;t instanceof qr;){if(t.postfix){r=t.postfix;break}t=t.right}}r&&(n=n.getSubData(this,r,t))}}else{s=e.variable.postfix,i=this.getVariableName(e.variable,t);const r=t.getVariable(i);if(null===r)return;n=r.value}if(n instanceof lo&&(n=n.reference),null===n)return;const r=this.evalExpression(e.value,t),o=e.operator;if("="===o)if(n instanceof po)n.setDataValue(this,r,s,t);else if(s){if(!(n instanceof ho||n instanceof fo))return;if(s instanceof Yr){const e=this.evalExpression(s.index,t).value;if(n instanceof ho){if(!(r instanceof co))return;n.data[e]=r.value}else{if(!(n instanceof fo))return;{const e=this.evalExpression(s.index,t).value;if(e<0)return;if(!(r instanceof ho))return;{const t=n.typeInfo.getTypeName();if("mat2x2"===t||"mat2x2f"===t||"mat2x2h"===t){if(!(e<2&&2===r.data.length))return;n.data[2*e]=r.data[0],n.data[2*e+1]=r.data[1]}else if("mat2x3"===t||"mat2x3f"===t||"mat2x3h"===t){if(!(e<2&&3===r.data.length))return;n.data[3*e]=r.data[0],n.data[3*e+1]=r.data[1],n.data[3*e+2]=r.data[2]}else if("mat2x4"===t||"mat2x4f"===t||"mat2x4h"===t){if(!(e<2&&4===r.data.length))return;n.data[4*e]=r.data[0],n.data[4*e+1]=r.data[1],n.data[4*e+2]=r.data[2],n.data[4*e+3]=r.data[3]}else if("mat3x2"===t||"mat3x2f"===t||"mat3x2h"===t){if(!(e<3&&2===r.data.length))return;n.data[2*e]=r.data[0],n.data[2*e+1]=r.data[1]}else if("mat3x3"===t||"mat3x3f"===t||"mat3x3h"===t){if(!(e<3&&3===r.data.length))return;n.data[3*e]=r.data[0],n.data[3*e+1]=r.data[1],n.data[3*e+2]=r.data[2]}else if("mat3x4"===t||"mat3x4f"===t||"mat3x4h"===t){if(!(e<3&&4===r.data.length))return;n.data[4*e]=r.data[0],n.data[4*e+1]=r.data[1],n.data[4*e+2]=r.data[2],n.data[4*e+3]=r.data[3]}else if("mat4x2"===t||"mat4x2f"===t||"mat4x2h"===t){if(!(e<4&&2===r.data.length))return;n.data[2*e]=r.data[0],n.data[2*e+1]=r.data[1]}else if("mat4x3"===t||"mat4x3f"===t||"mat4x3h"===t){if(!(e<4&&3===r.data.length))return;n.data[3*e]=r.data[0],n.data[3*e+1]=r.data[1],n.data[3*e+2]=r.data[2]}else{if("mat4x4"!==t&&"mat4x4f"!==t&&"mat4x4h"!==t)return;if(!(e<4&&4===r.data.length))return;n.data[4*e]=r.data[0],n.data[4*e+1]=r.data[1],n.data[4*e+2]=r.data[2],n.data[4*e+3]=r.data[3]}}}}}else if(s instanceof zr){const e=s.value;if(!(n instanceof ho))return;if(r instanceof co){if(e.length>1)return;if("x"===e)n.data[0]=r.value;else if("y"===e){if(n.data.length<2)return;n.data[1]=r.value}else if("z"===e){if(n.data.length<3)return;n.data[2]=r.value}else if("w"===e){if(n.data.length<4)return;n.data[3]=r.value}}else{if(!(r instanceof ho))return;if(e.length!==r.data.length)return;for(let t=0;t<e.length;++t){const i=e[t];if("x"===i||"r"===i)n.data[0]=r.data[t];else if("y"===i||"g"===i){if(r.data.length<2)return;n.data[1]=r.data[t]}else if("z"===i||"b"===i){if(r.data.length<3)return;n.data[2]=r.data[t]}else{if("w"!==i&&"a"!==i)return;if(r.data.length<4)return;n.data[3]=r.data[t]}}}}}else n instanceof co&&r instanceof co?n.value=r.value:(n instanceof ho&&r instanceof ho||n instanceof fo&&r instanceof fo)&&n.data.set(r.data);else{const e=n.getSubData(this,s,t);if(e instanceof ho&&r instanceof co){const t=e.data,n=r.value;if("+="===o)for(let e=0;e<t.length;++e)t[e]+=n;else if("-="===o)for(let e=0;e<t.length;++e)t[e]-=n;else if("*="===o)for(let e=0;e<t.length;++e)t[e]*=n;else if("/="===o)for(let e=0;e<t.length;++e)t[e]/=n;else if("%="===o)for(let e=0;e<t.length;++e)t[e]%=n;else if("&="===o)for(let e=0;e<t.length;++e)t[e]&=n;else if("|="===o)for(let e=0;e<t.length;++e)t[e]|=n;else if("^="===o)for(let e=0;e<t.length;++e)t[e]^=n;else if("<<="===o)for(let e=0;e<t.length;++e)t[e]<<=n;else if(">>="===o)for(let e=0;e<t.length;++e)t[e]>>=n}else if(e instanceof ho&&r instanceof ho){const t=e.data,n=r.data;if(t.length!==n.length)return;if("+="===o)for(let e=0;e<t.length;++e)t[e]+=n[e];else if("-="===o)for(let e=0;e<t.length;++e)t[e]-=n[e];else if("*="===o)for(let e=0;e<t.length;++e)t[e]*=n[e];else if("/="===o)for(let e=0;e<t.length;++e)t[e]/=n[e];else if("%="===o)for(let e=0;e<t.length;++e)t[e]%=n[e];else if("&="===o)for(let e=0;e<t.length;++e)t[e]&=n[e];else if("|="===o)for(let e=0;e<t.length;++e)t[e]|=n[e];else if("^="===o)for(let e=0;e<t.length;++e)t[e]^=n[e];else if("<<="===o)for(let e=0;e<t.length;++e)t[e]<<=n[e];else if(">>="===o)for(let e=0;e<t.length;++e)t[e]>>=n[e]}else{if(!(e instanceof co&&r instanceof co))return;"+="===o?e.value+=r.value:"-="===o?e.value-=r.value:"*="===o?e.value*=r.value:"/="===o?e.value/=r.value:"%="===o?e.value%=r.value:"&="===o?e.value&=r.value:"|="===o?e.value|=r.value:"^="===o?e.value^=r.value:"<<="===o?e.value<<=r.value:">>="===o&&(e.value>>=r.value)}n instanceof po&&n.setDataValue(this,e,s,t)}}_function(e,t){const n=new No(e);t.functions.set(e.name,n)}_const(e,t){let n=null;null!==e.value&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;if(null!==e.value){if(n=this.evalExpression(e.value,t),null===n)return;e.value instanceof qr||(n=n.clone())}else{const i=e.type.name;if("f32"===i||"i32"===i||"u32"===i||"bool"===i||"f16"===i||"vec2"===i||"vec3"===i||"vec4"===i||"vec2f"===i||"vec3f"===i||"vec4f"===i||"vec2i"===i||"vec3i"===i||"vec4i"===i||"vec2u"===i||"vec3u"===i||"vec4u"===i||"vec2h"===i||"vec3h"===i||"vec4h"===i||"vec2b"===i||"vec3b"===i||"vec4b"===i||"mat2x2"===i||"mat2x3"===i||"mat2x4"===i||"mat3x2"===i||"mat3x3"===i||"mat3x4"===i||"mat4x2"===i||"mat4x3"===i||"mat4x4"===i||"mat2x2f"===i||"mat2x3f"===i||"mat2x4f"===i||"mat3x2f"===i||"mat3x3f"===i||"mat3x4f"===i||"mat4x2f"===i||"mat4x3f"===i||"mat4x4f"===i||"mat2x2h"===i||"mat2x3h"===i||"mat2x4h"===i||"mat3x2h"===i||"mat3x3h"===i||"mat3x4h"===i||"mat4x2h"===i||"mat4x3h"===i||"mat4x4h"===i||"array"===i){const i=new Vr(e.type,[]);n=this._evalCreate(i,t)}}t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(null!==e.value){if(n=this.evalExpression(e.value,t),null===n)return;e.value instanceof qr||(n=n.clone())}else{if(null===e.type)return;const i=e.type.name;if("f32"===i||"i32"===i||"u32"===i||"bool"===i||"f16"===i||"vec2"===i||"vec3"===i||"vec4"===i||"vec2f"===i||"vec3f"===i||"vec4f"===i||"vec2i"===i||"vec3i"===i||"vec4i"===i||"vec2u"===i||"vec3u"===i||"vec4u"===i||"vec2h"===i||"vec3h"===i||"vec4h"===i||"vec2b"===i||"vec3b"===i||"vec4b"===i||"mat2x2"===i||"mat2x3"===i||"mat2x4"===i||"mat3x2"===i||"mat3x3"===i||"mat3x4"===i||"mat4x2"===i||"mat4x3"===i||"mat4x4"===i||"mat2x2f"===i||"mat2x3f"===i||"mat2x4f"===i||"mat3x2f"===i||"mat3x3f"===i||"mat3x4f"===i||"mat4x2f"===i||"mat4x3f"===i||"mat4x4f"===i||"mat2x2h"===i||"mat2x3h"===i||"mat2x4h"===i||"mat3x2h"===i||"mat3x3h"===i||"mat3x4h"===i||"mat4x2h"===i||"mat4x3h"===i||"mat4x4h"===i||e.type instanceof Dr||e.type instanceof Nr||e.type instanceof Fr){const i=new Vr(e.type,[]);n=this._evalCreate(i,t)}}t.createVariable(e.name,n,e)}_switch(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof co))return null;let i=null;for(const s of e.cases)if(s instanceof eo)for(const e of s.selectors){if(e instanceof Jr){i=s;continue}const r=this.evalExpression(e,t);if(!(r instanceof co))return null;if(r.value===n.value)return this._execStatements(s.body,t)}else s instanceof to&&(i=s);return i?this._execStatements(i.body,t):null}_if(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof co))return null;if(n.value)return this._execStatements(e.body,t);for(const i of e.elseif){const e=this.evalExpression(i.condition,t);if(!(e instanceof co))return null;if(e.value)return this._execStatements(i.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof co?e.value:0}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===zo._breakObj)break;if(null!==n&&n!==zo._continueObj)return n;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const n=this._execStatements(e.body,t);if(n===zo._breakObj)break;if(n===zo._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===zo._breakObj)break}else if(null!==n)return n}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===zo._breakObj)break;if(n!==zo._continueObj&&null!==n)return n}return null}_evalBitcast(e,t){const n=this.evalExpression(e.value,t),i=e.type;if(n instanceof co){const e=Io(n.value,n.typeInfo.name,i.name);return new co(e,this.getTypeInfo(i))}if(n instanceof ho){const e=n.typeInfo.getTypeName();let t="";if(e.endsWith("f"))t="f32";else if(e.endsWith("i"))t="i32";else if(e.endsWith("u"))t="u32";else if(e.endsWith("b"))t="bool";else{if(!e.endsWith("h"))return null;t="f16"}const s=i.getTypeName();let r="";if(s.endsWith("f"))r="f32";else if(s.endsWith("i"))r="i32";else if(s.endsWith("u"))r="u32";else if(s.endsWith("b"))r="bool";else{if(!s.endsWith("h"))return null;r="f16"}const o=function(e,t,n){if(t===n)return e;const i=new Array(e.length);for(let s=0;s<e.length;s++)i[s]=Io(e[s],t,n);return i}(Array.from(n.data),t,r);return new ho(o,this.getTypeInfo(i))}return null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var n;if(e instanceof Vr){if(null===e.type)return ao.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}e instanceof Vr?e.type.name:e.name;const i=e instanceof Vr?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(null===i)return null;if(0===i.size)return null;const s=new po(new ArrayBuffer(i.size),i,0);if(i instanceof Ms){if(e.args)for(let r=0;r<e.args.length;++r){const n=i.members[r],o=e.args[r],a=this.evalExpression(o,t);s.setData(this,a,n.type,n.offset,t)}}else if(i instanceof ks){let r=0;if(e.args)for(let o=0;o<e.args.length;++o){const a=e.args[o],l=this.evalExpression(a,t);null===i.format&&("x32"===(null===(n=l.typeInfo)||void 0===n?void 0:n.name)?i.format=this.getTypeInfo("i32"):i.format=l.typeInfo),s.setData(this,l,i.format,r,t),r+=i.stride}}return e instanceof Vr?s.getSubData(this,e.postfix,t):s}_evalLiteral(e,t){const n=this.getTypeInfo(e.type),i=n.name;return"x32"===i||"u32"===i||"f32"===i||"f16"===i||"i32"===i||"bool"===i?new co(e.scalarValue,n):"vec2"===i||"vec3"===i||"vec4"===i||"vec2f"===i||"vec3f"===i||"vec4f"===i||"vec2h"===i||"vec3h"===i||"vec4h"===i||"vec2i"===i||"vec3i"===i||"vec4i"===i||"vec2u"===i||"vec3u"===i||"vec4u"===i?this._callConstructorVec(e,t):"mat2x2"===i||"mat2x3"===i||"mat2x4"===i||"mat3x2"===i||"mat3x3"===i||"mat3x4"===i||"mat4x2"===i||"mat4x3"===i||"mat4x4"===i||"mat2x2f"===i||"mat2x3f"===i||"mat2x4f"===i||"mat3x2f"===i||"mat3x3f"===i||"mat3x4f"===i||"mat4x2f"===i||"mat4x3f"===i||"mat4x4f"===i||"mat2x2h"===i||"mat2x3h"===i||"mat2x4h"===i||"mat3x2h"===i||"mat3x3h"===i||"mat3x4h"===i||"mat4x2h"===i||"mat4x3h"===i||"mat4x4h"===i?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const n=t.getVariableValue(e.name);return null===n?n:n.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if("f32"===t.name)return t;for(let n=1;n<e.length;++n){const i=zo._priority.get(t.name);zo._priority.get(e[n].name)<i&&(t=e[n])}return"x32"===t.name?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const n=this.evalExpression(e.right,t);if("&"===e.operator)return new lo(n);if("*"===e.operator)return n instanceof lo?n.reference.getSubData(this,e.postfix,t):null;const i=n instanceof co?n.value:n instanceof ho?Array.from(n.data):null;switch(e.operator){case"+":{if(bo(i)){const e=i.map(((e,t)=>+e));return new ho(e,n.typeInfo)}const e=i,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new co(+e,t)}case"-":{if(bo(i)){const e=i.map(((e,t)=>-e));return new ho(e,n.typeInfo)}const e=i,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new co(-e,t)}case"!":{if(bo(i)){const e=i.map(((e,t)=>e?0:1));return new ho(e,n.typeInfo)}const e=i,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new co(e?0:1,t)}case"~":{if(bo(i)){const e=i.map(((e,t)=>~e));return new ho(e,n.typeInfo)}const e=i,t=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new co(~e,t)}}return null}_evalBinaryOp(e,t){const n=this.evalExpression(e.left,t),i=this.evalExpression(e.right,t),s=n instanceof co?n.value:n instanceof ho||n instanceof fo?Array.from(n.data):null,r=i instanceof co?i.value:i instanceof ho||i instanceof fo?Array.from(i.data):null;switch(e.operator){case"+":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e+t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t+e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e+t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e+t,o)}case"-":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e-t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t-e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e-t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e-t,o)}case"*":{if(bo(s)&&bo(r)){const e=s,t=r;if(n instanceof fo&&i instanceof fo){const s=function(e,t,n,i){if(void 0===Go[t.name]||void 0===Go[i.name])return null;const s=Go[t.name][0],r=Go[t.name][1],o=Go[i.name][0];if(s!==Go[i.name][1])return null;const a=new Array(o*r);for(let l=0;l<r;l++)for(let t=0;t<o;t++){let i=0;for(let o=0;o<s;o++)i+=e[o*r+l]*n[t*s+o];a[l*o+t]=i}return a}(e,n.typeInfo,t,i.typeInfo);if(null===s)return null;const r=Go[i.typeInfo.name][0],o=Go[n.typeInfo.name][1],a=this.getTypeInfo(`mat${r}x${o}f`);return new fo(s,a)}if(n instanceof fo&&i instanceof ho){const s=function(e,t,n,i){if(void 0===Go[t.name]||void 0===Uo[i.name])return null;const s=Go[t.name][0],r=Go[t.name][1];if(s!==n.length)return null;const o=new Array(r);for(let a=0;a<r;a++){let t=0;for(let i=0;i<s;i++)t+=e[i*r+a]*n[i];o[a]=t}return o}(e,n.typeInfo,t,i.typeInfo);return null===s?null:new ho(s,i.typeInfo)}if(n instanceof ho&&i instanceof fo){const s=function(e,t,n,i){if(void 0===Uo[t.name]||void 0===Go[i.name])return null;const s=Go[i.name][0],r=Go[i.name][1];if(r!==e.length)return null;const o=[];for(let a=0;a<s;a++){let t=0;for(let i=0;i<r;i++)t+=e[i]*n[i*s+a];o[a]=t}return o}(e,n.typeInfo,t,i.typeInfo);return null===s?null:new ho(s,n.typeInfo)}{if(e.length!==t.length)return null;const i=e.map(((e,n)=>e*t[n]));return new ho(i,n.typeInfo)}}if(bo(s)){const e=r,t=s.map(((t,n)=>t*e));return n instanceof fo?new fo(t,n.typeInfo):new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e*t));return i instanceof fo?new fo(t,i.typeInfo):new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e*t,o)}case"%":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e%t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t%e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e%t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e%t,o)}case"/":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e/t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t/e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e/t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e/t,o)}case"&":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e&t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t&e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e&t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e&t,o)}case"|":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e|t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t|e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e|t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e|t,o)}case"^":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e^t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t^e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e^t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e^t,o)}case"<<":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e<<t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t<<e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e<<t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e<<t,o)}case">>":{if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e>>t[n]));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t>>e));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e>>t));return new ho(t,i.typeInfo)}const e=s,t=r,o=this._maxFormatTypeInfo([n.typeInfo,i.typeInfo]);return new co(e>>t,o)}case">":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e>t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t>e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e>t?1:0));return new ho(t,i.typeInfo)}return new co(s>r?1:0,this.getTypeInfo("bool"));case"<":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e<t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t<e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e<t?1:0));return new ho(t,i.typeInfo)}return new co(s<r?1:0,this.getTypeInfo("bool"));case"==":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e===t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t==e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e==t?1:0));return new ho(t,i.typeInfo)}return new co(s===r?1:0,this.getTypeInfo("bool"));case"!=":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e!==t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t!==e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e!==t?1:0));return new ho(t,i.typeInfo)}return new co(s!==r?1:0,this.getTypeInfo("bool"));case">=":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e>=t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t>=e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e>=t?1:0));return new ho(t,i.typeInfo)}return new co(s>=r?1:0,this.getTypeInfo("bool"));case"<=":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e<=t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t<=e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e<=t?1:0));return new ho(t,i.typeInfo)}return new co(s<=r?1:0,this.getTypeInfo("bool"));case"&&":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e&&t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t&&e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e&&t?1:0));return new ho(t,i.typeInfo)}return new co(s&&r?1:0,this.getTypeInfo("bool"));case"||":if(bo(s)&&bo(r)){const e=s,t=r;if(e.length!==t.length)return null;const i=e.map(((e,n)=>e||t[n]?1:0));return new ho(i,n.typeInfo)}if(bo(s)){const e=r,t=s.map(((t,n)=>t||e?1:0));return new ho(t,n.typeInfo)}if(bo(r)){const e=s,t=r.map(((t,n)=>e||t?1:0));return new ho(t,i.typeInfo)}return new co(s||r?1:0,this.getTypeInfo("bool"))}return null}_evalCall(e,t){if(null!==e.cachedReturnValue)return e.cachedReturnValue;const n=t.clone();n.currentFunctionName=e.name;const i=t.getFunction(e.name);if(!i)return e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)?this._evalCreate(e,t):null;for(let s=0;s<i.node.args.length;++s){const t=i.node.args[s],r=this.evalExpression(e.args[s],n);n.createVariable(t.name,r,t)}return this._execStatements(i.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothStep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const n=t.getFunction(e.name);if(n){const i=t.clone();for(let t=0;t<n.node.args.length;++t){const s=n.node.args[t],r=this.evalExpression(e.args[t],i);i.setVariable(s.name,r,s)}return this._execStatements(n.node.body,i)}return null}_callConstructorValue(e,t){if(!e.args||0===e.args.length)return new co(0,this.getTypeInfo(e.type));const n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const n=this.getTypeInfo(e.type),i=e.type.getTypeName(),s=Uo[i];if(void 0===s)return null;const r=[];if(e instanceof $r)if(e.isVector){const t=e.vectorValue;for(const e of t)r.push(e)}else r.push(e.scalarValue);else if(e.args)for(const o of e.args){const e=this.evalExpression(o,t);if(e instanceof ho){const t=e.data;for(let e=0;e<t.length;++e){let n=t[e];r.push(n)}}else if(e instanceof co){let t=e.value;r.push(t)}}if(e.type instanceof Fr&&null===e.type.format&&(e.type.format=Fr.f32),0===r.length){const i=new Array(s).fill(0);return new ho(i,n).getSubData(this,e.postfix,t)}if(1===r.length)for(;r.length<s;)r.push(r[0]);return r.length<s?null:new ho(r.length>s?r.slice(0,s):r,n).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const n=this.getTypeInfo(e.type),i=e.type.getTypeName(),s=Go[i];if(void 0===s)return null;const r=[];if(e instanceof $r)if(e.isVector){const t=e.vectorValue;for(const e of t)r.push(e)}else r.push(e.scalarValue);else if(e.args)for(const o of e.args){const e=this.evalExpression(o,t);e instanceof ho?r.push(...e.data):e instanceof co?r.push(e.value):e instanceof fo&&r.push(...e.data)}if(n instanceof Os&&null===n.format&&(n.format=this.getTypeInfo("f32")),0===r.length){const i=new Array(s[2]).fill(0);return new fo(i,n).getSubData(this,e.postfix,t)}return r.length!==s[2]?null:new fo(r,n).getSubData(this,e.postfix,t)}}zo._breakObj=new oo(new Is("BREAK",null),null),zo._continueObj=new oo(new Is("CONTINUE",null),null),zo._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class Vo{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class Wo{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new Vo,this._exec=new zo,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(const e of this._deferArrayCountEval){const t=e.arrayType,i=e.countNode;if(i instanceof jr){const e=i.name,s=this._context.constants.get(e);if(s)try{const e=s.constEvaluate(this._exec);t.count=e}catch(n){}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const i of t)i.search((e=>{e instanceof so||e instanceof Br?e.type=this._forwardType(e.type):e instanceof Dr?e.format=this._forwardType(e.format):e instanceof hr||e instanceof fr||e instanceof pr?e.type=this._forwardType(e.type):e instanceof or?e.returnType=this._forwardType(e.returnType):e instanceof no&&(e.type=this._forwardType(e.type))}));return t}_forwardType(e){if(e instanceof Or){const t=this._getType(e.name);if(t)return t}else e instanceof Br?e.type=this._forwardType(e.type):e instanceof Dr&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if("string"==typeof e){const t=new vo(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=null!=t?t:this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==_o.eof}_match(e){if(e instanceof mo)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){const n=e[t];if(this._check(n))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const n=t.type;let i=!1;for(const t of e){if(n===t)return!0;t===_o.tokens.name&&(i=!0)}if(i){const e=_o.tokens.name.rule.exec(t.lexeme);if(e&&0==e.index&&e[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===_o.tokens.name){const e=_o.tokens.name.rule.exec(t.lexeme);return e&&0==e.index&&e[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=null!==(t=null===(e=this._peek())||void 0===e?void 0:e.line)&&void 0!==t?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(_o.tokens.semicolon)&&!this._isAtEnd(););if(this._match(_o.keywords.alias)){const e=this._type_alias();return this._consume(_o.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(_o.keywords.diagnostic)){const e=this._diagnostic();return this._consume(_o.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(_o.keywords.requires)){const e=this._requires_directive();return this._consume(_o.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(_o.keywords.enable)){const e=this._enable_directive();return this._consume(_o.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}const e=this._attribute();if(this._check(_o.keywords.var)){const t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(_o.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(_o.keywords.override)){const t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(_o.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(_o.keywords.let)){const t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(_o.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(_o.keywords.const)){const t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(_o.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(_o.keywords.struct)){const t=this._struct_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(_o.keywords.fn)){const t=this._function_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(_o.keywords.fn))return null;const e=this._currentLine,t=this._consume(_o.tokens.ident,"Expected function name.").toString();this._consume(_o.tokens.paren_left,"Expected '(' for function arguments.");const n=[];if(!this._check(_o.tokens.paren_right))do{if(this._check(_o.tokens.paren_right))break;const e=this._attribute(),t=this._consume(_o.tokens.name,"Expected argument name.").toString();this._consume(_o.tokens.colon,"Expected ':' for argument type.");const i=this._attribute(),s=this._type_decl();null!=s&&(s.attributes=i,n.push(this._updateNode(new no(t,s,e))))}while(this._match(_o.tokens.comma));this._consume(_o.tokens.paren_right,"Expected ')' after function arguments.");let i=null;if(this._match(_o.tokens.arrow)){const e=this._attribute();i=this._type_decl(),null!=i&&(i.attributes=e)}const s=this._compound_statement(),r=this._currentLine;return this._updateNode(new or(t,n,i,s,e,r),e)}_compound_statement(){const e=[];for(this._consume(_o.tokens.brace_left,"Expected '{' for block.");!this._check(_o.tokens.brace_right);){const t=this._statement();null!==t&&e.push(t)}return this._consume(_o.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(_o.tokens.semicolon)&&!this._isAtEnd(););if(this._check(_o.tokens.attr)&&this._attribute(),this._check(_o.keywords.if))return this._if_statement();if(this._check(_o.keywords.switch))return this._switch_statement();if(this._check(_o.keywords.loop))return this._loop_statement();if(this._check(_o.keywords.for))return this._for_statement();if(this._check(_o.keywords.while))return this._while_statement();if(this._check(_o.keywords.continuing))return this._continuing_statement();if(this._check(_o.keywords.static_assert))return this._static_assert_statement();if(this._check(_o.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(_o.keywords.return))e=this._return_statement();else if(this._check([_o.keywords.var,_o.keywords.let,_o.keywords.const]))e=this._variable_statement();else if(this._match(_o.keywords.discard))e=this._updateNode(new Ir);else if(this._match(_o.keywords.break)){const t=this._updateNode(new Lr);if(this._currentLoop.length>0){const e=this._currentLoop[this._currentLoop.length-1];t.loopId=e.id}e=t,this._check(_o.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(_o.keywords.continue)){const t=this._updateNode(new Mr);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const e=this._currentLoop[this._currentLoop.length-1];t.loopId=e.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return null!=e&&this._consume(_o.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(_o.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new ar(t),e)}_while_statement(){if(!this._match(_o.keywords.while))return null;const e=this._updateNode(new lr(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(_o.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(_o.keywords.continuing))return null;const t=this._currentLine,n=this._compound_statement();return this._updateNode(new cr(n,e),t)}_for_statement(){if(!this._match(_o.keywords.for))return null;this._consume(_o.tokens.paren_left,"Expected '('.");const e=this._updateNode(new ur(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(_o.tokens.semicolon)?null:this._for_init(),this._consume(_o.tokens.semicolon,"Expected ';'."),e.condition=this._check(_o.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(_o.tokens.semicolon,"Expected ';'."),e.increment=this._check(_o.tokens.paren_right)?null:this._for_increment(),this._consume(_o.tokens.paren_right,"Expected ')'."),this._check(_o.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(_o.keywords.var)){const e=this._variable_decl();if(null===e)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(_o.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new hr(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(_o.keywords.let)){const e=this._currentLine,t=this._consume(_o.tokens.name,"Expected name for let.").toString();let n=null;if(this._match(_o.tokens.colon)){const e=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=e)}this._consume(_o.tokens.equal,"Expected '=' for let.");const i=this._short_circuit_or_expression();return this._updateNode(new fr(t,n,null,null,i),e)}if(this._match(_o.keywords.const)){const e=this._currentLine,t=this._consume(_o.tokens.name,"Expected name for const.").toString();let n=null;if(this._match(_o.tokens.colon)){const e=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=e)}this._consume(_o.tokens.equal,"Expected '=' for const.");const i=this._short_circuit_or_expression();return null===n&&i instanceof $r&&(n=i.type),this._updateNode(new pr(t,n,null,null,i),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(null==t)return null;if(!this._check(_o.increment_operators))return this._current=e,null;const n=this._consume(_o.increment_operators,"Expected increment operator");return this._updateNode(new vr(n.type===_o.tokens.plus_plus?gr.increment:gr.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(_o.tokens.brace_right))return null;let n=this._match(_o.tokens.underscore);if(n||(e=this._unary_expression()),!n&&null==e)return null;const i=this._consume(_o.assignment_operators,"Expected assignment operator."),s=this._short_circuit_or_expression();return this._updateNode(new br(mr.parse(i.lexeme),e,s),t)}_func_call_statement(){if(!this._check(_o.tokens.ident))return null;const e=this._currentLine,t=this._current,n=this._consume(_o.tokens.ident,"Expected function name."),i=this._argument_expression_list();return null===i?(this._current=t,null):this._updateNode(new Er(n.lexeme,i),e)}_loop_statement(){if(!this._match(_o.keywords.loop))return null;this._check(_o.tokens.attr)&&this._attribute(),this._consume(_o.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new xr([],null));this._currentLoop.push(e);let t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof cr){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(_o.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(_o.keywords.switch))return null;const e=this._updateNode(new wr(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(_o.tokens.attr)&&this._attribute(),this._consume(_o.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),null==e.cases||0==e.cases.length)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(_o.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([_o.keywords.default,_o.keywords.case]);){if(this._match(_o.keywords.case)){const n=this._case_selectors();for(const e of n)if(e instanceof Jr){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(_o.tokens.colon),this._check(_o.tokens.attr)&&this._attribute(),this._consume(_o.tokens.brace_left,"Exected '{' for switch case.");const i=this._case_body();this._consume(_o.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new eo(n,i)))}if(this._match(_o.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(_o.tokens.colon),this._check(_o.tokens.attr)&&this._attribute(),this._consume(_o.tokens.brace_left,"Exected '{' for switch default.");const n=this._case_body();this._consume(_o.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new to(n)))}}return e}_case_selectors(){const e=[];for(this._match(_o.keywords.default)?e.push(this._updateNode(new Jr)):e.push(this._shift_expression());this._match(_o.tokens.comma);)this._match(_o.keywords.default)?e.push(this._updateNode(new Jr)):e.push(this._shift_expression());return e}_case_body(){if(this._match(_o.keywords.fallthrough))return this._consume(_o.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);const t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(_o.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(_o.tokens.attr)&&this._attribute();const n=this._compound_statement();let i=[];this._match_elseif()&&(this._check(_o.tokens.attr)&&this._attribute(),i=this._elseif_statement(i));let s=null;return this._match(_o.keywords.else)&&(this._check(_o.tokens.attr)&&this._attribute(),s=this._compound_statement()),this._updateNode(new Tr(t,n,i,s),e)}_match_elseif(){return this._tokens[this._current].type===_o.keywords.else&&this._tokens[this._current+1].type===_o.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new io(t,n))),this._match_elseif()&&(this._check(_o.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(_o.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new Ar(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(_o.tokens.or_or);)e=this._updateNode(new Zr(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(_o.tokens.and_and);)e=this._updateNode(new Zr(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(_o.tokens.or);)e=this._updateNode(new Zr(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(_o.tokens.xor);)e=this._updateNode(new Zr(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(_o.tokens.and);)e=this._updateNode(new Zr(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([_o.tokens.equal_equal,_o.tokens.not_equal])?this._updateNode(new Zr(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([_o.tokens.less_than,_o.tokens.greater_than,_o.tokens.less_than_equal,_o.tokens.greater_than_equal]);)e=this._updateNode(new Zr(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([_o.tokens.shift_left,_o.tokens.shift_right]);)e=this._updateNode(new Zr(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([_o.tokens.plus,_o.tokens.minus]);)e=this._updateNode(new Zr(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([_o.tokens.star,_o.tokens.forward_slash,_o.tokens.modulo]);)e=this._updateNode(new Zr(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([_o.tokens.minus,_o.tokens.bang,_o.tokens.tilde,_o.tokens.star,_o.tokens.and])?this._updateNode(new qr(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(_o.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(_o.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new Yr(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(_o.tokens.period)){const e=this._consume(_o.tokens.name,"Expected member name."),t=this._postfix_expression(),n=this._updateNode(new zr(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(null!==t)return t;switch(e){case"void":return kr.void;case"bool":return kr.bool;case"i32":return kr.i32;case"u32":return kr.u32;case"f32":return kr.f32;case"f16":return kr.f16;case"vec2f":return Fr.vec2f;case"vec3f":return Fr.vec3f;case"vec4f":return Fr.vec4f;case"vec2i":return Fr.vec2i;case"vec3i":return Fr.vec3i;case"vec4i":return Fr.vec4i;case"vec2u":return Fr.vec2u;case"vec3u":return Fr.vec3u;case"vec4u":return Fr.vec4u;case"vec2h":return Fr.vec2h;case"vec3h":return Fr.vec3h;case"vec4h":return Fr.vec4h;case"mat2x2f":return Fr.mat2x2f;case"mat2x3f":return Fr.mat2x3f;case"mat2x4f":return Fr.mat2x4f;case"mat3x2f":return Fr.mat3x2f;case"mat3x3f":return Fr.mat3x3f;case"mat3x4f":return Fr.mat3x4f;case"mat4x2f":return Fr.mat4x2f;case"mat4x3f":return Fr.mat4x3f;case"mat4x4f":return Fr.mat4x4f;case"mat2x2h":return Fr.mat2x2h;case"mat2x3h":return Fr.mat2x3h;case"mat2x4h":return Fr.mat2x4h;case"mat3x2h":return Fr.mat3x2h;case"mat3x3h":return Fr.mat3x3h;case"mat3x4h":return Fr.mat3x4h;case"mat4x2h":return Fr.mat4x2h;case"mat4x3h":return Fr.mat4x3h;case"mat4x4h":return Fr.mat4x4h;case"mat2x2i":return Fr.mat2x2i;case"mat2x3i":return Fr.mat2x3i;case"mat2x4i":return Fr.mat2x4i;case"mat3x2i":return Fr.mat3x2i;case"mat3x3i":return Fr.mat3x3i;case"mat3x4i":return Fr.mat3x4i;case"mat4x2i":return Fr.mat4x2i;case"mat4x3i":return Fr.mat4x3i;case"mat4x4i":return Fr.mat4x4i;case"mat2x2u":return Fr.mat2x2u;case"mat2x3u":return Fr.mat2x3u;case"mat2x4u":return Fr.mat2x4u;case"mat3x2u":return Fr.mat3x2u;case"mat3x3u":return Fr.mat3x3u;case"mat3x4u":return Fr.mat3x4u;case"mat4x2u":return Fr.mat4x2u;case"mat4x3u":return Fr.mat4x3u;case"mat4x4u":return Fr.mat4x4u}return null}_validateTypeRange(e,t){if("i32"===t.name){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if("u32"===t.name&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(_o.tokens.ident)){const e=this._previous().toString();if(this._check(_o.tokens.paren_left)){const t=this._argument_expression_list(),n=this._getType(e);return null!==n?this._updateNode(new Vr(n,t)):this._updateNode(new Wr(e,t))}if(this._context.constants.has(e)){const t=this._context.constants.get(e);return this._updateNode(new Hr(e,t.value))}return this._updateNode(new jr(e))}if(this._match(_o.tokens.int_literal)){const e=this._previous().toString();let t=e.endsWith("i")||e.endsWith("i")?kr.i32:e.endsWith("u")||e.endsWith("U")?kr.u32:kr.x32;const n=parseInt(e);return this._validateTypeRange(n,t),this._updateNode(new $r(new co(n,this._exec.getTypeInfo(t)),t))}if(this._match(_o.tokens.uint_literal)){const e=parseInt(this._previous().toString());return this._validateTypeRange(e,kr.u32),this._updateNode(new $r(new co(e,this._exec.getTypeInfo(kr.u32)),kr.u32))}if(this._match([_o.tokens.decimal_float_literal,_o.tokens.hex_float_literal])){let e=this._previous().toString(),t=e.endsWith("h");t&&(e=e.substring(0,e.length-1));const n=parseFloat(e);this._validateTypeRange(n,t?kr.f16:kr.f32);const i=t?kr.f16:kr.f32;return this._updateNode(new $r(new co(n,this._exec.getTypeInfo(i)),i))}if(this._match([_o.keywords.true,_o.keywords.false])){let e=this._previous().toString()===_o.keywords.true.rule;return this._updateNode(new $r(new co(e?1:0,this._exec.getTypeInfo(kr.bool)),kr.bool))}if(this._check(_o.tokens.paren_left))return this._paren_expression();if(this._match(_o.keywords.bitcast)){this._consume(_o.tokens.less_than,"Expected '<'.");const e=this._type_decl();this._consume(_o.tokens.greater_than,"Expected '>'.");const t=this._paren_expression();return this._updateNode(new Xr(e,t))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new Vr(e,t))}_argument_expression_list(){if(!this._match(_o.tokens.paren_left))return null;const e=[];do{if(this._check(_o.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(_o.tokens.comma));return this._consume(_o.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(_o.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(_o.tokens.paren_right),e}_paren_expression(){this._consume(_o.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(_o.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(_o.keywords.struct))return null;const e=this._currentLine,t=this._consume(_o.tokens.ident,"Expected name for struct.").toString();this._consume(_o.tokens.brace_left,"Expected '{' for struct body.");const n=[];for(;!this._check(_o.tokens.brace_right);){const e=this._attribute(),t=this._consume(_o.tokens.name,"Expected variable name.").toString();this._consume(_o.tokens.colon,"Expected ':' for struct member type.");const i=this._attribute(),s=this._type_decl();null!=s&&(s.attributes=i),this._check(_o.tokens.brace_right)?this._match(_o.tokens.comma):this._consume(_o.tokens.comma,"Expected ',' for struct member."),n.push(this._updateNode(new so(t,s,e)))}this._consume(_o.tokens.brace_right,"Expected '}' after struct body.");const i=this._currentLine,s=this._updateNode(new Nr(t,n,e,i),e);return this._context.structs.set(t,s),s}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(_o.tokens.equal)){const t=this._const_expression();e.value=t}if(null!==e.type&&e.value instanceof $r){if("x32"!==e.value.type.name&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else null===e.type&&e.value instanceof $r&&(e.type="x32"===e.value.type.name?kr.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(_o.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(_o.keywords.const))return null;const t=this._consume(_o.tokens.name,"Expected variable name"),n=this._currentLine;let i=null;if(this._match(_o.tokens.colon)){const e=this._attribute();i=this._type_decl(),null!=i&&(i.attributes=e)}let s=null;this._consume(_o.tokens.equal,"const declarations require an assignment");const r=this._short_circuit_or_expression();try{let e=[kr.f32],n=r.constEvaluate(this._exec,e);n instanceof co&&this._validateTypeRange(n.value,e[0]),e[0]instanceof Fr&&null===e[0].format&&n.typeInfo instanceof Os&&null!==n.typeInfo.format&&("f16"===n.typeInfo.format.name?e[0].format=kr.f16:"f32"===n.typeInfo.format.name?e[0].format=kr.f32:"i32"===n.typeInfo.format.name?e[0].format=kr.i32:"u32"===n.typeInfo.format.name?e[0].format=kr.u32:"bool"===n.typeInfo.format.name&&(e[0].format=kr.bool)),s=this._updateNode(new $r(n,e[0])),this._exec.context.setVariable(t.toString(),n)}catch(a){s=r}if(null!==i&&s instanceof $r){if("x32"!==s.type.name&&i.getTypeName()!==s.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${i.name}. Line:${this._currentLine}`);s.type=i,s.isScalar&&this._validateTypeRange(s.scalarValue,s.type)}else null===i&&s instanceof $r&&(i=null!==(e=null==s?void 0:s.type)&&void 0!==e?e:kr.f32,i===kr.x32&&(i=kr.i32));const o=this._updateNode(new pr(t.toString(),i,"","",s),n);return this._context.constants.set(o.name,o),o}_global_let_decl(){if(!this._match(_o.keywords.let))return null;const e=this._currentLine,t=this._consume(_o.tokens.name,"Expected variable name");let n=null;if(this._match(_o.tokens.colon)){const e=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=e)}let i=null;if(this._match(_o.tokens.equal)&&(i=this._const_expression()),null!==n&&i instanceof $r){if("x32"!==i.type.name&&n.getTypeName()!==i.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${i.type.name} to ${n.name}. Line:${this._currentLine}`);i.type=n}else null===n&&i instanceof $r&&(n="x32"===i.type.name?kr.i32:i.type);return i instanceof $r&&i.isScalar&&this._validateTypeRange(i.scalarValue,n),this._updateNode(new fr(t.toString(),n,"","",i),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(_o.keywords.var))return null;const e=this._currentLine;let t="",n="";this._match(_o.tokens.less_than)&&(t=this._consume(_o.storage_class,"Expected storage_class.").toString(),this._match(_o.tokens.comma)&&(n=this._consume(_o.access_mode,"Expected access_mode.").toString()),this._consume(_o.tokens.greater_than,"Expected '>'."));const i=this._consume(_o.tokens.name,"Expected variable name");let s=null;if(this._match(_o.tokens.colon)){const e=this._attribute();s=this._type_decl(),null!=s&&(s.attributes=e)}return this._updateNode(new hr(i.toString(),s,t,n,null),e)}_override_decl(){if(!this._match(_o.keywords.override))return null;const e=this._consume(_o.tokens.name,"Expected variable name");let t=null;if(this._match(_o.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}return this._updateNode(new dr(e.toString(),t,null))}_diagnostic(){this._consume(_o.tokens.paren_left,"Expected '('");const e=this._consume(_o.tokens.ident,"Expected severity control name.");this._consume(_o.tokens.comma,"Expected ','");let t=this._consume(_o.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(_o.tokens.period)&&(t+=`.${this._consume(_o.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(_o.tokens.paren_right,"Expected ')'"),this._updateNode(new Pr(e.toString(),t))}_enable_directive(){const e=this._consume(_o.tokens.ident,"identity expected.");return this._updateNode(new Sr(e.toString()))}_requires_directive(){const e=[this._consume(_o.tokens.ident,"identity expected.").toString()];for(;this._match(_o.tokens.comma);){const t=this._consume(_o.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new Rr(e))}_type_alias(){const e=this._consume(_o.tokens.ident,"identity expected.");this._consume(_o.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(null===t)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const n=this._updateNode(new Cr(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([_o.tokens.ident,..._o.texel_format,_o.keywords.bool,_o.keywords.f32,_o.keywords.i32,_o.keywords.u32])){const e=this._advance().toString();if(this._context.structs.has(e))return this._context.structs.get(e);if(this._context.aliases.has(e))return this._context.aliases.get(e).type;if(!this._getType(e)){const t=this._updateNode(new Or(e));return this._forwardTypeCount++,t}return this._updateNode(new kr(e))}let e=this._texture_sampler_types();if(e)return e;if(this._check(_o.template_types)){let e=this._advance().toString(),t=null,n=null;return this._match(_o.tokens.less_than)&&(t=this._type_decl(),n=null,this._match(_o.tokens.comma)&&(n=this._consume(_o.access_mode,"Expected access_mode for pointer").toString()),this._consume(_o.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new Fr(e,t,n))}if(this._match(_o.keywords.ptr)){let e=this._previous().toString();this._consume(_o.tokens.less_than,"Expected '<' for pointer.");const t=this._consume(_o.storage_class,"Expected storage_class for pointer");this._consume(_o.tokens.comma,"Expected ',' for pointer.");const n=this._type_decl();let i=null;return this._match(_o.tokens.comma)&&(i=this._consume(_o.access_mode,"Expected access_mode for pointer").toString()),this._consume(_o.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Br(e,t.toString(),n,i))}const t=this._attribute();if(this._match(_o.keywords.array)){let e=null,i=-1;const s=this._previous();let r=null;if(this._match(_o.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t="";if(this._match(_o.tokens.comma)){r=this._shift_expression();try{t=r.constEvaluate(this._exec).toString(),r=null}catch(n){t="1"}}this._consume(_o.tokens.greater_than,"Expected '>' for array."),i=t?parseInt(t):0}const o=this._updateNode(new Dr(s.toString(),t,e,i));return r&&this._deferArrayCountEval.push({arrayType:o,countNode:r}),o}return null}_texture_sampler_types(){if(this._match(_o.sampler_type))return this._updateNode(new Ur(this._previous().toString(),null,null));if(this._match(_o.depth_texture_type))return this._updateNode(new Ur(this._previous().toString(),null,null));if(this._match(_o.sampled_texture_type)||this._match(_o.multisampled_texture_type)){const e=this._previous();this._consume(_o.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(_o.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Ur(e.toString(),t,null))}if(this._match(_o.storage_texture_type)){const e=this._previous();this._consume(_o.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(_o.texel_format,"Invalid texel format.").toString();this._consume(_o.tokens.comma,"Expected ',' after texel format.");const n=this._consume(_o.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(_o.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new Ur(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(_o.tokens.attr);){const t=this._consume(_o.attribute_name,"Expected attribute name"),n=this._updateNode(new ro(t.toString(),null));if(this._match(_o.tokens.paren_left)){if(n.value=this._consume(_o.literal_or_ident,"Expected attribute value").toString(),this._check(_o.tokens.comma)){this._advance();do{const e=this._consume(_o.literal_or_ident,"Expected attribute value").toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(e)}while(this._match(_o.tokens.comma))}this._consume(_o.tokens.paren_right,"Expected ')'")}e.push(n)}return 0==e.length?null:e}}class jo extends ko{constructor(e){super(),e&&this.update(e)}update(e){const t=(new Wo).parse(e);this.updateAST(t)}}function Ho(e){var t;const n={attributes:[],bindings:[]};let i;try{i=function(e){try{return new jo(e)}catch(t){if(t instanceof Error)throw t;let e="WGSL parse error";throw"object"==typeof t&&(null==t?void 0:t.message)&&(e+=`: ${t.message} `),"object"==typeof t&&(null==t?void 0:t.token)&&(e+=t.token.line||""),new Error(e,{cause:t})}}(e)}catch(o){return Zn.error(o.message)(),n}for(const a of i.uniforms){const e=[];for(const n of(null==(t=a.type)?void 0:t.members)||[])e.push({name:n.name,type:$o(n.type)});n.bindings.push({type:"uniform",name:a.name,group:a.group,location:a.binding,members:e})}for(const a of i.textures)n.bindings.push({type:"texture",name:a.name,group:a.group,location:a.binding});for(const a of i.samplers)n.bindings.push({type:"sampler",name:a.name,group:a.group,location:a.binding});const s=i.entry.vertex[0],r=(null==s?void 0:s.inputs.length)||0;for(let a=0;a<r;a++){const e=s.inputs[a];if("location"===e.locationType){const t=$o(e.type);n.attributes.push({name:e.name,location:Number(e.location),type:t})}}return n}function $o(e){return e.format?`${e.name}<${e.format.name}>`:e.name}globalThis.mathgl=globalThis.mathgl||{config:{EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1}};const Xo=globalThis.mathgl.config;function Yo(e,{precision:t=Xo.precision}={}){return e=function(e){return Math.round(e/Xo.EPSILON)*Xo.EPSILON}(e),`${parseFloat(e.toPrecision(t))}`}function Ko(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}function qo(e,t,n){return function(e,t,n){if(Ko(e)){const i=e;n=n||function(e){return e.clone?e.clone():new Array(e.length)}(i);for(let s=0;s<n.length&&s<i.length;++s){const i="number"==typeof e?e:e[s];n[s]=t(i,s,n)}return n}return t(e)}(e,(e=>Math.max(t,Math.min(n,e))))}function Zo(e,t,n){return Ko(e)?e.map(((e,i)=>Zo(e,t[i],n))):n*t+(1-n)*e}function Qo(e,t,n){const i=Xo.EPSILON;n&&(Xo.EPSILON=n);try{if(e===t)return!0;if(Ko(e)&&Ko(t)){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(!Qo(e[n],t[n]))return!1;return!0}return e&&e.equals?e.equals(t):t&&t.equals?t.equals(e):"number"==typeof e&&"number"==typeof t&&Math.abs(e-t)<=Xo.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}finally{Xo.EPSILON=i}}class Jo extends Array{clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){for(let n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}toArray(e=[],t=0){for(let n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Ko(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Xo)}formatString(e){let t="";for(let n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+Yo(this[n],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!Qo(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,n){if(void 0===n)return this.lerp(this,e,t);for(let i=0;i<this.ELEMENTS;++i){const s=e[i],r="number"==typeof t?t:t[i];this[i]=s+n*(r-s)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}add(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]+=t[e];return this.check()}subtract(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]-=t[e];return this.check()}scale(e){if("number"==typeof e)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Xo.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}get elements(){return this}}function ea(e){if(!Number.isFinite(e))throw new Error(`Invalid number ${JSON.stringify(e)}`);return e}function ta(e,t,n=""){if(Xo.debug&&!function(e,t){if(e.length!==t)return!1;for(let n=0;n<e.length;++n)if(!Number.isFinite(e[n]))return!1;return!0}(e,t))throw new Error(`math.gl: ${n} some fields set to invalid numbers'`);return e}function na(e,t){if(!e)throw new Error(`math.gl assertion ${t}`)}class ia extends Jo{get x(){return this[0]}set x(e){this[0]=ea(e)}get y(){return this[1]}set y(e){this[1]=ea(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let n=0;n<this.ELEMENTS;++n){const i=this[n]-e[n];t+=i*i}return ea(t)}dot(e){let t=0;for(let n=0;n<this.ELEMENTS;++n)t+=this[n]*e[n];return ea(t)}normalize(){const e=this.magnitude();if(0!==e)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]*=t[e];return this.check()}divide(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t[e];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return na(e>=0&&e<this.ELEMENTS,"index is out of range"),ea(this[e])}setComponent(e,t){return na(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const sa=1e-6;let ra="undefined"!=typeof Float32Array?Float32Array:Array;function oa(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function aa(e,t,n,i){const s=t[0],r=t[1];return e[0]=s+i*(n[0]-s),e[1]=r+i*(n[1]-r),e}const la=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e};function ca(e,t,n){const i=t[0],s=t[1],r=t[2],o=n[3]*i+n[7]*s+n[11]*r||1;return e[0]=(n[0]*i+n[4]*s+n[8]*r)/o,e[1]=(n[1]*i+n[5]*s+n[9]*r)/o,e[2]=(n[2]*i+n[6]*s+n[10]*r)/o,e}function ua(e,t,n){const i=t[0],s=t[1],r=t[2];let o=n[3]*i+n[7]*s+n[11]*r+n[15];return o=o||1,e[0]=(n[0]*i+n[4]*s+n[8]*r+n[12])/o,e[1]=(n[1]*i+n[5]*s+n[9]*r+n[13])/o,e[2]=(n[2]*i+n[6]*s+n[10]*r+n[14])/o,e}!function(){const e=function(){const e=new ra(2);return ra!=Float32Array&&(e[0]=0,e[1]=0),e}()}();const ha=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e};!function(){const e=function(){const e=new ra(3);return ra!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}()}();const da=[0,0,0];let fa;class pa extends ia{static get ZERO(){return fa||(fa=new pa(0,0,0),Object.freeze(fa)),fa}constructor(e=0,t=0,n=0){super(-0,-0,-0),1===arguments.length&&Ko(e)?this.copy(e):(Xo.debug&&(ea(e),ea(t),ea(n)),this[0]=e,this[1]=t,this[2]=n)}set(e,t,n){return this[0]=e,this[1]=t,this[2]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Xo.debug&&(ea(e.x),ea(e.y),ea(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=ea(e)}angle(e){return function(e,t){const n=e[0],i=e[1],s=e[2],r=t[0],o=t[1],a=t[2],l=Math.sqrt((n*n+i*i+s*s)*(r*r+o*o+a*a)),c=l&&function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(e,t)/l;return Math.acos(Math.min(Math.max(c,-1),1))}(this,e)}cross(e){return function(e,t,n){const i=t[0],s=t[1],r=t[2],o=n[0],a=n[1],l=n[2];e[0]=s*l-r*a,e[1]=r*o-i*l,e[2]=i*a-s*o}(this,this,e),this.check()}rotateX({radians:e,origin:t=da}){return function(e,t,n,i){const s=[],r=[];s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],r[0]=s[0],r[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),r[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),e[0]=r[0]+n[0],e[1]=r[1]+n[1],e[2]=r[2]+n[2]}(this,this,t,e),this.check()}rotateY({radians:e,origin:t=da}){return function(e,t,n,i){const s=[],r=[];s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],r[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),r[1]=s[1],r[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),e[0]=r[0]+n[0],e[1]=r[1]+n[1],e[2]=r[2]+n[2]}(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=da}){return function(e,t,n,i){const s=[],r=[];s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],r[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),r[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),r[2]=s[2],e[0]=r[0]+n[0],e[1]=r[1]+n[1],e[2]=r[2]+n[2]}(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return ua(this,this,e),this.check()}transformAsVector(e){return ca(this,this,e),this.check()}transformByMatrix3(e){return function(e,t,n){const i=t[0],s=t[1],r=t[2];e[0]=i*n[0]+s*n[3]+r*n[6],e[1]=i*n[1]+s*n[4]+r*n[7],e[2]=i*n[2]+s*n[5]+r*n[8]}(this,this,e),this.check()}transformByMatrix2(e){return function(e,t,n){const i=t[0],s=t[1];e[0]=n[0]*i+n[2]*s,e[1]=n[1]*i+n[3]*s,e[2]=t[2]}(this,this,e),this.check()}transformByQuaternion(e){return function(e,t,n){const i=n[0],s=n[1],r=n[2],o=n[3],a=t[0],l=t[1],c=t[2];let u=s*c-r*l,h=r*a-i*c,d=i*l-s*a,f=s*d-r*h,p=r*u-i*d,g=i*h-s*u;const m=2*o;u*=m,h*=m,d*=m,f*=2,p*=2,g*=2,e[0]=a+u+f,e[1]=l+h+p,e[2]=c+d+g}(this,this,e),this.check()}}class ga extends Jo{toString(){let e="[";if(Xo.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let n=0;n<this.RANK;++n)e+=` ${this[n*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,n){return this[t*this.RANK+e]=ea(n),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const n=e*this.RANK;for(let i=0;i<this.RANK;++i)t[i]=this[n+i];return t}setColumn(e,t){const n=e*this.RANK;for(let i=0;i<this.RANK;++i)this[n+i]=t[i];return this}}function ma(e,t){const n=t[0],i=t[1],s=t[2],r=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],f=t[11],p=t[12],g=t[13],m=t[14],_=t[15],y=n*a-i*o,v=n*l-s*o,b=n*c-r*o,E=i*l-s*a,x=i*c-r*a,w=s*c-r*l,T=u*g-h*p,A=u*m-d*p,S=u*_-f*p,R=h*m-d*g,P=h*_-f*g,C=d*_-f*m;let I=y*C-v*P+b*R+E*S-x*A+w*T;return I?(I=1/I,e[0]=(a*C-l*P+c*R)*I,e[1]=(s*P-i*C-r*R)*I,e[2]=(g*w-m*x+_*E)*I,e[3]=(d*x-h*w-f*E)*I,e[4]=(l*S-o*C-c*A)*I,e[5]=(n*C-s*S+r*A)*I,e[6]=(m*b-p*w-_*v)*I,e[7]=(u*w-d*b+f*v)*I,e[8]=(o*P-a*S+c*T)*I,e[9]=(i*S-n*P-r*T)*I,e[10]=(p*x-g*b+_*y)*I,e[11]=(h*b-u*x-f*y)*I,e[12]=(a*A-o*R-l*T)*I,e[13]=(n*R-i*A+s*T)*I,e[14]=(g*v-p*E-m*y)*I,e[15]=(u*E-h*v+d*y)*I,e):null}function _a(e,t,n){const i=t[0],s=t[1],r=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],f=t[10],p=t[11],g=t[12],m=t[13],_=t[14],y=t[15];let v=n[0],b=n[1],E=n[2],x=n[3];return e[0]=v*i+b*a+E*h+x*g,e[1]=v*s+b*l+E*d+x*m,e[2]=v*r+b*c+E*f+x*_,e[3]=v*o+b*u+E*p+x*y,v=n[4],b=n[5],E=n[6],x=n[7],e[4]=v*i+b*a+E*h+x*g,e[5]=v*s+b*l+E*d+x*m,e[6]=v*r+b*c+E*f+x*_,e[7]=v*o+b*u+E*p+x*y,v=n[8],b=n[9],E=n[10],x=n[11],e[8]=v*i+b*a+E*h+x*g,e[9]=v*s+b*l+E*d+x*m,e[10]=v*r+b*c+E*f+x*_,e[11]=v*o+b*u+E*p+x*y,v=n[12],b=n[13],E=n[14],x=n[15],e[12]=v*i+b*a+E*h+x*g,e[13]=v*s+b*l+E*d+x*m,e[14]=v*r+b*c+E*f+x*_,e[15]=v*o+b*u+E*p+x*y,e}function ya(e,t,n){const i=n[0],s=n[1],r=n[2];let o,a,l,c,u,h,d,f,p,g,m,_;return t===e?(e[12]=t[0]*i+t[4]*s+t[8]*r+t[12],e[13]=t[1]*i+t[5]*s+t[9]*r+t[13],e[14]=t[2]*i+t[6]*s+t[10]*r+t[14],e[15]=t[3]*i+t[7]*s+t[11]*r+t[15]):(o=t[0],a=t[1],l=t[2],c=t[3],u=t[4],h=t[5],d=t[6],f=t[7],p=t[8],g=t[9],m=t[10],_=t[11],e[0]=o,e[1]=a,e[2]=l,e[3]=c,e[4]=u,e[5]=h,e[6]=d,e[7]=f,e[8]=p,e[9]=g,e[10]=m,e[11]=_,e[12]=o*i+u*s+p*r+t[12],e[13]=a*i+h*s+g*r+t[13],e[14]=l*i+d*s+m*r+t[14],e[15]=c*i+f*s+_*r+t[15]),e}function va(e,t,n){const i=n[0],s=n[1],r=n[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function ba(e,t,n){const i=Math.sin(n),s=Math.cos(n),r=t[4],o=t[5],a=t[6],l=t[7],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=r*s+c*i,e[5]=o*s+u*i,e[6]=a*s+h*i,e[7]=l*s+d*i,e[8]=c*s-r*i,e[9]=u*s-o*i,e[10]=h*s-a*i,e[11]=d*s-l*i,e}function Ea(e,t,n){const i=Math.sin(n),s=Math.cos(n),r=t[0],o=t[1],a=t[2],l=t[3],c=t[4],u=t[5],h=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*s+c*i,e[1]=o*s+u*i,e[2]=a*s+h*i,e[3]=l*s+d*i,e[4]=c*s-r*i,e[5]=u*s-o*i,e[6]=h*s-a*i,e[7]=d*s-l*i,e}const xa=function(e,t,n,i,s){const r=1/Math.tan(t/2);if(e[0]=r/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0){const t=1/(i-s);e[10]=(s+i)*t,e[14]=2*s*i*t}else e[10]=-1,e[14]=-2*i;return e};const wa=function(e,t,n,i,s,r,o){const a=1/(t-n),l=1/(i-s),c=1/(r-o);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+n)*a,e[13]=(s+i)*l,e[14]=(o+r)*c,e[15]=1,e};function Ta(e,t,n){const i=t[0],s=t[1],r=t[2],o=t[3];return e[0]=n[0]*i+n[4]*s+n[8]*r+n[12]*o,e[1]=n[1]*i+n[5]*s+n[9]*r+n[13]*o,e[2]=n[2]*i+n[6]*s+n[10]*r+n[14]*o,e[3]=n[3]*i+n[7]*s+n[11]*r+n[15]*o,e}var Aa,Sa;!function(){const e=function(){const e=new ra(4);return ra!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}(),(Sa=Aa||(Aa={}))[Sa.COL0ROW0=0]="COL0ROW0",Sa[Sa.COL0ROW1=1]="COL0ROW1",Sa[Sa.COL0ROW2=2]="COL0ROW2",Sa[Sa.COL0ROW3=3]="COL0ROW3",Sa[Sa.COL1ROW0=4]="COL1ROW0",Sa[Sa.COL1ROW1=5]="COL1ROW1",Sa[Sa.COL1ROW2=6]="COL1ROW2",Sa[Sa.COL1ROW3=7]="COL1ROW3",Sa[Sa.COL2ROW0=8]="COL2ROW0",Sa[Sa.COL2ROW1=9]="COL2ROW1",Sa[Sa.COL2ROW2=10]="COL2ROW2",Sa[Sa.COL2ROW3=11]="COL2ROW3",Sa[Sa.COL3ROW0=12]="COL3ROW0",Sa[Sa.COL3ROW1=13]="COL3ROW1",Sa[Sa.COL3ROW2=14]="COL3ROW2",Sa[Sa.COL3ROW3=15]="COL3ROW3";const Ra=45*Math.PI/180,Pa=1,Ca=.1,Ia=500,La=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Ma extends ga{static get IDENTITY(){return function(){Oa||(Oa=new Ma,Object.freeze(Oa));return Oa}()}static get ZERO(){return function(){ka||(ka=new Ma([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(ka));return ka}()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return Aa}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,n,i,s,r,o,a,l,c,u,h,d,f,p,g){return this[0]=e,this[1]=t,this[2]=n,this[3]=i,this[4]=s,this[5]=r,this[6]=o,this[7]=a,this[8]=l,this[9]=c,this[10]=u,this[11]=h,this[12]=d,this[13]=f,this[14]=p,this[15]=g,this.check()}setRowMajor(e,t,n,i,s,r,o,a,l,c,u,h,d,f,p,g){return this[0]=e,this[1]=s,this[2]=l,this[3]=d,this[4]=t,this[5]=r,this[6]=c,this[7]=f,this[8]=n,this[9]=o,this[10]=u,this[11]=p,this[12]=i,this[13]=a,this[14]=h,this[15]=g,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(La)}fromObject(e){return this.check()}fromQuaternion(e){return function(e,t){const n=t[0],i=t[1],s=t[2],r=t[3],o=n+n,a=i+i,l=s+s,c=n*o,u=i*o,h=i*a,d=s*o,f=s*a,p=s*l,g=r*o,m=r*a,_=r*l;e[0]=1-h-p,e[1]=u+_,e[2]=d-m,e[3]=0,e[4]=u-_,e[5]=1-c-p,e[6]=f+g,e[7]=0,e[8]=d+m,e[9]=f-g,e[10]=1-c-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(this,e),this.check()}frustum(e){const{left:t,right:n,bottom:i,top:s,near:r=Ca,far:o=Ia}=e;return o===1/0?function(e,t,n,i,s,r){const o=2*r/(n-t),a=2*r/(s-i),l=(n+t)/(n-t),c=(s+i)/(s-i),u=-1,h=-1,d=-2*r;e[0]=o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=l,e[9]=c,e[10]=u,e[11]=h,e[12]=0,e[13]=0,e[14]=d,e[15]=0}(this,t,n,i,s,r):function(e,t,n,i,s,r,o){const a=1/(n-t),l=1/(s-i),c=1/(r-o);e[0]=2*r*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*r*l,e[6]=0,e[7]=0,e[8]=(n+t)*a,e[9]=(s+i)*l,e[10]=(o+r)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*r*2*c,e[15]=0}(this,t,n,i,s,r,o),this.check()}lookAt(e){const{eye:t,center:n=[0,0,0],up:i=[0,1,0]}=e;return function(e,t,n,i){let s,r,o,a,l,c,u,h,d,f;const p=t[0],g=t[1],m=t[2],_=i[0],y=i[1],v=i[2],b=n[0],E=n[1],x=n[2];Math.abs(p-b)<sa&&Math.abs(g-E)<sa&&Math.abs(m-x)<sa?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(h=p-b,d=g-E,f=m-x,s=1/Math.sqrt(h*h+d*d+f*f),h*=s,d*=s,f*=s,r=y*f-v*d,o=v*h-_*f,a=_*d-y*h,s=Math.sqrt(r*r+o*o+a*a),s?(s=1/s,r*=s,o*=s,a*=s):(r=0,o=0,a=0),l=d*a-f*o,c=f*r-h*a,u=h*o-d*r,s=Math.sqrt(l*l+c*c+u*u),s?(s=1/s,l*=s,c*=s,u*=s):(l=0,c=0,u=0),e[0]=r,e[1]=l,e[2]=h,e[3]=0,e[4]=o,e[5]=c,e[6]=d,e[7]=0,e[8]=a,e[9]=u,e[10]=f,e[11]=0,e[12]=-(r*p+o*g+a*m),e[13]=-(l*p+c*g+u*m),e[14]=-(h*p+d*g+f*m),e[15]=1)}(this,t,n,i),this.check()}ortho(e){const{left:t,right:n,bottom:i,top:s,near:r=Ca,far:o=Ia}=e;return wa(this,t,n,i,s,r,o),this.check()}orthographic(e){const{fovy:t=Ra,aspect:n=Pa,focalDistance:i=1,near:s=Ca,far:r=Ia}=e;Na(t);const o=t/2,a=i*Math.tan(o),l=a*n;return this.ortho({left:-l,right:l,bottom:-a,top:a,near:s,far:r})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:n=1,near:i=.1,far:s=500}=e;return Na(t),xa(this,t,n,i,s),this.check()}determinant(){return function(e){const t=e[0],n=e[1],i=e[2],s=e[3],r=e[4],o=e[5],a=e[6],l=e[7],c=e[8],u=e[9],h=e[10],d=e[11],f=e[12],p=e[13],g=e[14],m=t*o-n*r,_=t*a-i*r,y=n*a-i*o,v=c*p-u*f,b=c*g-h*f,E=u*g-h*p;return l*(t*E-n*b+i*v)-s*(r*E-o*b+a*v)+e[15]*(c*y-u*_+h*m)-d*(f*y-p*_+g*m)}(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const n=this.getScale(t),i=1/n[0],s=1/n[1],r=1/n[2];return e[0]=this[0]*i,e[1]=this[1]*s,e[2]=this[2]*r,e[3]=0,e[4]=this[4]*i,e[5]=this[5]*s,e[6]=this[6]*r,e[7]=0,e[8]=this[8]*i,e[9]=this[9]*s,e[10]=this[10]*r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const n=this.getScale(t),i=1/n[0],s=1/n[1],r=1/n[2];return e[0]=this[0]*i,e[1]=this[1]*s,e[2]=this[2]*r,e[3]=this[4]*i,e[4]=this[5]*s,e[5]=this[6]*r,e[6]=this[8]*i,e[7]=this[9]*s,e[8]=this[10]*r,e}transpose(){return function(e,t){if(e===t){const n=t[1],i=t[2],s=t[3],r=t[6],o=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=r,e[11]=t[14],e[12]=s,e[13]=o,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]}(this,this),this.check()}invert(){return ma(this,this),this.check()}multiplyLeft(e){return _a(this,e,this),this.check()}multiplyRight(e){return _a(this,this,e),this.check()}rotateX(e){return ba(this,this,e),this.check()}rotateY(e){return function(e,t,n){const i=Math.sin(n),s=Math.cos(n),r=t[0],o=t[1],a=t[2],l=t[3],c=t[8],u=t[9],h=t[10],d=t[11];t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*s-c*i,e[1]=o*s-u*i,e[2]=a*s-h*i,e[3]=l*s-d*i,e[8]=r*i+c*s,e[9]=o*i+u*s,e[10]=a*i+h*s,e[11]=l*i+d*s}(this,this,e),this.check()}rotateZ(e){return Ea(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return function(e,t,n,i){let s,r,o,a,l,c,u,h,d,f,p,g,m,_,y,v,b,E,x,w,T,A,S,R,P=i[0],C=i[1],I=i[2],L=Math.sqrt(P*P+C*C+I*I);L<sa||(L=1/L,P*=L,C*=L,I*=L,r=Math.sin(n),s=Math.cos(n),o=1-s,a=t[0],l=t[1],c=t[2],u=t[3],h=t[4],d=t[5],f=t[6],p=t[7],g=t[8],m=t[9],_=t[10],y=t[11],v=P*P*o+s,b=C*P*o+I*r,E=I*P*o-C*r,x=P*C*o-I*r,w=C*C*o+s,T=I*C*o+P*r,A=P*I*o+C*r,S=C*I*o-P*r,R=I*I*o+s,e[0]=a*v+h*b+g*E,e[1]=l*v+d*b+m*E,e[2]=c*v+f*b+_*E,e[3]=u*v+p*b+y*E,e[4]=a*x+h*w+g*T,e[5]=l*x+d*w+m*T,e[6]=c*x+f*w+_*T,e[7]=u*x+p*w+y*T,e[8]=a*A+h*S+g*R,e[9]=l*A+d*S+m*R,e[10]=c*A+f*S+_*R,e[11]=u*A+p*S+y*R,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(this,this,e,t),this.check()}scale(e){return va(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return ya(this,this,e),this.check()}transform(e,t){return 4===e.length?(ta(t=Ta(t||[-0,-0,-0,-0],e,this),4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:n}=e;let i;switch(n){case 2:i=function(e,t,n){const i=t[0],s=t[1];return e[0]=n[0]*i+n[4]*s+n[12],e[1]=n[1]*i+n[5]*s+n[13],e}(t||[-0,-0],e,this);break;case 3:i=ua(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return ta(i,e.length),i}transformAsVector(e,t){let n;switch(e.length){case 2:n=function(e,t,n){const i=t[0],s=t[1],r=n[3]*i+n[7]*s||1;return e[0]=(n[0]*i+n[4]*s)/r,e[1]=(n[1]*i+n[5]*s)/r,e}(t||[-0,-0],e,this);break;case 3:n=ca(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return ta(n,e.length),n}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,n){return this.identity().translate([e,t,n])}}let ka,Oa;function Na(e){if(e>2*Math.PI)throw Error("expected radians")}function Fa(e,t=[],n=0){const i=Math.fround(e),s=e-i;return t[n]=i,t[n+1]=s,t}const Ba={name:"fp32",vs:"#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\n\n// All these functions are for substituting tan() function from Intel GPU only\nconst float TWO_PI = 6.2831854820251465;\nconst float PI_2 = 1.5707963705062866;\nconst float PI_16 = 0.1963495463132858;\n\nconst float SIN_TABLE_0 = 0.19509032368659973;\nconst float SIN_TABLE_1 = 0.3826834261417389;\nconst float SIN_TABLE_2 = 0.5555702447891235;\nconst float SIN_TABLE_3 = 0.7071067690849304;\n\nconst float COS_TABLE_0 = 0.9807852506637573;\nconst float COS_TABLE_1 = 0.9238795042037964;\nconst float COS_TABLE_2 = 0.8314695954322815;\nconst float COS_TABLE_3 = 0.7071067690849304;\n\nconst float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!\nconst float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!\nconst float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!\nconst float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!\n\nfloat sin_taylor_fp32(float a) {\n  float r, s, t, x;\n\n  if (a == 0.0) {\n    return 0.0;\n  }\n\n  x = -a * a;\n  s = a;\n  r = a;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_3;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_5;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_7;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_9;\n  s = s + t;\n\n  return s;\n}\n\nvoid sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {\n  if (a == 0.0) {\n    sin_t = 0.0;\n    cos_t = 1.0;\n  }\n  sin_t = sin_taylor_fp32(a);\n  cos_t = sqrt(1.0 - sin_t * sin_t);\n}\n\nfloat tan_taylor_fp32(float a) {\n    float sin_a;\n    float cos_a;\n\n    if (a == 0.0) {\n        return 0.0;\n    }\n\n    // 2pi range reduction\n    float z = floor(a / TWO_PI);\n    float r = a - TWO_PI * z;\n\n    float t;\n    float q = floor(r / PI_2 + 0.5);\n    int j = int(q);\n\n    if (j < -2 || j > 2) {\n        return 1.0 / 0.0;\n    }\n\n    t = r - PI_2 * q;\n\n    q = floor(t / PI_16 + 0.5);\n    int k = int(q);\n    int abs_k = int(abs(float(k)));\n\n    if (abs_k > 4) {\n        return 1.0 / 0.0;\n    } else {\n        t = t - PI_16 * q;\n    }\n\n    float u = 0.0;\n    float v = 0.0;\n\n    float sin_t, cos_t;\n    float s, c;\n    sincos_taylor_fp32(t, sin_t, cos_t);\n\n    if (k == 0) {\n        s = sin_t;\n        c = cos_t;\n    } else {\n        if (abs(float(abs_k) - 1.0) < 0.5) {\n            u = COS_TABLE_0;\n            v = SIN_TABLE_0;\n        } else if (abs(float(abs_k) - 2.0) < 0.5) {\n            u = COS_TABLE_1;\n            v = SIN_TABLE_1;\n        } else if (abs(float(abs_k) - 3.0) < 0.5) {\n            u = COS_TABLE_2;\n            v = SIN_TABLE_2;\n        } else if (abs(float(abs_k) - 4.0) < 0.5) {\n            u = COS_TABLE_3;\n            v = SIN_TABLE_3;\n        }\n        if (k > 0) {\n            s = u * sin_t + v * cos_t;\n            c = u * cos_t - v * sin_t;\n        } else {\n            s = u * sin_t - v * cos_t;\n            c = u * cos_t + v * sin_t;\n        }\n    }\n\n    if (j == 0) {\n        sin_a = s;\n        cos_a = c;\n    } else if (j == 1) {\n        sin_a = c;\n        cos_a = -s;\n    } else if (j == -1) {\n        sin_a = -c;\n        cos_a = s;\n    } else {\n        sin_a = -s;\n        cos_a = -c;\n    }\n    return sin_a / cos_a;\n}\n#endif\n\nfloat tan_fp32(float a) {\n#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\n  return tan_taylor_fp32(a);\n#else\n  return tan(a);\n#endif\n}\n"},Da={name:"fp64arithmetic",vs:"\nuniform fp64arithmeticUniforms {\n  uniform float ONE;\n} fp64;\n\n/*\nAbout LUMA_FP64_CODE_ELIMINATION_WORKAROUND\n\nThe purpose of this workaround is to prevent shader compilers from\noptimizing away necessary arithmetic operations by swapping their sequences\nor transform the equation to some 'equivalent' form.\n\nThe method is to multiply an artifical variable, ONE, which will be known to\nthe compiler to be 1 only at runtime. The whole expression is then represented\nas a polynomial with respective to ONE. In the coefficients of all terms, only one a\nand one b should appear\n\nerr = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE\n*/\n\n// Divide float number to high and low floats to extend fraction bits\nvec2 split(float a) {\n  const float SPLIT = 4097.0;\n  float t = a * SPLIT;\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\n  float a_hi = t * fp64.ONE - (t - a);\n  float a_lo = a * fp64.ONE - a_hi;\n#else\n  float a_hi = t - (t - a);\n  float a_lo = a - a_hi;\n#endif\n  return vec2(a_hi, a_lo);\n}\n\n// Divide float number again when high float uses too many fraction bits\nvec2 split2(vec2 a) {\n  vec2 b = split(a.x);\n  b.y += a.y;\n  return b;\n}\n\n// Special sum operation when a > b\nvec2 quickTwoSum(float a, float b) {\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\n  float sum = (a + b) * fp64.ONE;\n  float err = b - (sum - a) * fp64.ONE;\n#else\n  float sum = a + b;\n  float err = b - (sum - a);\n#endif\n  return vec2(sum, err);\n}\n\n// General sum operation\nvec2 twoSum(float a, float b) {\n  float s = (a + b);\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\n  float v = (s * fp64.ONE - a) * fp64.ONE;\n  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);\n#else\n  float v = s - a;\n  float err = (a - (s - v)) + (b - v);\n#endif\n  return vec2(s, err);\n}\n\nvec2 twoSub(float a, float b) {\n  float s = (a - b);\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\n  float v = (s * fp64.ONE - a) * fp64.ONE;\n  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);\n#else\n  float v = s - a;\n  float err = (a - (s - v)) - (b + v);\n#endif\n  return vec2(s, err);\n}\n\nvec2 twoSqr(float a) {\n  float prod = a * a;\n  vec2 a_fp64 = split(a);\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\n  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *\n    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;\n#else\n  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;\n#endif\n  return vec2(prod, err);\n}\n\nvec2 twoProd(float a, float b) {\n  float prod = a * b;\n  vec2 a_fp64 = split(a);\n  vec2 b_fp64 = split(b);\n  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +\n    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;\n  return vec2(prod, err);\n}\n\nvec2 sum_fp64(vec2 a, vec2 b) {\n  vec2 s, t;\n  s = twoSum(a.x, b.x);\n  t = twoSum(a.y, b.y);\n  s.y += t.x;\n  s = quickTwoSum(s.x, s.y);\n  s.y += t.y;\n  s = quickTwoSum(s.x, s.y);\n  return s;\n}\n\nvec2 sub_fp64(vec2 a, vec2 b) {\n  vec2 s, t;\n  s = twoSub(a.x, b.x);\n  t = twoSub(a.y, b.y);\n  s.y += t.x;\n  s = quickTwoSum(s.x, s.y);\n  s.y += t.y;\n  s = quickTwoSum(s.x, s.y);\n  return s;\n}\n\nvec2 mul_fp64(vec2 a, vec2 b) {\n  vec2 prod = twoProd(a.x, b.x);\n  // y component is for the error\n  prod.y += a.x * b.y;\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\n  prod = split2(prod);\n#endif\n  prod = quickTwoSum(prod.x, prod.y);\n  prod.y += a.y * b.x;\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\n  prod = split2(prod);\n#endif\n  prod = quickTwoSum(prod.x, prod.y);\n  return prod;\n}\n\nvec2 div_fp64(vec2 a, vec2 b) {\n  float xn = 1.0 / b.x;\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\n  vec2 yn = mul_fp64(a, vec2(xn, 0));\n#else\n  vec2 yn = a * xn;\n#endif\n  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;\n  vec2 prod = twoProd(xn, diff);\n  return sum_fp64(yn, prod);\n}\n\nvec2 sqrt_fp64(vec2 a) {\n  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);\n  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);\n\n  float x = 1.0 / sqrt(a.x);\n  float yn = a.x * x;\n#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)\n  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;\n#else\n  vec2 yn_sqr = twoSqr(yn);\n#endif\n  float diff = sub_fp64(a, yn_sqr).x;\n  vec2 prod = twoProd(x * 0.5, diff);\n#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)\n  return sum_fp64(split(yn), prod);\n#else\n  return sum_fp64(vec2(yn, 0.0), prod);\n#endif\n}\n",defaultUniforms:{ONE:1},uniformTypes:{ONE:"f32"},fp64ify:Fa,fp64LowPart:function(e){return e-Math.fround(e)},fp64ifyMatrix4:function(e){const t=new Float32Array(32);for(let n=0;n<4;++n)for(let i=0;i<4;++i){const s=4*n+i;Fa(e[4*i+n],t,2*s)}return t}},Ua={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:[0,1,1,1]},vs:"uniform pickingUniforms {\n  float isActive;\n  float isAttribute;\n  float isHighlightActive;\n  float useFloatColors;\n  vec3 highlightedObjectColor;\n  vec4 highlightColor;\n} picking;\n\nout vec4 picking_vRGBcolor_Avalid;\n\n// Normalize unsigned byte color to 0-1 range\nvec3 picking_normalizeColor(vec3 color) {\n  return picking.useFloatColors > 0.5 ? color : color / 255.0;\n}\n\n// Normalize unsigned byte color to 0-1 range\nvec4 picking_normalizeColor(vec4 color) {\n  return picking.useFloatColors > 0.5 ? color : color / 255.0;\n}\n\nbool picking_isColorZero(vec3 color) {\n  return dot(color, vec3(1.0)) < 0.00001;\n}\n\nbool picking_isColorValid(vec3 color) {\n  return dot(color, vec3(1.0)) > 0.00001;\n}\n\n// Check if this vertex is highlighted \nbool isVertexHighlighted(vec3 vertexColor) {\n  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);\n  return\n    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));\n}\n\n// Set the current picking color\nvoid picking_setPickingColor(vec3 pickingColor) {\n  pickingColor = picking_normalizeColor(pickingColor);\n\n  if (bool(picking.isActive)) {\n    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable\n    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));\n\n    if (!bool(picking.isAttribute)) {\n      // Stores the picking color so that the fragment shader can render it during picking\n      picking_vRGBcolor_Avalid.rgb = pickingColor;\n    }\n  } else {\n    // Do the comparison with selected item color in vertex shader as it should mean fewer compares\n    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));\n  }\n}\n\nvoid picking_setPickingAttribute(float value) {\n  if (bool(picking.isAttribute)) {\n    picking_vRGBcolor_Avalid.r = value;\n  }\n}\n\nvoid picking_setPickingAttribute(vec2 value) {\n  if (bool(picking.isAttribute)) {\n    picking_vRGBcolor_Avalid.rg = value;\n  }\n}\n\nvoid picking_setPickingAttribute(vec3 value) {\n  if (bool(picking.isAttribute)) {\n    picking_vRGBcolor_Avalid.rgb = value;\n  }\n}\n",fs:"uniform pickingUniforms {\n  float isActive;\n  float isAttribute;\n  float isHighlightActive;\n  float useFloatColors;\n  vec3 highlightedObjectColor;\n  vec4 highlightColor;\n} picking;\n\nin vec4 picking_vRGBcolor_Avalid;\n\n/*\n * Returns highlight color if this item is selected.\n */\nvec4 picking_filterHighlightColor(vec4 color) {\n  // If we are still picking, we don't highlight\n  if (picking.isActive > 0.5) {\n    return color;\n  }\n\n  bool selected = bool(picking_vRGBcolor_Avalid.a);\n\n  if (selected) {\n    // Blend in highlight color based on its alpha value\n    float highLightAlpha = picking.highlightColor.a;\n    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);\n    float highLightRatio = highLightAlpha / blendedAlpha;\n\n    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);\n    return vec4(blendedRGB, blendedAlpha);\n  } else {\n    return color;\n  }\n}\n\n/*\n * Returns picking color if picking enabled else unmodified argument.\n */\nvec4 picking_filterPickingColor(vec4 color) {\n  if (bool(picking.isActive)) {\n    if (picking_vRGBcolor_Avalid.a == 0.0) {\n      discard;\n    }\n    return picking_vRGBcolor_Avalid;\n  }\n  return color;\n}\n\n/*\n * Returns picking color if picking is enabled if not\n * highlight color if this item is selected, otherwise unmodified argument.\n */\nvec4 picking_filterColor(vec4 color) {\n  vec4 highlightColor = picking_filterHighlightColor(color);\n  return picking_filterPickingColor(highlightColor);\n}\n",getUniforms:function(e={},t){const n={};if(void 0===e.highlightedObjectColor);else if(null===e.highlightedObjectColor)n.isHighlightActive=!1;else{n.isHighlightActive=!0;const t=e.highlightedObjectColor.slice(0,3);n.highlightedObjectColor=t}if(e.highlightColor){const t=Array.from(e.highlightColor,(e=>e/255));Number.isFinite(t[3])||(t[3]=1),n.highlightColor=t}void 0!==e.isActive&&(n.isActive=Boolean(e.isActive),n.isAttribute=Boolean(e.isAttribute));void 0!==e.useFloatColors&&(n.useFloatColors=Boolean(e.useFloatColors));return n}};const Ga="precision highp int;\n\n// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))\nstruct AmbientLight {\n  vec3 color;\n};\n\nstruct PointLight {\n  vec3 color;\n  vec3 position;\n  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential\n};\n\nstruct DirectionalLight {\n  vec3 color;\n  vec3 direction;\n};\n\nuniform lightingUniforms {\n  int enabled;\n  int lightType;\n\n  int directionalLightCount;\n  int pointLightCount;\n\n  vec3 ambientColor;\n\n  vec3 lightColor0;\n  vec3 lightPosition0;\n  vec3 lightDirection0;\n  vec3 lightAttenuation0;\n\n  vec3 lightColor1;\n  vec3 lightPosition1;\n  vec3 lightDirection1;\n  vec3 lightAttenuation1;\n\n  vec3 lightColor2;\n  vec3 lightPosition2;\n  vec3 lightDirection2;\n  vec3 lightAttenuation2;\n} lighting;\n\nPointLight lighting_getPointLight(int index) {\n  switch (index) {\n    case 0:\n      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);\n    case 1:\n      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);\n    case 2:\n    default:  \n      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);\n  }\n}\n\nDirectionalLight lighting_getDirectionalLight(int index) {\n  switch (index) {\n    case 0:\n      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);\n    case 1:\n      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);\n    case 2:\n    default:   \n      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);\n  }\n} \n\nfloat getPointLightAttenuation(PointLight pointLight, float distance) {\n  return pointLight.attenuation.x\n       + pointLight.attenuation.y * distance\n       + pointLight.attenuation.z * distance * distance;\n}\n\n// #endif\n";var za,Va;(Va=za||(za={}))[Va.POINT=0]="POINT",Va[Va.DIRECTIONAL=1]="DIRECTIONAL";const Wa={props:{},uniforms:{},name:"lighting",defines:{MAX_LIGHTS:3},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientLightColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:za.POINT,directionalLightCount:0,pointLightCount:0,ambientLightColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:"// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))\nstruct AmbientLight {\n  color: vec3<f32>,\n};\n\nstruct PointLight {\n  color: vec3<f32>,\n  position: vec3<f32>,\n  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential\n};\n\nstruct DirectionalLight {\n  color: vec3<f32>,\n  direction: vec3<f32>,\n};\n\nstruct lightingUniforms {\n  enabled: i32,\n  pointLightCount: i32,\n  directionalLightCount: i32,\n\n  ambientColor: vec3<f32>,\n\n  // TODO - support multiple lights by uncommenting arrays below\n  lightType: i32,\n  lightColor: vec3<f32>,\n  lightDirection: vec3<f32>,\n  lightPosition: vec3<f32>,\n  lightAttenuation: vec3<f32>,\n\n  // AmbientLight ambientLight;\n  // PointLight pointLight[MAX_LIGHTS];\n  // DirectionalLight directionalLight[MAX_LIGHTS];\n};\n\n// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)\n@binding(1) @group(0) var<uniform> lighting : lightingUniforms;\n\nfn lighting_getPointLight(index: i32) -> PointLight {\n  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);\n}\n\nfn lighting_getDirectionalLight(index: i32) -> DirectionalLight {\n  return DirectionalLight(lighting.lightColor, lighting.lightDirection);\n} \n\nfn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {\n  return pointLight.attenuation.x\n       + pointLight.attenuation.y * distance\n       + pointLight.attenuation.z * distance * distance;\n}\n",vs:Ga,fs:Ga,getUniforms:function(e,t={}){if(!(e=e?{...e}:e))return{...Wa.defaultUniforms};e.lights&&(e={...e,...Ha(e.lights),lights:void 0});const{ambientLight:n,pointLights:i,directionalLights:s}=e||{};if(!(n||i&&i.length>0||s&&s.length>0))return{...Wa.defaultUniforms,enabled:0};const r={...Wa.defaultUniforms,...t,...ja({ambientLight:n,pointLights:i,directionalLights:s})};void 0!==e.enabled&&(r.enabled=e.enabled?1:0);return r}};function ja({ambientLight:e,pointLights:t=[],directionalLights:n=[]}){const i={};i.ambientLightColor=$a(e);let s=0;for(const r of t){i.lightType=za.POINT;const e=s;i[`lightColor${e}`]=$a(r),i[`lightPosition${e}`]=r.position,i[`lightAttenuation${e}`]=r.attenuation||[1,0,0],s++}for(const r of n){i.lightType=za.DIRECTIONAL;const e=s;i[`lightColor${e}`]=$a(r),i[`lightDirection${e}`]=r.direction,s++}return s>3&&Zn.warn("MAX_LIGHTS exceeded")(),i.directionalLightCount=n.length,i.pointLightCount=t.length,i}function Ha(e){var t,n;const i={pointLights:[],directionalLights:[]};for(const s of e||[])switch(s.type){case"ambient":i.ambientLight=s;break;case"directional":null==(t=i.directionalLights)||t.push(s);break;case"point":null==(n=i.pointLights)||n.push(s)}return i}function $a(e={}){const{color:t=[0,0,0],intensity:n=1}=e;return t.map((e=>e*n/255))}const Xa="uniform phongMaterialUniforms {\n  uniform float ambient;\n  uniform float diffuse;\n  uniform float shininess;\n  uniform vec3  specularColor;\n} material;\n",Ya="struct phongMaterialUniforms {\n  ambient: f32,\n  diffuse: f32,\n  shininess: f32,\n  specularColor: vec3<f32>,\n};\n\n@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;\n\nfn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {\n  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);\n  var lambertian: f32 = dot(light_direction, normal_worldspace);\n  var specular: f32 = 0.0;\n  if (lambertian > 0.0) {\n    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);\n    specular = pow(specular_angle, phongMaterial.shininess);\n  }\n  lambertian = max(lambertian, 0.0);\n  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;\n}\n\nfn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {\n  var lightColor: vec3<f32> = surfaceColor;\n\n  if (lighting.enabled == 0) {\n    return lightColor;\n  }\n\n  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);\n  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;\n\n  if (lighting.lightType == 0) {\n    let pointLight: PointLight  = lighting_getPointLight(0);\n    let light_position_worldspace: vec3<f32> = pointLight.position;\n    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);\n    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n  } else if (lighting.lightType == 1) {\n    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);\n    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n  }\n  \n  return lightColor;\n  /*\n  for (int i = 0; i < MAX_LIGHTS; i++) {\n    if (i >= lighting.pointLightCount) {\n      break;\n    }\n    PointLight pointLight = lighting.pointLight[i];\n    vec3 light_position_worldspace = pointLight.position;\n    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n  }\n\n  for (int i = 0; i < MAX_LIGHTS; i++) {\n    if (i >= lighting.directionalLightCount) {\n      break;\n    }\n    DirectionalLight directionalLight = lighting.directionalLight[i];\n    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n  }\n  */\n}\n\nfn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{\n  var lightColor = vec3<f32>(0, 0, 0);\n  let surfaceColor = vec3<f32>(0, 0, 0);\n\n  if (lighting.enabled == 0) {\n    let view_direction = normalize(cameraPosition - position_worldspace);\n\n    switch (lighting.lightType) {\n      case 0, default: {\n        let pointLight: PointLight = lighting_getPointLight(0);\n        let light_position_worldspace: vec3<f32> = pointLight.position;\n        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);\n        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n      }\n      case 1: {\n        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);\n        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n      }\n    }\n  }\n  return lightColor;\n}\n",Ka={props:{},name:"gouraudMaterial",vs:"uniform phongMaterialUniforms {\n  uniform float ambient;\n  uniform float diffuse;\n  uniform float shininess;\n  uniform vec3  specularColor;\n} material;\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {\n  vec3 halfway_direction = normalize(light_direction + view_direction);\n  float lambertian = dot(light_direction, normal_worldspace);\n  float specular = 0.0;\n  if (lambertian > 0.0) {\n    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);\n    specular = pow(specular_angle, material.shininess);\n  }\n  lambertian = max(lambertian, 0.0);\n  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;\n}\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {\n  vec3 lightColor = surfaceColor;\n\n  if (lighting.enabled == 0) {\n    return lightColor;\n  }\n\n  vec3 view_direction = normalize(cameraPosition - position_worldspace);\n  lightColor = material.ambient * surfaceColor * lighting.ambientColor;\n\n  for (int i = 0; i < lighting.pointLightCount; i++) {\n    PointLight pointLight = lighting_getPointLight(i);\n    vec3 light_position_worldspace = pointLight.position;\n    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));\n    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);\n  }\n\n  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);\n  for (int i = lighting.pointLightCount; i < totalLights; i++) {\n    DirectionalLight directionalLight = lighting_getDirectionalLight(i);\n    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n  }\n  \n  return lightColor;\n}\n".replace("phongMaterial","gouraudMaterial"),fs:Xa.replace("phongMaterial","gouraudMaterial"),source:Ya.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:1},dependencies:[Wa],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(e){const t={...e};return t.specularColor&&(t.specularColor=t.specularColor.map((e=>e/255))),{...Ka.defaultUniforms,...t}}},qa="uniform layerUniforms {\n  uniform float opacity;\n} layer;\n",Za={name:"layer",vs:qa,fs:qa,getUniforms:e=>({opacity:Math.pow(e.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},Qa="#define SMOOTH_EDGE_RADIUS 0.5",Ja={name:"geometry",source:"const SMOOTH_EDGE_RADIUS: f32 = 0.5;\n\nstruct VertexGeometry {\n  position: vec4<f32>,\n  worldPosition: vec3<f32>,\n  worldPositionAlt: vec3<f32>,\n  normal: vec3<f32>,\n  uv: vec2<f32>,\n  pickingColor: vec3<f32>,\n};\n\nvar<private> geometry_: VertexGeometry = VertexGeometry(\n  vec4<f32>(0.0, 0.0, 1.0, 0.0),\n  vec3<f32>(0.0, 0.0, 0.0),\n  vec3<f32>(0.0, 0.0, 0.0),\n  vec3<f32>(0.0, 0.0, 0.0),\n  vec2<f32>(0.0, 0.0),\n  vec3<f32>(0.0, 0.0, 0.0)\n);\n\nstruct FragmentGeometry {\n  uv: vec2<f32>,\n};\n\nvar<private> fragmentGeometry: FragmentGeometry;\n\nfn smoothedge(edge: f32, x: f32) -> f32 {\n  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);\n}\n",vs:`${Qa}\n\nstruct VertexGeometry {\n  vec4 position;\n  vec3 worldPosition;\n  vec3 worldPositionAlt;\n  vec3 normal;\n  vec2 uv;\n  vec3 pickingColor;\n} geometry = VertexGeometry(\n  vec4(0.0, 0.0, 1.0, 0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec2(0.0),\n  vec3(0.0)\n);\n`,fs:`${Qa}\n\nstruct FragmentGeometry {\n  vec2 uv;\n} geometry;\n\nfloat smoothedge(float edge, float x) {\n  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);\n}\n`};var el,tl,nl,il,sl,rl;(tl=el||(el={}))[tl.Start=1]="Start",tl[tl.Move=2]="Move",tl[tl.End=4]="End",tl[tl.Cancel=8]="Cancel",(il=nl||(nl={}))[il.None=0]="None",il[il.Left=1]="Left",il[il.Right=2]="Right",il[il.Up=4]="Up",il[il.Down=8]="Down",il[il.Horizontal=3]="Horizontal",il[il.Vertical=12]="Vertical",il[il.All=15]="All",(rl=sl||(sl={}))[rl.Possible=1]="Possible",rl[rl.Began=2]="Began",rl[rl.Changed=4]="Changed",rl[rl.Ended=8]="Ended",rl[rl.Recognized=8]="Recognized",rl[rl.Cancelled=16]="Cancelled",rl[rl.Failed=32]="Failed";const ol="manipulation",al="none",ll="pan-x",cl="pan-y";class ul{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){"compute"===e&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return function(e){if(e.includes(al))return al;const t=e.includes(ll),n=e.includes(cl);return t&&n?al:t||n?t?ll:cl:e.includes(ol)?ol:"auto"}(e.join(" "))}}function hl(e){return e.trim().split(/\s+/g)}function dl(e,t,n){if(e)for(const i of hl(t))e.addEventListener(i,n,!1)}function fl(e,t,n){if(e)for(const i of hl(t))e.removeEventListener(i,n,!1)}function pl(e){return(e.ownerDocument||e).defaultView}function gl(e){const t=e.length;if(1===t)return{x:Math.round(e[0].clientX),y:Math.round(e[0].clientY)};let n=0,i=0,s=0;for(;s<t;)n+=e[s].clientX,i+=e[s].clientY,s++;return{x:Math.round(n/t),y:Math.round(i/t)}}function ml(e){const t=[];let n=0;for(;n<e.pointers.length;)t[n]={clientX:Math.round(e.pointers[n].clientX),clientY:Math.round(e.pointers[n].clientY)},n++;return{timeStamp:Date.now(),pointers:t,center:gl(t),deltaX:e.deltaX,deltaY:e.deltaY}}function _l(e,t){const n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)}function yl(e,t){const n=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.sqrt(n*n+i*i)}function vl(e,t){const n=t.clientX-e.clientX,i=t.clientY-e.clientY;return 180*Math.atan2(i,n)/Math.PI}function bl(e,t){return e===t?nl.None:Math.abs(e)>=Math.abs(t)?e<0?nl.Left:nl.Right:t<0?nl.Up:nl.Down}function El(e,t,n){return{x:t/e||0,y:n/e||0}}function xl(e,t){const{session:n}=e,{pointers:i}=t,{length:s}=i;n.firstInput||(n.firstInput=ml(t)),s>1&&!n.firstMultiple?n.firstMultiple=ml(t):1===s&&(n.firstMultiple=!1);const{firstInput:r,firstMultiple:o}=n,a=o?o.center:r.center,l=t.center=gl(i);t.timeStamp=Date.now(),t.deltaTime=t.timeStamp-r.timeStamp,t.angle=function(e,t){const n=t.x-e.x,i=t.y-e.y;return 180*Math.atan2(i,n)/Math.PI}(a,l),t.distance=_l(a,l);const{deltaX:c,deltaY:u}=function(e,t){const n=t.center;let i=e.offsetDelta,s=e.prevDelta;const r=e.prevInput;return t.eventType!==el.Start&&(null==r?void 0:r.eventType)!==el.End||(s=e.prevDelta={x:(null==r?void 0:r.deltaX)||0,y:(null==r?void 0:r.deltaY)||0},i=e.offsetDelta={x:n.x,y:n.y}),{deltaX:s.x+(n.x-i.x),deltaY:s.y+(n.y-i.y)}}(n,t);t.deltaX=c,t.deltaY=u,t.offsetDirection=bl(t.deltaX,t.deltaY);const h=El(t.deltaTime,t.deltaX,t.deltaY);var d,f;t.overallVelocityX=h.x,t.overallVelocityY=h.y,t.overallVelocity=Math.abs(h.x)>Math.abs(h.y)?h.x:h.y,t.scale=o?(d=o.pointers,yl((f=i)[0],f[1])/yl(d[0],d[1])):1,t.rotation=o?function(e,t){return vl(t[1],t[0])-vl(e[1],e[0])}(o.pointers,i):0,t.maxPointers=n.prevInput?t.pointers.length>n.prevInput.maxPointers?t.pointers.length:n.prevInput.maxPointers:t.pointers.length;let p=e.element;return function(e,t){let n=e;for(;n;){if(n===t)return!0;n=n.parentNode}return!1}(t.srcEvent.target,p)&&(p=t.srcEvent.target),t.target=p,function(e,t){const n=e.lastInterval||t,i=t.timeStamp-n.timeStamp;let s,r,o,a;if(t.eventType!==el.Cancel&&(i>25||void 0===n.velocity)){const l=t.deltaX-n.deltaX,c=t.deltaY-n.deltaY,u=El(i,l,c);r=u.x,o=u.y,s=Math.abs(u.x)>Math.abs(u.y)?u.x:u.y,a=bl(l,c),e.lastInterval=t}else s=n.velocity,r=n.velocityX,o=n.velocityY,a=n.direction;t.velocity=s,t.velocityX=r,t.velocityY=o,t.direction=a}(n,t),t}let wl=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=e=>{this.manager.options.enable&&this.handler(e)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){!function(e,t,n){const i=n.pointers.length,s=n.changedPointers.length,r=t&el.Start&&i-s==0,o=t&(el.End|el.Cancel)&&i-s==0;n.isFirst=Boolean(r),n.isFinal=Boolean(o),r&&(e.session={}),n.eventType=t;const a=xl(e,n);e.emit("hammer.input",a),e.recognize(a),e.session.prevInput=a}(this.manager,e,t)}init(){dl(this.element,this.evEl,this.domHandler),dl(this.target,this.evTarget,this.domHandler),dl(pl(this.element),this.evWin,this.domHandler)}destroy(){fl(this.element,this.evEl,this.domHandler),fl(this.target,this.evTarget,this.domHandler),fl(pl(this.element),this.evWin,this.domHandler)}};const Tl={pointerdown:el.Start,pointermove:el.Move,pointerup:el.End,pointercancel:el.Cancel,pointerout:el.Cancel};class Al extends wl{constructor(e){super(e),this.evEl="pointerdown",this.evWin="pointermove pointerup pointercancel",this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let n=!1;const i=Tl[e.type],s=e.pointerType,r="touch"===s;let o=t.findIndex((t=>t.pointerId===e.pointerId));i&el.Start&&(e.buttons||r)?o<0&&(t.push(e),o=t.length-1):i&(el.End|el.Cancel)&&(n=!0),o<0||(t[o]=e,this.callback(i,{pointers:t,changedPointers:[e],eventType:i,pointerType:s,srcEvent:e}),n&&t.splice(o,1))}}const Sl=["","webkit","Moz","MS","ms","o"];function Rl(e,t){const n=t[0].toUpperCase()+t.slice(1);for(const i of Sl){const s=i?i+n:t;if(s in e)return s}}const Pl={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class Cl{constructor(e,t){this.options={...Pl,...t,cssProps:{...Pl.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new Al(this),this.touchAction=new ul(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?2:1}recognize(e){const{session:t}=this;if(t.stopped)return;let n;this.session.prevented&&e.srcEvent.preventDefault();const{recognizers:i}=this;let{curRecognizer:s}=t;(!s||s&&s.state&sl.Recognized)&&(s=t.curRecognizer=null);let r=0;for(;r<i.length;)n=i[r],2===t.stopped||s&&n!==s&&!n.canRecognizeWith(s)?n.reset():n.recognize(e),!s&&n.state&(sl.Began|sl.Changed|sl.Ended)&&(s=t.curRecognizer=n),r++}get(e){const{recognizers:t}=this;for(let n=0;n<t.length;n++)if(t[n].options.event===e)return t[n];return null}add(e){if(Array.isArray(e)){for(const t of e)this.add(t);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const t of e)this.remove(t);return this}const t="string"==typeof e?this.get(e):e;if(t){const{recognizers:e}=this,n=e.indexOf(t);-1!==n&&(e.splice(n,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:n}=this;for(const i of hl(e))n[i]=n[i]||[],n[i].push(t)}off(e,t){if(!e)return;const{handlers:n}=this;for(const i of hl(e))t?n[i]&&n[i].splice(n[i].indexOf(t),1):delete n[i]}emit(e,t){const n=this.handlers[e]&&this.handlers[e].slice();if(!n||!n.length)return;const i=t;i.type=e,i.preventDefault=function(){t.srcEvent.preventDefault()};let s=0;for(;s<n.length;)n[s](i),s++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[n,i]of Object.entries(this.options.cssProps)){const s=Rl(t.style,n);e?(this.oldCssProps[s]=t.style[s],t.style[s]=i):t.style[s]=this.oldCssProps[s]||""}e||(this.oldCssProps={})}}}let Il=1;function Ll(e){return e&sl.Cancelled?"cancel":e&sl.Ended?"end":e&sl.Changed?"move":e&sl.Began?"start":""}class Ml{constructor(e){this.options=e,this.id=Il++,this.state=sl.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const t of e)this.recognizeWith(t);return this}let t;if("string"==typeof e){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:n}=this;return n[t.id]||(n[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const t of e)this.dropRecognizeWith(t);return this}let t;return t="string"==typeof e?this.manager.get(e):e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const t of e)this.requireFailure(t);return this}let t;if("string"==typeof e){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:n}=this;return-1===n.indexOf(t)&&(n.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const t of e)this.dropRequireFailure(t);return this}let t;if(t="string"==typeof e?this.manager.get(e):e,t){const e=this.requireFail.indexOf(t);e>-1&&this.requireFail.splice(e,1)}return this}hasRequireFailures(){return Boolean(this.requireFail.find((e=>e.options.enable)))}canRecognizeWith(e){return Boolean(this.simultaneous[e.id])}emit(e){if(!e)return;const{state:t}=this;t<sl.Ended&&this.manager.emit(this.options.event+Ll(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=sl.Ended&&this.manager.emit(this.options.event+Ll(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=sl.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(sl.Failed|sl.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable)return this.reset(),void(this.state=sl.Failed);this.state&(sl.Recognized|sl.Cancelled|sl.Failed)&&(this.state=sl.Possible),this.state=this.process(t),this.state&(sl.Began|sl.Changed|sl.Ended|sl.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class kl extends Ml{attrTest(e){const t=this.options.pointers;return 0===t||e.pointers.length===t}process(e){const{state:t}=this,{eventType:n}=e,i=t&(sl.Began|sl.Changed),s=this.attrTest(e);return i&&(n&el.Cancel||!s)?t|sl.Cancelled:i||s?n&el.End?t|sl.Ended:t&sl.Began?t|sl.Changed:sl.Began:sl.Failed}}class Ol extends Ml{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[ol]}process(e){const{options:t}=this,n=e.pointers.length===t.pointers,i=e.distance<t.threshold,s=e.deltaTime<t.time;if(this.reset(),e.eventType&el.Start&&0===this.count)return this.failTimeout();if(i&&s&&n){if(e.eventType!==el.End)return this.failTimeout();const n=!this.pTime||e.timeStamp-this.pTime<t.interval,i=!this.pCenter||_l(this.pCenter,e.center)<t.posThreshold;this.pTime=e.timeStamp,this.pCenter=e.center,i&&n?this.count+=1:this.count=1,this._input=e;if(0===this.count%t.taps)return this.hasRequireFailures()?(this._timer=setTimeout((()=>{this.state=sl.Recognized,this.tryEmit(this._input)}),t.interval),sl.Began):sl.Recognized}return sl.Failed}failTimeout(){return this._timer=setTimeout((()=>{this.state=sl.Failed}),this.options.interval),sl.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===sl.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const Nl=["","start","move","end","cancel","up","down","left","right"];class Fl extends kl{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:nl.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&nl.Horizontal&&t.push(cl),e&nl.Vertical&&t.push(ll),t}getEventNames(){return Nl.map((e=>this.options.event+e))}directionTest(e){const{options:t}=this;let n=!0,{distance:i}=e,{direction:s}=e;const r=e.deltaX,o=e.deltaY;return s&t.direction||(t.direction&nl.Horizontal?(s=0===r?nl.None:r<0?nl.Left:nl.Right,n=r!==this.pX,i=Math.abs(e.deltaX)):(s=0===o?nl.None:o<0?nl.Up:nl.Down,n=o!==this.pY,i=Math.abs(e.deltaY))),e.direction=s,n&&i>t.threshold&&Boolean(s&t.direction)}attrTest(e){return super.attrTest(e)&&(Boolean(this.state&sl.Began)||!(this.state&sl.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=nl[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const Bl=["","start","move","end","cancel","in","out"];class Dl{constructor(e,t,n){this.element=e,this.callback=t,this.options=n}}const Ul=-1!==("undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"").indexOf("firefox"),Gl=4.000244140625;class zl extends Dl{constructor(e,t,n){super(e,t,{enable:!0,...n}),this.handleEvent=e=>{if(!this.options.enable)return;let t=e.deltaY;globalThis.WheelEvent&&(Ul&&e.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(t/=globalThis.devicePixelRatio),e.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(t*=40)),0!==t&&t%Gl==0&&(t=Math.floor(t/Gl)),e.shiftKey&&t&&(t*=.25),this.callback({type:"wheel",center:{x:e.clientX,y:e.clientY},delta:-t,srcEvent:e,pointerType:"mouse",target:e.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){"wheel"===e&&(this.options.enable=t)}}const Vl=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class Wl extends Dl{constructor(e,t,n){super(e,t,{enable:!0,...n}),this.handleEvent=e=>{this.handleOverEvent(e),this.handleOutEvent(e),this.handleEnterEvent(e),this.handleLeaveEvent(e),this.handleMoveEvent(e)},this.pressed=!1;const{enable:i}=this.options;this.enableMoveEvent=i,this.enableLeaveEvent=i,this.enableEnterEvent=i,this.enableOutEvent=i,this.enableOverEvent=i,Vl.forEach((t=>e.addEventListener(t,this.handleEvent)))}destroy(){Vl.forEach((e=>this.element.removeEventListener(e,this.handleEvent)))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t}}handleOverEvent(e){this.enableOverEvent&&"mouseover"===e.type&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&"mouseout"===e.type&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&"mouseenter"===e.type&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&"mouseleave"===e.type&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":0===e.buttons&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const jl=["keydown","keyup"];class Hl extends Dl{constructor(e,t,n){super(e,t,{enable:!0,tabIndex:0,...n}),this.handleEvent=e=>{const t=e.target||e.srcElement;"INPUT"===t.tagName&&"text"===t.type||"TEXTAREA"===t.tagName||(this.enableDownEvent&&"keydown"===e.type&&this.callback({type:"keydown",srcEvent:e,key:e.key,target:e.target}),this.enableUpEvent&&"keyup"===e.type&&this.callback({type:"keyup",srcEvent:e,key:e.key,target:e.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",jl.forEach((t=>e.addEventListener(t,this.handleEvent)))}destroy(){jl.forEach((e=>this.element.removeEventListener(e,this.handleEvent)))}enableEventType(e,t){"keydown"===e&&(this.enableDownEvent=t),"keyup"===e&&(this.enableUpEvent=t)}}class $l extends Dl{constructor(e,t,n){super(e,t,n),this.handleEvent=e=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){"contextmenu"===e&&(this.options.enable=t)}}const Xl={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4};function Yl(e){const t=Xl[e.srcEvent.type];if(!t)return null;const{buttons:n,button:i}=e.srcEvent;let s=!1,r=!1,o=!1;return 2===t?(s=Boolean(1&n),r=Boolean(4&n),o=Boolean(2&n)):(s=0===i,r=1===i,o=2===i),{leftButton:s,middleButton:r,rightButton:o}}function Kl(e,t){const n=e.center;if(!n)return null;const i=t.getBoundingClientRect(),s=i.width/t.offsetWidth||1,r=i.height/t.offsetHeight||1;return{center:n,offsetCenter:{x:(n.x-i.left-t.clientLeft)/s,y:(n.y-i.top-t.clientTop)/r}}}const ql={srcElement:"root",priority:0};class Zl{constructor(e,t){this.handleEvent=e=>{if(this.isEmpty())return;const t=this._normalizeEvent(e);let n=e.srcEvent.target;for(;n&&n!==t.rootElement;){if(this._emit(t,n),t.handled)return;n=n.parentNode}this._emit(t,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,n,i=!1,s=!1){const{handlers:r,handlersByElement:o}=this,a={...ql,...n};let l=o.get(a.srcElement);l||(l=[],o.set(a.srcElement,l));const c={type:e,handler:t,srcElement:a.srcElement,priority:a.priority};i&&(c.once=!0),s&&(c.passive=!0),r.push(c),this._active=this._active||!c.passive;let u=l.length-1;for(;u>=0&&!(l[u].priority>=c.priority);)u--;l.splice(u+1,0,c)}remove(e,t){const{handlers:n,handlersByElement:i}=this;for(let s=n.length-1;s>=0;s--){const r=n[s];if(r.type===e&&r.handler===t){n.splice(s,1);const e=i.get(r.srcElement);e.splice(e.indexOf(r),1),0===e.length&&i.delete(r.srcElement)}}this._active=n.some((e=>!e.passive))}_emit(e,t){const n=this.handlersByElement.get(t);if(n){let t=!1;const i=()=>{e.handled=!0},s=()=>{e.handled=!0,t=!0},r=[];for(let o=0;o<n.length;o++){const{type:a,handler:l,once:c}=n[o];if(l({...e,type:a,stopPropagation:i,stopImmediatePropagation:s}),c&&r.push(n[o]),t)break}for(let e=0;e<r.length;e++){const{type:t,handler:n}=r[e];this.remove(t,n)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...Yl(e),...Kl(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function Ql(e){if("recognizer"in e)return e;let t;const n=Array.isArray(e)?[...e]:[e];if("function"==typeof n[0]){t=new(n.shift())(n.shift()||{})}else t=n.shift();return{recognizer:t,recognizeWith:"string"==typeof n[0]?[n[0]]:n[0],requireFailure:"string"==typeof n[1]?[n[1]]:n[1]}}class Jl{constructor(e=null,t={}){if(this._onBasicInput=e=>{this.manager.emit(e.srcEvent.type,e)},this._onOtherEvent=e=>{this.manager.emit(e.type,e)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,e){this.manager=new Cl(e,this.options);for(const e of this.options.recognizers){const{recognizer:t,recognizeWith:n,requireFailure:i}=Ql(e);this.manager.add(t),n&&t.recognizeWith(n),i&&t.requireFailure(i)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new zl(e,this._onOtherEvent,{enable:!1}),this.moveInput=new Wl(e,this._onOtherEvent,{enable:!1}),this.keyInput=new Hl(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new $l(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,n){this._addEventHandler(e,t,n,!1)}once(e,t,n){this._addEventHandler(e,t,n,!0)}watch(e,t,n){this._addEventHandler(e,t,n,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){var n,i,s,r;const{manager:o}=this;if(!o)return;const a=o.get(e);a&&(a.set({enable:t}),o.touchAction.update()),null==(n=this.wheelInput)||n.enableEventType(e,t),null==(i=this.moveInput)||i.enableEventType(e,t),null==(s=this.keyInput)||s.enableEventType(e,t),null==(r=this.contextmenuInput)||r.enableEventType(e,t)}_addEventHandler(e,t,n,i,s){if("string"!=typeof e){n=t;for(const[t,r]of Object.entries(e))this._addEventHandler(t,r,n,i,s);return}const{manager:r,events:o}=this;if(!r)return;let a=o.get(e);if(!a){const t=this._getRecognizerName(e)||e;a=new Zl(this,t),o.set(e,a),r&&r.on(e,a.handleEvent)}a.add(e,t,n,i,s),a.isEmpty()||this._toggleRecognizer(a.recognizerName,!0)}_removeEventHandler(e,t){if("string"!=typeof e){for(const[t,n]of Object.entries(e))this._removeEventHandler(t,n);return}const{events:n}=this,i=n.get(e);if(i&&(i.remove(e,t),i.isEmpty())){const{recognizerName:e}=i;let t=!1;for(const i of n.values())if(i.recognizerName===e&&!i.isEmpty()){t=!0;break}t||this._toggleRecognizer(e,!1)}}_getRecognizerName(e){var t;return null==(t=this.manager.recognizers.find((t=>t.getEventNames().includes(e))))?void 0:t.options.event}}const ec={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(ec,"IDENTITY",{get:()=>(ln.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const tc={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},nc={common:0,meters:1,pixels:2},ic={click:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},sc={multipan:[Fl,{threshold:10,direction:nl.Vertical,pointers:2}],pinch:[class extends kl{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[al]}getEventNames(){return Bl.map((e=>this.options.event+e))}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||Boolean(this.state&sl.Began))}emit(e){if(1!==e.scale){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}},{},null,["multipan"]],pan:[Fl,{threshold:1},["pinch"],["multipan"]],dblclick:[Ol,{event:"dblclick",taps:2}],click:[Ol,{event:"click"},null,["dblclick"]]};function rc(e,t){if(e===t)return!0;if(Array.isArray(e)){const n=e.length;if(!t||t.length!==n)return!1;for(let i=0;i<n;i++)if(e[i]!==t[i])return!1;return!0}return!1}function oc(e){let t,n={};return i=>{for(const s in i)if(!rc(i[s],n[s])){t=e(i),n=i;break}return t}}const ac=[0,0,0,0],lc=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],cc=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],uc=[0,0,0],hc=[0,0,0],dc=oc((function({viewport:e,devicePixelRatio:t,coordinateSystem:n,coordinateOrigin:i}){const{projectionCenter:s,viewProjectionMatrix:r,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:l,geospatialOrigin:c}=function(e,t,n){const{viewMatrixUncentered:i,projectionMatrix:s}=e;let{viewMatrix:r,viewProjectionMatrix:o}=e,a=ac,l=ac,c=e.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:d}=fc(e,t,n);d&&(l=e.projectPosition(u||h),c=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],l[3]=1,a=Ta([],l,o),r=i||r,o=_a([],s,r),o=_a([],o,lc));return{viewMatrix:r,viewProjectionMatrix:o,projectionCenter:a,originCommon:l,cameraPosCommon:c,shaderCoordinateOrigin:h,geospatialOrigin:u}}(e,n,i),u=e.getDistanceScales(),h=[e.width*t,e.height*t],d=Ta([],[0,0,-e.focalDistance,1],e.projectionMatrix)[3]||1,f={coordinateSystem:n,projectionMode:e.projectionMode,coordinateOrigin:l,commonOrigin:o.slice(0,3),center:s,pseudoMeters:Boolean(e._pseudoMeters),viewportSize:h,devicePixelRatio:t,focalDistance:d,commonUnitsPerMeter:u.unitsPerMeter,commonUnitsPerWorldUnit:u.unitsPerMeter,commonUnitsPerWorldUnit2:uc,scale:e.scale,wrapLongitude:!1,viewProjectionMatrix:r,modelMatrix:cc,cameraPosition:a};if(c){const t=e.getDistanceScales(c);switch(n){case ec.METER_OFFSETS:f.commonUnitsPerWorldUnit=t.unitsPerMeter,f.commonUnitsPerWorldUnit2=t.unitsPerMeter2;break;case ec.LNGLAT:case ec.LNGLAT_OFFSETS:e._pseudoMeters||(f.commonUnitsPerMeter=t.unitsPerMeter),f.commonUnitsPerWorldUnit=t.unitsPerDegree,f.commonUnitsPerWorldUnit2=t.unitsPerDegree2;break;case ec.CARTESIAN:f.commonUnitsPerWorldUnit=[1,1,t.unitsPerMeter[2]],f.commonUnitsPerWorldUnit2=[0,0,t.unitsPerMeter2[2]]}}return f}));function fc(e,t,n=hc){n.length<3&&(n=[n[0],n[1],0]);let i,s=n,r=!0;switch(i=t===ec.LNGLAT_OFFSETS||t===ec.METER_OFFSETS?n:e.isGeospatial?[Math.fround(e.longitude),Math.fround(e.latitude),0]:null,e.projectionMode){case tc.WEB_MERCATOR:t!==ec.LNGLAT&&t!==ec.CARTESIAN||(i=[0,0,0],r=!1);break;case tc.WEB_MERCATOR_AUTO_OFFSET:t===ec.LNGLAT?s=i:t===ec.CARTESIAN&&(s=[Math.fround(e.center[0]),Math.fround(e.center[1]),0],i=e.unprojectPosition(s),s[0]-=n[0],s[1]-=n[1],s[2]-=n[2]);break;case tc.IDENTITY:s=e.position.map(Math.fround),s[2]=s[2]||0;break;case tc.GLOBE:r=!1,i=null;break;default:r=!1}return{geospatialOrigin:i,shaderCoordinateOrigin:s,offsetMode:r}}const pc=`${`${Object.keys(ec).map((e=>`const COORDINATE_SYSTEM_${e}: i32 = ${ec[e]};`)).join("")}\n${Object.keys(tc).map((e=>`const PROJECTION_MODE_${e}: i32 = ${tc[e]};`)).join("")}\n${Object.keys(nc).map((e=>`const UNIT_${e.toUpperCase()}: i32 = ${nc[e]};`)).join("")}\n\nconst TILE_SIZE: f32 = 512.0;\nconst PI: f32 = 3.1415926536;\nconst WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);\nconst ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);\nconst EARTH_RADIUS: f32 = 6370972.0; // meters\nconst GLOBE_RADIUS: f32 = 256.0;\n\n// -----------------------------------------------------------------------------\n// Uniform block (converted from GLSL uniform block)\n// -----------------------------------------------------------------------------\nstruct ProjectUniforms {\n  wrapLongitude: i32,\n  coordinateSystem: i32,\n  commonUnitsPerMeter: vec3<f32>,\n  projectionMode: i32,\n  scale: f32,\n  commonUnitsPerWorldUnit: vec3<f32>,\n  commonUnitsPerWorldUnit2: vec3<f32>,\n  center: vec4<f32>,\n  modelMatrix: mat4x4<f32>,\n  viewProjectionMatrix: mat4x4<f32>,\n  viewportSize: vec2<f32>,\n  devicePixelRatio: f32,\n  focalDistance: f32,\n  cameraPosition: vec3<f32>,\n  coordinateOrigin: vec3<f32>,\n  commonOrigin: vec3<f32>,\n  pseudoMeters: i32,\n};\n\n@group(0) @binding(0)\nvar<uniform> project: ProjectUniforms;\n\n// -----------------------------------------------------------------------------\n// Geometry data\n// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,\n// you might supply this via vertex attributes or a uniform. Here we define a\n// uniform struct for demonstration.)\n// -----------------------------------------------------------------------------\n\n// Structure to carry additional geometry data used by deck.gl filters.\nstruct Geometry {\n  worldPosition: vec3<f32>,\n  worldPositionAlt: vec3<f32>,\n  position: vec4<f32>,\n  uv: vec2<f32>,\n  pickingColor: vec3<f32>,\n};\n\n// @group(0) @binding(1)\nvar<private> geometry: Geometry;\n`}\n\n// -----------------------------------------------------------------------------\n// Functions\n// -----------------------------------------------------------------------------\n\n// Returns an adjustment factor for commonUnitsPerMeter\nfn _project_size_at_latitude(lat: f32) -> f32 {\n  let y = clamp(lat, -89.9, 89.9);\n  return 1.0 / cos(radians(y));\n}\n\n// Overloaded version: scales a value in meters at a given latitude.\nfn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {\n  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);\n}\n\n// Computes a non-linear scale factor based on geometry.\n// (Note: This function relies on "geometry" being provided.)\nfn project_size() -> f32 {\n  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&\n      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&\n      project.pseudoMeters == 0) {\n    if (geometry.position.w == 0.0) {\n      return _project_size_at_latitude(geometry.worldPosition.y);\n    }\n    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;\n    let y2 = y * y;\n    let y4 = y2 * y2;\n    let y6 = y4 * y2;\n    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;\n  }\n  return 1.0;\n}\n\n// Overloads to scale offsets (meters to world units)\nfn project_size_float(meters: f32) -> f32 {\n  return meters * project.commonUnitsPerMeter.z * project_size();\n}\n\nfn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {\n  return meters * project.commonUnitsPerMeter.xy * project_size();\n}\n\nfn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {\n  return meters * project.commonUnitsPerMeter * project_size();\n}\n\nfn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {\n  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);\n}\n\n// Returns a rotation matrix aligning the z‑axis with the given up vector.\nfn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {\n  let uz = normalize(up);\n  let ux = select(\n    vec3<f32>(1.0, 0.0, 0.0),\n    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),\n    abs(uz.z) == 1.0\n  );\n  let uy = cross(uz, ux);\n  return mat3x3<f32>(ux, uy, uz);\n}\n\n// Since WGSL does not support "out" parameters, we return a struct.\nstruct RotationResult {\n  needsRotation: bool,\n  transform: mat3x3<f32>,\n};\n\nfn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {\n  if (project.projectionMode == PROJECTION_MODE_GLOBE) {\n    return RotationResult(true, project_get_orientation_matrix(commonPosition));\n  } else {\n    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed\n  };\n}\n\n// Projects a normal vector from the current coordinate system to world space.\nfn project_normal(vector: vec3<f32>) -> vec3<f32> {\n  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);\n  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);\n  let rotResult = project_needs_rotation(geometry.position.xyz);\n  if (rotResult.needsRotation) {\n    n = rotResult.transform * n;\n  }\n  return n;\n}\n\n// Applies a scale offset based on y-offset (dy)\nfn project_offset_(offset: vec4<f32>) -> vec4<f32> {\n  let dy: f32 = offset.y;\n  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;\n  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);\n}\n\n// Projects lng/lat coordinates to a unit tile [0,1]\nfn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {\n  var x = lnglat.x;\n  if (project.wrapLongitude != 0) {\n    x = ((x + 180.0) % 360.0) - 180.0;\n  }\n  let y = clamp(lnglat.y, -89.9, 89.9);\n  return vec2<f32>(\n    radians(x) + PI,\n    PI + log(tan(PI * 0.25 + radians(y) * 0.5))\n  ) * WORLD_SCALE;\n}\n\n// Projects lng/lat/z coordinates for a globe projection.\nfn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {\n  let lambda = radians(lnglatz.x);\n  let phi = radians(lnglatz.y);\n  let cosPhi = cos(phi);\n  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;\n  return vec3<f32>(\n    sin(lambda) * cosPhi,\n    -cos(lambda) * cosPhi,\n    sin(phi)\n  ) * D;\n}\n\n// Projects positions (with an optional 64-bit low part) from the input\n// coordinate system to the common space.\nfn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {\n  var position_world = project.modelMatrix * position;\n\n  // Work around for a Mac+NVIDIA bug:\n  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {\n    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4<f32>(\n        project_mercator_(position_world.xy),\n        _project_size_at_latitude_m(position_world.z, position_world.y),\n        position_world.w\n      );\n    }\n    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {\n      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);\n    }\n  }\n  if (project.projectionMode == PROJECTION_MODE_GLOBE) {\n    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4<f32>(\n        project_globe_(position_world.xyz),\n        position_world.w\n      );\n    }\n  }\n  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {\n    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {\n        return vec4<f32>(\n          project_mercator_(position_world.xy) - project.commonOrigin.xy,\n          project_size_float(position_world.z),\n          position_world.w\n        );\n      }\n    }\n  }\n  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||\n      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&\n       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\n        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {\n    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);\n  }\n\n  return project_offset_(position_world) +\n         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));\n}\n\n// Overloaded versions for different input types.\nfn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {\n  return project_position_vec4_f64(position, ZERO_64_LOW);\n}\n\nfn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {\n  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);\n  return projected_position.xyz;\n}\n\nfn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {\n  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);\n  return projected_position.xyz;\n}\n\nfn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {\n  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);\n  return projected_position.xy;\n}\n\n// Transforms a common space position to clip space.\nfn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {\n  return viewProjectionMatrix * position + center;\n}\n\n// Uses the project viewProjectionMatrix and center.\nfn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {\n  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);\n}\n\n// Returns a clip space offset corresponding to a given number of screen pixels.\nfn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {\n  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;\n  return offset * project.focalDistance;\n}\n\nfn project_meter_size_to_pixel(meters: f32) -> f32 {\n  return project_size_float(meters) * project.scale;\n}\n\nfn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {\n  if (unit == UNIT_METERS) {\n    return project_meter_size_to_pixel(size);\n  } else if (unit == UNIT_COMMON) {\n    return size * project.scale;\n  }\n  // UNIT_PIXELS: no scaling applied.\n  return size;\n}\n\nfn project_pixel_size_float(pixels: f32) -> f32 {\n  return pixels / project.scale;\n}\n\nfn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {\n  return pixels / project.scale;\n}\n`,gc=Object.keys(ec).map((e=>`const int COORDINATE_SYSTEM_${e} = ${ec[e]};`)).join(""),mc=Object.keys(tc).map((e=>`const int PROJECTION_MODE_${e} = ${tc[e]};`)).join(""),_c=Object.keys(nc).map((e=>`const int UNIT_${e.toUpperCase()} = ${nc[e]};`)).join(""),yc={};const vc={name:"project",dependencies:[Ba,Ja],source:pc,vs:`${gc}\n${mc}\n${_c}\nuniform projectUniforms {\nbool wrapLongitude;\nint coordinateSystem;\nvec3 commonUnitsPerMeter;\nint projectionMode;\nfloat scale;\nvec3 commonUnitsPerWorldUnit;\nvec3 commonUnitsPerWorldUnit2;\nvec4 center;\nmat4 modelMatrix;\nmat4 viewProjectionMatrix;\nvec2 viewportSize;\nfloat devicePixelRatio;\nfloat focalDistance;\nvec3 cameraPosition;\nvec3 coordinateOrigin;\nvec3 commonOrigin;\nbool pseudoMeters;\n} project;\nconst float TILE_SIZE = 512.0;\nconst float PI = 3.1415926536;\nconst float WORLD_SCALE = TILE_SIZE / (PI * 2.0);\nconst vec3 ZERO_64_LOW = vec3(0.0);\nconst float EARTH_RADIUS = 6370972.0;\nconst float GLOBE_RADIUS = 256.0;\nfloat project_size_at_latitude(float lat) {\nfloat y = clamp(lat, -89.9, 89.9);\nreturn 1.0 / cos(radians(y));\n}\nfloat project_size() {\nif (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&\nproject.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&\nproject.pseudoMeters == false) {\nif (geometry.position.w == 0.0) {\nreturn project_size_at_latitude(geometry.worldPosition.y);\n}\nfloat y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;\nfloat y2 = y * y;\nfloat y4 = y2 * y2;\nfloat y6 = y4 * y2;\nreturn 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;\n}\nreturn 1.0;\n}\nfloat project_size_at_latitude(float meters, float lat) {\nreturn meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);\n}\nfloat project_size(float meters) {\nreturn meters * project.commonUnitsPerMeter.z * project_size();\n}\nvec2 project_size(vec2 meters) {\nreturn meters * project.commonUnitsPerMeter.xy * project_size();\n}\nvec3 project_size(vec3 meters) {\nreturn meters * project.commonUnitsPerMeter * project_size();\n}\nvec4 project_size(vec4 meters) {\nreturn vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);\n}\nmat3 project_get_orientation_matrix(vec3 up) {\nvec3 uz = normalize(up);\nvec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));\nvec3 uy = cross(uz, ux);\nreturn mat3(ux, uy, uz);\n}\nbool project_needs_rotation(vec3 commonPosition, out mat3 transform) {\nif (project.projectionMode == PROJECTION_MODE_GLOBE) {\ntransform = project_get_orientation_matrix(commonPosition);\nreturn true;\n}\nreturn false;\n}\nvec3 project_normal(vec3 vector) {\nvec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);\nvec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);\nmat3 rotation;\nif (project_needs_rotation(geometry.position.xyz, rotation)) {\nn = rotation * n;\n}\nreturn n;\n}\nvec4 project_offset_(vec4 offset) {\nfloat dy = offset.y;\nvec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;\nreturn vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);\n}\nvec2 project_mercator_(vec2 lnglat) {\nfloat x = lnglat.x;\nif (project.wrapLongitude) {\nx = mod(x + 180., 360.0) - 180.;\n}\nfloat y = clamp(lnglat.y, -89.9, 89.9);\nreturn vec2(\nradians(x) + PI,\nPI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))\n) * WORLD_SCALE;\n}\nvec3 project_globe_(vec3 lnglatz) {\nfloat lambda = radians(lnglatz.x);\nfloat phi = radians(lnglatz.y);\nfloat cosPhi = cos(phi);\nfloat D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;\nreturn vec3(\nsin(lambda) * cosPhi,\n-cos(lambda) * cosPhi,\nsin(phi)\n) * D;\n}\nvec4 project_position(vec4 position, vec3 position64Low) {\nvec4 position_world = project.modelMatrix * position;\nif (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {\nif (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\nreturn vec4(\nproject_mercator_(position_world.xy),\nproject_size_at_latitude(position_world.z, position_world.y),\nposition_world.w\n);\n}\nif (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {\nposition_world.xyz += project.coordinateOrigin;\n}\n}\nif (project.projectionMode == PROJECTION_MODE_GLOBE) {\nif (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\nreturn vec4(\nproject_globe_(position_world.xyz),\nposition_world.w\n);\n}\n}\nif (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {\nif (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\nif (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {\nreturn vec4(\nproject_mercator_(position_world.xy) - project.commonOrigin.xy,\nproject_size(position_world.z),\nposition_world.w\n);\n}\n}\n}\nif (project.projectionMode == PROJECTION_MODE_IDENTITY ||\n(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&\n(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\nproject.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {\nposition_world.xyz -= project.coordinateOrigin;\n}\nreturn project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));\n}\nvec4 project_position(vec4 position) {\nreturn project_position(position, ZERO_64_LOW);\n}\nvec3 project_position(vec3 position, vec3 position64Low) {\nvec4 projected_position = project_position(vec4(position, 1.0), position64Low);\nreturn projected_position.xyz;\n}\nvec3 project_position(vec3 position) {\nvec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);\nreturn projected_position.xyz;\n}\nvec2 project_position(vec2 position) {\nvec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);\nreturn projected_position.xy;\n}\nvec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {\nreturn viewProjectionMatrix * position + center;\n}\nvec4 project_common_position_to_clipspace(vec4 position) {\nreturn project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);\n}\nvec2 project_pixel_size_to_clipspace(vec2 pixels) {\nvec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;\nreturn offset * project.focalDistance;\n}\nfloat project_size_to_pixel(float meters) {\nreturn project_size(meters) * project.scale;\n}\nfloat project_size_to_pixel(float size, int unit) {\nif (unit == UNIT_METERS) return project_size_to_pixel(size);\nif (unit == UNIT_COMMON) return size * project.scale;\nreturn size;\n}\nfloat project_pixel_size(float pixels) {\nreturn pixels / project.scale;\n}\nvec2 project_pixel_size(vec2 pixels) {\nreturn pixels / project.scale;\n}\n`,getUniforms:function(e=yc){return"viewport"in e?function({viewport:e,devicePixelRatio:t=1,modelMatrix:n=null,coordinateSystem:i=ec.DEFAULT,coordinateOrigin:s=hc,autoWrapLongitude:r=!1}){i===ec.DEFAULT&&(i=e.isGeospatial?ec.LNGLAT:ec.CARTESIAN);const o=dc({viewport:e,devicePixelRatio:t,coordinateSystem:i,coordinateOrigin:s});return o.wrapLongitude=r,o.modelMatrix=n||cc,o}(e):{}},uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},bc={name:"project32",dependencies:[vc],source:"// Define a structure to hold both the clip-space position and the common position.\nstruct ProjectResult {\n  clipPosition: vec4<f32>,\n  commonPosition: vec4<f32>,\n};\n\n// This function mimics the GLSL version with the 'out' parameter by returning both values.\nfn project_position_to_clipspace_and_commonspace(\n    position: vec3<f32>,\n    position64Low: vec3<f32>,\n    offset: vec3<f32>\n) -> ProjectResult {\n  // Compute the projected position.\n  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);\n\n  // Start with the provided offset.\n  var finalOffset: vec3<f32> = offset;\n\n  // Get whether a rotation is needed and the rotation matrix.\n  let rotationResult = project_needs_rotation(projectedPosition);\n\n  // If rotation is needed, update the offset.\n  if (rotationResult.needsRotation) {\n    finalOffset = rotationResult.transform * offset;\n  }\n\n  // Compute the common position.\n  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);\n\n  // Convert to clip-space.\n  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);\n\n  return ProjectResult(clipPosition, commonPosition);\n}\n\n// A convenience overload that returns only the clip-space position.\nfn project_position_to_clipspace(\n    position: vec3<f32>,\n    position64Low: vec3<f32>,\n    offset: vec3<f32>\n) -> vec4<f32> {\n  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;\n}\n",vs:"vec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition\n) {\n  vec3 projectedPosition = project_position(position, position64Low);\n  mat3 rotation;\n  if (project_needs_rotation(projectedPosition, rotation)) {\n    // offset is specified as ENU\n    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe\n    offset = rotation * offset;\n  }\n  commonPosition = vec4(projectedPosition + offset, 1.0);\n  return project_common_position_to_clipspace(commonPosition);\n}\n\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset\n) {\n  vec4 commonPosition;\n  return project_position_to_clipspace(position, position64Low, offset, commonPosition);\n}\n"};function Ec(e,t){const n=Ta([],t,e);var i,s,r;return i=n,s=n,r=1/n[3],i[0]=s[0]*r,i[1]=s[1]*r,i[2]=s[2]*r,i[3]=s[3]*r,n}function xc(e,t){const n=e%t;return n<0?t+n:n}function wc(e,t,n){return e<t?t:e>n?n:e}const Tc=Math.log2||function(e){return Math.log(e)*Math.LOG2E};function Ac(e,t){if(!e)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}const Sc=Math.PI,Rc=Sc/4,Pc=Sc/180,Cc=180/Sc,Ic=512,Lc=4003e4,Mc=85.051129,kc=1.5;function Oc(e){return Math.pow(2,e)}function Nc(e){return Tc(e)}function Fc(e){const[t,n]=e;Ac(Number.isFinite(t)),Ac(Number.isFinite(n)&&n>=-90&&n<=90,"invalid latitude");const i=n*Pc;return[Ic*(t*Pc+Sc)/(2*Sc),Ic*(Sc+Math.log(Math.tan(Rc+.5*i)))/(2*Sc)]}function Bc(e){const[t,n]=e,i=t/Ic*(2*Sc)-Sc,s=2*(Math.atan(Math.exp(n/Ic*(2*Sc)-Sc))-Rc);return[i*Cc,s*Cc]}function Dc(e){return 12790407194604047e-21/Math.cos(e*Pc)}function Uc(e){const{latitude:t,longitude:n,highPrecision:i=!1}=e;Ac(Number.isFinite(t)&&Number.isFinite(n));const s=Ic,r=Math.cos(t*Pc),o=s/360,a=o/r,l=12790407194604047e-21/r,c={unitsPerMeter:[l,l,l],metersPerUnit:[1/l,1/l,1/l],unitsPerDegree:[o,a,l],degreesPerUnit:[.703125,1/a,1/l]};if(i){const e=Pc*Math.tan(t*Pc)/r,n=o*e/2,i=12790407194604047e-21*e,s=i/a*l;c.unitsPerDegree2=[0,n,i],c.unitsPerMeter2=[s,0,s]}return c}function Gc(e,t){const[n,i,s]=e,[r,o,a]=t,{unitsPerMeter:l,unitsPerMeter2:c}=Uc({longitude:n,latitude:i,highPrecision:!0}),u=Fc(e);u[0]+=r*(l[0]+c[0]*o),u[1]+=o*(l[1]+c[1]*o);const h=Bc(u),d=(s||0)+(a||0);return Number.isFinite(s)||Number.isFinite(a)?[h[0],h[1],d]:h}function zc(e){return 2*Math.atan(.5/e)*Cc}function Vc(e){return.5/Math.tan(.5*e*Pc)}function Wc(e,t){const[n,i,s=0]=e;return Ac(Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(s)),Ec(t,[n,i,s,1])}function jc(e,t,n=0){const[i,s,r]=e;if(Ac(Number.isFinite(i)&&Number.isFinite(s),"invalid pixel coordinate"),Number.isFinite(r)){return Ec(t,[i,s,r,1])}const o=Ec(t,[i,s,0,1]),a=Ec(t,[i,s,1,1]),l=o[2],c=a[2];return aa([],o,a,l===c?0:((n||0)-l)/(c-l))}function Hc(e){const{width:t,height:n,bounds:i,minExtent:s=0,maxZoom:r=24,offset:o=[0,0]}=e,[[a,l],[c,u]]=i,h=function(e=0){if("number"==typeof e)return{top:e,bottom:e,left:e,right:e};return Ac(Number.isFinite(e.top)&&Number.isFinite(e.bottom)&&Number.isFinite(e.left)&&Number.isFinite(e.right)),e}(e.padding),d=Fc([a,wc(u,-85.051129,Mc)]),f=Fc([c,wc(l,-85.051129,Mc)]),p=[Math.max(Math.abs(f[0]-d[0]),s),Math.max(Math.abs(f[1]-d[1]),s)],g=[t-h.left-h.right-2*Math.abs(o[0]),n-h.top-h.bottom-2*Math.abs(o[1])];Ac(g[0]>0&&g[1]>0);const m=g[0]/p[0],_=g[1]/p[1],y=(h.right-h.left)/2/m,v=(h.top-h.bottom)/2/_,b=Bc([(f[0]+d[0])/2+y,(f[1]+d[1])/2+v]),E=Math.min(r,Tc(Math.abs(Math.min(m,_))));return Ac(Number.isFinite(E)),{longitude:b[0],latitude:b[1],zoom:E}}const $c=Math.PI/180;function Xc(e,t,n){const{pixelUnprojectionMatrix:i}=e,s=Ec(i,[t,0,1,1]),r=Ec(i,[t,e.height,1,1]),o=Bc(aa([],s,r,(n*e.distanceScales.unitsPerMeter[2]-s[2])/(r[2]-s[2])));return o.push(n),o}const Yc=["longitude","latitude","zoom"],Kc={curve:1.414,speed:1.2};function qc(e,t,n){const i=(n=Object.assign({},Kc,n)).curve,s=e.zoom,r=[e.longitude,e.latitude],o=Oc(s),a=t.zoom,l=[t.longitude,t.latitude],c=Oc(a-s),u=Fc(r),h=Fc(l),d=la([],h,u),f=Math.max(e.width,e.height),p=f/c,g=function(e){const t=e[0],n=e[1];return Math.sqrt(t*t+n*n)}(d)*o,m=Math.max(g,.01),_=i*i,y=(p*p-f*f+_*_*m*m)/(2*f*_*m),v=(p*p-f*f-_*_*m*m)/(2*p*_*m),b=Math.log(Math.sqrt(y*y+1)-y),E=Math.log(Math.sqrt(v*v+1)-v);return{startZoom:s,startCenterXY:u,uDelta:d,w0:f,u1:g,S:(E-b)/i,rho:i,rho2:_,r0:b,r1:E}}const Zc="\nuniform shadowUniforms {\n  bool drawShadowMap;\n  bool useShadowMap;\n  vec4 color;\n  highp int lightId;\n  float lightCount;\n  mat4 viewProjectionMatrix0;\n  mat4 viewProjectionMatrix1;\n  vec4 projectCenter0;\n  vec4 projectCenter1;\n} shadow;\n",Qc=`\n${Zc}\n\nconst int max_lights = 2;\n\nout vec3 shadow_vPosition[max_lights];\n\nvec4 shadow_setVertexPosition(vec4 position_commonspace) {\n  mat4 viewProjectionMatrices[max_lights];\n  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;\n  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;\n  vec4 projectCenters[max_lights];\n  projectCenters[0] = shadow.projectCenter0;\n  projectCenters[1] = shadow.projectCenter1;\n\n  if (shadow.drawShadowMap) {\n    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);\n  }\n  if (shadow.useShadowMap) {\n    for (int i = 0; i < max_lights; i++) {\n      if(i < int(shadow.lightCount)) {\n        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);\n        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;\n      }\n    }\n  }\n  return gl_Position;\n}\n\n`,Jc=`\n${Zc}\n\nconst int max_lights = 2;\nuniform sampler2D shadow_uShadowMap0;\nuniform sampler2D shadow_uShadowMap1;\n\nin vec3 shadow_vPosition[max_lights];\n\nconst vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);\nconst vec4 bitUnpackShift = 1.0 / bitPackShift;\nconst vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);\n\nfloat shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {\n  vec4 rgbaDepth = texture(shadowMap, position.xy);\n\n  float z = dot(rgbaDepth, bitUnpackShift);\n  return smoothstep(0.001, 0.01, position.z - z);\n}\n\nvec4 shadow_filterShadowColor(vec4 color) {\n  if (shadow.drawShadowMap) {\n    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);\n    rgbaDepth -= rgbaDepth.gbaa * bitMask;\n    return rgbaDepth;\n  }\n  if (shadow.useShadowMap) {\n    float shadowAlpha = 0.0;\n    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);\n    if(shadow.lightCount > 1.0) {\n      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);\n    }\n    shadowAlpha *= shadow.color.a / shadow.lightCount;\n    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);\n\n    return vec4(\n      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),\n      blendedAlpha\n    );\n  }\n  return color;\n}\n\n`,eu=oc((function({viewport:e,center:t}){return new Ma(e.viewProjectionMatrix).invert().transform(t)})),tu=oc((function({viewport:e,shadowMatrices:t}){const n=[],i=e.pixelUnprojectionMatrix,s=e.isGeospatial?void 0:1,r=[[0,0,s],[e.width,0,s],[0,e.height,s],[e.width,e.height,s],[0,0,-1],[e.width,0,-1],[0,e.height,-1],[e.width,e.height,-1]].map((e=>function(e,t){const[n,i,s]=e,r=jc([n,i,s],t);if(Number.isFinite(s))return r;return[r[0],r[1],0]}(e,i)));for(const o of t){const t=o.clone().translate(new pa(e.center).negate()),i=r.map((e=>t.transform(e))),s=(new Ma).ortho({left:Math.min(...i.map((e=>e[0]))),right:Math.max(...i.map((e=>e[0]))),bottom:Math.min(...i.map((e=>e[1]))),top:Math.max(...i.map((e=>e[1]))),near:Math.min(...i.map((e=>-e[2]))),far:Math.max(...i.map((e=>-e[2])))});n.push(s.multiplyRight(o))}return n})),nu=[0,0,0,1],iu=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];const su={name:"shadow",dependencies:[vc],vs:Qc,fs:Jc,inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    position = shadow_setVertexPosition(geometry.position);\n    ","fs:DECKGL_FILTER_COLOR":"\n    color = shadow_filterShadowColor(color);\n    "},getUniforms:function(e){const{shadowEnabled:t=!0,project:n}=e;if(!(t&&n&&e.shadowMatrices&&e.shadowMatrices.length))return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:e.dummyShadowMap,shadow_uShadowMap1:e.dummyShadowMap};const i=vc.getUniforms(n),s=eu({viewport:n.viewport,center:i.center}),r=[],o=tu({shadowMatrices:e.shadowMatrices,viewport:n.viewport}).slice();for(let l=0;l<e.shadowMatrices.length;l++){const e=o[l],t=e.clone().translate(new pa(n.viewport.center).negate());i.coordinateSystem===ec.LNGLAT&&i.projectionMode===tc.WEB_MERCATOR?(o[l]=t,r[l]=s):(o[l]=e.clone().multiplyRight(iu),r[l]=t.transform(s))}const a={drawShadowMap:Boolean(e.drawToShadowMap),useShadowMap:!!e.shadowMaps&&e.shadowMaps.length>0,color:e.shadowColor||nu,lightId:e.shadowLightId||0,lightCount:e.shadowMatrices.length,shadow_uShadowMap0:e.dummyShadowMap,shadow_uShadowMap1:e.dummyShadowMap};for(let l=0;l<o.length;l++)a[`viewProjectionMatrix${l}`]=o[l],a[`projectCenter${l}`]=r[l];for(let l=0;l<2;l++)a[`shadow_uShadowMap${l}`]=e.shadowMaps&&e.shadowMaps[l]||e.dummyShadowMap;return a},uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},ru={...Ua,defaultUniforms:{...Ua.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    // for picking depth values\n    picking_setPickingAttribute(position.z / position.w);\n  ","vs:DECKGL_FILTER_COLOR":"\n  picking_setPickingColor(geometry.pickingColor);\n  ","fs:DECKGL_FILTER_COLOR":{order:99,injection:"\n  // use highlight color if this fragment belongs to the selected object.\n  color = picking_filterHighlightColor(color);\n\n  // use picking color if rendering to picking FBO.\n  color = picking_filterPickingColor(color);\n    "}}},ou=[Ja],au=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],lu=[];function cu(e){const t=Yn.getDefaultShaderAssembler();for(const i of ou)t.addDefaultModule(i);const n="glsl"===e?au:lu;for(const i of n)t.addShaderHook(i);return t}const uu=[255,255,255],hu=1;let du=0;class fu{constructor(e={}){this.type="ambient";const{color:t=uu}=e,{intensity:n=hu}=e;this.id=e.id||"ambient-"+du++,this.color=t,this.intensity=n}}const pu=[255,255,255],gu=1,mu=[0,0,-1];let _u=0;class yu{constructor(e={}){this.type="directional";const{color:t=pu}=e,{intensity:n=gu}=e,{direction:i=mu}=e,{_shadow:s=!1}=e;this.id=e.id||"directional-"+_u++,this.color=t,this.intensity=n,this.type="directional",this.direction=new pa(i).normalize().toArray(),this.shadow=s}getProjectedLight(e){return this}}class vu{constructor(e,t={id:"pass"}){const{id:n}=t;this.id=n,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class bu extends vu{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,n]=this.device.canvasContext.getDrawingBufferSize(),i=e.clearCanvas??!0,s=e.clearColor??(!!i&&[0,0,0,0]),r=!!i&&1,o=!!i&&0,a=e.colorMask??15,l={viewport:[0,0,t,n]};e.colorMask&&(l.colorMask=a),e.scissorRect&&(l.scissorRect=e.scissorRect);const c=this.device.beginRenderPass({framebuffer:e.target,parameters:l,clearColor:s,clearDepth:r,clearStencil:o});try{return this._drawLayers(c,e)}finally{c.end(),this.device.submit()}}_drawLayers(e,t){const{target:n,shaderModuleProps:i,viewports:s,views:r,onViewportActive:o,clearStack:a=!0}=t;t.pass=t.pass||"unknown",a&&(this._lastRenderIndex=-1);const l=[];for(const c of s){const s=r&&r[c.id];null==o||o(c);const a=this._getDrawLayerParams(c,t),u=c.subViewports||[c];for(const r of u){const o=this._drawLayersInViewport(e,{target:n,shaderModuleProps:i,viewport:r,view:s,pass:t.pass,layers:t.layers},a);l.push(o)}}return l}_getDrawLayerParams(e,{layers:t,pass:n,isPicking:i=!1,layerFilter:s,cullRect:r,effects:o,shaderModuleProps:a},l=!1){var c;const u=[],h=Eu(this._lastRenderIndex+1),d={layer:t[0],viewport:e,isPicking:i,renderPass:n,cullRect:r},f={};for(let p=0;p<t.length;p++){const i=t[p],r=this._shouldDrawLayer(i,d,s,f),g={shouldDrawLayer:r};r&&!l&&(g.shouldDrawLayer=!0,g.layerRenderIndex=h(i,r),g.shaderModuleProps=this._getShaderModuleProps(i,o,n,a),g.layerParameters={...null==(c=i.context.deck)?void 0:c.props.parameters,...this.getLayerParameters(i,p,e)}),u[p]=g}return u}_drawLayersInViewport(e,{layers:t,shaderModuleProps:n,pass:i,target:s,viewport:r,view:o},a){const l=function(e,{shaderModuleProps:t,target:n,viewport:i}){var s;const r=(null==(s=null==t?void 0:t.project)?void 0:s.devicePixelRatio)??e.canvasContext.cssToDeviceRatio(),[,o]=e.canvasContext.getDrawingBufferSize(),a=n?n.height:o,l=i;return[l.x*r,a-(l.y+l.height)*r,l.width*r,l.height*r]}(this.device,{shaderModuleProps:n,target:s,viewport:r});if(o&&o.props.clear){const e=!0===o.props.clear?{color:!0,depth:!0}:o.props.clear;this.device.beginRenderPass({framebuffer:s,parameters:{viewport:l,scissorRect:l},clearColor:!!e.color&&[0,0,0,0],clearDepth:!!e.depth&&1}).end()}const c={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:l});for(let h=0;h<t.length;h++){const n=t[h],s=a[h],{shouldDrawLayer:o}=s;if(o&&n.props.pickable&&c.pickableCount++,n.isComposite&&c.compositeCount++,n.isDrawable&&s.shouldDrawLayer){const{layerRenderIndex:t,shaderModuleProps:o,layerParameters:a}=s;c.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,t),o.project&&(o.project.viewport=r),n.context.renderPass=e;try{n._drawLayer({renderPass:e,shaderModuleProps:o,uniforms:{layerIndex:t},parameters:a})}catch(u){n.raiseError(u,`drawing ${n} to ${i}`)}}}return c}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,n){return null}getLayerParameters(e,t,n){return e.props.parameters}_shouldDrawLayer(e,t,n,i){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let s=e.parent;for(;s;){if(!s.props.visible||!s.filterSubLayer(t))return!1;t.layer=s,s=s.parent}if(n){const e=t.layer.id;if(e in i||(i[e]=n(t)),!i[e])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,n,i){var s,r;const o=this.device.canvasContext.cssToDeviceRatio(),a=(null==(s=e.internalState)?void 0:s.propsInTransition)||e.props,l={layer:a,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:o,modelMatrix:a.modelMatrix,coordinateSystem:a.coordinateSystem,coordinateOrigin:a.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const c of t)xu(l,null==(r=c.getShaderModuleProps)?void 0:r.call(c,e,l));return xu(l,this.getShaderModuleProps(e,t,l),i)}}function Eu(e=0,t={}){const n={},i=(s,r)=>{const o=s.props._offset,a=s.id,l=s.parent&&s.parent.id;let c;if(l&&!(l in t)&&i(s.parent,!1),l in n){const e=n[l]=n[l]||Eu(t[l],t);c=e(s,r),n[a]=e}else Number.isFinite(o)?(c=o+(t[l]||0),n[a]=null):c=e;return r&&c>=e&&(e=c+1),t[a]=c,c};return i}function xu(e,...t){for(const n of t)if(n)for(const t in n)e[t]?Object.assign(e[t],n[t]):e[t]=n[t];return e}class wu extends bu{constructor(e,t){super(e,t);const n=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),i=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[n],depthStencilAttachment:i})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,n=this.device.canvasContext.cssToDeviceRatio(),i=e.viewports[0],s=i.width*n,r=i.height*n;s===t.width&&r===t.height||t.resize({width:s,height:r}),super.render({...e,clearColor:[1,1,1,1],target:t,pass:"shadow"})}getLayerParameters(e,t,n){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return!1!==e.props.shadowEnabled}getShaderModuleProps(e,t,n){return{shadow:{project:n.project,drawToShadowMap:!0}}}}const Tu={color:[255,255,255],intensity:1},Au=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],Su=[0,0,0,200/255];class Ru{constructor(e={}){this.id="lighting-effect",this.shadowColor=Su,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:n}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),n._addDefaultShaderModule(su),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const n=e[t];switch(n.type){case"ambient":this.ambientLight=n;break;case"directional":this.directionalLights.push(n);break;case"point":this.pointLights.push(n)}}this._applyDefaultLights(),this.shadow=this.directionalLights.some((e=>e.shadow)),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:n,onViewportActive:i,views:s}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let r=0;r<this.shadowPasses.length;r++){this.shadowPasses[r].render({layers:e,layerFilter:t,viewports:n,onViewportActive:i,views:s,shaderModuleProps:{shadow:{shadowLightId:r,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}}getShaderModuleProps(e,t){const n=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map((e=>e.getShadowMap())),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},i={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map((t=>t.getProjectedLight({layer:e}))),pointLights:this.pointLights.map((t=>t.getProjectedLight({layer:e})))},s=e.props.material;return{shadow:n,lighting:i,phongMaterial:s,gouraudMaterial:s}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(su))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const n=(new Ma).lookAt({eye:new pa(t.direction).negate()});e.push(n)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const n=new wu(e);this.shadowPasses[t]=n}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:n}=this;e||0!==t.length||0!==n.length||(this.ambientLight=new fu(Tu),this.directionalLights.push(new yu(Au[0]),new yu(Au[1])))}}const Pu=new class{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:n=1,type:i,padding:s=0,copy:r=!1,initialize:o=!1,maxCount:a}){const l=i||e&&e.constructor||Float32Array,c=t*n+s;if(ArrayBuffer.isView(e)){if(c<=e.length)return e;if(c*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new l(e.buffer,0,c)}let u=1/0;a&&(u=a*n+s);const h=this._allocate(l,c,o,u);return e&&r?h.set(e):o||h.fill(0,0,4),this._release(e),h}release(e){this._release(e)}_allocate(e,t,n,i){let s=Math.max(Math.ceil(t*this.opts.overAlloc),1);s>i&&(s=i);const r=this._pool,o=e.BYTES_PER_ELEMENT*s,a=r.findIndex((e=>e.byteLength>=o));if(a>=0){const t=new e(r.splice(a,1)[0],0,s);return n&&t.fill(0),t}return new e(s)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:n}=e,{byteLength:i}=n,s=t.findIndex((e=>e.byteLength>=i));s<0?t.push(n):(s>0||t.length<this.opts.poolSize)&&t.splice(s,0,n),t.length>this.opts.poolSize&&t.shift()}};const Cu=new pa;function Iu(e,t,n,i){Cu.set(e,t,n);const s=Cu.len();return{distance:i/s,normal:new pa(-e/s,-t/s,-n/s)}}let Lu;function Mu(e,t){const{size:n=1,startIndex:i=0}=t,s=void 0!==t.endIndex?t.endIndex:e.length,r=(s-i)/n;Lu=Pu.allocate(Lu,r,{type:Float32Array,size:2*n});let o=i,a=0;for(;o<s;){for(let t=0;t<n;t++){const i=e[o++];Lu[a+t]=i,Lu[a+t+n]=(l=i)-Math.fround(l)}a+=2*n}var l;return Lu.subarray(0,r*n*2)}function ku(e){let t=null,n=!1;for(const i of e)i&&(t?(n||(t=[[t[0][0],t[0][1]],[t[1][0],t[1][1]]],n=!0),t[0][0]=Math.min(t[0][0],i[0][0]),t[0][1]=Math.min(t[0][1],i[0][1]),t[1][0]=Math.max(t[1][0],i[1][0]),t[1][1]=Math.max(t[1][1],i[1][1])):t=i);return t}const Ou=Math.PI/180,Nu=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Fu=[0,0,0],Bu={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};class Du{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||Bu,this.focalDistance=e.focalDistance||1,this.position=e.position||Fu,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:n}=e;this.isGeospatial=Number.isFinite(n)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?tc.WEB_MERCATOR:tc.WEB_MERCATOR_AUTO_OFFSET:tc.IDENTITY}equals(e){return e instanceof Du&&(this===e||e.width===this.width&&e.height===this.height&&e.scale===this.scale&&Qo(e.projectionMatrix,this.projectionMatrix)&&Qo(e.viewMatrix,this.viewMatrix))}project(e,{topLeft:t=!0}={}){const n=Wc(this.projectPosition(e),this.pixelProjectionMatrix),[i,s]=n,r=t?s:this.height-s;return 2===e.length?[i,r]:[i,r,n[2]]}unproject(e,{topLeft:t=!0,targetZ:n}={}){const[i,s,r]=e,o=t?s:this.height-s,a=n&&n*this.distanceScales.unitsPerMeter[2],l=jc([i,o,r],this.pixelUnprojectionMatrix,a),[c,u,h]=this.unprojectPosition(l);return Number.isFinite(r)?[c,u,h]:Number.isFinite(n)?[c,u,n]:[c,u]}projectPosition(e){const[t,n]=this.projectFlat(e);return[t,n,(e[2]||0)*this.distanceScales.unitsPerMeter[2]]}unprojectPosition(e){const[t,n]=this.unprojectFlat(e);return[t,n,(e[2]||0)*this.distanceScales.metersPerUnit[2]]}projectFlat(e){if(this.isGeospatial){const t=Fc(e);return t[1]=qo(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?Bc(e):e}getBounds(e={}){const t={targetZ:e.z||0},n=this.unproject([0,0],t),i=this.unproject([this.width,0],t),s=this.unproject([0,this.height],t),r=this.unproject([this.width,this.height],t);return[Math.min(n[0],i[0],s[0],r[0]),Math.min(n[1],i[1],s[1],r[1]),Math.max(n[0],i[0],s[0],r[0]),Math.max(n[1],i[1],s[1],r[1])]}getDistanceScales(e){return e&&this.isGeospatial?Uc({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:n=1,height:i=1}){return e<this.x+this.width&&this.x<e+n&&t<this.y+this.height&&this.y<t+i}getFrustumPlanes(){return this._frustumPlanes.near||Object.assign(this._frustumPlanes,{left:Iu((e=this.viewProjectionMatrix)[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]),right:Iu(e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]),bottom:Iu(e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]),top:Iu(e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]),near:Iu(e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]),far:Iu(e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14])}),this._frustumPlanes;var e}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,n=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=function(e){const{latitude:t}=e;Ac(Number.isFinite(t));const n=Math.cos(t*Pc);return Nc(Lc*n)-9}({latitude:n})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Uc({latitude:n,longitude:t}));const i=Math.pow(2,this.zoom);this.scale=i;const{position:s,modelMatrix:r}=e;let o=Fu;if(s&&(o=r?new Ma(r).transformAsVector(s,[]):s),this.isGeospatial){const e=this.projectPosition([t,n,0]);this.center=new pa(o).scale(this.distanceScales.unitsPerMeter).add(e)}else this.center=this.projectPosition(o)}_initMatrices(e){const{viewMatrix:t=Nu,projectionMatrix:n=null,orthographic:i=!1,fovyRadians:s,fovy:r=75,near:o=.1,far:a=1e3,padding:l=null,focalDistance:c=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=(new Ma).multiplyRight(t).translate(new pa(this.center).negate()),this.projectionMatrix=n||function({width:e,height:t,orthographic:n,fovyRadians:i,focalDistance:s,padding:r,near:o,far:a}){const l=e/t,c=n?(new Ma).orthographic({fovy:i,aspect:l,focalDistance:s,near:o,far:a}):(new Ma).perspective({fovy:i,aspect:l,near:o,far:a});if(r){const{left:n=0,right:i=0,top:s=0,bottom:o=0}=r,a=qo((n+e-i)/2,0,e)-e/2,l=qo((s+t-o)/2,0,t)-t/2;c[8]-=2*a/e,c[9]+=2*l/t}return c}({width:this.width,height:this.height,orthographic:i,fovyRadians:s||r*Ou,focalDistance:c,padding:l,near:o,far:a});const u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var h;_a(u,u,this.projectionMatrix),_a(u,u,this.viewMatrix),this.viewProjectionMatrix=u,this.viewMatrixInverse=ma([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=[(h=this.viewMatrixInverse)[12],h[13],h[14]];const d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];va(d,d,[this.width/2,-this.height/2,1]),ya(d,d,[1,-1,0]),_a(f,d,this.viewProjectionMatrix),this.pixelProjectionMatrix=f,this.pixelUnprojectionMatrix=ma([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||ln.warn("Pixel project matrix not invertible")()}}Du.displayName="Viewport";const Uu=Du;class Gu extends Uu{constructor(e={}){const{latitude:t=0,longitude:n=0,zoom:i=0,pitch:s=0,bearing:r=0,nearZMultiplier:o=.1,farZMultiplier:a=1.01,nearZ:l,farZ:c,orthographic:u=!1,projectionMatrix:h,repeat:d=!1,worldOffset:f=0,position:p,padding:g,legacyMeterSizes:m=!1}=e;let{width:_,height:y,altitude:v=1.5}=e;const b=Math.pow(2,i);let E;_=_||1,y=y||1;let x=null;if(h)v=h[5]/2,E=zc(v);else{let n;if(e.fovy?(E=e.fovy,v=Vc(E)):E=zc(v),g){const{top:e=0,bottom:t=0}=g;n=[0,qo((e+y-t)/2,0,y)-y/2]}x=function(e){const{width:t,height:n,altitude:i,pitch:s=0,offset:r,center:o,scale:a,nearZMultiplier:l=1,farZMultiplier:c=1}=e;let{fovy:u=zc(kc)}=e;void 0!==i&&(u=zc(i));const h=u*Pc,d=s*Pc,f=Vc(u);let p=f;o&&(p+=o[2]*a/Math.cos(d)/n);const g=h*(.5+(r?r[1]:0)/n),m=Math.sin(g)*p/Math.sin(wc(Math.PI/2-d-g,.01,Math.PI-.01)),_=Math.sin(d)*m+p,y=10*p;return{fov:h,aspect:t/n,focalDistance:f,near:l,far:Math.min(_*c,y)}}({width:_,height:y,scale:b,center:p&&[0,0,p[2]*Dc(t)],offset:n,pitch:s,fovy:E,nearZMultiplier:o,farZMultiplier:a}),Number.isFinite(l)&&(x.near=l),Number.isFinite(c)&&(x.far=c)}let w=function(e){const{height:t,pitch:n,bearing:i,altitude:s,scale:r,center:o}=e,a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];ya(a,a,[0,0,-s]),ba(a,a,-n*Pc),Ea(a,a,i*Pc);const l=r/t;var c,u;return va(a,a,[l,l,l]),o&&ya(a,a,((c=[])[0]=-(u=o)[0],c[1]=-u[1],c[2]=-u[2],c)),a}({height:y,pitch:s,bearing:r,scale:b,altitude:v});if(f){w=(new Ma).translate([512*f,0,0]).multiplyLeft(w)}super({...e,width:_,height:y,viewMatrix:w,longitude:n,latitude:t,zoom:i,...x,fovy:E,focalDistance:v}),this.latitude=t,this.longitude=n,this.zoom=i,this.pitch=s,this.bearing=r,this.altitude=v,this.fovy=E,this.orthographic=u,this._subViewports=d?[]:null,this._pseudoMeters=m,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),n=Math.ceil((e[2]-180)/360);for(let i=t;i<=n;i++){const e=i?new Gu({...this,worldOffset:i}):this;this._subViewports.push(e)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,n]=this.projectFlat(e);return[t,n,(e[2]||0)*Dc(e[1])]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,n]=this.unprojectFlat(e);return[t,n,(e[2]||0)/Dc(n)]}addMetersToLngLat(e,t){return Gc(e,t)}panByPosition(e,t){const n=jc(t,this.pixelUnprojectionMatrix),i=oa([],this.projectFlat(e),((s=[])[0]=-(r=n)[0],s[1]=-r[1],s));var s,r;const o=oa([],this.center,i),[a,l]=this.unprojectFlat(o);return{longitude:a,latitude:l}}getBounds(e={}){const t=function(e,t=0){const{width:n,height:i,unproject:s}=e,r={targetZ:t},o=s([0,i],r),a=s([n,i],r);let l,c;return(e.fovy?.5*e.fovy*$c:Math.atan(.5/e.altitude))>(90-e.pitch)*$c-.01?(l=Xc(e,0,t),c=Xc(e,n,t)):(l=s([0,0],r),c=s([n,0],r)),[o,a,c,l]}(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:n,height:i}=this,{longitude:s,latitude:r,zoom:o}=Hc({width:n,height:i,bounds:e,...t});return new Gu({width:n,height:i,longitude:s,latitude:r,zoom:o})}}Gu.displayName="WebMercatorViewport";const zu=Gu,Vu=[0,0,0];function Wu(e,t,n=!1){const i=t.projectPosition(e);if(n&&t instanceof zu){const[n,s,r=0]=e,o=t.getDistanceScales([n,s]);i[2]=r*o.unitsPerMeter[2]}return i}function ju(e,{viewport:t,modelMatrix:n,coordinateSystem:i,coordinateOrigin:s,offsetMode:r}){let[o,a,l=0]=e;switch(n&&([o,a,l]=Ta([],[o,a,l,1],n)),i){case ec.LNGLAT:return Wu([o,a,l],t,r);case ec.LNGLAT_OFFSETS:return Wu([o+s[0],a+s[1],l+(s[2]||0)],t,r);case ec.METER_OFFSETS:return Wu(Gc(s,[o,a,l]),t,r);default:return t.isGeospatial?[o+s[0],a+s[1],l+s[2]]:t.projectPosition([o,a,l])}}function Hu(e,t){const{viewport:n,coordinateSystem:i,coordinateOrigin:s,modelMatrix:r,fromCoordinateSystem:o,fromCoordinateOrigin:a}=function(e){const{viewport:t,modelMatrix:n,coordinateOrigin:i}=e;let{coordinateSystem:s,fromCoordinateSystem:r,fromCoordinateOrigin:o}=e;return s===ec.DEFAULT&&(s=t.isGeospatial?ec.LNGLAT:ec.CARTESIAN),void 0===r&&(r=s),void 0===o&&(o=i),{viewport:t,coordinateSystem:s,coordinateOrigin:i,modelMatrix:n,fromCoordinateSystem:r,fromCoordinateOrigin:o}}(t),{autoOffset:l=!0}=t,{geospatialOrigin:c=Vu,shaderCoordinateOrigin:u=Vu,offsetMode:h=!1}=l?fc(n,i,s):{},d=ju(e,{viewport:n,modelMatrix:r,coordinateSystem:o,coordinateOrigin:a,offsetMode:h});if(h){const e=n.projectPosition(c||u);ha(d,d,e)}return d}let $u=1,Xu=1;class Yu{constructor(){i(this,"time",0),i(this,"channels",new Map),i(this,"animations",new Map),i(this,"playing",!1),i(this,"lastEngineTime",-1)}addChannel(e){const{delay:t=0,duration:n=Number.POSITIVE_INFINITY,rate:i=1,repeat:s=1}=e,r=$u++,o={time:0,delay:t,duration:n,rate:i,repeat:s};return this._setChannelTime(o,this.time),this.channels.set(r,o),r}removeChannel(e){this.channels.delete(e);for(const[t,n]of this.animations)n.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return void 0!==t&&this.time>=t.delay+t.duration*t.repeat}getTime(e){if(void 0===e)return this.time;const t=this.channels.get(e);return void 0===t?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const i of t)this._setChannelTime(i,this.time);const n=this.animations.values();for(const i of n){const{animation:e,channel:t}=i;e.setTime(this.getTime(t))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const n=Xu++;return this.animations.set(n,{animation:e,channel:t}),e.setTime(this.getTime(t)),n}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(-1===this.lastEngineTime&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const n=t-e.delay;n>=e.duration*e.repeat?e.time=e.duration*e.rate:(e.time=Math.max(0,n)%e.duration,e.time*=e.rate)}}let Ku=0;const qu={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:e=>{},stats:Li.stats.get("animation-loop-"+Ku++),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class Zu{constructor(e){if(i(this,"device",null),i(this,"canvas",null),i(this,"props"),i(this,"animationProps",null),i(this,"timeline",null),i(this,"stats"),i(this,"cpuTime"),i(this,"gpuTime"),i(this,"frameRate"),i(this,"display"),i(this,"needsRedraw","initialized"),i(this,"_initialized",!1),i(this,"_running",!1),i(this,"_animationFrameId",null),i(this,"_nextFramePromise",null),i(this,"_resolveNextFrame",null),i(this,"_cpuStartTime",0),i(this,"_error",null),this.props={...qu,...e},!(e=this.props).device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new Ve({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){var t,n;this.props.onError(e),this._error=Error();if((null==(n=null==(t=this.device)?void 0:t.canvasContext)?void 0:n.canvas)instanceof HTMLCanvasElement){const t=document.createElement("h1");t.innerHTML=e.message,t.style.position="absolute",t.style.top="20%",t.style.left="10px",t.style.color="black",t.style.backgroundColor="red",document.body.appendChild(t)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(!1!==e&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(null==(e=this.device)?void 0:e.isLost)||this._error||(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers()),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise((e=>{this._resolveNextFrame=e}))),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){var e;this._running&&(this._animationFrameId=(e=this._animationFrame.bind(this),"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(e):setTimeout(e,1e3/60)))}_cancelAnimationFrame(){var e;null!==this._animationFrameId&&(e=this._animationFrameId,"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(e):clearTimeout(e),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){var t;this.display?this.display._renderFrame(e):(this.props.onRender(this._getAnimationProps()),null==(t=this.device)||t.submit())}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var e,t;const n=null==(t=null==(e=this.device)?void 0:e.canvasContext)?void 0:t.canvas;if(!this.device||!n)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:n,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:n}=this._getSizeAndAspect();e===this.animationProps.width&&t===this.animationProps.height||this.setNeedsRedraw("drawing buffer resized"),n!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=n,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=(null==(e=this.device.canvasContext)?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const n=this.props.onAddHTML(t);n&&(t.innerHTML=n)}}_getSizeAndAspect(){var e,t,n,i;if(!this.device)return{width:1,height:1,aspect:1};const[s,r]=(null==(t=null==(e=this.device)?void 0:e.canvasContext)?void 0:t.getPixelSize())||[1,1];let o=1;const a=null==(i=null==(n=this.device)?void 0:n.canvasContext)?void 0:i.canvas;return a&&a.clientHeight?o=a.clientWidth/a.clientHeight:s>0&&r>0&&(o=s/r),{width:s,height:r,aspect:o}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,t;this.props.autoResizeDrawingBuffer&&(null==(t=null==(e=this.device)?void 0:e.canvasContext)||t.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const Qu={};function Ju(e="id"){Qu[e]=Qu[e]||1;return`${e}-${Qu[e]++}`}class eh{constructor(e){if(i(this,"id"),i(this,"userData",{}),i(this,"topology"),i(this,"bufferLayout",[]),i(this,"vertexCount"),i(this,"indices"),i(this,"attributes"),this.id=e.id||Ju("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&ni.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){var e;null==(e=this.indices)||e.destroy();for(const t of Object.values(this.attributes))t.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function th(e,t){if(t instanceof eh)return t;const n=function(e,t){if(!t.indices)return;const n=t.indices.value;return e.createBuffer({usage:ni.INDEX,data:n})}(e,t),{attributes:i,bufferLayout:s}=function(e,t){const n=[],i={};for(const[r,o]of Object.entries(t.attributes)){let t=r;switch(r){case"POSITION":t="positions";break;case"NORMAL":t="normals";break;case"TEXCOORD_0":t="texCoords";break;case"COLOR_0":t="colors"}if(o){i[t]=e.createBuffer({data:o.value,id:`${r}-buffer`});const{value:s,size:a,normalized:l}=o;n.push({name:t,format:Ps(s,a,l)})}}const s=t._calculateVertexCount(t.attributes,t.indices);return{attributes:i,bufferLayout:n,vertexCount:s}}(e,t);return new eh({topology:t.topology||"triangle-list",bufferLayout:s,vertexCount:t.vertexCount,indices:n,attributes:i})}const nh=class e{constructor(e){i(this,"device"),i(this,"destroyPolicy"),i(this,"_hashCounter",0),i(this,"_hashes",{}),i(this,"_renderPipelineCache",{}),i(this,"_computePipelineCache",{}),this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultPipelineFactory(t){return t._lumaData.defaultPipelineFactory=t._lumaData.defaultPipelineFactory||new e(t),t._lumaData.defaultPipelineFactory}createRenderPipeline(e){const t={...Qi.defaultProps,...e},n=this._hashRenderPipeline(t);if(!this._renderPipelineCache[n]){const e=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});e.hash=n,this._renderPipelineCache[n]={pipeline:e,useCount:0}}return this._renderPipelineCache[n].useCount++,this._renderPipelineCache[n].pipeline}createComputePipeline(e){const t={...ns.defaultProps,...e},n=this._hashComputePipeline(t);if(!this._computePipelineCache[n]){const e=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});e.hash=n,this._computePipelineCache[n]={pipeline:e,useCount:0}}return this._computePipelineCache[n].useCount++,this._computePipelineCache[n].pipeline}release(e){const t=e.hash,n=e instanceof ns?this._computePipelineCache:this._renderPipelineCache;n[t].useCount--,0===n[t].useCount&&"unused"===this.destroyPolicy&&(n[t].pipeline.destroy(),delete n[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,n=e.fs?this._getHash(e.fs.source):0,i=this._getHash(JSON.stringify(e.bufferLayout));if("webgl"===this.device.type)return`${t}/${n}V-BL${i}`;{const s=this._getHash(JSON.stringify(e.parameters));return`${t}/${n}V-T${e.topology}P${s}BL${i}`}}_getHash(e){return void 0===this._hashes[e]&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}};i(nh,"defaultProps",{...Qi.defaultProps});let ih=nh;const sh=class e{constructor(e){i(this,"device"),i(this,"destroyPolicy"),i(this,"_cache",{}),this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}static getDefaultShaderFactory(t){var n;return(n=t._lumaData).defaultShaderFactory||(n.defaultShaderFactory=new e(t)),t._lumaData.defaultShaderFactory}createShader(e){const t=this._hashShader(e);let n=this._cache[t];if(!n){const i=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=n={shader:i,useCount:0}}return n.useCount++,n.shader}release(e){const t=this._hashShader(e),n=this._cache[t];n&&(n.useCount--,0===n.useCount&&"unused"===this.destroyPolicy&&(delete this._cache[t],n.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}};i(sh,"defaultProps",{...ji.defaultProps});let rh=sh;let oh=null,ah=null;function lh(e,t,n){if(e===t)return!0;if(!n||!e||!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!lh(e[i],t[i],n-1))return!1;return!0}if(Array.isArray(t))return!1;if("object"==typeof e&&"object"==typeof t){const i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(const r of i){if(!t.hasOwnProperty(r))return!1;if(!lh(e[r],t[r],n-1))return!1}return!0}return!1}function ch(e){return function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}(e)||function(e){return!!Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}(e)}function uh(e){const t={bindings:{},uniforms:{}};return Object.keys(e).forEach((n=>{const i=e[n];var s;ch(s=i)||"number"==typeof s||"boolean"==typeof s?t.uniforms[n]=i:t.bindings[n]=i})),t}class hh{constructor(e,t){i(this,"options",{disableWarnings:!1}),i(this,"modules"),i(this,"moduleUniforms"),i(this,"moduleBindings"),Object.assign(this.options,t);const n=Cn(Object.values(e).filter((e=>e.dependencies)));for(const i of n)e[i.name]=i;Zn.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[i,s]of Object.entries(e))this._addModule(s),s.name&&i!==s.name&&!this.options.disableWarnings&&Zn.warn(`Module name: ${i} vs ${s.name}`)()}destroy(){}setProps(e){var t;for(const n of Object.keys(e)){const i=n,s=e[i]||{},r=this.modules[i];if(!r){this.options.disableWarnings||Zn.warn(`Module ${n} not found`)();continue}const o=this.moduleUniforms[i],a=this.moduleBindings[i],l=(null==(t=r.getUniforms)?void 0:t.call(r,s,o))||s,{uniforms:c,bindings:u}=uh(l);this.moduleUniforms[i]={...o,...c},this.moduleBindings[i]={...a,...u}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){var e;const t={};for(const[n,i]of Object.entries(this.moduleUniforms))for(const[s,r]of Object.entries(i))t[`${n}.${s}`]={type:null==(e=this.modules[n].uniformTypes)?void 0:e[s],value:String(r)};return t}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}async function dh(e,t){const n=new Image;return n.crossOrigin=(null==t?void 0:t.crossOrigin)||"anonymous",n.src=e.startsWith("http")?e:""+e,await n.decode(),t?await createImageBitmap(n,t):await createImageBitmap(n)}class fh{constructor(e,t){i(this,"device"),i(this,"id"),i(this,"texture"),i(this,"sampler"),i(this,"view"),i(this,"ready"),i(this,"isReady",!1),i(this,"destroyed",!1),i(this,"resolveReady",(()=>{})),i(this,"rejectReady",(()=>{})),this.device=e,this.id=t.id||Ju("async-texture"),"string"==typeof(null==t?void 0:t.data)&&"2d"===t.dimension&&(t={...t,data:dh(t.data)}),this.ready=new Promise(((e,t)=>{this.resolveReady=()=>{this.isReady=!0,e()},this.rejectReady=t})),this.initAsync(t)}get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}async initAsync(e){const t=e.data,n=await ph(t).then(undefined,undefined);if(this.destroyed)return;const i={...e,data:n};this.texture=this.device.createTexture(i),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}}async function ph(e){if(e=await e,Array.isArray(e))return await Promise.all(e.map(ph));if(e&&"object"==typeof e&&e.constructor===Object){const t=e,n=await Promise.all(Object.values(t)),i=Object.keys(t),s={};for(let e=0;e<i.length;e++)s[i[e]]=n[e];return s}return e}const gh=class e{constructor(t,n){var s,r,o,a;i(this,"device"),i(this,"id"),i(this,"source"),i(this,"vs"),i(this,"fs"),i(this,"pipelineFactory"),i(this,"shaderFactory"),i(this,"userData",{}),i(this,"parameters"),i(this,"topology"),i(this,"bufferLayout"),i(this,"isInstanced"),i(this,"instanceCount",0),i(this,"vertexCount"),i(this,"indexBuffer",null),i(this,"bufferAttributes",{}),i(this,"constantAttributes",{}),i(this,"bindings",{}),i(this,"uniforms",{}),i(this,"vertexArray"),i(this,"transformFeedback",null),i(this,"pipeline"),i(this,"shaderInputs"),i(this,"_uniformStore"),i(this,"_attributeInfos",{}),i(this,"_gpuGeometry",null),i(this,"_getModuleUniforms"),i(this,"props"),i(this,"_pipelineNeedsUpdate","newly created"),i(this,"_needsRedraw","initializing"),i(this,"_destroyed",!1),i(this,"_lastDrawTimestamp",-1),i(this,"_lastLogTime",0),i(this,"_logOpen",!1),i(this,"_drawCount",0),this.props={...e.defaultProps,...n},n=this.props,this.id=n.id||Ju("model"),this.device=t,Object.assign(this.userData,n.userData);const l=Object.fromEntries((null==(s=this.props.modules)?void 0:s.map((e=>[e.name,e])))||[]),c=n.shaderInputs||new hh(l,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(c);const u=function(e){return{type:e.type,shaderLanguage:e.info.shadingLanguage,shaderLanguageVersion:e.info.shadingLanguageVersion,gpu:e.info.gpu,features:e.features}}(t),h=((null==(r=this.props.modules)?void 0:r.length)>0?this.props.modules:null==(o=this.shaderInputs)?void 0:o.getModules())||[];if("webgpu"===this.device.type&&this.props.source){const{source:e,getUniforms:t}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:u,...this.props,modules:h});this.source=e,this._getModuleUniforms=t,(a=this.props).shaderLayout||(a.shaderLayout=Ho(this.source))}else{const{vs:e,fs:t,getUniforms:n}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:u,...this.props,modules:h});this.vs=e,this.fs=t,this._getModuleUniforms=n}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,n.geometry&&this.setGeometry(n.geometry),this.pipelineFactory=n.pipelineFactory||ih.getDefaultPipelineFactory(this.device),this.shaderFactory=n.shaderFactory||rh.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=t.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in n&&(this.isInstanced=n.isInstanced),n.instanceCount&&this.setInstanceCount(n.instanceCount),n.vertexCount&&this.setVertexCount(n.vertexCount),n.indexBuffer&&this.setIndexBuffer(n.indexBuffer),n.attributes&&this.setAttributes(n.attributes),n.constantAttributes&&this.setConstantAttributes(n.constantAttributes),n.bindings&&this.setBindings(n.bindings),n.uniforms&&this.setUniformsWebGL(n.uniforms),n.moduleSettings&&this.updateModuleSettingsWebGL(n.moduleSettings),n.transformFeedback&&(this.transformFeedback=n.transformFeedback),Object.seal(this)}get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}destroy(){var e;this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),null==(e=this._gpuGeometry)||e.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||(this._needsRedraw=e)}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return Zn.info(2,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let n;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const t=this._getBindings();this.pipeline.setBindings(t,{disableWarnings:this.props.disableWarnings}),yh(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:i}=this.vertexArray,s=i?i.byteLength/("uint32"===i.indexType?4:2):void 0;n=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:s,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),n?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",n}setGeometry(e){var t;null==(t=this._gpuGeometry)||t.destroy();const n=e&&th(this.device,e);if(n){this.setTopology(n.topology||"triangle-list");const e=new Cs(this.bufferLayout);this.bufferLayout=e.mergeBufferLayouts(n.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(n)}this._gpuGeometry=n}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new Cs(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){lh(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,void 0===this.isInstanced&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new As(this.shaderInputs.modules);for(const[t,n]of Object.entries(this.shaderInputs.modules))if(_h(n)){const e=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=e}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const n=(null==t?void 0:t.disableWarnings)??this.props.disableWarnings;e.indices&&Zn.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)();const i=new Cs(this.bufferLayout);for(const[s,r]of Object.entries(e)){const e=i.getBufferLayout(s);if(!e){n||Zn.warn(`Model(${this.id}): Missing layout for buffer "${s}".`)();continue}const t=i.getAttributeNamesForBuffer(e);let o=!1;for(const n of t){const e=this._attributeInfos[n];e&&(this.vertexArray.setBuffer(e.location,r),o=!0)}o||n||Zn.warn(`Model(${this.id}): Ignoring buffer "${r.id}" for unknown attribute "${s}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[n,i]of Object.entries(e)){const e=this._attributeInfos[n];e?this.vertexArray.setConstantWebGL(e.location,i):((null==t?void 0:t.disableWarnings)??this.props.disableWarnings)||Zn.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${n}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){this.setUniformsWebGL(e)}setUniformsWebGL(e){yh(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(e){const{bindings:t,uniforms:n}=uh(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,n),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof fh&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,n]of Object.entries(this.bindings))n instanceof fh?n.isReady&&(e[t]=n.texture):e[t]=n;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof Gi?e=Math.max(e,t.texture.updateTimestamp):t instanceof ni||t instanceof Di?e=Math.max(e,t.updateTimestamp):t instanceof fh?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof Yi||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[n]of Object.entries(t))this.pipeline.shaderLayout.attributes.find((e=>e.name===n))||"positions"===n||delete t[n];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||(this._pipelineNeedsUpdate=e),this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(Zn.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const n=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let i=null;this.source?i=n:this.fs&&(i=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:n,fs:i}),this._attributeInfos=us(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_logDrawCallStart(){const e=Zn.level>3?0:1e4;Zn.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,Zn.group(2,`>>> DRAWING MODEL ${this.id}`,{collapsed:Zn.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=function(e){var t;const n={},i="Values";if(0===e.attributes.length&&!(null==(t=e.varyings)?void 0:t.length))return{"No attributes or varyings":{[i]:"N/A"}};for(const s of e.attributes)s&&(n[`in ${s.location} ${s.name}: ${s.type}`]={[i]:s.stepMode||"vertex"});for(const s of e.varyings||[])n[`out ${s.location} ${s.name}`]={[i]:JSON.stringify(s)};return n}(this.pipeline.shaderLayout,this.id);Zn.table(2,e)();const t=this.shaderInputs.getDebugTable();for(const[i,s]of Object.entries(this.uniforms))t[i]={value:s};Zn.table(2,t)();const n=this._getAttributeDebugTable();Zn.table(2,this._attributeInfos)(),Zn.table(2,n)(),Zn.groupEnd(2)(),this._logOpen=!1}}_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const n=e.props.framebuffer;n&&function(e,{id:t,minimap:n,opaque:i,top:s="0",left:r="0",rgbaScale:o=1}){oh||(oh=document.createElement("canvas"),oh.id=t,oh.title=t,oh.style.zIndex="100",oh.style.position="absolute",oh.style.top=s,oh.style.left=r,oh.style.border="blue 5px solid",oh.style.transform="scaleY(-1)",document.body.appendChild(oh),ah=oh.getContext("2d")),oh.width===e.width&&oh.height===e.height||(oh.width=e.width/2,oh.height=e.height/2,oh.style.width="400px",oh.style.height="400px");const a=e.device.readPixelsToArrayWebGL(e),l=null==ah?void 0:ah.createImageData(e.width,e.height);if(l){const e=0;for(let t=0;t<a.length;t+=4)l.data[e+t+0]=a[t+0]*o,l.data[e+t+1]=a[t+1]*o,l.data[e+t+2]=a[t+2]*o,l.data[e+t+3]=i?255:a[t+3]*o;null==ah||ah.putImageData(l,0,0)}}(n,{id:n.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,n]of Object.entries(this._attributeInfos)){const i=this.vertexArray.attributes[n.location];e[n.location]={name:t,type:n.shaderType,values:i?this._getBufferOrConstantValues(i,n.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,n="uint32"===t.indexType?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:n.toString()}}return e}_getBufferOrConstantValues(e,t){const n=Rs(t);return(e instanceof ni?new n(e.debugData):e).toString()}};i(gh,"defaultProps",{...Qi.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Yn.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});let mh=gh;function _h(e){return Boolean(e.uniformTypes&&!yh(e.uniformTypes))}function yh(e){for(const t in e)return!1;return!0}const vh=class e{constructor(t,n=e.defaultProps){if(i(this,"device"),i(this,"model"),i(this,"transformFeedback"),!e.isSupported(t))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=t,this.model=new mh(this.device,{id:n.id||"buffer-transform-model",fs:n.fs||Kn(),topology:n.topology||"point-list",varyings:n.outputs||n.varyings,...n}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:n.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}static isSupported(e){var t;return"webgl"===(null==(t=null==e?void 0:e.info)?void 0:t.type)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){(null==e?void 0:e.inputBuffers)&&this.model.setAttributes(e.inputBuffers),(null==e?void 0:e.outputBuffers)&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof ni)return t.readAsync();const{buffer:n,byteOffset:i=0,byteLength:s=n.byteLength}=t;return n.readAsync(i,s)}};i(vh,"defaultProps",{...mh.defaultProps,outputs:void 0,feedbackBuffers:void 0});let bh=vh;class Eh{constructor(e){i(this,"id"),i(this,"topology"),i(this,"vertexCount"),i(this,"indices"),i(this,"attributes"),i(this,"userData",{});const{attributes:t={},indices:n=null,vertexCount:s=null}=e;this.id=e.id||Ju("geometry"),this.topology=e.topology,n&&(this.indices=ArrayBuffer.isView(n)?{value:n,size:1}:n),this.attributes={};for(const[i,r]of Object.entries(t)){const e=ArrayBuffer.isView(r)?{value:r}:r;if(!ArrayBuffer.isView(e.value))throw new Error(`${this._print(i)}: must be typed array or object with value as typed array`);if("POSITION"!==i&&"positions"!==i||e.size||(e.size=3),"indices"===i){if(this.indices)throw new Error("Multiple indices detected");this.indices=e}else this.attributes[i]=e}this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=s||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let n=1/0;for(const i of Object.values(e)){const{value:e,size:t,constant:s}=i;!s&&e&&void 0!==t&&t>=1&&(n=Math.min(n,e.length/t))}return n}}const xh={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class wh extends bu{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:n,viewports:i,onViewportActive:s,pickingFBO:r,deviceRect:{x:o,y:a,width:l,height:c},cullRect:u,effects:h,pass:d="picking",pickZ:f,shaderModuleProps:p}){this.pickZ=f;const g=this._resetColorEncoder(f),m=[o,a,l,c],_=super.render({target:r,layers:e,layerFilter:t,views:n,viewports:i,onViewportActive:s,cullRect:u,effects:null==h?void 0:h.filter((e=>e.useInPicking)),pass:d,isPicking:!0,shaderModuleProps:p,clearColor:[0,0,0,0],colorMask:15,scissorRect:m});this._colorEncoderState=null;return{decodePickingColor:g&&Th.bind(null,g),stats:_}}shouldDrawLayer(e){const{pickable:t,operation:n}=e.props;return t&&n.includes("draw")||n.includes("terrain")||n.includes("mask")}getShaderModuleProps(e,t,n){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,n){const i={...e.props.parameters},{pickable:s,operation:r}=e.props;return!this._colorEncoderState||r.includes("terrain")?i.blend=!1:s&&r.includes("draw")&&(Object.assign(i,xh),i.blend=!0,i.blendColor=function(e,t,n){const{byLayer:i,byAlpha:s}=e;let r,o=i.get(t);o?(o.viewports.push(n),r=o.a):(r=i.size+1,r<=255?(o={a:r,layer:t,viewports:[n]},i.set(t,o),s[r]=o):(ln.warn("Too many pickable layers, only picking the first 255")(),r=0));return[0,0,0,r/255]}(this._colorEncoderState,e,n)),i}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function Th(e,t){const n=e.byAlpha[t[3]];return n&&{pickedLayer:n.layer,pickedViewports:n.viewports,pickedObjectIndex:n.layer.decodePickingColor(t)}}const Ah="Awaiting state",Sh="Matched. State transferred from previous layer",Rh="Initialized",Ph="Discarded. Awaiting garbage collection",Ch="No longer matched. Awaiting garbage collection",Ih="Finalized! Awaiting garbage collection",Lh=Symbol.for("component"),Mh=Symbol.for("propTypes"),kh=Symbol.for("deprecatedProps"),Oh=Symbol.for("asyncPropDefaults"),Nh=Symbol.for("asyncPropOriginal"),Fh=Symbol.for("asyncPropResolved");function Bh(e,t=()=>!0){return Array.isArray(e)?Dh(e,t,[]):t(e)?[e]:[]}function Dh(e,t,n){let i=-1;for(;++i<e.length;){const s=e[i];Array.isArray(s)?Dh(s,t,n):t(s)&&n.push(s)}return n}function Uh({target:e,source:t,start:n=0,count:i=1}){const s=t.length,r=i*s;let o=0;for(let a=n;o<s;o++)e[a++]=t[o];for(;o<r;)o<r-o?(e.copyWithin(n+o,n,n+o),o*=2):(e.copyWithin(n+o,n,n+r-o),o=r);return e}class Gh{constructor(e,t,n){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=n,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then((()=>this.getData()))}setData(e,t){if(e===this._data&&!t)return;this._data=e;const n=++this._loadCount;let i=e;"string"==typeof e&&(i=Gt(e)),i instanceof Promise?(this.isLoaded=!1,this._loader=i.then((e=>{this._loadCount===n&&(this.isLoaded=!0,this._error=void 0,this._content=e)})).catch((e=>{this._loadCount===n&&(this.isLoaded=!0,this._error=e||!0)}))):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const s of this._subscribers)s.onChange(this.getData())}}class zh{constructor(e){var t;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:null==(t=e.device)?void 0:t.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return!!e.startsWith(this.protocol)||e in this._resources}add({resourceId:e,data:t,forceUpdate:n=!1,persistent:i=!0}){let s=this._resources[e];s?s.setData(t,n):(s=new Gh(e,t,this._context),this._resources[e]=s),s.persistent=i}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const e in t){const n=t[e],i=this._resources[n.resourceId];i&&i.unsubscribe(n)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:n,requestId:i="default"}){const{_resources:s,protocol:r}=this;e.startsWith(r)&&(s[e=e.replace(r,"")]||this.add({resourceId:e,data:null,persistent:!1}));const o=s[e];if(this._track(n,i,o,t),o)return o.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout((()=>this._prune()),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,n,i){const s=this._consumers,r=s[e]=s[e]||{};let o=r[t];const a=o&&o.resourceId&&this._resources[o.resourceId];a&&(a.unsubscribe(o),this.prune()),n&&(o?(o.onChange=i,o.resourceId=n.id):o={onChange:i,resourceId:n.id},r[t]=o,n.subscribe(o))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];t.persistent||t.inUse()||(t.delete(),delete this._resources[e])}}}class Vh{constructor(e,t){var n;this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=e=>{hn("layerManager.activateViewport",this,e),e&&(this.context.viewport=e)};const{deck:i,stats:s,viewport:r,timeline:o}=t||{};this.layers=[],this.resourceManager=new zh({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:null==e?void 0:e.gl,deck:i,shaderAssembler:cu((null==(n=null==e?void 0:e.info)?void 0:n.shadingLanguage)||"glsl"),defaultShaderModules:[Za],renderPass:void 0,stats:s||new Ve({id:"deck.gl"}),viewport:r||new Uu({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Yu,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const n of this.layers){const i=n.getNeedsRedraw(e);t=t||i}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter((t=>e.find((e=>0===t.id.indexOf(e))))):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){hn("layerManager.setLayers",this,t,e),this._lastRenderedLayers=e;const n=Bh(e,Boolean);for(const i of n)i.context=this.context;this._updateLayers(this.layers,n)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find((t=>t.name===e.name))||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,n=t.findIndex((t=>t.name===e.name));n>=0&&(t.splice(n,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,n){n.raiseError(t,`${e} of ${n}`)}_updateLayers(e,t){const n={};for(const r of e)n[r.id]?ln.warn(`Multiple old layers with same id ${r.id}`)():n[r.id]=r;if(this._defaultShaderModulesChanged){for(const t of e)t.setNeedsUpdate(),t.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const i=[];this._updateSublayersRecursively(t,n,i),this._finalizeOldLayers(n);let s=!1;for(const r of i)if(r.hasUniformTransition()){s=`Uniform transition in ${r}`;break}this._needsUpdate=s,this.layers=i}_updateSublayersRecursively(e,t,n){for(const s of e){s.context=this.context;const e=t[s.id];null===e&&ln.warn(`Multiple new layers with same id ${s.id}`)(),t[s.id]=null;let r=null;try{this._debug&&e!==s&&s.validateProps(),e?(this._transferLayerState(e,s),this._updateLayer(s)):this._initializeLayer(s),n.push(s),r=s.isComposite?s.getSubLayers():null}catch(i){this._handleError("matching",i,s)}r&&this._updateSublayersRecursively(r,t,n)}}_finalizeOldLayers(e){for(const t in e){const n=e[t];n&&this._finalizeLayer(n)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=Rh}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=Sh,t!==e&&(e.lifecycle=Ph)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=Ch;try{e._finalize(),e.lifecycle=Ih}catch(t){this._handleError("finalization",t,e)}}}function Wh(e,t,n){if(e===t)return!0;if(!n||!e||!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!Wh(e[i],t[i],n-1))return!1;return!0}if(Array.isArray(t))return!1;if("object"==typeof e&&"object"==typeof t){const i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(const r of i){if(!t.hasOwnProperty(r))return!1;if(!Wh(e[r],t[r],n-1))return!1}return!0}return!1}class jh{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter((t=>t.containsPixel(e))):this._viewports}getViews(){const e={};return this.views.forEach((t=>{e[t.id]=t})),e}getView(e){return this.views.find((t=>t.id===e))}getViewState(e){const t="string"==typeof e?this.getView(e):e,n=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(n):n}getViewport(e){return this._viewportMap[e]}unproject(e,t){const n=this.getViewports(),i={x:e[0],y:e[1]};for(let s=n.length-1;s>=0;--s){const r=n[s];if(r.containsPixel(i)){const n=e.slice();return n[0]-=r.x,n[1]-=r.y,r.unproject(n,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){e===this.width&&t===this.height||(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Bh(e,Boolean);this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){if(e){!Wh(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e}else ln.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const n=new(0,t.type)({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:t=>{var n;return null==(n=this.getView(e.id))?void 0:n.makeViewport({viewState:t,width:this.width,height:this.height})}});return n}_updateController(e,t,n,i){const s=e.controller;if(s&&n){const r={...t,...s,id:e.id,x:n.x,y:n.y,width:n.width,height:n.height};return i&&i.constructor===s.type||(i=this._createController(e,r)),i&&i.setProps(r),i}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let n=!1;for(let i=e.length;i--;){const s=e[i],r=this.getViewState(s),o=s.makeViewport({viewState:r,width:this.width,height:this.height});let a=t[s.id];const l=Boolean(s.controller);l&&!a&&(n=!0),!n&&l||!a||(a.finalize(),a=null),this.controllers[s.id]=this._updateController(s,r,o,a),o&&this._viewports.unshift(o)}for(const i in t){const e=t[i];e&&!this.controllers[i]&&e.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach((e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)}))}_diffViews(e,t){return e.length!==t.length||e.some(((n,i)=>!e[i].equals(t[i])))}}const Hh=/([0-9]+\.?[0-9]*)(%|px)/;function $h(e){switch(typeof e){case"number":return{position:e,relative:!1};case"string":const t=Hh.exec(e);if(t&&t.length>=3){const e="%"===t[2],n=parseFloat(t[1]);return{position:e?n/100:n,relative:e}}default:throw new Error(`Could not parse position string ${e}`)}}function Xh(e,t){return e.relative?Math.round(e.position*t):e.position}class Yh{constructor(e){const{id:t,x:n=0,y:i=0,width:s="100%",height:r="100%",padding:o=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=$h(n),this._y=$h(i),this._width=$h(s),this._height=$h(r),this._padding=o&&{left:$h(o.left||0),right:$h(o.right||0),top:$h(o.top||0),bottom:$h(o.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e||this.constructor===e.constructor&&Wh(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:n}){n=this.filterViewState(n);const i=this.getDimensions({width:e,height:t});if(!i.height||!i.width)return null;return new(this.getViewportType(n))({...n,...this.props,...i})}getViewStateId(){const{viewState:e}=this.props;return"string"==typeof e?e:(null==e?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&"object"==typeof this.props.viewState){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const e in this.props.viewState)"id"!==e&&(t[e]=this.props.viewState[e]);return t}return e}getDimensions({width:e,height:t}){const n={x:Xh(this._x,e),y:Xh(this._y,t),width:Xh(this._width,e),height:Xh(this._height,t)};return this._padding&&(n.padding={left:Xh(this._padding.left,e),top:Xh(this._padding.top,t),right:Xh(this._padding.right,e),bottom:Xh(this._padding.bottom,t)}),n}get controller(){const e=this.props.controller;return e?!0===e?{type:this.ControllerType}:"function"==typeof e?{type:e}:{type:this.ControllerType,...e}:null}}class Kh{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){var t,n;this.cancel(),this.settings=e,this._inProgress=!0,null==(n=(t=this.settings).onStart)||n.call(t,this)}end(){var e,t;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,null==(t=(e=this.settings).onEnd)||t.call(e,this))}cancel(){var e,t;this._inProgress&&(null==(t=(e=this.settings).onInterrupt)||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,t;if(!this._inProgress)return!1;if(null===this._handle){const{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),null==(t=(e=this.settings).onUpdate)||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const qh=()=>{},Zh=2,Qh=3,Jh=e=>e,ed=1;class td{constructor(e){this._onTransitionUpdate=e=>{const{time:t,settings:{interpolator:n,startProps:i,endProps:s,duration:r,easing:o}}=e,a=o(t/r),l=n.interpolateProps(i,s,a);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new Kh(e.timeline),this.onViewStateChange=e.onViewStateChange||qh,this.onStateChange=e.onStateChange||qh}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const n=this.props;if(this.props=e,!n||this._shouldIgnoreViewportChange(n,e))return!1;if(this._isTransitionEnabled(e)){let i=n;if(this.transition.inProgress){const{interruption:e,endProps:t}=this.transition.settings;i={...n,...e===Zh?t:this.propsInTransition||n}}this._triggerTransition(i,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:n}=e;return(t>0||"auto"===t)&&Boolean(n)}_isUpdateDueToCurrentTransition(e){return!(!this.transition.inProgress||!this.propsInTransition)&&this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition)}_shouldIgnoreViewportChange(e,t){if(this.transition.inProgress){return this.transition.settings.interruption===Qh||this._isUpdateDueToCurrentTransition(t)}return!this._isTransitionEnabled(t)||t.transitionInterpolator.arePropsEqual(e,t)}_triggerTransition(e,t){const n=this.getControllerState(e),i=this.getControllerState(t).shortestPathFrom(n),s=t.transitionInterpolator,r=s.getDuration?s.getDuration(e,t):t.transitionDuration;if(0===r)return;const o=s.initializeProps(e,i);this.propsInTransition={};const a={duration:r,easing:t.transitionEasing||Jh,interpolator:s,interruption:t.transitionInterruption||ed,startProps:o.start,endProps:o.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(a),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),null==e||e(t)}}}function nd(e,t){if(!e)throw new Error(t||"deck.gl: assertion failed.")}class id{constructor(e){const{compare:t,extract:n,required:i}=e;this._propsToCompare=t,this._propsToExtract=n||t,this._requiredProps=i}arePropsEqual(e,t){for(const n of this._propsToCompare)if(!(n in e)||!(n in t)||!Qo(e[n],t[n]))return!1;return!0}initializeProps(e,t){const n={},i={};for(const s of this._propsToExtract)(s in e||s in t)&&(n[s]=e[s],i[s]=t[s]);return this._checkRequiredProps(n),this._checkRequiredProps(i),{start:n,end:i}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach((t=>{const n=e[t];nd(Number.isFinite(n)||Array.isArray(n),`${t} is required for transition`)}))}}const sd=["longitude","latitude","zoom","bearing","pitch"],rd=["longitude","latitude","zoom"];class od extends id{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,n=Array.isArray(e)?{}:e;n.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:sd,required:rd},super(n.transitionProps),this.opts=n}initializeProps(e,t){const n=super.initializeProps(e,t),{makeViewport:i,around:s}=this.opts;if(i&&s){const r=i(e),o=i(t),a=r.unproject(s);n.start.around=s,Object.assign(n.end,{around:o.project(a),aroundPosition:a,width:t.width,height:t.height})}return n}interpolateProps(e,t,n){const i={};for(const s of this._propsToExtract)i[s]=Zo(e[s]||0,t[s]||0,n);if(t.aroundPosition&&this.opts.makeViewport){const s=this.opts.makeViewport({...t,...i});Object.assign(i,s.panByPosition(t.aroundPosition,Zo(e.around,t.around,n)))}return i}}const ad={transitionDuration:0},ld=e=>1-(1-e)*(1-e),cd=["wheel"],ud=["panstart","panmove","panend"],hd=["pinchstart","pinchmove","pinchend"],dd=["multipanstart","multipanmove","multipanend"],fd=["dblclick"],pd=["keydown"],gd={};class md{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new td({...e,getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const t in this._events)this._events[t]&&(null==(e=this.eventManager)||e.off(t,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return!t&&this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return!t&&this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return!t&&this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:n}=this.props,{offsetCenter:i}=e;return[i.x-t,i.y-n]}isPointInBounds(e,t){const{width:n,height:i}=this.props;if(t&&t.handled)return!1;const s=e[0]>=0&&e[0]<=n&&e[1]>=0&&e[1]<=i;return s&&t&&t.stopPropagation(),s}isFunctionKeyPressed(e){const{srcEvent:t}=e;return Boolean(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout((()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)}),e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:!0===t?300:0;const{scrollZoom:n=!0,dragPan:i=!0,dragRotate:s=!0,doubleClickZoom:r=!0,touchZoom:o=!0,touchRotate:a=!1,keyboard:l=!0}=e,c=Boolean(this.onViewStateChange);this.toggleEvents(cd,c&&n),this.toggleEvents(ud,c),this.toggleEvents(hd,c&&(o||a)),this.toggleEvents(dd,c&&a),this.toggleEvents(fd,c&&r),this.toggleEvents(pd,c&&l),this.scrollZoom=n,this.dragPan=i,this.dragRotate=s,this.doubleClickZoom=r,this.touchZoom=o,this.touchRotate=a,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach((e=>{this._events[e]!==t&&(this._events[e]=t,t?this.eventManager.on(e,this.handleEvent):this.eventManager.off(e,this.handleEvent))}))}updateViewport(e,t=null,n={}){const i={...e.getViewportProps(),...t},s=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(n),s){const e=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:i,interactionState:this._interactionState,oldViewState:e,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let n=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||"pan"===this.dragMode)&&(n=!n);const i=this.controllerState[n?"panStart":"rotateStart"]({pos:t});return this._panMove=n,this.updateViewport(i,ad,{isDragging:!0}),!0}_onPan(e){return!!this.isDragging()&&(this._panMove?this._onPanMove(e):this._onPanRotate(e))}_onPanEnd(e){return!!this.isDragging()&&(this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e))}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),n=this.controllerState.pan({pos:t});return this.updateViewport(n,ad,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const n=this.getCenter(e),i=[n[0]+e.velocityX*t/2,n[1]+e.velocityY*t/2],s=this.controllerState.pan({pos:i}).panEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:ld},{isDragging:!1,isPanning:!0})}else{const e=this.controllerState.panEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),n=this.controllerState.rotate({pos:t});return this.updateViewport(n,ad,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const n=this.getCenter(e),i=[n[0]+e.velocityX*t/2,n[1]+e.velocityY*t/2],s=this.controllerState.rotate({pos:i}).rotateEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:ld},{isDragging:!1,isRotating:!0})}else{const e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:n=.01,smooth:i=!1}=!0===this.scrollZoom?{}:this.scrollZoom,{delta:s}=e;let r=2/(1+Math.exp(-Math.abs(s*n)));s<0&&0!==r&&(r=1/r);const o=this.controllerState.zoom({pos:t,scale:r});return this.updateViewport(o,{...this._getTransitionProps({around:t}),transitionDuration:i?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.controllerState.rotateStart({pos:t});return this.updateViewport(n,ad,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate)return!1;if(!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const n=this.controllerState.rotate({pos:t});return this.updateViewport(n,ad,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const n=this.getCenter(e),i=[n[0],n[1]+=e.velocityY*t/2],s=this.controllerState.rotate({pos:i});this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:ld},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return gd._startPinchRotation=e.rotation,gd._lastPinchEvent=e,this.updateViewport(n,ad,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate)return!1;if(!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:n}=e,i=this.getCenter(e);t=t.zoom({pos:i,scale:n})}if(this.touchRotate){const{rotation:n}=e;t=t.rotate({deltaAngleX:gd._startPinchRotation-n})}return this.updateViewport(t,ad,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),gd._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:n}=gd;if(this.touchZoom&&t&&n&&e.scale!==n.scale){const i=this.getCenter(e);let s=this.controllerState.rotateEnd();const r=Math.log2(e.scale),o=(r-Math.log2(n.scale))/(e.deltaTime-n.deltaTime),a=Math.pow(2,r+o*t/2);s=s.zoom({pos:i,scale:a}).zoomEnd(),this.updateViewport(s,{...this._getTransitionProps({around:i}),transitionDuration:t,transitionEasing:ld},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const e=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return gd._startPinchRotation=null,gd._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.isFunctionKeyPressed(e),i=this.controllerState.zoom({pos:t,scale:n?.5:2});return this.updateViewport(i,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:n,moveSpeed:i,rotateSpeedX:s,rotateSpeedY:r}=!0===this.keyboard?{}:this.keyboard,{controllerState:o}=this;let a;const l={};switch(e.srcEvent.code){case"Minus":a=t?o.zoomOut(n).zoomOut(n):o.zoomOut(n),l.isZooming=!0;break;case"Equal":a=t?o.zoomIn(n).zoomIn(n):o.zoomIn(n),l.isZooming=!0;break;case"ArrowLeft":t?(a=o.rotateLeft(s),l.isRotating=!0):(a=o.moveLeft(i),l.isPanning=!0);break;case"ArrowRight":t?(a=o.rotateRight(s),l.isRotating=!0):(a=o.moveRight(i),l.isPanning=!0);break;case"ArrowUp":t?(a=o.rotateUp(r),l.isRotating=!0):(a=o.moveUp(i),l.isPanning=!0);break;case"ArrowDown":t?(a=o.rotateDown(r),l.isRotating=!0):(a=o.moveDown(i),l.isPanning=!0);break;default:return!1}return this.updateViewport(a,this._getTransitionProps(),l),!0}_getTransitionProps(e){const{transition:t}=this;return t&&t.transitionInterpolator?e?{...t,transitionInterpolator:new od({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t:ad}}class _d{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}class yd extends _d{constructor(e){const{width:t,height:n,latitude:i,longitude:s,zoom:r,bearing:o=0,pitch:a=0,altitude:l=1.5,position:c=[0,0,0],maxZoom:u=20,minZoom:h=0,maxPitch:d=60,minPitch:f=0,startPanLngLat:p,startZoomLngLat:g,startRotatePos:m,startBearing:_,startPitch:y,startZoom:v,normalize:b=!0}=e;nd(Number.isFinite(s)),nd(Number.isFinite(i)),nd(Number.isFinite(r)),super({width:t,height:n,latitude:i,longitude:s,zoom:r,bearing:o,pitch:a,altitude:l,maxZoom:u,minZoom:h,maxPitch:d,minPitch:f,normalize:b,position:c},{startPanLngLat:p,startZoomLngLat:g,startRotatePos:m,startBearing:_,startPitch:y,startZoom:v}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const n=this.getState().startPanLngLat||this._unproject(t);if(!n)return this;const i=this.makeViewport(this.getViewportProps()).panByPosition(n,e);return this._getUpdatedState(i)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:n=0}){const{startRotatePos:i,startBearing:s,startPitch:r}=this.getState();if(!i||void 0===s||void 0===r)return this;let o;return o=e?this._getNewRotation(e,i,r,s):{bearing:s+t,pitch:r+n},this._getUpdatedState(o)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:n}){let{startZoom:i,startZoomLngLat:s}=this.getState();if(s||(i=this.getViewportProps().zoom,s=this._unproject(t)||this._unproject(e)),!s)return this;const{maxZoom:r,minZoom:o}=this.getViewportProps();let a=i+Math.log2(n);a=qo(a,o,r);const l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(s,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),n={...this.getViewportProps()},{bearing:i,longitude:s}=n;return Math.abs(i-t.bearing)>180&&(n.bearing=i<0?i+360:i-360),Math.abs(s-t.longitude)>180&&(n.longitude=s<0?s+360:s-360),n}applyConstraints(e){const{maxZoom:t,minZoom:n,zoom:i}=e;e.zoom=qo(i,n,t);const{maxPitch:s,minPitch:r,pitch:o}=e;e.pitch=qo(o,r,s);const{normalize:a=!0}=e;return a&&Object.assign(e,function(e){const{width:t,height:n,pitch:i=0}=e;let{longitude:s,latitude:r,zoom:o,bearing:a=0}=e;(s<-180||s>180)&&(s=xc(s+180,360)-180),(a<-180||a>180)&&(a=xc(a+180,360)-180);const l=Tc(n/512);if(o<=l)o=l,r=0;else{const e=n/2/Math.pow(2,o),t=Bc([0,e])[1];if(r<t)r=t;else{const t=Bc([0,512-e])[1];r>t&&(r=t)}}return{width:t,height:n,longitude:s,latitude:r,zoom:o,pitch:i,bearing:a}}(e)),e}_zoomFromCenter(e){const{width:t,height:n}=this.getViewportProps();return this.zoom({pos:[t/2,n/2],scale:e})}_panFromCenter(e){const{width:t,height:n}=this.getViewportProps();return this.pan({startPos:[t/2,n/2],pos:[t/2+e[0],n/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,n,i){const s=e[0]-t[0],r=e[1]-t[1],o=e[1],a=t[1],{width:l,height:c}=this.getViewportProps(),u=s/l;let h=0;r>0?Math.abs(c-a)>5&&(h=r/(a-c)*1.2):r<0&&a>5&&(h=1-o/a),h=qo(h,-1,1);const{minPitch:d,maxPitch:f}=this.getViewportProps();let p=n;return h>0?p=n+h*(f-n):h<0&&(p=n-h*(d-n)),{pitch:p,bearing:i+180*u}}}class vd extends md{constructor(){super(...arguments),this.ControllerState=yd,this.transition={transitionDuration:300,transitionInterpolator:new od({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e);(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class bd extends Yh{constructor(e={}){super(e)}getViewportType(){return zu}get ControllerType(){return vd}}bd.displayName="MapView";const Ed=bd,xd=new Ru;class wd{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find((t=>t.id===e.id))){const n=t.findIndex((t=>function(e,t){return(e.order??1/0)-(t.order??1/0)}(t,e)>0));n<0?t.push(e):t.splice(n,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(Wh(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const i of this.effects)t[i.id]=i;const n=[];for(const i of e){const e=t[i.id];let s=i;e&&e!==i?e.setProps?(e.setProps(i.props),s=e):e.cleanup(this._context):e||i.setup(this._context),n.push(s),delete t[i.id]}for(const i in t)t[i].cleanup(this._context);this.effects=n,this._resolvedEffects=n.concat(this._defaultEffects),e.some((e=>e instanceof Ru))||this._resolvedEffects.push(xd),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class Td extends bu{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}class Ad{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new Td(e),this.pickLayersPass=new wh(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,n={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};n.effects&&this._preRender(n.effects,n);const i=this.lastPostProcessEffect?this.renderBuffers[0]:n.target;this.lastPostProcessEffect&&(n.clearColor=[0,0,0,0],n.clearCanvas=!0);const s=t.render({...n,target:i});n.effects&&this._postRender(n.effects,n),this.renderCount++,hn("deckRenderer.renderLayers",this,s,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const n of e)t.preRenderStats[n.id]=n.preRender(t),n.postRender&&(this.lastPostProcessEffect=n.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();0===e.length&&[0,1].map((t=>{const n=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${t}`,colorAttachments:[n]}))}));for(const n of e)n.resize(t)}_postRender(e,t){const{renderBuffers:n}=this,i={...t,inputBuffer:n[0],swapBuffer:n[1]};for(const s of e)if(s.postRender){i.target=s.id===this.lastPostProcessEffect?t.target:void 0;const e=s.postRender(i);i.inputBuffer=e,i.swapBuffer=e===n[0]?n[1]:n[0]}}}const Sd={pickedColor:null,pickedObjectIndex:-1};function Rd({pickedColors:e,decodePickingColor:t,deviceX:n,deviceY:i,deviceRadius:s,deviceRect:r}){const{x:o,y:a,width:l,height:c}=r;let u=s*s,h=-1,d=0;for(let f=0;f<c;f++){const t=f+a-i,s=t*t;if(s>u)d+=4*l;else for(let i=0;i<l;i++){if(e[d+3]-1>=0){const e=i+o-n,t=e*e+s;t<=u&&(u=t,h=d)}d+=4}}if(h>=0){const n=e.slice(h,h+4),i=t(n);if(i){const e=Math.floor(h/4/l),t=h/4-e*l;return{...i,pickedColor:n,pickedX:o+t,pickedY:a+e}}ln.error("Picked non-existent layer. Is picking buffer corrupt?")()}return Sd}function Pd({pickInfo:e,viewports:t,pixelRatio:n,x:i,y:s,z:r}){let o,a=t[0];if(t.length>1&&(a=function(e,t){for(let n=e.length-1;n>=0;n--){const i=e[n];if(i.containsPixel(t))return i}return e[0]}((null==e?void 0:e.pickedViewports)||t,{x:i,y:s})),a){const e=[i-a.x,s-a.y];void 0!==r&&(e[2]=r),o=a.unproject(e)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:i,y:s,pixel:[i,s],coordinate:o,devicePixel:e&&"pickedX"in e?[e.pickedX,e.pickedY]:void 0,pixelRatio:n}}function Cd(e){const{pickInfo:t,lastPickedInfo:n,mode:i,layers:s}=e,{pickedColor:r,pickedLayer:o,pickedObjectIndex:a}=t,l=o?[o]:[];if("hover"===i){const e=n.index,t=n.layerId,i=o?o.props.id:null;if(i!==t||a!==e){if(i!==t){const e=s.find((e=>e.props.id===t));e&&l.unshift(e)}n.layerId=i,n.index=a,n.info=null}}const c=Pd(e),u=new Map;return u.set(null,c),l.forEach((e=>{let t={...c};e===o&&(t.color=r,t.index=a,t.picked=!0),t=Id({layer:e,info:t,mode:i});const s=t.layer;e===o&&"hover"===i&&(n.info=t),u.set(s.id,t),"hover"===i&&s.updateAutoHighlight(t)})),u}function Id({layer:e,info:t,mode:n}){for(;e&&t;){const i=t.layer||null;t.sourceLayer=i,t.layer=e,t=e.getPickingInfo({info:t,mode:n,sourceLayer:i}),e=e.parent}return t}class Ld{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new wh(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:n,viewports:i},s=this.lastPickedInfo.info){const r=s&&s.layer&&s.layer.id,o=s&&s.viewport&&s.viewport.id,a=r?n.find((e=>e.id===r)):null,l=o&&i.find((e=>e.id===o))||i[0],c=l&&l.unproject([e-l.x,t-l.y]),u={x:e,y:t,viewport:l,coordinate:c,layer:a};return{...s,...u}}_resizeBuffer(){var e,t;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const e=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=e}const{canvas:n}=this.device.getDefaultCanvasContext();null==(e=this.pickingFBO)||e.resize({width:n.width,height:n.height}),null==(t=this.depthFBO)||t.resize({width:n.width,height:n.height})}_getPickable(e){if(!1===this._pickable)return null;const t=e.filter((e=>this.pickLayersPass.shouldDrawLayer(e)&&!e.isComposite));return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:n,x:i,y:s,radius:r=0,depth:o=1,mode:a="query",unproject3D:l,onViewportActive:c,effects:u}){const h=this.device.canvasContext.cssToDeviceRatio(),d=this._getPickable(e);if(!d||0===n.length)return{result:[],emptyInfo:Pd({viewports:n,x:i,y:s,pixelRatio:h})};this._resizeBuffer();const f=this.device.canvasContext.cssToDevicePixels([i,s],!0),p=[f.x+Math.floor(f.width/2),f.y+Math.floor(f.height/2)],g=Math.round(r*h),{width:m,height:_}=this.pickingFBO,y=this._getPickingRect({deviceX:p[0],deviceY:p[1],deviceRadius:g,deviceWidth:m,deviceHeight:_}),v={x:i-r,y:s-r,width:2*r+1,height:2*r+1};let b;const E=[],x=new Set;for(let w=0;w<o;w++){let e,r;if(y){e=Rd({...this._drawAndSample({layers:d,views:t,viewports:n,onViewportActive:c,deviceRect:y,cullRect:v,effects:u,pass:`picking:${a}`}),deviceX:p[0],deviceY:p[1],deviceRadius:g,deviceRect:y})}else e={pickedColor:null,pickedObjectIndex:-1};if(e.pickedLayer&&l&&this.depthFBO){const{pickedColors:i}=this._drawAndSample({layers:[e.pickedLayer],views:t,viewports:n,onViewportActive:c,deviceRect:{x:e.pickedX,y:e.pickedY,width:1,height:1},cullRect:v,effects:u,pass:`picking:${a}:z`},!0);i[3]&&(r=i[0])}e.pickedLayer&&w+1<o&&(x.add(e.pickedLayer),e.pickedLayer.disablePickingIndex(e.pickedObjectIndex)),b=Cd({pickInfo:e,lastPickedInfo:this.lastPickedInfo,mode:a,layers:d,viewports:n,x:i,y:s,z:r,pixelRatio:h});for(const t of b.values())t.layer&&E.push(t);if(!e.pickedColor)break}for(const w of x)w.restorePickingColors();return{result:E,emptyInfo:b.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:n,x:i,y:s,width:r=1,height:o=1,mode:a="query",maxObjects:l=null,onViewportActive:c,effects:u}){const h=this._getPickable(e);if(!h||0===n.length)return[];this._resizeBuffer();const d=this.device.canvasContext.cssToDeviceRatio(),f=this.device.canvasContext.cssToDevicePixels([i,s],!0),p=f.x,g=f.y+f.height,m=this.device.canvasContext.cssToDevicePixels([i+r,s+o],!0),_=m.x+m.width,y=m.y,v={x:p,y:y,width:_-p,height:g-y},b=function({pickedColors:e,decodePickingColor:t}){const n=new Map;if(e)for(let i=0;i<e.length;i+=4)if(e[i+3]-1>=0){const s=e.slice(i,i+4),r=s.join(",");if(!n.has(r)){const e=t(s);e?n.set(r,{...e,color:s}):ln.error("Picked non-existent layer. Is picking buffer corrupt?")()}}return Array.from(n.values())}(this._drawAndSample({layers:h,views:t,viewports:n,onViewportActive:c,deviceRect:v,cullRect:{x:i,y:s,width:r,height:o},effects:u,pass:`picking:${a}`})),E=new Map,x=[],w=Number.isFinite(l);for(let T=0;T<b.length&&!(w&&x.length>=l);T++){const e=b[T];let t={color:e.pickedColor,layer:null,index:e.pickedObjectIndex,picked:!0,x:i,y:s,pixelRatio:d};t=Id({layer:e.pickedLayer,info:t,mode:a});const n=t.layer.id;E.has(n)||E.set(n,new Set);const r=E.get(n),o=t.object??t.index;r.has(o)||(r.add(o),x.push(t))}return x}_drawAndSample({layers:e,views:t,viewports:n,onViewportActive:i,deviceRect:s,cullRect:r,effects:o,pass:a},l=!1){const c=l?this.depthFBO:this.pickingFBO,u={layers:e,layerFilter:this.layerFilter,views:t,viewports:n,onViewportActive:i,pickingFBO:c,deviceRect:s,cullRect:r,effects:o,pass:a,pickZ:l,preRenderStats:{},isPicking:!0};for(const _ of o)_.useInPicking&&(u.preRenderStats[_.id]=_.preRender(u));const{decodePickingColor:h}=this.pickLayersPass.render(u),{x:d,y:f,width:p,height:g}=s,m=new(l?Float32Array:Uint8Array)(p*g*4);return this.device.readPixelsToArrayWebGL(c,{sourceX:d,sourceY:f,sourceWidth:p,sourceHeight:g,target:m}),{pickedColors:m,decodePickingColor:h}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:n,deviceWidth:i,deviceHeight:s}){const r=Math.max(0,e-n),o=Math.max(0,t-n),a=Math.min(i,e+n+1)-r,l=Math.min(s,t+n+1)-o;return a<=0||l<=0?null:{x:r,y:o,width:a,height:l}}}const Md={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},kd="top-left",Od="__root";class Nd{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!Wh(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find((t=>t.id===e.id))||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const n of this.resolvedWidgets)t[n.id]=n;this.resolvedWidgets.length=0;for(const n of this.defaultWidgets)t[n.id]=null,this.resolvedWidgets.push(n);for(let n of e){const e=t[n.id];e?e.viewId!==n.viewId||e.placement!==n.placement?(this._remove(e),this._add(n)):n!==e&&(e.setProps(n.props),n=e):this._add(n),t[n.id]=null,this.resolvedWidgets.push(n)}for(const n in t){const e=t[n];e&&this._remove(e)}this.widgets=e}_add(e){const{viewId:t=null,placement:n=kd}=e,i=e.onAdd({deck:this.deck,viewId:t});i&&this._getContainer(t,n).append(i),e._element=i}_remove(e){var t;null==(t=e.onRemove)||t.call(e),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){var n;const i=e||Od;let s=this.containers[i];s||(s=document.createElement("div"),s.style.pointerEvents="none",s.style.position="absolute",s.style.overflow="hidden",null==(n=this.parentElement)||n.append(s),this.containers[i]=s);let r=s.querySelector(`.${t}`);return r||(r=document.createElement("div"),r.className=t,r.style.position="absolute",r.style.zIndex="2",Object.assign(r.style,Md[t]),s.append(r)),r}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const n in this.containers){const i=this.lastViewports[n]||null,s=n===Od||i,r=this.containers[n];s?(r.style.display="block",r.style.left=`${i?i.x:0}px`,r.style.top=`${i?i.y:0}px`,r.style.width=`${i?i.width:e}px`,r.style.height=`${i?i.height:t}px`):r.style.display="none"}}onRedraw({viewports:e,layers:t}){var n,i;const s=e.reduce(((e,t)=>(e[t.id]=t,e)),{});for(const r of this.getWidgets()){const{viewId:o}=r;if(o){const e=s[o];e&&(r.onViewportChange&&r.onViewportChange(e),null==(n=r.onRedraw)||n.call(r,{viewports:[e],layers:t}))}else{if(r.onViewportChange)for(const t of e)r.onViewportChange(t);null==(i=r.onRedraw)||i.call(r,{viewports:e,layers:t})}}this.lastViewports=s,this._updateContainers()}onHover(e,t){var n,i;for(const s of this.getWidgets()){const{viewId:r}=s;r&&r!==(null==(n=e.viewport)?void 0:n.id)||null==(i=s.onHover)||i.call(s,e,t)}}onEvent(e,t){var n,i;const s=ic[t.type];if(s)for(const r of this.getWidgets()){const{viewId:o}=r;o&&o!==(null==(n=e.viewport)?void 0:n.id)||null==(i=r[s])||i.call(r,e,t)}}}const Fd={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class Bd{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,Fd),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var t;this.isVisible&&e.id===(null==(t=this.lastViewport)?void 0:t.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,n=t&&t.props.getTooltip;if(!n)return;const i=n(e);this.lastViewport=e.viewport,this.setTooltip(i,e.x,e.y)}setTooltip(e,t,n){const i=this.element;if(i){if("string"==typeof e)i.innerText=e;else{if(!e)return this.isVisible=!1,void(i.style.display="none");e.text&&(i.innerText=e.text),e.html&&(i.innerHTML=e.html),e.className&&(i.className=e.className)}this.isVisible=!0,i.style.display="block",i.style.transform=`translate(${t}px, ${n}px)`,e&&"object"==typeof e&&"style"in e&&Object.assign(i.style,e.style)}}}var Dd,Ud;(Ud=Dd||(Dd={}))[Ud.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",Ud[Ud.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",Ud[Ud.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",Ud[Ud.POINTS=0]="POINTS",Ud[Ud.LINES=1]="LINES",Ud[Ud.LINE_LOOP=2]="LINE_LOOP",Ud[Ud.LINE_STRIP=3]="LINE_STRIP",Ud[Ud.TRIANGLES=4]="TRIANGLES",Ud[Ud.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",Ud[Ud.TRIANGLE_FAN=6]="TRIANGLE_FAN",Ud[Ud.ZERO=0]="ZERO",Ud[Ud.ONE=1]="ONE",Ud[Ud.SRC_COLOR=768]="SRC_COLOR",Ud[Ud.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",Ud[Ud.SRC_ALPHA=770]="SRC_ALPHA",Ud[Ud.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",Ud[Ud.DST_ALPHA=772]="DST_ALPHA",Ud[Ud.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",Ud[Ud.DST_COLOR=774]="DST_COLOR",Ud[Ud.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",Ud[Ud.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",Ud[Ud.CONSTANT_COLOR=32769]="CONSTANT_COLOR",Ud[Ud.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",Ud[Ud.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",Ud[Ud.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",Ud[Ud.FUNC_ADD=32774]="FUNC_ADD",Ud[Ud.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",Ud[Ud.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",Ud[Ud.BLEND_EQUATION=32777]="BLEND_EQUATION",Ud[Ud.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",Ud[Ud.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",Ud[Ud.BLEND_DST_RGB=32968]="BLEND_DST_RGB",Ud[Ud.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",Ud[Ud.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",Ud[Ud.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",Ud[Ud.BLEND_COLOR=32773]="BLEND_COLOR",Ud[Ud.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",Ud[Ud.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",Ud[Ud.LINE_WIDTH=2849]="LINE_WIDTH",Ud[Ud.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",Ud[Ud.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",Ud[Ud.CULL_FACE_MODE=2885]="CULL_FACE_MODE",Ud[Ud.FRONT_FACE=2886]="FRONT_FACE",Ud[Ud.DEPTH_RANGE=2928]="DEPTH_RANGE",Ud[Ud.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",Ud[Ud.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",Ud[Ud.DEPTH_FUNC=2932]="DEPTH_FUNC",Ud[Ud.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",Ud[Ud.STENCIL_FUNC=2962]="STENCIL_FUNC",Ud[Ud.STENCIL_FAIL=2964]="STENCIL_FAIL",Ud[Ud.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",Ud[Ud.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",Ud[Ud.STENCIL_REF=2967]="STENCIL_REF",Ud[Ud.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",Ud[Ud.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",Ud[Ud.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",Ud[Ud.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",Ud[Ud.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",Ud[Ud.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",Ud[Ud.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",Ud[Ud.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",Ud[Ud.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",Ud[Ud.VIEWPORT=2978]="VIEWPORT",Ud[Ud.SCISSOR_BOX=3088]="SCISSOR_BOX",Ud[Ud.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",Ud[Ud.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",Ud[Ud.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",Ud[Ud.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",Ud[Ud.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",Ud[Ud.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",Ud[Ud.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",Ud[Ud.RED_BITS=3410]="RED_BITS",Ud[Ud.GREEN_BITS=3411]="GREEN_BITS",Ud[Ud.BLUE_BITS=3412]="BLUE_BITS",Ud[Ud.ALPHA_BITS=3413]="ALPHA_BITS",Ud[Ud.DEPTH_BITS=3414]="DEPTH_BITS",Ud[Ud.STENCIL_BITS=3415]="STENCIL_BITS",Ud[Ud.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",Ud[Ud.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",Ud[Ud.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",Ud[Ud.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",Ud[Ud.SAMPLES=32937]="SAMPLES",Ud[Ud.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",Ud[Ud.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",Ud[Ud.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",Ud[Ud.VENDOR=7936]="VENDOR",Ud[Ud.RENDERER=7937]="RENDERER",Ud[Ud.VERSION=7938]="VERSION",Ud[Ud.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",Ud[Ud.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",Ud[Ud.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",Ud[Ud.STATIC_DRAW=35044]="STATIC_DRAW",Ud[Ud.STREAM_DRAW=35040]="STREAM_DRAW",Ud[Ud.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",Ud[Ud.ARRAY_BUFFER=34962]="ARRAY_BUFFER",Ud[Ud.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",Ud[Ud.BUFFER_SIZE=34660]="BUFFER_SIZE",Ud[Ud.BUFFER_USAGE=34661]="BUFFER_USAGE",Ud[Ud.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",Ud[Ud.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",Ud[Ud.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",Ud[Ud.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",Ud[Ud.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",Ud[Ud.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",Ud[Ud.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",Ud[Ud.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",Ud[Ud.CULL_FACE=2884]="CULL_FACE",Ud[Ud.FRONT=1028]="FRONT",Ud[Ud.BACK=1029]="BACK",Ud[Ud.FRONT_AND_BACK=1032]="FRONT_AND_BACK",Ud[Ud.BLEND=3042]="BLEND",Ud[Ud.DEPTH_TEST=2929]="DEPTH_TEST",Ud[Ud.DITHER=3024]="DITHER",Ud[Ud.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",Ud[Ud.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",Ud[Ud.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",Ud[Ud.SCISSOR_TEST=3089]="SCISSOR_TEST",Ud[Ud.STENCIL_TEST=2960]="STENCIL_TEST",Ud[Ud.NO_ERROR=0]="NO_ERROR",Ud[Ud.INVALID_ENUM=1280]="INVALID_ENUM",Ud[Ud.INVALID_VALUE=1281]="INVALID_VALUE",Ud[Ud.INVALID_OPERATION=1282]="INVALID_OPERATION",Ud[Ud.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",Ud[Ud.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",Ud[Ud.CW=2304]="CW",Ud[Ud.CCW=2305]="CCW",Ud[Ud.DONT_CARE=4352]="DONT_CARE",Ud[Ud.FASTEST=4353]="FASTEST",Ud[Ud.NICEST=4354]="NICEST",Ud[Ud.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",Ud[Ud.BYTE=5120]="BYTE",Ud[Ud.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",Ud[Ud.SHORT=5122]="SHORT",Ud[Ud.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",Ud[Ud.INT=5124]="INT",Ud[Ud.UNSIGNED_INT=5125]="UNSIGNED_INT",Ud[Ud.FLOAT=5126]="FLOAT",Ud[Ud.DOUBLE=5130]="DOUBLE",Ud[Ud.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",Ud[Ud.ALPHA=6406]="ALPHA",Ud[Ud.RGB=6407]="RGB",Ud[Ud.RGBA=6408]="RGBA",Ud[Ud.LUMINANCE=6409]="LUMINANCE",Ud[Ud.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",Ud[Ud.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",Ud[Ud.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",Ud[Ud.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",Ud[Ud.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",Ud[Ud.VERTEX_SHADER=35633]="VERTEX_SHADER",Ud[Ud.COMPILE_STATUS=35713]="COMPILE_STATUS",Ud[Ud.DELETE_STATUS=35712]="DELETE_STATUS",Ud[Ud.LINK_STATUS=35714]="LINK_STATUS",Ud[Ud.VALIDATE_STATUS=35715]="VALIDATE_STATUS",Ud[Ud.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",Ud[Ud.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",Ud[Ud.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",Ud[Ud.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",Ud[Ud.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",Ud[Ud.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",Ud[Ud.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",Ud[Ud.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",Ud[Ud.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",Ud[Ud.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",Ud[Ud.SHADER_TYPE=35663]="SHADER_TYPE",Ud[Ud.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",Ud[Ud.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",Ud[Ud.NEVER=512]="NEVER",Ud[Ud.LESS=513]="LESS",Ud[Ud.EQUAL=514]="EQUAL",Ud[Ud.LEQUAL=515]="LEQUAL",Ud[Ud.GREATER=516]="GREATER",Ud[Ud.NOTEQUAL=517]="NOTEQUAL",Ud[Ud.GEQUAL=518]="GEQUAL",Ud[Ud.ALWAYS=519]="ALWAYS",Ud[Ud.KEEP=7680]="KEEP",Ud[Ud.REPLACE=7681]="REPLACE",Ud[Ud.INCR=7682]="INCR",Ud[Ud.DECR=7683]="DECR",Ud[Ud.INVERT=5386]="INVERT",Ud[Ud.INCR_WRAP=34055]="INCR_WRAP",Ud[Ud.DECR_WRAP=34056]="DECR_WRAP",Ud[Ud.NEAREST=9728]="NEAREST",Ud[Ud.LINEAR=9729]="LINEAR",Ud[Ud.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",Ud[Ud.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",Ud[Ud.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",Ud[Ud.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",Ud[Ud.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",Ud[Ud.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",Ud[Ud.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",Ud[Ud.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",Ud[Ud.TEXTURE_2D=3553]="TEXTURE_2D",Ud[Ud.TEXTURE=5890]="TEXTURE",Ud[Ud.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",Ud[Ud.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",Ud[Ud.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",Ud[Ud.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",Ud[Ud.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",Ud[Ud.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",Ud[Ud.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",Ud[Ud.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",Ud[Ud.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",Ud[Ud.TEXTURE0=33984]="TEXTURE0",Ud[Ud.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",Ud[Ud.REPEAT=10497]="REPEAT",Ud[Ud.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",Ud[Ud.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",Ud[Ud.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",Ud[Ud.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",Ud[Ud.FLOAT_VEC2=35664]="FLOAT_VEC2",Ud[Ud.FLOAT_VEC3=35665]="FLOAT_VEC3",Ud[Ud.FLOAT_VEC4=35666]="FLOAT_VEC4",Ud[Ud.INT_VEC2=35667]="INT_VEC2",Ud[Ud.INT_VEC3=35668]="INT_VEC3",Ud[Ud.INT_VEC4=35669]="INT_VEC4",Ud[Ud.BOOL=35670]="BOOL",Ud[Ud.BOOL_VEC2=35671]="BOOL_VEC2",Ud[Ud.BOOL_VEC3=35672]="BOOL_VEC3",Ud[Ud.BOOL_VEC4=35673]="BOOL_VEC4",Ud[Ud.FLOAT_MAT2=35674]="FLOAT_MAT2",Ud[Ud.FLOAT_MAT3=35675]="FLOAT_MAT3",Ud[Ud.FLOAT_MAT4=35676]="FLOAT_MAT4",Ud[Ud.SAMPLER_2D=35678]="SAMPLER_2D",Ud[Ud.SAMPLER_CUBE=35680]="SAMPLER_CUBE",Ud[Ud.LOW_FLOAT=36336]="LOW_FLOAT",Ud[Ud.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",Ud[Ud.HIGH_FLOAT=36338]="HIGH_FLOAT",Ud[Ud.LOW_INT=36339]="LOW_INT",Ud[Ud.MEDIUM_INT=36340]="MEDIUM_INT",Ud[Ud.HIGH_INT=36341]="HIGH_INT",Ud[Ud.FRAMEBUFFER=36160]="FRAMEBUFFER",Ud[Ud.RENDERBUFFER=36161]="RENDERBUFFER",Ud[Ud.RGBA4=32854]="RGBA4",Ud[Ud.RGB5_A1=32855]="RGB5_A1",Ud[Ud.RGB565=36194]="RGB565",Ud[Ud.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",Ud[Ud.STENCIL_INDEX=6401]="STENCIL_INDEX",Ud[Ud.STENCIL_INDEX8=36168]="STENCIL_INDEX8",Ud[Ud.DEPTH_STENCIL=34041]="DEPTH_STENCIL",Ud[Ud.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",Ud[Ud.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",Ud[Ud.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",Ud[Ud.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",Ud[Ud.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",Ud[Ud.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",Ud[Ud.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",Ud[Ud.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",Ud[Ud.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",Ud[Ud.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",Ud[Ud.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",Ud[Ud.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",Ud[Ud.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",Ud[Ud.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",Ud[Ud.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",Ud[Ud.NONE=0]="NONE",Ud[Ud.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",Ud[Ud.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",Ud[Ud.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",Ud[Ud.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",Ud[Ud.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",Ud[Ud.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",Ud[Ud.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",Ud[Ud.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",Ud[Ud.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",Ud[Ud.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",Ud[Ud.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",Ud[Ud.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",Ud[Ud.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",Ud[Ud.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",Ud[Ud.READ_BUFFER=3074]="READ_BUFFER",Ud[Ud.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",Ud[Ud.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",Ud[Ud.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",Ud[Ud.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",Ud[Ud.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",Ud[Ud.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",Ud[Ud.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",Ud[Ud.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",Ud[Ud.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",Ud[Ud.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",Ud[Ud.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",Ud[Ud.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",Ud[Ud.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",Ud[Ud.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",Ud[Ud.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",Ud[Ud.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",Ud[Ud.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",Ud[Ud.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",Ud[Ud.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",Ud[Ud.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",Ud[Ud.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",Ud[Ud.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",Ud[Ud.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",Ud[Ud.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",Ud[Ud.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",Ud[Ud.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",Ud[Ud.RED=6403]="RED",Ud[Ud.RGB8=32849]="RGB8",Ud[Ud.RGBA8=32856]="RGBA8",Ud[Ud.RGB10_A2=32857]="RGB10_A2",Ud[Ud.TEXTURE_3D=32879]="TEXTURE_3D",Ud[Ud.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",Ud[Ud.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",Ud[Ud.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",Ud[Ud.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",Ud[Ud.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",Ud[Ud.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",Ud[Ud.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",Ud[Ud.SRGB=35904]="SRGB",Ud[Ud.SRGB8=35905]="SRGB8",Ud[Ud.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",Ud[Ud.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",Ud[Ud.RGBA32F=34836]="RGBA32F",Ud[Ud.RGB32F=34837]="RGB32F",Ud[Ud.RGBA16F=34842]="RGBA16F",Ud[Ud.RGB16F=34843]="RGB16F",Ud[Ud.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",Ud[Ud.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",Ud[Ud.R11F_G11F_B10F=35898]="R11F_G11F_B10F",Ud[Ud.RGB9_E5=35901]="RGB9_E5",Ud[Ud.RGBA32UI=36208]="RGBA32UI",Ud[Ud.RGB32UI=36209]="RGB32UI",Ud[Ud.RGBA16UI=36214]="RGBA16UI",Ud[Ud.RGB16UI=36215]="RGB16UI",Ud[Ud.RGBA8UI=36220]="RGBA8UI",Ud[Ud.RGB8UI=36221]="RGB8UI",Ud[Ud.RGBA32I=36226]="RGBA32I",Ud[Ud.RGB32I=36227]="RGB32I",Ud[Ud.RGBA16I=36232]="RGBA16I",Ud[Ud.RGB16I=36233]="RGB16I",Ud[Ud.RGBA8I=36238]="RGBA8I",Ud[Ud.RGB8I=36239]="RGB8I",Ud[Ud.RED_INTEGER=36244]="RED_INTEGER",Ud[Ud.RGB_INTEGER=36248]="RGB_INTEGER",Ud[Ud.RGBA_INTEGER=36249]="RGBA_INTEGER",Ud[Ud.R8=33321]="R8",Ud[Ud.RG8=33323]="RG8",Ud[Ud.R16F=33325]="R16F",Ud[Ud.R32F=33326]="R32F",Ud[Ud.RG16F=33327]="RG16F",Ud[Ud.RG32F=33328]="RG32F",Ud[Ud.R8I=33329]="R8I",Ud[Ud.R8UI=33330]="R8UI",Ud[Ud.R16I=33331]="R16I",Ud[Ud.R16UI=33332]="R16UI",Ud[Ud.R32I=33333]="R32I",Ud[Ud.R32UI=33334]="R32UI",Ud[Ud.RG8I=33335]="RG8I",Ud[Ud.RG8UI=33336]="RG8UI",Ud[Ud.RG16I=33337]="RG16I",Ud[Ud.RG16UI=33338]="RG16UI",Ud[Ud.RG32I=33339]="RG32I",Ud[Ud.RG32UI=33340]="RG32UI",Ud[Ud.R8_SNORM=36756]="R8_SNORM",Ud[Ud.RG8_SNORM=36757]="RG8_SNORM",Ud[Ud.RGB8_SNORM=36758]="RGB8_SNORM",Ud[Ud.RGBA8_SNORM=36759]="RGBA8_SNORM",Ud[Ud.RGB10_A2UI=36975]="RGB10_A2UI",Ud[Ud.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",Ud[Ud.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",Ud[Ud.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",Ud[Ud.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",Ud[Ud.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",Ud[Ud.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",Ud[Ud.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",Ud[Ud.HALF_FLOAT=5131]="HALF_FLOAT",Ud[Ud.RG=33319]="RG",Ud[Ud.RG_INTEGER=33320]="RG_INTEGER",Ud[Ud.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",Ud[Ud.CURRENT_QUERY=34917]="CURRENT_QUERY",Ud[Ud.QUERY_RESULT=34918]="QUERY_RESULT",Ud[Ud.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",Ud[Ud.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",Ud[Ud.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",Ud[Ud.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",Ud[Ud.DRAW_BUFFER0=34853]="DRAW_BUFFER0",Ud[Ud.DRAW_BUFFER1=34854]="DRAW_BUFFER1",Ud[Ud.DRAW_BUFFER2=34855]="DRAW_BUFFER2",Ud[Ud.DRAW_BUFFER3=34856]="DRAW_BUFFER3",Ud[Ud.DRAW_BUFFER4=34857]="DRAW_BUFFER4",Ud[Ud.DRAW_BUFFER5=34858]="DRAW_BUFFER5",Ud[Ud.DRAW_BUFFER6=34859]="DRAW_BUFFER6",Ud[Ud.DRAW_BUFFER7=34860]="DRAW_BUFFER7",Ud[Ud.DRAW_BUFFER8=34861]="DRAW_BUFFER8",Ud[Ud.DRAW_BUFFER9=34862]="DRAW_BUFFER9",Ud[Ud.DRAW_BUFFER10=34863]="DRAW_BUFFER10",Ud[Ud.DRAW_BUFFER11=34864]="DRAW_BUFFER11",Ud[Ud.DRAW_BUFFER12=34865]="DRAW_BUFFER12",Ud[Ud.DRAW_BUFFER13=34866]="DRAW_BUFFER13",Ud[Ud.DRAW_BUFFER14=34867]="DRAW_BUFFER14",Ud[Ud.DRAW_BUFFER15=34868]="DRAW_BUFFER15",Ud[Ud.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",Ud[Ud.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",Ud[Ud.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",Ud[Ud.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",Ud[Ud.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",Ud[Ud.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",Ud[Ud.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",Ud[Ud.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",Ud[Ud.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",Ud[Ud.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",Ud[Ud.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",Ud[Ud.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",Ud[Ud.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",Ud[Ud.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",Ud[Ud.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",Ud[Ud.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",Ud[Ud.SAMPLER_3D=35679]="SAMPLER_3D",Ud[Ud.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",Ud[Ud.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",Ud[Ud.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",Ud[Ud.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",Ud[Ud.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",Ud[Ud.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",Ud[Ud.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",Ud[Ud.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",Ud[Ud.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",Ud[Ud.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",Ud[Ud.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",Ud[Ud.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",Ud[Ud.MAX_SAMPLES=36183]="MAX_SAMPLES",Ud[Ud.SAMPLER_BINDING=35097]="SAMPLER_BINDING",Ud[Ud.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",Ud[Ud.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",Ud[Ud.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",Ud[Ud.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",Ud[Ud.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",Ud[Ud.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",Ud[Ud.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",Ud[Ud.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",Ud[Ud.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",Ud[Ud.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",Ud[Ud.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",Ud[Ud.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",Ud[Ud.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",Ud[Ud.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",Ud[Ud.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",Ud[Ud.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",Ud[Ud.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",Ud[Ud.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",Ud[Ud.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",Ud[Ud.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",Ud[Ud.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",Ud[Ud.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",Ud[Ud.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",Ud[Ud.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",Ud[Ud.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",Ud[Ud.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",Ud[Ud.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",Ud[Ud.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",Ud[Ud.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",Ud[Ud.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",Ud[Ud.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",Ud[Ud.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",Ud[Ud.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",Ud[Ud.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",Ud[Ud.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",Ud[Ud.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",Ud[Ud.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",Ud[Ud.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",Ud[Ud.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",Ud[Ud.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",Ud[Ud.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",Ud[Ud.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",Ud[Ud.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",Ud[Ud.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",Ud[Ud.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",Ud[Ud.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",Ud[Ud.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",Ud[Ud.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",Ud[Ud.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",Ud[Ud.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",Ud[Ud.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",Ud[Ud.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",Ud[Ud.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",Ud[Ud.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",Ud[Ud.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",Ud[Ud.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",Ud[Ud.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",Ud[Ud.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",Ud[Ud.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",Ud[Ud.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",Ud[Ud.UNIFORM_TYPE=35383]="UNIFORM_TYPE",Ud[Ud.UNIFORM_SIZE=35384]="UNIFORM_SIZE",Ud[Ud.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",Ud[Ud.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",Ud[Ud.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",Ud[Ud.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",Ud[Ud.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",Ud[Ud.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",Ud[Ud.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",Ud[Ud.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",Ud[Ud.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",Ud[Ud.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",Ud[Ud.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",Ud[Ud.OBJECT_TYPE=37138]="OBJECT_TYPE",Ud[Ud.SYNC_CONDITION=37139]="SYNC_CONDITION",Ud[Ud.SYNC_STATUS=37140]="SYNC_STATUS",Ud[Ud.SYNC_FLAGS=37141]="SYNC_FLAGS",Ud[Ud.SYNC_FENCE=37142]="SYNC_FENCE",Ud[Ud.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",Ud[Ud.UNSIGNALED=37144]="UNSIGNALED",Ud[Ud.SIGNALED=37145]="SIGNALED",Ud[Ud.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",Ud[Ud.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",Ud[Ud.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",Ud[Ud.WAIT_FAILED=37149]="WAIT_FAILED",Ud[Ud.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",Ud[Ud.COLOR=6144]="COLOR",Ud[Ud.DEPTH=6145]="DEPTH",Ud[Ud.STENCIL=6146]="STENCIL",Ud[Ud.MIN=32775]="MIN",Ud[Ud.MAX=32776]="MAX",Ud[Ud.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",Ud[Ud.STREAM_READ=35041]="STREAM_READ",Ud[Ud.STREAM_COPY=35042]="STREAM_COPY",Ud[Ud.STATIC_READ=35045]="STATIC_READ",Ud[Ud.STATIC_COPY=35046]="STATIC_COPY",Ud[Ud.DYNAMIC_READ=35049]="DYNAMIC_READ",Ud[Ud.DYNAMIC_COPY=35050]="DYNAMIC_COPY",Ud[Ud.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",Ud[Ud.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",Ud[Ud.INVALID_INDEX=4294967295]="INVALID_INDEX",Ud[Ud.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",Ud[Ud.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",Ud[Ud.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",Ud[Ud.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",Ud[Ud.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",Ud[Ud.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",Ud[Ud.R16_EXT=33322]="R16_EXT",Ud[Ud.RG16_EXT=33324]="RG16_EXT",Ud[Ud.RGB16_EXT=32852]="RGB16_EXT",Ud[Ud.RGBA16_EXT=32859]="RGBA16_EXT",Ud[Ud.R16_SNORM_EXT=36760]="R16_SNORM_EXT",Ud[Ud.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",Ud[Ud.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",Ud[Ud.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",Ud[Ud.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",Ud[Ud.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",Ud[Ud.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",Ud[Ud.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",Ud[Ud.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",Ud[Ud.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",Ud[Ud.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",Ud[Ud.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",Ud[Ud.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",Ud[Ud.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",Ud[Ud.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",Ud[Ud.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",Ud[Ud.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",Ud[Ud.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",Ud[Ud.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",Ud[Ud.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",Ud[Ud.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",Ud[Ud.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",Ud[Ud.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",Ud[Ud.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",Ud[Ud.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",Ud[Ud.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",Ud[Ud.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",Ud[Ud.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",Ud[Ud.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",Ud[Ud.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",Ud[Ud.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",Ud[Ud.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",Ud[Ud.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",Ud[Ud.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",Ud[Ud.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",Ud[Ud.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",Ud[Ud.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",Ud[Ud.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",Ud[Ud.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",Ud[Ud.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",Ud[Ud.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",Ud[Ud.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",Ud[Ud.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",Ud[Ud.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",Ud[Ud.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",Ud[Ud.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",Ud[Ud.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",Ud[Ud.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",Ud[Ud.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",Ud[Ud.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",Ud[Ud.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",Ud[Ud.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",Ud[Ud.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",Ud[Ud.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",Ud[Ud.LINE_WEBGL=6913]="LINE_WEBGL",Ud[Ud.FILL_WEBGL=6914]="FILL_WEBGL",Ud[Ud.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",Ud[Ud.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",Ud[Ud.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",Ud[Ud.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",Ud[Ud.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",Ud[Ud.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",Ud[Ud.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",Ud[Ud.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",Ud[Ud.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",Ud[Ud.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",Ud[Ud.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",Ud[Ud.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",Ud[Ud.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",Ud[Ud.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",Ud[Ud.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",Ud[Ud.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",Ud[Ud.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",Ud[Ud.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",Ud[Ud.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",Ud[Ud.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",Ud[Ud.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",Ud[Ud.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",Ud[Ud.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",Ud[Ud.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT";const Gd={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},zd=(e,t,n)=>t?e.enable(n):e.disable(n),Vd=(e,t,n)=>e.hint(n,t),Wd=(e,t,n)=>e.pixelStorei(n,t),jd=(e,t,n)=>{const i=36006===n?36009:36008;return e.bindFramebuffer(i,t)},Hd=(e,t,n)=>{const i={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[n];e.bindBuffer(i,t)};function $d(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}const Xd={3042:zd,32773:(e,t)=>e.blendColor(...t),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(e,t)=>e.clearColor(...t),3107:(e,t)=>e.colorMask(...t),2884:zd,2885:(e,t)=>e.cullFace(t),2929:zd,2931:(e,t)=>e.clearDepth(t),2932:(e,t)=>e.depthFunc(t),2928:(e,t)=>e.depthRange(...t),2930:(e,t)=>e.depthMask(t),3024:zd,35723:Vd,35725:(e,t)=>e.useProgram(t),36007:(e,t)=>e.bindRenderbuffer(36161,t),36389:(e,t)=>{var n;return null==(n=e.bindTransformFeedback)?void 0:n.call(e,36386,t)},34229:(e,t)=>e.bindVertexArray(t),36006:jd,36010:jd,34964:Hd,36662:Hd,36663:Hd,35053:Hd,35055:Hd,2886:(e,t)=>e.frontFace(t),33170:Vd,2849:(e,t)=>e.lineWidth(t),32823:zd,32824:"polygonOffset",10752:"polygonOffset",35977:zd,32926:zd,32928:zd,32938:"sampleCoverage",32939:"sampleCoverage",3089:zd,3088:(e,t)=>e.scissor(...t),2960:zd,2961:(e,t)=>e.clearStencil(t),2968:(e,t)=>e.stencilMaskSeparate(1028,t),36005:(e,t)=>e.stencilMaskSeparate(1029,t),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(e,t)=>e.viewport(...t),34383:zd,10754:zd,12288:zd,12289:zd,12290:zd,12291:zd,12292:zd,12293:zd,12294:zd,12295:zd,3333:Wd,3317:Wd,37440:Wd,37441:Wd,37443:Wd,3330:Wd,3332:Wd,3331:Wd,3314:Wd,32878:Wd,3316:Wd,3315:Wd,32877:Wd,framebuffer:(e,t)=>{const n=t&&"handle"in t?t.handle:t;return e.bindFramebuffer(36160,n)},blend:(e,t)=>t?e.enable(3042):e.disable(3042),blendColor:(e,t)=>e.blendColor(...t),blendEquation:(e,t)=>{const n="number"==typeof t?[t,t]:t;e.blendEquationSeparate(...n)},blendFunc:(e,t)=>{const n=2===(null==t?void 0:t.length)?[...t,...t]:t;e.blendFuncSeparate(...n)},clearColor:(e,t)=>e.clearColor(...t),clearDepth:(e,t)=>e.clearDepth(t),clearStencil:(e,t)=>e.clearStencil(t),colorMask:(e,t)=>e.colorMask(...t),cull:(e,t)=>t?e.enable(2884):e.disable(2884),cullFace:(e,t)=>e.cullFace(t),depthTest:(e,t)=>t?e.enable(2929):e.disable(2929),depthFunc:(e,t)=>e.depthFunc(t),depthMask:(e,t)=>e.depthMask(t),depthRange:(e,t)=>e.depthRange(...t),dither:(e,t)=>t?e.enable(3024):e.disable(3024),derivativeHint:(e,t)=>{e.hint(35723,t)},frontFace:(e,t)=>e.frontFace(t),mipmapHint:(e,t)=>e.hint(33170,t),lineWidth:(e,t)=>e.lineWidth(t),polygonOffsetFill:(e,t)=>t?e.enable(32823):e.disable(32823),polygonOffset:(e,t)=>e.polygonOffset(...t),sampleCoverage:(e,t)=>e.sampleCoverage(t[0],t[1]||!1),scissorTest:(e,t)=>t?e.enable(3089):e.disable(3089),scissor:(e,t)=>e.scissor(...t),stencilTest:(e,t)=>t?e.enable(2960):e.disable(2960),stencilMask:(e,t)=>{t=$d(t)?t:[t,t];const[n,i]=t;e.stencilMaskSeparate(1028,n),e.stencilMaskSeparate(1029,i)},stencilFunc:(e,t)=>{t=$d(t)&&3===t.length?[...t,...t]:t;const[n,i,s,r,o,a]=t;e.stencilFuncSeparate(1028,n,i,s),e.stencilFuncSeparate(1029,r,o,a)},stencilOp:(e,t)=>{t=$d(t)&&3===t.length?[...t,...t]:t;const[n,i,s,r,o,a]=t;e.stencilOpSeparate(1028,n,i,s),e.stencilOpSeparate(1029,r,o,a)},viewport:(e,t)=>e.viewport(...t)};function Yd(e,t,n){return void 0!==t[e]?t[e]:n[e]}const Kd={blendEquation:(e,t,n)=>e.blendEquationSeparate(Yd(32777,t,n),Yd(34877,t,n)),blendFunc:(e,t,n)=>e.blendFuncSeparate(Yd(32969,t,n),Yd(32968,t,n),Yd(32971,t,n),Yd(32970,t,n)),polygonOffset:(e,t,n)=>e.polygonOffset(Yd(32824,t,n),Yd(10752,t,n)),sampleCoverage:(e,t,n)=>e.sampleCoverage(Yd(32938,t,n),Yd(32939,t,n)),stencilFuncFront:(e,t,n)=>e.stencilFuncSeparate(1028,Yd(2962,t,n),Yd(2967,t,n),Yd(2963,t,n)),stencilFuncBack:(e,t,n)=>e.stencilFuncSeparate(1029,Yd(34816,t,n),Yd(36003,t,n),Yd(36004,t,n)),stencilOpFront:(e,t,n)=>e.stencilOpSeparate(1028,Yd(2964,t,n),Yd(2965,t,n),Yd(2966,t,n)),stencilOpBack:(e,t,n)=>e.stencilOpSeparate(1029,Yd(34817,t,n),Yd(34818,t,n),Yd(34819,t,n))},qd={enable:(e,t)=>e({[t]:!0}),disable:(e,t)=>e({[t]:!1}),pixelStorei:(e,t,n)=>e({[t]:n}),hint:(e,t,n)=>e({[t]:n}),useProgram:(e,t)=>e({35725:t}),bindRenderbuffer:(e,t,n)=>e({36007:n}),bindTransformFeedback:(e,t,n)=>e({36389:n}),bindVertexArray:(e,t)=>e({34229:t}),bindFramebuffer:(e,t,n)=>{switch(t){case 36160:return e({36006:n,36010:n});case 36009:return e({36006:n});case 36008:return e({36010:n});default:return null}},bindBuffer:(e,t,n)=>{const i={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[t];return i?e({[i]:n}):{valueChanged:!0}},blendColor:(e,t,n,i,s)=>e({32773:new Float32Array([t,n,i,s])}),blendEquation:(e,t)=>e({32777:t,34877:t}),blendEquationSeparate:(e,t,n)=>e({32777:t,34877:n}),blendFunc:(e,t,n)=>e({32969:t,32968:n,32971:t,32970:n}),blendFuncSeparate:(e,t,n,i,s)=>e({32969:t,32968:n,32971:i,32970:s}),clearColor:(e,t,n,i,s)=>e({3106:new Float32Array([t,n,i,s])}),clearDepth:(e,t)=>e({2931:t}),clearStencil:(e,t)=>e({2961:t}),colorMask:(e,t,n,i,s)=>e({3107:[t,n,i,s]}),cullFace:(e,t)=>e({2885:t}),depthFunc:(e,t)=>e({2932:t}),depthRange:(e,t,n)=>e({2928:new Float32Array([t,n])}),depthMask:(e,t)=>e({2930:t}),frontFace:(e,t)=>e({2886:t}),lineWidth:(e,t)=>e({2849:t}),polygonOffset:(e,t,n)=>e({32824:t,10752:n}),sampleCoverage:(e,t,n)=>e({32938:t,32939:n}),scissor:(e,t,n,i,s)=>e({3088:new Int32Array([t,n,i,s])}),stencilMask:(e,t)=>e({2968:t,36005:t}),stencilMaskSeparate:(e,t,n)=>e({[1028===t?2968:36005]:n}),stencilFunc:(e,t,n,i)=>e({2962:t,2967:n,2963:i,34816:t,36003:n,36004:i}),stencilFuncSeparate:(e,t,n,i,s)=>e({[1028===t?2962:34816]:n,[1028===t?2967:36003]:i,[1028===t?2963:36004]:s}),stencilOp:(e,t,n,i)=>e({2964:t,2965:n,2966:i,34817:t,34818:n,34819:i}),stencilOpSeparate:(e,t,n,i,s)=>e({[1028===t?2964:34817]:n,[1028===t?2965:34818]:i,[1028===t?2966:34819]:s}),viewport:(e,t,n,i,s)=>e({2978:[t,n,i,s]})},Zd=(e,t)=>e.isEnabled(t),Qd={3042:Zd,2884:Zd,2929:Zd,3024:Zd,32823:Zd,32926:Zd,32928:Zd,3089:Zd,2960:Zd,35977:Zd},Jd=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function ef(e,t){if(function(e){for(const t in e)return!1;return!0}(t))return;const n={};for(const s in t){const i=Number(s),r=Xd[s];r&&("string"==typeof r?n[r]=!0:r(e,t[s],i))}const i=e.state&&e.state.cache;if(i)for(const s in n){(0,Kd[s])(e,t,i)}}function tf(e,t=Gd){if("number"==typeof t){const n=t,i=Qd[n];return i?i(e,n):e.getParameter(n)}const n=Array.isArray(t)?t:Object.keys(t),i={};for(const s of n){const t=Qd[s];i[s]=t?t(e,Number(s)):e.getParameter(Number(s))}return i}function nf(e,t){if(e===t)return!0;const n=Array.isArray(e)||ArrayBuffer.isView(e),i=Array.isArray(t)||ArrayBuffer.isView(t);if(n&&i&&e.length===t.length){for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}return!1}class sf{constructor(e,t){i(this,"gl"),i(this,"program",null),i(this,"stateStack",[]),i(this,"enable",!0),i(this,"cache",null),i(this,"log"),i(this,"initialized",!1),this.gl=e,this.log=(null==t?void 0:t.log)||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}static get(e){return e.state}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];ef(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t.copyState?tf(e):Object.assign({},Gd),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,function(e){const t=e.useProgram.bind(e);e.useProgram=function(n){const i=sf.get(e);i.program!==n&&(t(n),i.program=n)}}(e);for(const n in qd){of(e,n,qd[n])}rf(e,"getParameter"),rf(e,"isEnabled")}_updateCache(e){let t,n=!1;const i=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const s in e){const r=e[s],o=this.cache[s];nf(r,o)||(n=!0,t=o,i&&!(s in i)&&(i[s]=o),this.cache[s]=r)}return{valueChanged:n,oldValue:t}}}function rf(e,t){const n=e[t].bind(e);e[t]=function(t){if(void 0===t||Jd.has(t))return n(t);const i=sf.get(e);return t in i.cache||(i.cache[t]=n(t)),i.enable?i.cache[t]:n(t)},Object.defineProperty(e[t],"name",{value:`${t}-from-cache`,configurable:!1})}function of(e,t,n){if(!e[t])return;const i=e[t].bind(e);e[t]=function(...t){const s=sf.get(e),{valueChanged:r,oldValue:o}=n(s._updateCache,...t);return r&&i(...t),o},Object.defineProperty(e[t],"name",{value:`${t}-to-cache`,configurable:!1})}function af(e,t,n){return void 0===n[t]&&(n[t]=e.getExtension(t)||null),n[t]}function lf(e,t){const n=e.getParameter(7936),i=e.getParameter(7937);af(e,"WEBGL_debug_renderer_info",t);const s=t.WEBGL_debug_renderer_info,r=e.getParameter(s?s.UNMASKED_VENDOR_WEBGL:7936)||n,o=e.getParameter(s?s.UNMASKED_RENDERER_WEBGL:7937)||i,a=e.getParameter(7938),l=cf(r,o),c=function(e,t){if(/Metal/i.exec(e)||/Metal/i.exec(t))return"metal";if(/ANGLE/i.exec(e)||/ANGLE/i.exec(t))return"opengl";return"unknown"}(r,o),u=function(e,t){if(/SwiftShader/i.exec(e)||/SwiftShader/i.exec(t))return"cpu";switch(cf(e,t)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}(r,o);return{type:"webgl",gpu:l,gpuType:u,gpuBackend:c,vendor:r,renderer:o,version:a,shadingLanguage:"glsl",shadingLanguageVersion:300}}function cf(e,t){return/NVIDIA/i.exec(e)||/NVIDIA/i.exec(t)?"nvidia":/INTEL/i.exec(e)||/INTEL/i.exec(t)?"intel":/Apple/i.exec(e)||/Apple/i.exec(t)?"apple":/AMD/i.exec(e)||/AMD/i.exec(t)||/ATI/i.exec(e)||/ATI/i.exec(t)?"amd":/SwiftShader/i.exec(e)||/SwiftShader/i.exec(t)?"software":"unknown"}function uf(e){switch(e){case"uint8":case"unorm8":return 5121;case"sint8":case"snorm8":return 5120;case"uint16":case"unorm16":return 5123;case"sint16":case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(e))}const hf="WEBGL_compressed_texture_s3tc",df="WEBGL_compressed_texture_s3tc_srgb",ff="EXT_texture_compression_rgtc",pf="EXT_texture_compression_bptc",gf="EXT_texture_norm16",mf="EXT_render_snorm",_f={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[mf],"norm16-renderable-webgl":[gf],"snorm16-renderable-webgl":[gf,mf],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[hf,df,ff,pf],"texture-compression-bc5-webgl":[ff],"texture-compression-bc7-webgl":[pf],"texture-compression-etc2":["WEBGL_compressed_texture_etc"],"texture-compression-astc":["WEBGL_compressed_texture_astc"],"texture-compression-etc1-webgl":["WEBGL_compressed_texture_etc1"],"texture-compression-pvrtc-webgl":["WEBGL_compressed_texture_pvrtc"],"texture-compression-atc-webgl":["WEBGL_compressed_texture_atc"]};const yf={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},"r16unorm-webgl":{gl:33322,rb:!0},"r16snorm-webgl":{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},"rg16unorm-webgl":{gl:33324},"rg16snorm-webgl":{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},"rgb10a2uint-webgl":{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},"rgba16unorm-webgl":{gl:32859,rb:!0},"rgba16snorm-webgl":{gl:36763},"rgb32float-webgl":{gl:34837,x:"EXT_color_buffer_float",dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:hf},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:df},"bc1-rgba-unorm":{gl:33777,x:hf},"bc1-rgba-unorm-srgb":{gl:35916,x:df},"bc2-rgba-unorm":{gl:33778,x:hf},"bc2-rgba-unorm-srgb":{gl:35918,x:df},"bc3-rgba-unorm":{gl:33779,x:hf},"bc3-rgba-unorm-srgb":{gl:35919,x:df},"bc4-r-unorm":{gl:36283,x:ff},"bc4-r-snorm":{gl:36284,x:ff},"bc5-rg-unorm":{gl:36285,x:ff},"bc5-rg-snorm":{gl:36286,x:ff},"bc6h-rgb-ufloat":{gl:36495,x:pf},"bc6h-rgb-float":{gl:36494,x:pf},"bc7-rgba-unorm":{gl:36492,x:pf},"bc7-rgba-unorm-srgb":{gl:36493,x:pf},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function vf(e){var t;const n=yf[e],i=function(e){const t=yf[e],n=null==t?void 0:t.gl;if(void 0===n)throw new Error(`Unsupported texture format ${e}`);return n}(e),s=wi(e);return{internalFormat:i,format:(null==n?void 0:n.dataFormat)||bf(s.channels,s.integer,s.normalized,i),type:s.dataType?uf(s.dataType):(null==(t=null==n?void 0:n.types)?void 0:t[0])||5121,compressed:s.compressed||!1}}function bf(e,t,n,i){if(6408===i||6407===i)return i;switch(e){case"r":return t&&!n?36244:6403;case"rg":return t&&!n?33320:33319;case"rgb":return t&&!n?36248:6407;case"rgba":return t&&!n?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}const Ef={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class xf extends Ai{constructor(e,t,n){super([],n),i(this,"gl"),i(this,"extensions"),i(this,"testedFeatures",new Set),this.gl=e,this.extensions=t,af(e,"EXT_color_buffer_float",t)}*[Symbol.iterator](){const e=this.getFeatures();for(const t of e)this.has(t)&&(yield t);return[]}has(e){var t;return!(null==(t=this.disabledFeatures)?void 0:t[e])&&(this.testedFeatures.has(e)||(this.testedFeatures.add(e),function(e){return e in _f}(e)&&function(e,t,n){return(_f[t]||[]).every((t=>af(e,t,n)))}(this.gl,e,this.extensions)&&this.features.add(e),this.getWebGLFeature(e)&&this.features.add(e)),this.features.has(e))}initializeFeatures(){const e=this.getFeatures().filter((e=>"polygon-mode-webgl"!==e));for(const t of e)this.has(t)}getFeatures(){return[...Object.keys(Ef),...Object.keys(_f)]}getWebGLFeature(e){const t=Ef[e];return"string"==typeof t?Boolean(af(this.gl,t,this.extensions)):Boolean(t)}}class wf extends Ti{constructor(e){super(),i(this,"gl"),i(this,"limits",{}),this.gl=e}get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}getParameter(e){return void 0===this.limits[e]&&(this.limits[e]=this.gl.getParameter(e)),this.limits[e]||0}}class Tf extends qi{constructor(e,t){super(e,t),i(this,"device"),i(this,"gl"),i(this,"handle"),i(this,"colorAttachments",[]),i(this,"depthStencilAttachment",null);const n=null===t.handle;this.device=e,this.gl=e.gl,this.handle=this.props.handle||n?this.props.handle:this.gl.createFramebuffer(),n||(e.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),this.destroyed||null===this.handle||this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const e=this.gl.bindFramebuffer(36160,this.handle);for(let t=0;t<this.colorAttachments.length;++t){const e=this.colorAttachments[t];if(e){const n=36064+t;this._attachTextureView(n,e)}}if(this.depthStencilAttachment){const e=function(e){switch(wi(e).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${e}`)}}(this.depthStencilAttachment.props.format);this._attachTextureView(e,this.depthStencilAttachment)}if(this.device.props.debug){const e=this.gl.checkFramebufferStatus(36160);if(36053!==e)throw new Error(`Framebuffer ${function(e){switch(e){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${e}`}}(e)}`)}this.gl.bindFramebuffer(36160,e)}_attachTextureView(e,t){const{gl:n}=this.device,{texture:i}=t,s=t.props.baseMipLevel,r=t.props.baseArrayLayer;switch(n.bindTexture(i.glTarget,i.handle),i.glTarget){case 35866:case 32879:n.framebufferTextureLayer(36160,e,i.handle,s,r);break;case 34067:const t=function(e){return e<34069?e+34069:e}(r);n.framebufferTexture2D(36160,e,t,i.handle,s);break;case 3553:n.framebufferTexture2D(36160,e,3553,i.handle,s);break;default:throw new Error("Illegal texture type")}n.bindTexture(i.glTarget,null)}}class Af extends Oi{constructor(e,t){super(t),i(this,"device"),i(this,"format","rgba8unorm"),i(this,"depthStencilFormat","depth24plus"),i(this,"presentationSize"),i(this,"_framebuffer",null),this.device=e,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}get[Symbol.toStringTag](){return"WebGLCanvasContext"}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new Tf(this.device,{handle:null}),this._framebuffer}update(){const e=this.getPixelSize();(e[0]!==this.presentationSize[0]||e[1]!==this.presentationSize[1])&&(this.presentationSize=e,this.resize())}resize(e){if(this.device.gl)if(this.canvas){const t=this.getDevicePixelRatio(null==e?void 0:e.useDevicePixels);this.setDevicePixelRatio(t,e)}else;}commit(){}}async function Sf(e,t){const n=document.getElementsByTagName("head")[0];if(!n)throw new Error("loadScript");const i=document.createElement("script");return i.setAttribute("type","text/javascript"),i.setAttribute("src",e),t&&(i.id=t),new Promise(((t,s)=>{i.onload=t,i.onerror=t=>s(new Error(`Unable to load script '${e}': ${t}`)),n.appendChild(i)}))}let Rf=null,Pf=!1;const Cf={debugSpectorJS:Zn.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};function If(e){return e.luma=e.luma||{},e.luma}function Lf(e,t={}){return t.debugWebGL||t.traceWebGL?function(e,t){if(!globalThis.WebGLDebugUtils)return Zn.warn("webgl-debug not loaded")(),e;const n=If(e);if(n.debugContext)return n.debugContext;globalThis.WebGLDebugUtils.init({...Dd,...e});const i=globalThis.WebGLDebugUtils.makeDebugContext(e,kf.bind(null,t),Of.bind(null,t));for(const o in Dd)o in i||"number"!=typeof Dd[o]||(i[o]=Dd[o]);class s{}Object.setPrototypeOf(i,Object.getPrototypeOf(e)),Object.setPrototypeOf(s,i);const r=Object.create(s);return n.realContext=e,n.debugContext=r,r.debug=!0,r}(e,t):function(e){const t=If(e);return t.realContext?t.realContext:e}(e)}function Mf(e,t){t=Array.from(t).map((e=>void 0===e?"undefined":e));let n=globalThis.WebGLDebugUtils.glFunctionArgsToString(e,t);return n=`${n.slice(0,100)}${n.length>100?"...":""}`,`gl.${e}(${n})`}function kf(e,t,n,i){i=Array.from(i).map((e=>void 0===e?"undefined":e));const s=`${globalThis.WebGLDebugUtils.glEnumToString(t)} in gl.${n}(${globalThis.WebGLDebugUtils.glFunctionArgsToString(n,i)})`;Zn.error(s)()}function Of(e,t,n){let i="";Zn.level>=1&&(i=Mf(t,n),e.traceWebGL&&Zn.log(1,i)());for(const s of n)void 0===s&&(i=i||Mf(t,n))}const Nf={};function Ff(e="id"){Nf[e]=Nf[e]||1;return`${e}-${Nf[e]++}`}class Bf extends ni{constructor(e,t={}){super(e,t),i(this,"device"),i(this,"gl"),i(this,"handle"),i(this,"glTarget"),i(this,"glUsage"),i(this,"glIndexType",5123),i(this,"byteLength"),i(this,"bytesUsed"),this.device=e,this.gl=this.device.gl;const n="object"==typeof t?t.handle:void 0;this.handle=n||this.gl.createBuffer(),e.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=function(e){if(e&ni.INDEX)return 34963;if(e&ni.VERTEX)return 34962;if(e&ni.UNIFORM)return 35345;return 34962}(this.props.usage),this.glUsage=function(e){if(e&ni.INDEX)return 35044;if(e&ni.VERTEX)return 35044;if(e&ni.UNIFORM)return 35048;return 35044}(this.props.usage),this.glIndexType="uint32"===this.props.indexType?5125:5123,t.data?this._initWithData(t.data,t.byteOffset,t.byteLength):this._initWithByteLength(t.byteLength||0)}_initWithData(e,t=0,n=e.byteLength+t){const i=this.glTarget;this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,n,this.glUsage),this.gl.bufferSubData(i,t,e),this.gl.bindBuffer(i,null),this.bytesUsed=n,this.byteLength=n,this._setDebugData(e,t,n),this.trackAllocatedMemory(n)}_initWithByteLength(e){let t=e;0===e&&(t=new Float32Array(0));const n=this.glTarget;return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,t,this.glUsage),this.gl.bindBuffer(n,null),this.bytesUsed=e,this.byteLength=e,this._setDebugData(null,0,e),this.trackAllocatedMemory(e),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(e,t=0){const n=36663;this.gl.bindBuffer(n,this.handle),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this._setDebugData(e,t,e.byteLength)}async readAsync(e=0,t){return this.readSyncWebGL(e,t)}readSyncWebGL(e=0,t){t=t??this.byteLength-e;const n=new Uint8Array(t);return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,n,0,t),this.gl.bindBuffer(36662,null),this._setDebugData(n,e,t),n}}function Df(e){const t=e.toLowerCase();return["warning","error","info"].includes(t)?t:"info"}class Uf extends ji{constructor(e,t){switch(super(e,t),i(this,"device"),i(this,"handle"),this.device=e,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then((()=>this.compilationStatus))}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const e=this.device.gl.getShaderInfoLog(this.handle);return e?function(e){const t=e.split(/\r?\n/),n=[];for(const i of t){if(i.length<=1)continue;const e=i.split(":");if(2===e.length){const[t,i]=e;n.push({message:i.trim(),type:Df(t),lineNum:0,linePos:0});continue}const[t,s,r,...o]=e;let a=parseInt(r,10);isNaN(a)&&(a=0);let l=parseInt(s,10);isNaN(l)&&(l=0),n.push({message:o.join(":").trim(),type:Df(t),lineNum:a,linePos:l})}return n}(e):[]}getTranslatedSource(){const e=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return(null==e?void 0:e.getTranslatedShaderSource(this.handle))||null}async _compile(e){e=e.startsWith("#version ")?e:`#version 300 es\n${e}`;const{gl:t}=this.device;if(t.shaderSource(this.handle,e),t.compileShader(this.handle),this.device.props.debug){if(this.device.features.has("compilation-status-async-webgl"))Zn.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),Zn.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader();else if(this._getCompilationStatus(),this.debugShader(),"error"===this.compilationStatus)throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`)}else this.compilationStatus="pending"}async _waitForCompilationComplete(){const e=async e=>await new Promise((t=>setTimeout(t,e)));if(!this.device.features.has("compilation-status-async-webgl"))return void(await e(10));const{gl:t}=this.device;for(;;){if(t.getShaderParameter(this.handle,37297))return;await e(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function Gf(e,t,n,i){if(function(e){let t=!0;for(const n in e){t=!1;break}return t}(t))return i(e);const s=e;s.pushState();try{return function(e,t){const n=e,{gl:i}=n;if(t.cullMode)switch(t.cullMode){case"none":i.disable(2884);break;case"front":i.enable(2884),i.cullFace(1028);break;case"back":i.enable(2884),i.cullFace(1029)}t.frontFace&&i.frontFace(Hf("frontFace",t.frontFace,{ccw:2305,cw:2304}));t.unclippedDepth&&e.features.has("depth-clip-control")&&i.enable(34383);void 0!==t.depthBias&&(i.enable(32823),i.polygonOffset(t.depthBias,t.depthBiasSlopeScale||0));if(t.provokingVertex&&e.features.has("provoking-vertex-webgl")){const e=n.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,i=Hf("provokingVertex",t.provokingVertex,{first:36429,last:36430});null==e||e.provokingVertexWEBGL(i)}if((t.polygonMode||t.polygonOffsetLine)&&e.features.has("polygon-mode-webgl")){if(t.polygonMode){const e=n.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,i=Hf("polygonMode",t.polygonMode,{fill:6914,line:6913});null==e||e.polygonModeWEBGL(1028,i),null==e||e.polygonModeWEBGL(1029,i)}t.polygonOffsetLine&&i.enable(10754)}e.features.has("shader-clip-cull-distance-webgl")&&(t.clipDistance0&&i.enable(12288),t.clipDistance1&&i.enable(12289),t.clipDistance2&&i.enable(12290),t.clipDistance3&&i.enable(12291),t.clipDistance4&&i.enable(12292),t.clipDistance5&&i.enable(12293),t.clipDistance6&&i.enable(12294),t.clipDistance7&&i.enable(12295));void 0!==t.depthWriteEnabled&&i.depthMask(t.depthWriteEnabled);t.depthCompare&&("always"!==t.depthCompare?i.enable(2929):i.disable(2929),i.depthFunc(zf("depthCompare",t.depthCompare)));if(t.stencilWriteMask){const e=t.stencilWriteMask;i.stencilMaskSeparate(1028,e),i.stencilMaskSeparate(1029,e)}t.stencilReadMask&&Zn.warn("stencilReadMask not supported under WebGL");if(t.stencilCompare){const e=t.stencilReadMask||4294967295,n=zf("depthCompare",t.stencilCompare);"always"!==t.stencilCompare?i.enable(2960):i.disable(2960),i.stencilFuncSeparate(1028,n,0,e),i.stencilFuncSeparate(1029,n,0,e)}if(t.stencilPassOperation&&t.stencilFailOperation&&t.stencilDepthFailOperation){const e=Vf("stencilPassOperation",t.stencilPassOperation),n=Vf("stencilFailOperation",t.stencilFailOperation),s=Vf("stencilDepthFailOperation",t.stencilDepthFailOperation);i.stencilOpSeparate(1028,n,s,e),i.stencilOpSeparate(1029,n,s,e)}switch(t.blend){case!0:i.enable(3042);break;case!1:i.disable(3042)}if(t.blendColorOperation||t.blendAlphaOperation){const e=Wf("blendColorOperation",t.blendColorOperation||"add"),n=Wf("blendAlphaOperation",t.blendAlphaOperation||"add");i.blendEquationSeparate(e,n);const s=jf("blendColorSrcFactor",t.blendColorSrcFactor||"one"),r=jf("blendColorDstFactor",t.blendColorDstFactor||"zero"),o=jf("blendAlphaSrcFactor",t.blendAlphaSrcFactor||"one"),a=jf("blendAlphaDstFactor",t.blendAlphaDstFactor||"zero");i.blendFuncSeparate(s,r,o,a)}}(e,t),ef(s.gl,n),i(e)}finally{s.popState()}}function zf(e,t){return Hf(e,t,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function Vf(e,t){return Hf(e,t,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function Wf(e,t){return Hf(e,t,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function jf(e,t){return Hf(e,t,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function Hf(e,t,n){if(!(t in n))throw new Error(function(e,t){return`Illegal parameter ${t} for ${e}`}(e,t));return n[t]}function $f(e){const t={};return e.addressModeU&&(t[10242]=Xf(e.addressModeU)),e.addressModeV&&(t[10243]=Xf(e.addressModeV)),e.addressModeW&&(t[32882]=Xf(e.addressModeW)),e.magFilter&&(t[10240]=Yf(e.magFilter)),(e.minFilter||e.mipmapFilter)&&(t[10241]=function(e,t="none"){if(!t)return Yf(e);switch(t){case"none":return Yf(e);case"nearest":return"nearest"===e?9984:9986;case"linear":return"nearest"===e?9985:9987}}(e.minFilter||"linear",e.mipmapFilter)),void 0!==e.lodMinClamp&&(t[33082]=e.lodMinClamp),void 0!==e.lodMaxClamp&&(t[33083]=e.lodMaxClamp),"comparison-sampler"===e.type&&(t[34892]=34894),e.compare&&(t[34893]=zf("compare",e.compare)),e.maxAnisotropy&&(t[34046]=e.maxAnisotropy),t}function Xf(e){switch(e){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function Yf(e){switch(e){case"nearest":return 9728;case"linear":return 9729}}class Kf extends Yi{constructor(e,t){super(e,t),i(this,"device"),i(this,"handle"),i(this,"parameters"),this.device=e,this.parameters=$f(t),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(e){for(const[t,n]of Object.entries(e)){const e=Number(t);switch(e){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,e,n);break;default:this.device.gl.samplerParameteri(this.handle,e,n)}}}}class qf extends Gi{constructor(e,t){super(e,{...Di.defaultProps,...t}),i(this,"device"),i(this,"gl"),i(this,"handle"),i(this,"texture"),this.device=e,this.gl=this.device.gl,this.handle=null,this.texture=t.texture}}function Zf(e){switch(e){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function Qf(e,t,n){if(function(e){for(const t in e)return!1;return!0}(t))return n(e);const{nocatch:i=!0}=t,s=sf.get(e);let r;if(s.push(),ef(e,t),i)r=n(e),s.pop();else try{r=n(e)}finally{s.pop()}return r}function Jf(e,t,n,i){const{width:s,height:r}=i,{dimension:o,depth:a=0,mipLevel:l=0}=i,{x:c=0,y:u=0,z:h=0}=i,{glFormat:d,glType:f}=i,p=tp(i.glTarget,o,a),g=i.flipY?{37440:!0}:{};Qf(e,g,(()=>{switch(o){case"2d-array":case"3d":e.bindTexture(p,t),e.texSubImage3D(p,l,c,u,h,s,r,a,d,f,n),e.bindTexture(p,null);break;case"2d":case"cube":e.bindTexture(p,t),e.texSubImage2D(p,l,c,u,s,r,d,f,n),e.bindTexture(p,null);break;default:throw new Error(o)}}))}function ep(e,t,n){const{dimension:i,width:s,height:r,depth:o=0,mipLevel:a=0,byteOffset:l=0}=n,{x:c=0,y:u=0,z:h=0}=n,{glFormat:d,glType:f,compressed:p}=n,g=tp(n.glTarget,i,o);switch(i){case"2d-array":case"3d":p?e.compressedTexSubImage3D(g,a,c,u,h,s,r,o,d,t,l):e.texSubImage3D(g,a,c,u,h,s,r,o,d,f,t,l);break;case"2d":case"cube":p?e.compressedTexSubImage2D(g,a,c,u,s,r,d,t,l):e.texSubImage2D(g,a,c,u,s,r,d,f,t,l);break;default:throw new Error(i)}}function tp(e,t,n){return"cube"===t?34069+n:e}function np(e,t){var n;const{sourceX:i=0,sourceY:s=0,sourceAttachment:r=0}=t||{};let{target:o=null,sourceWidth:a,sourceHeight:l,sourceDepth:c,sourceFormat:u,sourceType:h}=t||{};const{framebuffer:d,deleteFramebuffer:f}=ip(e),{gl:p,handle:g}=d;a||(a=d.width),l||(l=d.height);const m=null==(n=d.colorAttachments[r])?void 0:n.texture;if(!m)throw new Error(`Invalid framebuffer attachment ${r}`);c=(null==m?void 0:m.depth)||1,u||(u=(null==m?void 0:m.glFormat)||6408),h||(h=(null==m?void 0:m.glType)||5121),o=function(e,t,n,i,s){if(e)return e;t||(t=5121);const r=function(e,t){const{clamped:n=!0}=t||{};switch(e){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return n?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}(t,{clamped:!1}),o=Zf(n);return new r(i*s*o)}(o,h,u,a,l),h=h||function(e){switch(ArrayBuffer.isView(e)?e.constructor:e){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error("Failed to deduce GL constant from typed array")}}(o);const _=p.bindFramebuffer(36160,g);return p.readBuffer(36064+r),p.readPixels(i,s,a,l,u,h,o),p.readBuffer(36064),p.bindFramebuffer(36160,_||null),f&&d.destroy(),o}function ip(e){return e instanceof qi?{framebuffer:e,deleteFramebuffer:!1}:{framebuffer:sp(e),deleteFramebuffer:!0}}function sp(e,t){const{device:n,width:i,height:s,id:r}=e;return n.createFramebuffer({...t,id:`framebuffer-for-${r}`,width:i,height:s,colorAttachments:[e]})}class rp extends Di{constructor(e,t){super(e,t),i(this,"device"),i(this,"gl"),i(this,"handle"),i(this,"sampler"),i(this,"view"),i(this,"mipmaps"),i(this,"compressed"),i(this,"glTarget"),i(this,"glFormat"),i(this,"glType"),i(this,"glInternalFormat"),i(this,"textureUnit",0);const n={...this.props};n.data=t.data,this.device=e,this.gl=this.device.gl,this.glTarget=function(e){switch(e){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(e)}(this.props.dimension);const s=vf(this.props.format);this.glInternalFormat=s.internalFormat,this.glFormat=s.format,this.glType=s.type,this.compressed=s.compressed,this.mipmaps=Boolean(this.props.mipmaps),this._initialize(n),Object.seal(this)}_initialize(e){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:e.data});let{width:t,height:n}=e;if(!t||!n){const i=Di.getTextureDataSize(e.data);t=(null==i?void 0:i.width)||1,n=(null==i?void 0:i.height)||1}if(this.width=t,this.height=n,this.depth=e.depth,this.setSampler(e.sampler),this.view=new qf(this.device,{...this.props,texture:this}),this.bind(),function(e,t,n){const{dimension:i,width:s,height:r,depth:o=0}=n,{glInternalFormat:a}=n,l=n.glTarget;switch(i){case"2d-array":case"3d":e.texStorage3D(l,t,a,s,r,o);break;default:e.texStorage2D(l,t,a,s,r)}}(this.gl,this.mipLevels,this),e.data)switch(e.dimension){case"1d":this.setTexture1DData(e.data);break;case"2d":this.setTexture2DData(e.data);break;case"3d":this.setTexture3DData(e.data);break;case"cube":this.setTextureCubeData(e.data);break;case"2d-array":this.setTextureArrayData(e.data);break;case"cube-array":this.setTextureCubeArrayData(e.data);break;default:throw new Error(e.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(e){return new qf(this.device,{...e,texture:this})}setSampler(e={}){let t;e instanceof Kf?(this.sampler=e,t=e.props):(this.sampler=new Kf(this.device,e),t=e);const n=$f(t);this._setSamplerParameters(n)}generateMipmap(e){if(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format)||(Zn.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),null==e?void 0:e.force))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(t){Zn.warn(`Error generating mipmap for ${this}: ${t.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(e){const t=Di.getExternalImageSize(e.image),n={...Di.defaultCopyExternalImageOptions,...t,...e},{image:i,depth:s,mipLevel:r,x:o,y:a,z:l,flipY:c}=n;let{width:u,height:h}=n;const{dimension:d,glTarget:f,glFormat:p,glInternalFormat:g,glType:m}=this;if(u=Math.min(u,this.width-o),h=Math.min(h,this.height-a),e.sourceX||e.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return Jf(this.device.gl,this.handle,i,{dimension:d,mipLevel:r,x:o,y:a,z:l,width:u,height:h,depth:s,glFormat:p,glInternalFormat:g,glType:m,glTarget:f,flipY:c}),{width:n.width,height:n.height}}setTexture1DData(e){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(e,t=0){this.bind();const n=Di.normalizeTextureData(e,this);n.length>1&&!1!==this.props.mipmaps&&Zn.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let i=0;i<n.length;i++){const e=n[i];this._setMipLevel(t,i,e)}this.unbind()}setTexture3DData(e){if("3d"!==this.props.dimension)throw new Error(this.id);ArrayBuffer.isView(e)&&(this.bind(),ep(this.device.gl,e,this),this.unbind())}setTextureCubeData(e,t=0){if("cube"!==this.props.dimension)throw new Error(this.id);for(const n of Di.CubeFaces)this.setTextureCubeFaceData(e[n],n)}setTextureArrayData(e){if("2d-array"!==this.props.dimension)throw new Error(this.id);throw new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(e){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(e,t,n=0){Array.isArray(e)&&e.length>1&&!1!==this.props.mipmaps&&Zn.warn(`${this.id} has mipmap and multiple LODs.`)();const i=Di.CubeFaces.indexOf(t);this.setTexture2DData(e,i)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(e){const{face:t,width:n,height:i,pixels:s,data:r,format:o=6408,type:a=5121}=e,{gl:l}=this,c=s||r;this.bind(),c instanceof Promise?c.then((n=>this.setImageDataForFace(Object.assign({},e,{face:t,data:n,pixels:n})))):this.width||this.height?l.texImage2D(t,0,o,n,i,0,o,a,c):l.texImage2D(t,0,o,o,a,c)}_getImageDataMap(e){for(let t=0;t<Di.CubeFaces.length;++t){const n=Di.CubeFaces[t];e[n]&&(e[34069+t]=e[n],delete e[n])}return e}_setSamplerParameters(e){Zn.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(e))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[t,n]of Object.entries(e)){const e=Number(t),i=n;switch(e){case 33082:case 33083:this.gl.texParameterf(this.glTarget,e,i);break;case 10241:case 10242:case 10243:default:this.gl.texParameteri(this.glTarget,e,i);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,e,i)}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(e,t,n,i=this.glTarget){if(Di.isExternalImage(n))Jf(this.device.gl,this.handle,n,{...this,depth:e,mipLevel:t,glTarget:i,flipY:this.props.flipY});else{if(!Di.isTextureLevelData(n))throw new Error("Texture: invalid image data");ep(this.device.gl,n.data,{...this,depth:e,mipLevel:t,glTarget:i})}}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(e){const{gl:t}=this;return void 0!==e&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,this.handle),e}unbind(e){const{gl:t}=this;return void 0!==e&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,null),e}}const op=[1,2,4,8];class ap extends es{constructor(e,t){var n;let s;if(super(e,t),i(this,"device"),i(this,"glParameters"),this.device=e,!(null==(n=null==t?void 0:t.parameters)?void 0:n.viewport))if(null==t?void 0:t.framebuffer){const{width:e,height:n}=t.framebuffer;s=[0,0,e,n]}else{const[t,n]=e.getCanvasContext().getDrawingBufferSize();s=[0,0,t,n]}this.device.pushState(),this.setParameters({viewport:s,...this.props.parameters});const r=this.props.framebuffer;if(null==r?void 0:r.handle)if(this.props.framebuffer){const e=this.props.framebuffer.colorAttachments.map(((e,t)=>36064+t));this.device.gl.drawBuffers(e)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}setParameters(e={}){const t={...this.glParameters};t.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(t.depthMask=!this.props.depthReadOnly),t.stencilMask=this.props.stencilReadOnly?0:1,t[35977]=this.props.discard,e.viewport&&(e.viewport.length>=6?(t.viewport=e.viewport.slice(0,4),t.depthRange=[e.viewport[4],e.viewport[5]]):t.viewport=e.viewport),e.scissorRect&&(t.scissorTest=!0,t.scissor=e.scissorRect),e.blendConstant&&(t.blendColor=e.blendConstant),e.stencilReference&&(e[2967]=e.stencilReference),e.colorMask&&(t.colorMask=op.map((t=>Boolean(t&e.colorMask)))),this.glParameters=t,ef(this.device.gl,t)}beginOcclusionQuery(e){const t=this.props.occlusionQuerySet;null==t||t.beginOcclusionQuery()}endOcclusionQuery(){const e=this.props.occlusionQuerySet;null==e||e.endOcclusionQuery()}clear(){const e={...this.glParameters};let t=0;this.props.clearColors&&this.props.clearColors.forEach(((e,t)=>{e&&this.clearColorBuffer(t,e)})),!1!==this.props.clearColor&&void 0===this.props.clearColors&&(t|=16384,e.clearColor=this.props.clearColor),!1!==this.props.clearDepth&&(t|=256,e.clearDepth=this.props.clearDepth),!1!==this.props.clearStencil&&(t|=1024,e.clearStencil=this.props.clearStencil),0!==t&&Qf(this.device.gl,e,(()=>{this.device.gl.clear(t)}))}clearColorBuffer(e=0,t=[0,0,0,0]){Qf(this.device.gl,{framebuffer:this.props.framebuffer},(()=>{switch(t.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,e,t);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,e,t);break;case Float32Array:this.device.gl.clearBufferfv(6144,e,t);break;default:throw new Error("clearColorBuffer: color must be typed array")}}))}}const lp=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],cp={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function up(e){const t=cp[e];if(!t)throw new Error("uniform");const[n,i,,s]=t;return{format:s,components:i,glType:n}}function hp(e){const t=cp[e];if(!t)throw new Error("attribute");const[,n,,i,s]=t;return{attributeType:i,vertexFormat:s,components:n}}function dp(e,t){const n={attributes:[],bindings:[]};n.attributes=function(e,t){const n=[],i=e.getProgramParameter(t,35721);for(let s=0;s<i;s++){const i=e.getActiveAttrib(t,s);if(!i)throw new Error("activeInfo");const{name:r,type:o}=i,a=e.getAttribLocation(t,r);if(a>=0){const{attributeType:e}=hp(o),t=/instance/i.test(r)?"instance":"vertex";n.push({name:r,location:a,stepMode:t,type:e})}}return n.sort(((e,t)=>e.location-t.location)),n}(e,t);const i=function(e,t){const n=(n,i)=>e.getActiveUniformBlockParameter(t,n,i),i=[],s=e.getProgramParameter(t,35382);for(let r=0;r<s;r++){const s={name:e.getActiveUniformBlockName(t,r)||"",location:n(r,35391),byteLength:n(r,35392),vertex:n(r,35396),fragment:n(r,35398),uniformCount:n(r,35394),uniforms:[]},o=n(r,35395)||[],a=e.getActiveUniforms(t,o,35383),l=e.getActiveUniforms(t,o,35384),c=e.getActiveUniforms(t,o,35387),u=e.getActiveUniforms(t,o,35388);for(let n=0;n<s.uniformCount;++n){const i=e.getActiveUniform(t,o[n]);if(!i)throw new Error("activeInfo");s.uniforms.push({name:i.name,format:up(a[n]).format,type:a[n],arrayLength:l[n],byteOffset:c[n],byteStride:u[n]})}i.push(s)}return i.sort(((e,t)=>e.location-t.location)),i}(e,t);for(const l of i){const e=l.uniforms.map((e=>({name:e.name,format:e.format,byteOffset:e.byteOffset,byteStride:e.byteStride,arrayLength:e.arrayLength})));n.bindings.push({type:"uniform",name:l.name,group:0,location:l.location,visibility:(l.vertex?1:0)&(l.fragment?2:0),minBindingSize:l.byteLength,uniforms:e})}const s=function(e,t){const n=[],i=e.getProgramParameter(t,35718);for(let s=0;s<i;s++){const i=e.getActiveUniform(t,s);if(!i)throw new Error("activeInfo");const{name:r,size:o,type:a}=i,{name:l,isArray:c}=gp(r);let u=e.getUniformLocation(t,l);const h={location:u,name:l,size:o,type:a,isArray:c};if(n.push(h),h.size>1)for(let s=0;s<h.size;s++){const i=`${l}[${s}]`;u=e.getUniformLocation(t,i);const r={...h,name:i,location:u};n.push(r)}}return n}(e,t);let r=0;for(const l of s)if(o=l.type,lp.includes(o)){const{viewDimension:e,sampleType:t}=pp(l.type);n.bindings.push({type:"texture",name:l.name,group:0,location:r,viewDimension:e,sampleType:t}),l.textureUnit=r,r+=1}var o;s.length&&(n.uniforms=s);const a=function(e,t){const n=[],i=e.getProgramParameter(t,35971);for(let s=0;s<i;s++){const i=e.getTransformFeedbackVarying(t,s);if(!i)throw new Error("activeInfo");const{name:r,type:o,size:a}=i,{glType:l,components:c}=up(o),u={location:s,name:r,type:l,size:a*c};n.push(u)}return n.sort(((e,t)=>e.location-t.location)),n}(e,t);return(null==a?void 0:a.length)&&(n.varyings=a),n}const fp={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function pp(e){const t=fp[e];if(!t)throw new Error("sampler");const[n,i]=t;return{viewDimension:n,sampleType:i}}function gp(e){if("]"!==e[e.length-1])return{name:e,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(e);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${e}`);return{name:t[1],length:t[2]?1:0,isArray:Boolean(t[2])}}function mp(e,t,n,i){const s=e;let r=i;!0===r&&(r=1),!1===r&&(r=0);const o="number"==typeof r?[r]:r;switch(n){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if("number"!=typeof i)throw new Error("samplers must be set to integers");return e.uniform1i(t,i);case 5126:return e.uniform1fv(t,o);case 35664:return e.uniform2fv(t,o);case 35665:return e.uniform3fv(t,o);case 35666:return e.uniform4fv(t,o);case 5124:case 35670:return e.uniform1iv(t,o);case 35667:case 35671:return e.uniform2iv(t,o);case 35668:case 35672:return e.uniform3iv(t,o);case 35669:case 35673:return e.uniform4iv(t,o);case 5125:return s.uniform1uiv(t,o,1);case 36294:return s.uniform2uiv(t,o,2);case 36295:return s.uniform3uiv(t,o,3);case 36296:return s.uniform4uiv(t,o,4);case 35674:return e.uniformMatrix2fv(t,!1,o);case 35675:return e.uniformMatrix3fv(t,!1,o);case 35676:return e.uniformMatrix4fv(t,!1,o);case 35685:return s.uniformMatrix2x3fv(t,!1,o);case 35686:return s.uniformMatrix2x4fv(t,!1,o);case 35687:return s.uniformMatrix3x2fv(t,!1,o);case 35688:return s.uniformMatrix3x4fv(t,!1,o);case 35689:return s.uniformMatrix4x2fv(t,!1,o);case 35690:return s.uniformMatrix4x3fv(t,!1,o)}throw new Error("Illegal uniform")}function _p(e){const t={bindings:{},uniforms:{}};return Object.keys(e).forEach((n=>{const i=e[n];var s;null!==ch(s=i)||"number"==typeof s||"boolean"==typeof s?t.uniforms[n]=i:t.bindings[n]=i})),t}class yp extends Qi{constructor(e,t){super(e,t),i(this,"device"),i(this,"handle"),i(this,"vs"),i(this,"fs"),i(this,"introspectedLayout"),i(this,"uniforms",{}),i(this,"bindings",{}),i(this,"varyings",null),i(this,"_uniformCount",0),i(this,"_uniformSetters",{}),this.device=e,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=t.vs,this.fs=t.fs;const{varyings:n,bufferMode:s=35981}=t;n&&n.length>0&&(this.varyings=n,this.device.gl.transformFeedbackVaryings(this.handle,n,s)),this._linkShaders(),Zn.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=dp(this.device.gl,this.handle),Zn.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=function(e,t){const n={...e,attributes:e.attributes.map((e=>({...e})))};for(const i of(null==t?void 0:t.attributes)||[]){const e=n.attributes.find((e=>e.name===i.name));e?(e.type=i.type||e.type,e.stepMode=i.stepMode||e.stepMode):Zn.warn(`shader layout attribute ${i.name} not present in shader`)}return n}(this.introspectedLayout,t.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(e,t){for(const[n,i]of Object.entries(e)){const e=this.shaderLayout.bindings.find((e=>e.name===n))||this.shaderLayout.bindings.find((e=>e.name===`${n}Uniforms`));if(e){switch(i||Zn.warn(`Unsetting binding "${n}" in render pipeline "${this.id}"`)(),e.type){case"uniform":if(!(i instanceof Bf||i.buffer instanceof Bf))throw new Error("buffer value");break;case"texture":if(!(i instanceof qf||i instanceof rp||i instanceof Tf))throw new Error("texture value");break;case"sampler":Zn.warn(`Ignoring sampler ${n}`)();break;default:throw new Error(e.type)}this.bindings[n]=i}else{const e=this.shaderLayout.bindings.map((e=>`"${e.name}"`)).join(", ");(null==t?void 0:t.disableWarnings)||Zn.warn(`No binding "${n}" in render pipeline "${this.id}", expected one of ${e}`,i)()}}}draw(e){var t;const{renderPass:n,parameters:i=this.props.parameters,topology:s=this.props.topology,vertexArray:r,vertexCount:o,instanceCount:a,isInstanced:l=!1,firstVertex:c=0,transformFeedback:u}=e,h=function(e){switch(e){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(e)}}(s),d=Boolean(r.indexBuffer),f=null==(t=r.indexBuffer)?void 0:t.glIndexType;if("success"!==this.linkStatus)return Zn.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return Zn.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),r.bindBeforeRender(n),u&&u.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const p=n;return Gf(this.device,i,p.glParameters,(()=>{d&&l?this.device.gl.drawElementsInstanced(h,o||0,f,c,a||0):d?this.device.gl.drawElements(h,o||0,f,c):l?this.device.gl.drawArraysInstanced(h,c,o||0,a||0):this.device.gl.drawArrays(h,c,o||0),u&&u.end()})),r.unbindAfterRender(n),!0}setUniformsWebGL(e){const{bindings:t}=_p(e);Object.keys(t).forEach((e=>{Zn.warn(`Unsupported value "${JSON.stringify(t[e])}" used in setUniforms() for key ${e}. Use setBindings() instead?`)()})),Object.assign(this.uniforms,e)}async _linkShaders(){const{gl:e}=this.device;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),Zn.time(4,`linkProgram for ${this.id}`)(),e.linkProgram(this.handle),Zn.timeEnd(4,`linkProgram for ${this.id}`)(),Zn.level,!this.device.features.has("compilation-status-async-webgl")){const e=this._getLinkStatus();return void this._reportLinkStatus(e)}Zn.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),Zn.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const t=this._getLinkStatus();this._reportLinkStatus(t)}async _reportLinkStatus(e){var t;if("success"!==e){switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then((()=>this.vs.debugShader()))}switch(null==(t=this.fs)?void 0:t.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then((()=>this.fs.debugShader()))}const n=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${e}: ${n}`)}}_getLinkStatus(){const{gl:e}=this.device;if(!e.getProgramParameter(this.handle,35714))return this.linkStatus="error","linking";e.validateProgram(this.handle);return e.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")}async _waitForLinkComplete(){const e=async e=>await new Promise((t=>setTimeout(t,e)));if(!this.device.features.has("compilation-status-async-webgl"))return void(await e(10));const{gl:t}=this.device;for(;;){if(t.getProgramParameter(this.handle,37297))return;await e(10)}}_areTexturesRenderable(){let e=!0;for(const t of this.shaderLayout.bindings)this.bindings[t.name]||this.bindings[t.name.replace(/Uniforms$/,"")]||(Zn.warn(`Binding ${t.name} not found in ${this.id}`)(),e=!1);return e}_applyBindings(){if("success"!==this.linkStatus)return;const{gl:e}=this.device;e.useProgram(this.handle);let t=0,n=0;for(const i of this.shaderLayout.bindings){const s=this.bindings[i.name]||this.bindings[i.name.replace(/Uniforms$/,"")];if(!s)throw new Error(`No value for binding ${i.name} in ${this.id}`);switch(i.type){case"uniform":const{name:r}=i,o=e.getUniformBlockIndex(this.handle,r);if(4294967295===o)throw new Error(`Invalid uniform block name ${r}`);e.uniformBlockBinding(this.handle,n,o),s instanceof Bf?e.bindBufferBase(35345,n,s.handle):e.bindBufferRange(35345,n,s.buffer.handle,s.offset||0,s.size||s.buffer.byteLength-s.offset),n+=1;break;case"texture":if(!(s instanceof qf||s instanceof rp||s instanceof Tf))throw new Error("texture");let a;if(s instanceof qf)a=s.texture;else if(s instanceof rp)a=s;else{if(!(s instanceof Tf&&s.colorAttachments[0]instanceof qf))throw new Error("No texture");Zn.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),a=s.colorAttachments[0].texture}e.activeTexture(33984+t),e.bindTexture(a.glTarget,a.handle),t+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${i.type}' not supported in WebGL`)}}}_applyUniforms(){for(const e of this.shaderLayout.uniforms||[]){const{name:t,location:n,type:i,textureUnit:s}=e,r=this.uniforms[t]??s;void 0!==r&&mp(this.device.gl,n,i,r)}}}class vp extends os{constructor(e){super(e,{}),i(this,"device"),i(this,"commands",[]),this.device=e}submitCommands(e=this.commands){for(const t of e)switch(t.name){case"copy-buffer-to-buffer":bp(this.device,t.options);break;case"copy-buffer-to-texture":Ep(this.device,t.options);break;case"copy-texture-to-buffer":xp(this.device,t.options);break;case"copy-texture-to-texture":wp(this.device,t.options);break;default:throw new Error(t.name)}}}function bp(e,t){const n=t.sourceBuffer,i=t.destinationBuffer;e.gl.bindBuffer(36662,n.handle),e.gl.bindBuffer(36663,i.handle),e.gl.copyBufferSubData(36662,36663,t.sourceOffset??0,t.destinationOffset??0,t.size),e.gl.bindBuffer(36662,null),e.gl.bindBuffer(36663,null)}function Ep(e,t){throw new Error("Not implemented")}function xp(e,t){const{sourceTexture:n,mipLevel:i=0,aspect:s="all",width:r=t.sourceTexture.width,height:o=t.sourceTexture.height,depthOrArrayLayers:a=0,origin:l=[0,0],destinationBuffer:c,byteOffset:u=0,bytesPerRow:h,rowsPerImage:d}=t;if("all"!==s)throw new Error("aspect not supported in WebGL");if(0!==i||0!==a||h||d)throw new Error("not implemented");const{framebuffer:f,destroyFramebuffer:p}=Tp(n);let g;try{const t=c,n=r||f.width,i=o||f.height,s=vf(f.colorAttachments[0].texture.props.format),a=s.format,h=s.type;e.gl.bindBuffer(35051,t.handle),g=e.gl.bindFramebuffer(36160,f.handle),e.gl.readPixels(l[0],l[1],n,i,a,h,u)}finally{e.gl.bindBuffer(35051,null),void 0!==g&&e.gl.bindFramebuffer(36160,g),p&&f.destroy()}}function wp(e,t){const{sourceTexture:n,destinationMipLevel:i=0,origin:s=[0,0],destinationOrigin:r=[0,0],destinationTexture:o}=t;let{width:a=t.destinationTexture.width,height:l=t.destinationTexture.height}=t;const{framebuffer:c,destroyFramebuffer:u}=Tp(n),[h,d]=s,[f,p,g]=r,m=e.gl.bindFramebuffer(36160,c.handle);let _,y=null;if(!(o instanceof rp))throw new Error("invalid destination");switch(y=o,a=Number.isFinite(a)?a:y.width,l=Number.isFinite(l)?l:y.height,y.bind(0),_=y.glTarget,_){case 3553:case 34067:e.gl.copyTexSubImage2D(_,i,f,p,h,d,a,l);break;case 35866:case 32879:e.gl.copyTexSubImage3D(_,i,f,p,g,h,d,a,l)}y&&y.unbind(),e.gl.bindFramebuffer(36160,m),u&&c.destroy()}function Tp(e){if(e instanceof Di){const{width:t,height:n,id:i}=e;return{framebuffer:e.device.createFramebuffer({id:`framebuffer-for-${i}`,width:t,height:n,colorAttachments:[e]}),destroyFramebuffer:!0}}return{framebuffer:e,destroyFramebuffer:!1}}class Ap extends ss{constructor(e,t){super(e,t),i(this,"device"),i(this,"commandBuffer"),this.device=e,this.commandBuffer=new vp(e)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(e){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:e})}copyBufferToTexture(e){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:e})}copyTextureToBuffer(e){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:e})}copyTextureToTexture(e){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:e})}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}resolveQuerySet(e,t,n){}}class Sp extends fs{constructor(e,t){super(e,t),i(this,"device"),i(this,"handle"),i(this,"buffer",null),i(this,"bufferValue",null),this.device=e,this.handle=this.device.gl.createVertexArray()}get[Symbol.toStringTag](){return"VertexArray"}static isConstantAttributeZeroSupported(e){return"Chrome"==(t||Z()?q(t)?"Electron":(t||K.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node");var t}destroy(){var e;super.destroy(),this.buffer&&(null==(e=this.buffer)||e.destroy()),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(e){const t=e;if(t&&34963!==t.glTarget)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,t?t.handle:null),this.indexBuffer=t,this.device.gl.bindVertexArray(null)}setBuffer(e,t){const n=t;if(34963===n.glTarget)throw new Error("Use .setIndexBuffer()");const{size:i,type:s,stride:r,offset:o,normalized:a,integer:l,divisor:c}=this._getAccessor(e);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,n.handle),l?this.device.gl.vertexAttribIPointer(e,i,s,r,o):this.device.gl.vertexAttribPointer(e,i,s,a,r,o),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(e),this.device.gl.vertexAttribDivisor(e,c||0),this.attributes[e]=n,this.device.gl.bindVertexArray(null)}setConstantWebGL(e,t){this._enable(e,!1),this.attributes[e]=t}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let e=0;e<this.maxVertexAttributes;++e){const t=this.attributes[e];ArrayBuffer.isView(t)&&this.device.setConstantAttributeWebGL(e,t)}}_getAccessor(e){const t=this.attributeInfos[e];if(!t)throw new Error(`Unknown attribute location ${e}`);const n=uf(t.bufferDataType);return{size:t.bufferComponents,type:n,stride:t.byteStride,offset:t.byteOffset,normalized:t.normalized,integer:t.integer,divisor:"instance"===t.stepMode?1:0}}_enable(e,t=!0){const n=Sp.isConstantAttributeZeroSupported(this.device);(t||(n||0!==e))&&(e=Number(e),this.device.gl.bindVertexArray(this.handle),t?this.device.gl.enableVertexAttribArray(e):this.device.gl.disableVertexAttribArray(e),this.device.gl.bindVertexArray(null))}getConstantBuffer(e,t){const n=function(e){if(Array.isArray(e))return new Float32Array(e);return e}(t),i=n.byteLength*e,s=n.length*e;if(this.buffer&&i!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${i} !== ${this.buffer.byteLength}.`);let r=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:i}),r=r||!function(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(n,this.bufferValue),r){const e=function(e,t){return new e(Es(e.BYTES_PER_ELEMENT*t),0,t)}(t.constructor,s);!function(e){const{target:t,source:n,start:i=0,count:s=1}=e,r=n.length,o=s*r;let a=0;for(let l=i;a<r;a++)t[l++]=n[a];for(;a<o;)a<o-a?(t.copyWithin(i+a,i,i+a),a*=2):(t.copyWithin(i+a,i,i+o-a),a=o);e.target}({target:e,source:n,start:0,count:s}),this.buffer.write(e),this.bufferValue=t}return this.buffer}}class Rp extends gs{constructor(e,t){super(e,t),i(this,"device"),i(this,"gl"),i(this,"handle"),i(this,"layout"),i(this,"buffers",{}),i(this,"unusedBuffers",{}),i(this,"bindOnUse",!0),i(this,"_bound",!1),this.device=e,this.gl=e.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,t.buffers&&this.setBuffers(t.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(e="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(function(e){switch(e){case"point-list":return 0;case"line-list":case"line-strip":return 1;case"triangle-list":case"triangle-strip":return 4;default:throw new Error(e)}}(e))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(e){this.buffers={},this.unusedBuffers={},this.bind((()=>{for(const t in e)this.setBuffer(t,e[t])}))}setBuffer(e,t){const n=this._getVaryingIndex(e),{buffer:i,byteLength:s,byteOffset:r}=this._getBufferRange(t);if(n<0)return this.unusedBuffers[e]=i,void Zn.warn(`${this.id} unusedBuffers varying buffer ${e}`)();this.buffers[n]={buffer:i,byteLength:s,byteOffset:r},this.bindOnUse||this._bindBuffer(n,i,r,s)}getBuffer(e){if(Pp(e))return this.buffers[e]||null;const t=this._getVaryingIndex(e);return t>=0?this.buffers[t]:null}bind(e=this.handle){if("function"!=typeof e)return this.gl.bindTransformFeedback(36386,e),this;let t;return this._bound?t=e():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,t=e(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),t}unbind(){this.bind(null)}_getBufferRange(e){if(e instanceof Bf)return{buffer:e,byteOffset:0,byteLength:e.byteLength};const{buffer:t,byteOffset:n=0,byteLength:i=e.buffer.byteLength}=e;return{buffer:t,byteOffset:n,byteLength:i}}_getVaryingIndex(e){if(Pp(e))return Number(e);for(const t of this.layout.varyings)if(e===t.name)return t.location;return-1}_bindBuffers(){for(const e in this.buffers){const{buffer:t,byteLength:n,byteOffset:i}=this._getBufferRange(this.buffers[e]);this._bindBuffer(Number(e),t,i,n)}}_unbindBuffers(){for(const e in this.buffers)this.gl.bindBufferBase(35982,Number(e),null)}_bindBuffer(e,t,n=0,i){const s=t&&t.handle;s&&void 0!==i?this.gl.bindBufferRange(35982,e,s,n,i):this.gl.bindBufferBase(35982,e,s)}}function Pp(e){return"number"==typeof e?Number.isInteger(e):/^\d+$/.test(e)}class Cp extends _s{constructor(e,t){if(super(e,t),i(this,"device"),i(this,"handle"),i(this,"target",null),i(this,"_queryPending",!1),i(this,"_pollingPromise",null),this.device=e,t.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}get[Symbol.toStringTag](){return"Query"}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(e){return this._begin((null==e?void 0:e.conservative)?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(e){this._queryPending||(this.target=e,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const e=this.device.gl.getQueryParameter(this.handle,34919);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(e=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise(((n,i)=>{const s=()=>{this.isResultAvailable()?(n(this.getResult()),this._pollingPromise=null):t++>e?(i("Timed out"),this._pollingPromise=null):requestAnimationFrame(s)};requestAnimationFrame(s)})),this._pollingPromise}}class Ip extends Ri{constructor(e){var t,n;super({...e,id:e.id||Ff("webgl-device")}),i(this,"type","webgl"),i(this,"handle"),i(this,"features"),i(this,"limits"),i(this,"info"),i(this,"canvasContext"),i(this,"lost"),i(this,"_resolveContextLost"),i(this,"gl"),i(this,"debug",!1),i(this,"_canvasSizeInfo",{clientWidth:0,clientHeight:0,devicePixelRatio:1}),i(this,"_extensions",{}),i(this,"_polyfilled",!1),i(this,"spectorJS"),i(this,"renderPass",null),i(this,"_constants");const s=Ri._getCanvasContextProps(e);if(!s)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let r=null==(n=null==(t=s.canvas)?void 0:t.gl)?void 0:n.device;if(r)throw new Error(`WebGL context already attached to device ${r.id}`);this.canvasContext=new Af(this,s),this.lost=new Promise((e=>{this._resolveContextLost=e}));const o={...e.webgl};"premultiplied"===s.alphaMode&&(o.premultipliedAlpha=!0),void 0!==e.powerPreference&&(o.powerPreference=e.powerPreference);const a=this.props._handle||function(e,t,n){let i="";const s={preserveDrawingBuffer:!0,...n};let r=null;if(r||(r=e.getContext("webgl2",s)),s.failIfMajorPerformanceCaveat&&(i||(i="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow.")),r||n.failIfMajorPerformanceCaveat||(s.failIfMajorPerformanceCaveat=!1,r=e.getContext("webgl2",s),r.luma||(r.luma={}),r.luma.softwareRenderer=!0),r||(r=e.getContext("webgl",{}),r&&(r=null,i||(i="Your browser only supports WebGL1"))),!r)throw i||(i="Your browser does not support WebGL"),new Error(`Failed to create WebGL context: ${i}`);const{onContextLost:o,onContextRestored:a}=t;return e.addEventListener("webglcontextlost",(e=>o(e)),!1),e.addEventListener("webglcontextrestored",(e=>a(e)),!1),r.luma||(r.luma={}),r}(this.canvasContext.canvas,{onContextLost:e=>{var t;return null==(t=this._resolveContextLost)?void 0:t.call(this,{reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})},onContextRestored:e=>{}},o);if(!a)throw new Error("WebGL context creation failed");if(r=a.device,r){if(e._reuseDevices)return Zn.log(1,`Not creating a new Device, instead returning a reference to Device ${r.id} already attached to WebGL context`,r)(),r._reused=!0,r;throw new Error(`WebGL context already attached to device ${r.id}`)}this.handle=a,this.gl=a,this.spectorJS=function(e){var t;if(!(e={...Cf,...e}).debugSpectorJS)return null;if(!Rf&&globalThis.SPECTOR&&!(null==(t=globalThis.luma)?void 0:t.spector)){Zn.probe(1,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:e}=globalThis.SPECTOR;Rf=new e,globalThis.luma&&(globalThis.luma.spector=Rf)}if(!Rf)return null;if(Pf||(Pf=!0,Rf.spyCanvases(),null==Rf||Rf.onCaptureStarted.add((e=>Zn.info("Spector capture started:",e)())),null==Rf||Rf.onCapture.add((e=>{Zn.info("Spector capture complete:",e)(),null==Rf||Rf.getResultUI(),null==Rf||Rf.resultView.display(),null==Rf||Rf.resultView.addCapture(e)}))),e.gl){const t=e.gl,n=t.device;null==Rf||Rf.startCapture(e.gl,500),t.device=n,new Promise((e=>setTimeout(e,2e3))).then((e=>{Zn.info("Spector capture stopped after 2 seconds")(),null==Rf||Rf.stopCapture()}))}return Rf}({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=lf(this.gl,this._extensions),this.limits=new wf(this.gl),this.features=new xf(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),!1!==s.autoResize&&this.canvasContext.resize();new sf(this.gl,{log:(...e)=>Zn.log(1,...e)()}).trackState(this.gl,{copyState:!1});const l=e.debugWebGL||e.debug,c=e.debugWebGL;l&&(this.gl=Lf(this.gl,{debugWebGL:l,traceWebGL:c}),Zn.warn("WebGL debug mode activated. Performance reduced.")(),e.debugWebGL&&(Zn.level=Math.max(Zn.level,1)))}destroy(){this.props._reuseDevices||this._reused||delete this.gl.device}get isLost(){return this.gl.isContextLost()}createCanvasContext(e){throw new Error("WebGL only supports a single canvas")}createBuffer(e){const t=this._normalizeBufferProps(e);return new Bf(this,t)}createTexture(e){return new rp(this,e)}createExternalTexture(e){throw new Error("createExternalTexture() not implemented")}createSampler(e){return new Kf(this,e)}createShader(e){return new Uf(this,e)}createFramebuffer(e){return new Tf(this,e)}createVertexArray(e){return new Sp(this,e)}createTransformFeedback(e){return new Rp(this,e)}createQuerySet(e){return new Cp(this,e)}createRenderPipeline(e){return new yp(this,e)}beginRenderPass(e){return new ap(this,e)}createComputePipeline(e){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(e){throw new Error("ComputePass not supported in WebGL")}createCommandEncoder(e={}){return new Ap(this,e)}submit(){var e;null==(e=this.renderPass)||e.end(),this.renderPass=null}readPixelsToArrayWebGL(e,t){return np(e,t)}readPixelsToBufferWebGL(e,t){return function(e,t){const{target:n,sourceX:i=0,sourceY:s=0,sourceFormat:r=6408,targetByteOffset:o=0}=t||{};let{sourceWidth:a,sourceHeight:l,sourceType:c}=t||{};const{framebuffer:u,deleteFramebuffer:h}=ip(e);a=a||u.width,l=l||u.height;const d=u;c=c||5121;let f=n;if(!f){const e=o+a*l*Zf(r)*function(e){switch(e){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}(c);f=d.device.createBuffer({byteLength:e})}const p=e.device.createCommandEncoder();return p.copyTextureToBuffer({sourceTexture:e,width:a,height:l,origin:[i,s],destinationBuffer:f,byteOffset:o}),p.destroy(),h&&u.destroy(),f}(e,t)}setParametersWebGL(e){ef(this.gl,e)}getParametersWebGL(e){return tf(this.gl,e)}withParametersWebGL(e,t){return Qf(this.gl,e,t)}resetWebGL(){Zn.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),ef(this.gl,Gd)}_getDeviceSpecificTextureFormatCapabilities(e){return function(e,t,n){let i=t.create;const s=yf[t.format];return void 0===(null==s?void 0:s.gl)&&(i=!1),(null==s?void 0:s.x)&&(i=i&&Boolean(af(e,s.x,n))),{format:t.format,create:i&&t.create,render:i&&t.render,filter:i&&t.filter,blend:i&&t.blend,store:i&&t.store}}(this.gl,e,this._extensions)}loseDevice(){var e;let t=!1;const n=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return n&&(t=!0,n.loseContext()),null==(e=this._resolveContextLost)||e.call(this,{reason:"destroyed",message:"Application triggered context loss"}),t}pushState(){sf.get(this.gl).push()}popState(){sf.get(this.gl).pop()}setSpectorMetadata(e,t){e.__SPECTOR_Metadata=t}getGLKey(e,t){const n=Number(e);for(const i in this.gl)if(this.gl[i]===n)return`GL.${i}`;return(null==t?void 0:t.emptyIfUnknown)?"":String(e)}getGLKeys(e){const t={emptyIfUnknown:!0};return Object.entries(e).reduce(((e,[n,i])=>(e[`${n}:${this.getGLKey(n,t)}`]=`${i}:${this.getGLKey(i,t)}`,e)),{})}setConstantAttributeWebGL(e,t){const n=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(n).fill(null);const i=this._constants[e];switch(i&&function(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(i,t)&&Zn.info(1,`setConstantAttributeWebGL(${e}) could have been skipped, value unchanged`)(),this._constants[e]=t,t.constructor){case Float32Array:!function(e,t,n){switch(n.length){case 1:e.gl.vertexAttrib1fv(t,n);break;case 2:e.gl.vertexAttrib2fv(t,n);break;case 3:e.gl.vertexAttrib3fv(t,n);break;case 4:e.gl.vertexAttrib4fv(t,n)}}(this,e,t);break;case Int32Array:!function(e,t,n){e.gl.vertexAttribI4iv(t,n)}(this,e,t);break;case Uint32Array:!function(e,t,n){e.gl.vertexAttribI4uiv(t,n)}(this,e,t);break;default:throw new Error("constant")}}getExtension(e){return af(this.gl,e,this._extensions),this._extensions}}const Lp={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},Mp=e=>({drawBuffersWEBGL:t=>e.drawBuffers(t),COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),kp=e=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES:()=>e.createVertexArray(),deleteVertexArrayOES:t=>e.deleteVertexArray(t),isVertexArrayOES:t=>e.isVertexArray(t),bindVertexArrayOES:t=>e.bindVertexArray(t)}),Op=e=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE:(...t)=>e.drawArraysInstanced(...t),drawElementsInstancedANGLE:(...t)=>e.drawElementsInstanced(...t),vertexAttribDivisorANGLE:(...t)=>e.vertexAttribDivisor(...t)});function Np(e=!0){const t=HTMLCanvasElement.prototype;if(!e&&t.originalGetContext)return t.getContext=t.originalGetContext,void(t.originalGetContext=void 0);t.originalGetContext=t.getContext,t.getContext=function(e,t){if("webgl"===e||"experimental-webgl"===e){const e=this.originalGetContext("webgl2",t);return e instanceof HTMLElement&&function(e){e.getExtension("EXT_color_buffer_float");const t={...Lp,WEBGL_disjoint_timer_query:e.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:Mp(e),OES_vertex_array_object:kp(e),ANGLE_instanced_arrays:Op(e)},n=e.getExtension;e.getExtension=function(i){const s=n.call(e,i);return s||(i in t?t[i]:null)};const i=e.getSupportedExtensions;e.getSupportedExtensions=function(){const n=i.apply(e)||[];return null==n?void 0:n.concat(Object.keys(t))}}(e),e}return this.originalGetContext(e,t)}}const Fp=new class extends Mi{constructor(){super(),i(this,"type","webgl"),Ri.defaultProps={...Ri.defaultProps,...Cf},Ip.adapter=this}isSupported(){return"undefined"!=typeof WebGL2RenderingContext}enforceWebGL2(e){Np(e)}async attach(e){if(e instanceof Ip)return e;if((null==e?void 0:e.device)instanceof Ri)return e.device;if(!function(e){if("undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext)return!0;return Boolean(e&&Number.isFinite(e._version))}(e))throw new Error("Invalid WebGL2RenderingContext");return new Ip({_handle:e,createCanvasContext:{canvas:e.canvas,autoResize:!1}})}async create(e={}){Zn.groupCollapsed(1,"WebGLDevice created")();const t=[];(e.debugWebGL||e.debug)&&t.push(async function(){Z()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await Sf("https://unpkg.com/webgl-debug@2.0.1/index.js"))}()),e.debugSpectorJS&&t.push(async function(e){if(!globalThis.SPECTOR)try{await Sf(e.debugSpectorJSUrl||Cf.debugSpectorJSUrl)}catch(t){Zn.warn(String(t))}}(e));const n=await Promise.allSettled(t);for(const r of n)"rejected"===r.status&&Zn.error(`Failed to initialize debug libraries ${r.reason}`)();const i=new Ip(e),s=`${i._reused?"Reusing":"Created"} device with WebGL2 ${i.debug?"debug ":""}context: ${i.info.vendor}, ${i.info.renderer} for canvas: ${i.canvasContext.id}`;return Zn.probe(1,s)(),Zn.table(1,i.info)(),Zn.groupEnd(1)(),i}};function Bp(){}const Dp={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Bp,onWebGLInitialized:Bp,onResize:Bp,onViewStateChange:Bp,onInteractionStateChange:Bp,onBeforeRender:Bp,onAfterRender:Bp,onLoad:Bp,onError:e=>ln.error(e.message,e.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:({isDragging:e})=>e?"grabbing":"grab",getTooltip:null,debug:!1,drawPickingColors:!1};class Up{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new Ve({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=e=>{const{_pickRequest:t}=this;if("pointerleave"===e.type)t.x=-1,t.y=-1,t.radius=0;else{if(e.leftButton||e.rightButton)return;{const n=e.offsetCenter;if(!n)return;t.x=n.x,t.y=n.y,t.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:t.x,y:t.y}),t.event=e},this._onEvent=e=>{const t=ic[e.type],n=e.offsetCenter;if(!t||!n||!this.layerManager)return;const i=this.layerManager.getLayers(),s=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:i,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:r}=s,o=r&&(r[t]||r.props[t]),a=this.props[t];let l=!1;o&&(l=o.call(r,s,e)),l||(null==a||a(s,e),this.widgetManager.onEvent(s,e))},this._onPointerDown=e=>{var t;if("webgpu"===(null==(t=this.device)?void 0:t.type))return;const n=e.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:n.x,y:n.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo},this.props={...Dp,...e},(e=this.props).viewState&&e.initialViewState&&ln.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&ln.error("WebGL1 context not supported.")(),t=Fp.attach(e.gl)),t||(t=Li.createDevice({type:"best-available",_reuseDevices:!0,adapters:[Fp],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&Pu.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,n,i,s,r,o,a,l,c;null==(e=this.animationLoop)||e.stop(),null==(t=this.animationLoop)||t.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,null==(n=this.layerManager)||n.finalize(),this.layerManager=null,null==(i=this.viewManager)||i.finalize(),this.viewManager=null,null==(s=this.effectManager)||s.finalize(),this.effectManager=null,null==(r=this.deckRenderer)||r.finalize(),this.deckRenderer=null,null==(o=this.deckPicker)||o.finalize(),this.deckPicker=null,null==(a=this.eventManager)||a.destroy(),this.eventManager=null,null==(l=this.widgetManager)||l.finalize(),this.widgetManager=null,this.props.canvas||this.props.device||this.props.gl||!this.canvas||(null==(c=this.canvas.parentElement)||c.removeChild(this.canvas),this.canvas=null)}setProps(e){var t;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&ln.removed("onLayerHover","onHover")(),"onLayerClick"in e&&ln.removed("onLayerClick","onClick")(),e.initialViewState&&!Wh(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const n=Object.create(this.props);Object.assign(n,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),null==(t=this.animationLoop)||t.setProps(n),this.layerManager&&(this.viewManager.setProps(n),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(n),this.effectManager.setProps(n),this.deckRenderer.setProps(n),this.deckPicker.setProps(n),this.widgetManager.setProps(n)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const n=this.viewManager.needsRedraw(e),i=this.layerManager.needsRedraw(e),s=this.effectManager.needsRedraw(e),r=this.deckRenderer.needsRedraw(e);return t=t||n||i||s||r,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return null!==this.viewManager}getViews(){return nd(this.viewManager),this.viewManager.views}getViewports(e){return nd(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const n in e)this.layerManager.resourceManager.add({resourceId:n,data:e[n],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var t;null==(t=this.layerManager)||t.removeDefaultShaderModule(e)}_pick(e,t,n){nd(this.deckPicker);const{stats:i}=this;i.get("Pick Count").incrementCount(),i.get(t).timeStart();const s=this.deckPicker[e]({layers:this.layerManager.getLayers(n),views:this.viewManager.getViews(),viewports:this.getViewports(n),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...n});return i.get(t).timeEnd(),s}_createCanvas(e){let t=e.canvas;if("string"==typeof t&&(t=document.getElementById(t),nd(t)),!t){t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay";(e.parent||document.body).appendChild(t)}return Object.assign(t.style,e.style),t}_setCanvasSize(e){var t;if(!this.canvas)return;const{width:n,height:i}=e;if(n||0===n){const e=Number.isFinite(n)?`${n}px`:n;this.canvas.style.width=e}if(i||0===i){const n=Number.isFinite(i)?`${i}px`:i;this.canvas.style.position=(null==(t=e.style)?void 0:t.position)||"absolute",this.canvas.style.height=n}}_updateCanvasSize(){var e,t;const{canvas:n}=this;if(!n)return;const i=n.clientWidth??n.width,s=n.clientHeight??n.height;i===this.width&&s===this.height||(this.width=i,this.height=s,null==(e=this.viewManager)||e.setProps({width:i,height:s}),null==(t=this.layerManager)||t.activateViewport(this.getViewports()[0]),this.props.onResize({width:i,height:s}))}_createAnimationLoop(e,t){const{gl:n,onError:i,useDevicePixels:s}=t;return new Zu({device:e,useDevicePixels:s,autoResizeDrawingBuffer:!n,autoResizeViewport:!1,onInitialize:e=>this._setDevice(e.device),onRender:this._onRenderFrame.bind(this),onError:i})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new Ed({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var e,t,n,i;if("webgpu"===(null==(e=this.device)?void 0:e.type))return;const{_pickRequest:s}=this;if(s.event){const{result:e,emptyInfo:r}=this._pick("pickObject","pickObject Time",s);this.cursorState.isHovering=e.length>0;let o=r,a=!1;for(const n of e)o=n,a=(null==(t=n.layer)?void 0:t.onHover(n,s.event))||a;a||(null==(i=(n=this.props).onHover)||i.call(n,o,s.event),this.widgetManager.onHover(o,s.event)),s.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var t,n;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=null==(t=this.device.canvasContext)?void 0:t.canvas),"webgl"===this.device.type&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),"webgl"===this.device.type&&this.props.onWebGLInitialized(this.device.gl);const i=new Yu;i.play(),this.animationLoop.attachTimeline(i),this.eventManager=new Jl(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(sc).map((e=>{var t;const[n,i,s,r]=sc[e];return{recognizer:new n({...i,...null==(t=this.props.eventRecognizerOptions)?void 0:t[e],event:e}),recognizeWith:s,requestFailure:r}})),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const r in ic)this.eventManager.on(r,this._onEvent);this.viewManager=new jh({timeline:i,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const s=this.viewManager.getViewports()[0];this.layerManager=new Vh(this.device,{deck:this,stats:this.stats,viewport:s,timeline:i}),this.effectManager=new wd({deck:this,device:this.device}),this.deckRenderer=new Ad(this.device),this.deckPicker=new Ld(this.device),this.widgetManager=new Nd({deck:this,parentElement:null==(n=this.canvas)?void 0:n.parentElement}),this.widgetManager.addDefault(new Bd),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){var n;const{device:i,gl:s}=this.layerManager.context;this.props.onBeforeRender({device:i,gl:s});const r={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};null==(n=this.deckRenderer)||n.renderLayers(r),"screen"===r.pass&&this.widgetManager.onRedraw({viewports:r.viewports,layers:r.layers}),this.props.onAfterRender({device:i,gl:s})}_onRenderFrame(){var e;this._getFrameStats(),this._metricsCounter++%60==0&&(this._getMetrics(),this.stats.reset(),ln.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),"webgpu"!==(null==(e=this.device)?void 0:e.type)&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const n=Li.stats.get("Memory Usage");e.bufferMemory=n.get("Buffer Memory").count,e.textureMemory=n.get("Texture Memory").count,e.renderbufferMemory=n.get("Renderbuffer Memory").count,e.gpuMemory=n.get("GPU Memory").count}}Up.defaultProps=Dp,Up.VERSION=fn;const Gp=Up;const zp=Ss;function Vp(e,t,n){const i="webgpu"===n&&"uint8"===t.type?"unorm8":t.type;return{attribute:e,format:t.size>1?`${i}x${t.size}`:t.type,byteOffset:t.offset||0}}function Wp(e){return e.stride||e.size*e.bytesPerElement}function jp(e,t){t.offset&&ln.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const n=Wp(e),i=(void 0!==t.vertexOffset?t.vertexOffset:e.vertexOffset||0)*n+(t.elementOffset||0)*e.bytesPerElement+(e.offset||0);return{...t,offset:i,stride:n}}class Hp{constructor(e,t,n){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const i=t.logicalType||t.type,s="float64"===i;let r,{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0),r=s?"float32":!i&&t.isIndexed?"uint32":i||"float32";let a=function(e){switch(e){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return Rs(e)}}(i||r);this.doublePrecision=s,s&&!1===t.fp64&&(a=Float32Array),this.value=null,this.settings={...t,defaultType:a,defaultValue:o,logicalType:i,type:r,normalized:r.includes("norm"),size:this.size,bytesPerElement:a.BYTES_PER_ELEMENT},this.state={...n,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*Wp(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Pu.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const n={};if(this.state.constant){const i=this.value;if(t){const s=jp(this.getAccessor(),t),r=s.offset/i.BYTES_PER_ELEMENT,o=s.size||this.size;n[e]=i.subarray(r,r+o)}else n[e]=i}else n[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?n[`${e}64Low`]=n[e]:n[`${e}64Low`]=new Float32Array(this.size)),n}_getBufferLayout(e=this.id,t=null){const n=this.getAccessor(),i=[],s={name:this.id,byteStride:Wp(n),attributes:i};if(this.doublePrecision){const s=function(e,t){const n=jp(e,t);return{high:n,low:{...n,offset:n.offset+4*e.size}}}(n,t||{});i.push(Vp(e,{...n,...s.high},this.device.type),Vp(`${e}64Low`,{...n,...s.low},this.device.type))}else if(t){const s=jp(n,t);i.push(Vp(e,{...n,...s},this.device.type))}else i.push(Vp(e,n,this.device.type));return s}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:n,size:i}=this,s=n*i;if(t&&s&&t.length>=s){const n=new Array(i).fill(1/0),r=new Array(i).fill(-1/0);for(let e=0;e<s;)for(let s=0;s<i;s++){const i=t[e++];i<n[s]&&(n[s]=i),i>r[s]&&(r[s]=i)}e=[n,r]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let n;n=ArrayBuffer.isView(e)?{value:e}:e instanceof ni?{buffer:e}:e;const i={...this.settings,...n};if(ArrayBuffer.isView(n.value)){if(!n.type){if(this.doublePrecision&&n.value instanceof Float64Array)i.type="float32";else{const e=zp(n.value);i.type=i.normalized?e.replace("int","norm"):e}}i.bytesPerElement=n.value.BYTES_PER_ELEMENT,i.stride=Wp(i)}if(t.bounds=null,n.constant){let e=n.value;e=this._normalizeValue(e,[],0),this.settings.normalized&&(e=this.normalizeConstant(e));if(!(!t.constant||!this._areValuesEqual(e,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(e)?e:new Float32Array(e)}else if(n.buffer){const e=n.buffer;t.externalBuffer=e,t.constant=!1,this.value=n.value||null}else if(n.value){this._checkExternalBuffer(n);let e=n.value;t.externalBuffer=null,t.constant=!1,this.value=e;let{buffer:s}=this;const r=Wp(i),o=(i.vertexOffset||0)*r;if(this.doublePrecision&&e instanceof Float64Array&&(e=Mu(e,i)),this.settings.isIndexed){const t=this.settings.defaultType;e.constructor!==t&&(e=new t(e))}const a=e.byteLength+o+2*r;(!s||s.byteLength<a)&&(s=this._createBuffer(a)),s.write(e,o)}return this.setAccessor(i),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:n=0,endOffset:i}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?Mu(t,{size:this.size,startIndex:n,endIndex:i}):t.subarray(n,i),n*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:n}=this,i=n.allocatedValue,s=Pu.allocate(i,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=s;const{byteOffset:r}=this;let{buffer:o}=this;return(!o||o.byteLength<s.byteLength+r)&&(o=this._createBuffer(s.byteLength+r),t&&i&&o.write(i instanceof Float64Array?Mu(i,this):i,r)),n.allocatedValue=s,n.constant=!1,n.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const n=this.settings.defaultType;let i=!1;if(this.doublePrecision&&(i=t.BYTES_PER_ELEMENT<4),i)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);t instanceof n||!this.settings.normalized||"normalized"in e||ln.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map((e=>(e+128)/255*2-1));case"snorm16":return new Float32Array(e).map((e=>(e+32768)/65535*2-1));case"unorm8":return new Float32Array(e).map((e=>e/255));case"unorm16":return new Float32Array(e).map((e=>e/65535));default:return e}}_normalizeValue(e,t,n){const{defaultValue:i,size:s}=this.settings;if(Number.isFinite(e))return t[n]=e,t;if(!e){let e=s;for(;--e>=0;)t[n+e]=i[e];return t}switch(s){case 4:t[n+3]=Number.isFinite(e[3])?e[3]:i[3];case 3:t[n+2]=Number.isFinite(e[2])?e[2]:i[2];case 2:t[n+1]=Number.isFinite(e[1])?e[1]:i[1];case 1:t[n+0]=Number.isFinite(e[0])?e[0]:i[0];break;default:let r=s;for(;--r>=0;)t[n+r]=Number.isFinite(e[r])?e[r]:i[r]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:n}=this;for(let i=0;i<n;i++)if(e[i]!==t[i])return!1;return!0}_createBuffer(e){var t;this._buffer&&this._buffer.destroy();const{isIndexed:n,type:i}=this.settings;return this._buffer=this.device.createBuffer({...null==(t=this._buffer)?void 0:t.props,id:this.id,usage:(n?ni.INDEX:ni.VERTEX)|ni.COPY_DST,indexType:n?i:void 0,byteLength:e}),this._buffer}}const $p=[],Xp=[];function Yp(e,t=0,n=1/0){let i=$p;const s={index:-1,data:e,target:[]};return e?"function"==typeof e[Symbol.iterator]?i=e:e.length>0&&(Xp.length=e.length,i=Xp):i=$p,(t>0||Number.isFinite(n))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(t,n),s.index=t-1),{iterable:i,objectInfo:s}}function Kp(e){return e&&e[Symbol.asyncIterator]}function qp(e,t){const{size:n,stride:i,offset:s,startIndices:r,nested:o}=t,a=e.BYTES_PER_ELEMENT,l=i?i/a:n,c=s?s/a:0,u=Math.floor((e.length-c)/l);return(t,{index:i,target:s})=>{if(!r){const t=i*l+c;for(let i=0;i<n;i++)s[i]=e[t+i];return s}const a=r[i],h=r[i+1]||u;let d;if(o){d=new Array(h-a);for(let t=a;t<h;t++){const i=t*l+c;s=new Array(n);for(let t=0;t<n;t++)s[t]=e[i+t];d[t-a]=s}}else if(l===n)d=e.subarray(a*n+c,h*n+c);else{d=new e.constructor((h-a)*n);let t=0;for(let i=a;i<h;i++){const s=i*l+c;for(let i=0;i<n;i++)d[t++]=e[s+i]}}return d}}const Zp=[],Qp=[[0,1/0]];const Jp={interpolation:{duration:0,easing:e=>e},spring:{stiffness:.05,damping:.5}};function eg(e,t){if(!e)return null;Number.isFinite(e)&&(e={type:"interpolation",duration:e});const n=e.type||"interpolation";return{...Jp[n],...t,...e,type:n}}class tg extends Hp{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Qp}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t,n,i;(t=this.state).layoutChanged||(t.layoutChanged=(n=e,i=this.getAccessor(),!(n.type===i.type&&n.size===i.size&&Wp(n)===Wp(i)&&(n.offset||0)===(i.offset||0)))),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat("function"!=typeof e&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,n=this.settings.transition;return eg(Array.isArray(t)?e[t.find((t=>e[t]))]:e[t],n)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:e=0,endRow:n=1/0}=t;this.state.updateRanges=function(e,t){if(e===Qp)return e;if(t[0]<0&&(t[0]=0),t[0]>=t[1])return e;const n=[],i=e.length;let s=0;for(let r=0;r<i;r++){const i=e[r];i[1]<t[0]?(n.push(i),s=r+1):i[0]>t[1]?n.push(i):t=[Math.min(i[0],t[0]),Math.max(i[1],t[1])]}return n.splice(s,0,t),n}(this.state.updateRanges,[e,n])}else this.state.updateRanges=Qp}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=Zp}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:n}=this;return!n.noAlloc&&(!!n.update&&(super.allocate(e,t.updateRanges!==Qp),!0))}updateBuffer({numInstances:e,data:t,props:n,context:i}){if(!this.needsUpdate())return!1;const{state:{updateRanges:s},settings:{update:r,noAlloc:o}}=this;let a=!0;if(r){for(const[o,a]of s)r.call(i,this,{data:t,startRow:o,endRow:a,props:n,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[t,n]of s){const i=Number.isFinite(t)?this.getVertexOffset(t):0,s=Number.isFinite(n)?this.getVertexOffset(n):o||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:i,endOffset:s})}else;this._checkAttributeArray()}else a=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),a}setConstantValue(e){if("webgpu"===this.device.type||void 0===e||"function"==typeof e)return!1;return this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:n,settings:i}=this;if(!e)return n.binaryValue=null,n.binaryAccessor=null,!1;if(i.noAlloc)return!1;if(n.binaryValue===e)return this.clearNeedsUpdate(),!0;n.binaryValue=e,this.setNeedsRedraw();if(i.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const s=e;nd(ArrayBuffer.isView(s.value),`invalid ${i.accessor}`);const r=Boolean(s.size)&&s.size!==this.size;return n.binaryAccessor=qp(s.value,{size:s.size||this.size,stride:s.stride,offset:s.offset,startIndices:t,nested:r}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const n in e)Object.assign(t,super.getValue(n,e[n]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,n=super._getBufferLayout(),{stepMode:i}=this.settings;if(n.stepMode="dynamic"===i?e?e.isInstanced?"instance":"vertex":"instance":i??"vertex",!t)return n;for(const s in t){const e=super._getBufferLayout(s,t[s]);n.attributes.push(...e.attributes)}return n}_autoUpdater(e,{data:t,startRow:n,endRow:i,props:s,numInstances:r}){if(e.constant&&"webgpu"!==this.context.device.type)return;const{settings:o,state:a,value:l,size:c,startIndices:u}=e,{accessor:h,transform:d}=o;let f=a.binaryAccessor||("function"==typeof h?h:s[h]);"function"!=typeof f&&(f=()=>f),nd("function"==typeof f,`accessor "${h}" is not a function`);let p=e.getVertexOffset(n);const{iterable:g,objectInfo:m}=Yp(t,n,i);for(const _ of g){m.index++;let t=f(_,m);if(d&&(t=d.call(this,t)),u){const n=(m.index<u.length-1?u[m.index+1]:r)-u[m.index];if(t&&Array.isArray(t[0])){let n=p;for(const i of t)e._normalizeValue(i,l,n),n+=c}else t&&t.length>c?l.set(t,p):(e._normalizeValue(t,m.target,0),Uh({target:l,source:m.target,start:p,count:n}));p+=n*c}else e._normalizeValue(t,l,p),p+=c}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||"function"==typeof e.update))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let n=!0;switch(t){case 4:n=n&&Number.isFinite(e[3]);case 3:n=n&&Number.isFinite(e[2]);case 2:n=n&&Number.isFinite(e[1]);case 1:n=n&&Number.isFinite(e[0]);break;default:n=!1}if(!n)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function ng(e){const{source:t,target:n,start:i=0,size:s,getData:r}=e,o=e.end||n.length,a=t.length,l=o-i;if(a>l)return void n.set(t.subarray(0,l),i);if(n.set(t,i),!r)return;let c=a;for(;c<l;){const e=r(c,t);for(let t=0;t<s;t++)n[i+c]=e[t]||0,c++}}function ig(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${e}"`)}}function sg(e){switch(e){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function rg(e){e.push(e.shift())}function og({device:e,source:t,target:n}){return(!n||n.byteLength<t.byteLength)&&(null==n||n.destroy(),n=e.createBuffer({byteLength:t.byteLength,usage:t.usage})),n}function ag({device:e,buffer:t,attribute:n,fromLength:i,toLength:s,fromStartIndices:r,getData:o=e=>e}){const a=n.doublePrecision&&n.value instanceof Float64Array?2:1,l=n.size*a,c=n.byteOffset,u=n.settings.bytesPerElement<4?c/n.settings.bytesPerElement*4:c,h=n.startIndices,d=r&&h,f=n.isConstant;if(!d&&t&&i>=s)return t;const p=n.value instanceof Float64Array?Float32Array:n.value.constructor,g=f?n.value:new p(n.getBuffer().readSyncWebGL(c,s*p.BYTES_PER_ELEMENT).buffer);if(n.settings.normalized&&!f){const e=o;o=(t,i)=>n.normalizeConstant(e(t,i))}const m=f?(e,t)=>o(g,t):(e,t)=>o(g.subarray(e+c,e+c+l),t),_=t?new Float32Array(t.readSyncWebGL(u,4*i).buffer):new Float32Array(0),y=new Float32Array(s);return function({source:e,target:t,size:n,getData:i,sourceStartIndices:s,targetStartIndices:r}){if(!s||!r)return ng({source:e,target:t,size:n,getData:i}),t;let o=0,a=0;const l=i&&((e,t)=>i(e+a,t)),c=Math.min(s.length,r.length);for(let u=1;u<c;u++){const i=s[u]*n,c=r[u]*n;ng({source:e.subarray(o,i),target:t,start:a,end:c,size:n,getData:l}),o=i,a=c}a<t.length&&ng({source:[],target:t,start:a,size:n,getData:l})}({source:_,target:y,sourceStartIndices:r,targetStartIndices:h,size:l,getData:m}),(!t||t.byteLength<y.byteLength+u)&&(null==t||t.destroy(),t=e.createBuffer({byteLength:y.byteLength+u,usage:35050})),t.write(y,u),t}class lg{constructor({device:e,attribute:t,timeline:n}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new Kh(n),this.attribute=t,this.attributeInTransition=function(e){const{device:t,settings:n,value:i}=e,s=new tg(t,n);return s.setData({value:i instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:n.normalized}),s}(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,n=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=function(e,t){const{doublePrecision:n,settings:i,value:s,size:r}=e,o=n&&s instanceof Float64Array?2:1;let a=0;const{shaderAttributes:l}=e.settings;if(l)for(const c of Object.values(l))a=Math.max(a,c.vertexOffset??0);return(i.noAlloc?s.length:(t+a)*r)*o}(this.attribute,t),this.transition.start({...e,duration:n})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}const cg={name:"interpolation",vs:"uniform interpolationUniforms {\n  float time;\n} interpolation;\n",uniformTypes:{time:"f32"}},ug="#version 300 es\n#define SHADER_NAME interpolation-transition-vertex-shader\n\nin ATTRIBUTE_TYPE aFrom;\nin ATTRIBUTE_TYPE aTo;\nout ATTRIBUTE_TYPE vCurrent;\n\nvoid main(void) {\n  vCurrent = mix(aFrom, aTo, interpolation.time);\n  gl_Position = vec4(0.0);\n}\n",hg="#version 300 es\n#define SHADER_NAME interpolation-transition-vertex-shader\n\nin ATTRIBUTE_TYPE aFrom;\nin ATTRIBUTE_TYPE aFrom64Low;\nin ATTRIBUTE_TYPE aTo;\nin ATTRIBUTE_TYPE aTo64Low;\nout ATTRIBUTE_TYPE vCurrent;\nout ATTRIBUTE_TYPE vCurrent64Low;\n\nvec2 mix_fp64(vec2 a, vec2 b, float x) {\n  vec2 range = sub_fp64(b, a);\n  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));\n}\n\nvoid main(void) {\n  for (int i=0; i<ATTRIBUTE_SIZE; i++) {\n    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);\n    vCurrent[i] = value.x;\n    vCurrent64Low[i] = value.y;\n  }\n  gl_Position = vec4(0.0);\n}\n";function dg(e){return e.doublePrecision&&e.value instanceof Float64Array}const fg={name:"spring",vs:"uniform springUniforms {\n  float damping;\n  float stiffness;\n} spring;\n",uniformTypes:{damping:"f32",stiffness:"f32"}},pg="#version 300 es\n#define SHADER_NAME spring-transition-vertex-shader\n\n#define EPSILON 0.00001\n\nin ATTRIBUTE_TYPE aPrev;\nin ATTRIBUTE_TYPE aCur;\nin ATTRIBUTE_TYPE aTo;\nout ATTRIBUTE_TYPE vNext;\nout float vIsTransitioningFlag;\n\nATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {\n  ATTRIBUTE_TYPE velocity = cur - prev;\n  ATTRIBUTE_TYPE delta = dest - cur;\n  ATTRIBUTE_TYPE force = delta * spring.stiffness;\n  ATTRIBUTE_TYPE resistance = velocity * spring.damping;\n  return force - resistance + velocity + cur;\n}\n\nvoid main(void) {\n  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;\n  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;\n\n  vNext = getNextValue(aCur, aPrev, aTo);\n  gl_Position = vec4(0, 0, 0, 1);\n  gl_PointSize = 100.0;\n}\n",gg="#version 300 es\n#define SHADER_NAME spring-transition-is-transitioning-fragment-shader\n\nin float vIsTransitioningFlag;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  if (vIsTransitioningFlag == 0.0) {\n    discard;\n  }\n  fragColor = vec4(1.0);\n}";const mg={interpolation:class extends lg{constructor({device:e,attribute:t,timeline:n}){super({device:e,attribute:t,timeline:n}),this.type="interpolation",this.transform=function(e,t){const n=t.size,i=ig(n),s=sg(n),r=t.getBufferLayout();if(dg(t))return new bh(e,{vs:hg,bufferLayout:[{name:"aFrom",byteStride:8*n,attributes:[{attribute:"aFrom",format:s,byteOffset:0},{attribute:"aFrom64Low",format:s,byteOffset:4*n}]},{name:"aTo",byteStride:8*n,attributes:[{attribute:"aTo",format:s,byteOffset:0},{attribute:"aTo64Low",format:s,byteOffset:4*n}]}],modules:[Da,cg],defines:{ATTRIBUTE_TYPE:i,ATTRIBUTE_SIZE:n},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0});return new bh(e,{vs:ug,bufferLayout:[{name:"aFrom",format:s},{name:"aTo",format:r.attributes[0].format}],modules:[cg],defines:{ATTRIBUTE_TYPE:i},varyings:["vCurrent"],disableWarnings:!0})}(e,t)}start(e,t){const n=this.currentLength,i=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0)return void this.transition.cancel();const{buffers:s,attribute:r}=this;rg(s),s[0]=ag({device:this.device,buffer:s[0],attribute:r,fromLength:n,toLength:this.currentLength,fromStartIndices:i,getData:e.enter}),s[1]=og({device:this.device,source:s[0],target:s[1]}),this.setBuffer(s[1]);const{transform:o}=this,a=o.model;let l=Math.floor(this.currentLength/r.size);dg(r)&&(l/=2),a.setVertexCount(l),r.isConstant?(a.setAttributes({aFrom:s[0]}),a.setConstantAttributes({aTo:r.value})):a.setAttributes({aFrom:s[0],aTo:r.getBuffer()}),o.transformFeedback.setBuffers({vCurrent:s[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:n}=this.transition;let i=n/e;t&&(i=t(i));const{model:s}=this.transform,r={time:i};s.shaderInputs.setProps({interpolation:r}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}},spring:class extends lg{constructor({device:e,attribute:t,timeline:n}){super({device:e,attribute:t,timeline:n}),this.type="spring",this.texture=function(e){return e.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}(e),this.framebuffer=function(e,t){return e.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[t]})}(e,this.texture),this.transform=function(e,t){const n=ig(t.size),i=sg(t.size);return new bh(e,{vs:pg,fs:gg,bufferLayout:[{name:"aPrev",format:i},{name:"aCur",format:i},{name:"aTo",format:t.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[fg],defines:{ATTRIBUTE_TYPE:n},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}(e,t)}start(e,t){const n=this.currentLength,i=this.currentStartIndices;super.start(e,t);const{buffers:s,attribute:r}=this;for(let a=0;a<2;a++)s[a]=ag({device:this.device,buffer:s[a],attribute:r,fromLength:n,toLength:this.currentLength,fromStartIndices:i,getData:e.enter});s[2]=og({device:this.device,source:s[0],target:s[2]}),this.setBuffer(s[1]);const{model:o}=this.transform;o.setVertexCount(Math.floor(this.currentLength/r.size)),r.isConstant?o.setConstantAttributes({aTo:r.value}):o.setAttributes({aTo:r.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:n,transition:i}=this,s=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const r={stiffness:s.stiffness,damping:s.damping};t.model.shaderInputs.setProps({spring:r}),t.run({framebuffer:n,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),rg(e),this.setBuffer(e[1]);this.device.readPixelsToArrayWebGL(n)[0]>0||i.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}};class _g{constructor(e,{id:t,timeline:n}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=n,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:n}){this.numInstances=n||1;for(const i in e){const n=e[i],s=n.getTransitionSetting(t);s&&this._updateAttribute(i,n,s)}for(const i in this.transitions){const n=e[i];n&&n.getTransitionSetting(t)||this._removeTransition(i)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const n=this.transitions[t];n.inProgress&&(e[t]=n.attributeInTransition)}return e}run(){if(0===this.numInstances)return!1;for(const t in this.transitions){this.transitions[t].update()&&(this.needsRedraw=!0)}const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,n){const i=this.transitions[e];let s=!i||i.type!==n.type;if(s){i&&this._removeTransition(e);const r=mg[n.type];r?this.transitions[e]=new r({attribute:t,timeline:this.timeline,device:this.device}):(ln.error(`unsupported transition type '${n.type}'`)(),s=!1)}(s||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(n,this.numInstances))}}const yg="attributeManager.invalidate";class vg{constructor(e,{id:t="attribute-manager",stats:n,timeline:i}={}){this.mergeBoundsMemoized=oc(ku),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=n,this.attributeTransitionManager=new _g(e,{id:`${t}-transitions`,timeline:i}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)void 0!==this.attributes[t]&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const n=this._invalidateTrigger(e,t);hn(yg,this,e,n)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);hn(yg,this,"all")}update({data:e,numInstances:t,startIndices:n=null,transitions:i,props:s={},buffers:r={},context:o={}}){let a=!1;hn("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const l in this.attributes){const i=this.attributes[l],c=i.settings.accessor;i.startIndices=n,i.numInstances=t,s[l]&&ln.removed(`props.${l}`,`data.attributes.${l}`)(),i.setExternalBuffer(r[l])||i.setBinaryValue("string"==typeof c?r[c]:void 0,e.startIndices)||"string"==typeof c&&!r[c]&&i.setConstantValue(s[c])||i.needsUpdate()&&(a=!0,this._updateAttribute({attribute:i,numInstances:t,data:e,props:s,context:o})),this.needsRedraw=this.needsRedraw||i.needsRedraw()}a&&hn("attributeManager.updateEnd",this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:i})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map((e=>{var t;return null==(t=this.attributes[e])?void 0:t.getBounds()}));return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:n}=this,i={...n.getAttributes()};for(const s in t){const r=t[s];r.needsRedraw(e)&&!n.hasAttribute(s)&&(i[s]=r)}return i}getBufferLayouts(e){return Object.values(this.getAttributes()).map((t=>t.getBufferLayout(e)))}_add(e,t){for(const n in e){const i=e[n],s={...i,id:n,size:(i.isIndexed?1:i.size)||1,...t};this.attributes[n]=new tg(this.device,s)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes){this.attributes[t].getUpdateTriggers().forEach((n=>{e[n]||(e[n]=[]),e[n].push(t)}))}this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:n,updateTriggers:i}=this,s=i[e];return s&&s.forEach((e=>{const i=n[e];i&&i.setNeedsUpdate(i.id,t)})),s}_updateAttribute(e){const{attribute:t,numInstances:n}=e;if(hn("attribute.updateStart",t),t.constant)return void t.setConstantValue(t.value);t.allocate(n)&&hn("attribute.allocate",t,n);t.updateBuffer(e)&&(this.needsRedraw=!0,hn("attribute.updateEnd",t,n))}}const bg=1e-5;function Eg(e,t,n,i,s){const r=t-e;return(n-t)*s+-r*i+r+t}function xg(e,t){if(Array.isArray(e)){let n=0;for(let i=0;i<e.length;i++){const s=e[i]-t[i];n+=s*s}return Math.sqrt(n)}return Math.abs(e-t)}const wg={interpolation:class extends Kh{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:n,duration:i,easing:s}}=this,r=s(e/i);this._value=Zo(t,n,r)}},spring:class extends Kh{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:n,stiffness:i}=this.settings,{_prevValue:s=e,_currValue:r=e}=this;let o=function(e,t,n,i,s){if(Array.isArray(n)){const r=[];for(let o=0;o<n.length;o++)r[o]=Eg(e[o],t[o],n[o],i,s);return r}return Eg(e,t,n,i,s)}(s,r,t,n,i);const a=xg(o,t),l=xg(o,r);a<bg&&l<bg&&(o=t,this.end()),this._prevValue=r,this._currValue=o}}};class Tg{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,n,i){const{transitions:s}=this;if(s.has(e)){const n=s.get(e),{value:i=n.settings.fromValue}=n;t=i,this.remove(e)}if(!(i=eg(i)))return;const r=wg[i.type];if(!r)return void ln.error(`unsupported transition type '${i.type}'`)();const o=new r(this.timeline);o.start({...i,fromValue:t,toValue:n}),s.set(e,o)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,n]of this.transitions)n.update(),e[t]=n.value,n.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function Ag(e,t){const n=Rg({newProps:e,oldProps:t,propTypes:e[Mh],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=function(e,t){if(null===t)return"oldProps is null, initial diff";let n=!1;const{dataComparator:i,_dataDiff:s}=e;i?i(e.data,t.data)||(n="Data comparator detected a change"):e.data!==t.data&&(n="A new data container was supplied");n&&s&&(n=s(e.data,t.data)||n);return n}(e,t);let s=!1;return i||(s=function(e,t){if(null===t)return{all:!0};if("all"in e.updateTriggers){if(Ig(e,t,"all"))return{all:!0}}const n={};let i=!1;for(const s in e.updateTriggers)if("all"!==s){Ig(e,t,s)&&(n[s]=!0,i=!0)}return!!i&&n}(e,t)),{dataChanged:i,propsChanged:n,updateTriggersChanged:s,extensionsChanged:Cg(e,t),transitionsChanged:Sg(e,t)}}function Sg(e,t){if(!e.transitions)return!1;const n={},i=e[Mh];let s=!1;for(const r in e.transitions){const o=i[r],a=o&&o.type;("number"===a||"color"===a||"array"===a)&&Pg(e[r],t[r],o)&&(n[r]=!0,s=!0)}return!!s&&n}function Rg({newProps:e,oldProps:t,ignoreProps:n={},propTypes:i={},triggerName:s="props"}){if(t===e)return!1;if("object"!=typeof e||null===e)return`${s} changed shallowly`;if("object"!=typeof t||null===t)return`${s} changed shallowly`;for(const r of Object.keys(e))if(!(r in n)){if(!(r in t))return`${s}.${r} added`;const n=Pg(e[r],t[r],i[r]);if(n)return`${s}.${r} ${n}`}for(const r of Object.keys(t))if(!(r in n)){if(!(r in e))return`${s}.${r} dropped`;if(!Object.hasOwnProperty.call(e,r)){const n=Pg(e[r],t[r],i[r]);if(n)return`${s}.${r} ${n}`}}return!1}function Pg(e,t,n){let i=n&&n.equal;return i&&!i(e,t,n)?"changed deeply":i||(i=e&&t&&e.equals,!i||i.call(e,t))?i||t===e?null:"changed shallowly":"changed deeply"}function Cg(e,t){if(null===t)return!0;const n=t.extensions,{extensions:i}=e;if(i===n)return!1;if(!n||!i)return!0;if(i.length!==n.length)return!0;for(let s=0;s<i.length;s++)if(!i[s].equals(n[s]))return!0;return!1}function Ig(e,t,n){let i=e.updateTriggers[n];i=null==i?{}:i;let s=t.updateTriggers[n];s=null==s?{}:s;return Rg({oldProps:s,newProps:i,triggerName:n})}function Lg(e){if(null===(t=e)||"object"!=typeof t)throw new Error("count(): argument not an object");var t;if("function"==typeof e.count)return e.count();if(Number.isFinite(e.size))return e.size;if(Number.isFinite(e.length))return e.length;if(function(e){return null!==e&&"object"==typeof e&&e.constructor===Object}(e))return Object.keys(e).length;throw new Error("count(): argument not a container")}function Mg(e,t){if(!t)return e;const n={...e,...t};if("defines"in t&&(n.defines={...e.defines,...t.defines}),"modules"in t&&(n.modules=(e.modules||[]).concat(t.modules),t.modules.some((e=>"project64"===e.name)))){const e=n.modules.findIndex((e=>"project32"===e.name));e>=0&&n.modules.splice(e,1)}if("inject"in t)if(e.inject){const i={...e.inject};for(const e in t.inject)i[e]=(i[e]||"")+t.inject[e];n.inject=i}else n.inject=t.inject;return n}const kg={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},Og={};const Ng={boolean:{validate:(e,t)=>!0,equal:(e,t,n)=>Boolean(e)===Boolean(t)},number:{validate:(e,t)=>Number.isFinite(e)&&(!("max"in t)||e<=t.max)&&(!("min"in t)||e>=t.min)},color:{validate:(e,t)=>t.optional&&!e||Dg(e)&&(3===e.length||4===e.length),equal:(e,t,n)=>Wh(e,t,1)},accessor:{validate(e,t){const n=Ug(e);return"function"===n||n===Ug(t.value)},equal:(e,t,n)=>"function"==typeof t||Wh(e,t,1)},array:{validate:(e,t)=>t.optional&&!e||Dg(e),equal(e,t,n){const{compare:i}=n,s=Number.isInteger(i)?i:i?1:0;return i?Wh(e,t,s):e===t}},object:{equal(e,t,n){if(n.ignore)return!0;const{compare:i}=n,s=Number.isInteger(i)?i:i?1:0;return i?Wh(e,t,s):e===t}},function:{validate:(e,t)=>t.optional&&!e||"function"==typeof e,equal:(e,t,n)=>!n.compare&&!1!==n.ignore||e===t},data:{transform:(e,t,n)=>{if(!e)return e;const{dataTransform:i}=n.props;return i?i(e):"string"==typeof e.shape&&e.shape.endsWith("-table")&&Array.isArray(e.data)?e.data:e}},image:{transform:(e,t,n)=>{const i=n.context;return i&&i.device?function(e,t,n,i){if(n instanceof Di)return n;n.constructor&&"Object"!==n.constructor.name&&(n={data:n});let s=null;n.compressed&&(s={minFilter:"linear",mipmapFilter:n.data.length>1?"nearest":"linear"});const r=t.createTexture({...n,sampler:{...kg,...s,...i},mipmaps:!0});return Og[r.id]=e,r}(n.id,i.device,e,{...t.parameters,...n.props.textureParameters}):null},release:(e,t,n)=>{var i,s;i=n.id,(s=e)&&s instanceof Di&&Og[s.id]===i&&(s.delete(),delete Og[s.id])}}};function Fg(e,t){switch(Ug(t)){case"object":return Bg(e,t);case"array":return Bg(e,{type:"array",value:t,compare:!1});case"boolean":return Bg(e,{type:"boolean",value:t});case"number":return Bg(e,{type:"number",value:t});case"function":return Bg(e,{type:"function",value:t,compare:!0});default:return{name:e,type:"unknown",value:t}}}function Bg(e,t){return"type"in t?{name:e,...Ng[t.type],...t}:"value"in t?{name:e,type:Ug(t.value),...t}:{name:e,type:"object",value:t}}function Dg(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function Ug(e){return Dg(e)?"array":null===e?"null":typeof e}const Gg="_mergedDefaultProps";function zg(e,t){if(!(e instanceof Xg.constructor))return{};let n=Gg;if(t)for(const s of t){const e=s.constructor;e&&(n+=`:${e.extensionName||e.name}`)}const i=jg(e,n);return i||(e[n]=function(e,t){const n=e.prototype;if(!n)return null;const i=Object.getPrototypeOf(e),s=zg(i),r=jg(e,"defaultProps")||{},o=function(e){const t={},n={},i={};for(const[s,r]of Object.entries(e)){const e=null==r?void 0:r.deprecatedFor;if(e)i[s]=Array.isArray(e)?e:[e];else{const e=Fg(s,r);t[s]=e,n[s]=e.value}}return{propTypes:t,defaultProps:n,deprecatedProps:i}}(r),a=Object.assign(Object.create(null),s,o.defaultProps),l=Object.assign(Object.create(null),null==s?void 0:s[Mh],o.propTypes),c=Object.assign(Object.create(null),null==s?void 0:s[kh],o.deprecatedProps);for(const u of t){const e=zg(u.constructor);e&&(Object.assign(a,e),Object.assign(l,e[Mh]),Object.assign(c,e[kh]))}(function(e,t){const n=function(e){const t=e.componentName;t||ln.warn(`${e.name}.componentName not specified`)();return t||e.name}(t);Object.defineProperties(e,{id:{writable:!0,value:n}})})(a,e),function(e,t){const n={},i={};for(const s in t){const e=t[s],{name:r,value:o}=e;e.async&&(n[r]=o,i[r]=Vg(r))}e[Oh]=n,e[Nh]={},Object.defineProperties(e,i)}(a,l),function(e,t){for(const n in t)Object.defineProperty(e,n,{enumerable:!1,set(e){const i=`${this.id}: ${n}`;for(const s of t[n])Wg(this,s)||(this[s]=e);ln.deprecated(i,t[n].join("/"))()}})}(a,c),a[Mh]=l,a[kh]=c,0!==t.length||Wg(e,"_propTypes")||(e._propTypes=l);return a}(e,t||[]))}function Vg(e){return{enumerable:!0,set(t){"string"==typeof t||t instanceof Promise||Kp(t)?this[Nh][e]=t:this[Fh][e]=t},get(){if(this[Fh]){if(e in this[Fh]){return this[Fh][e]||this[Oh][e]}if(e in this[Nh]){const t=this[Lh]&&this[Lh].internalState;if(t&&t.hasAsyncProp(e))return t.getAsyncProp(e)||this[Oh][e]}}return this[Oh][e]}}}function Wg(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function jg(e,t){return Wg(e,t)&&e[t]}let Hg=0;class $g{constructor(...e){this.props=function(e,t){let n;for(let r=t.length-1;r>=0;r--){const e=t[r];"extensions"in e&&(n=e.extensions)}const i=zg(e.constructor,n),s=Object.create(i);s[Lh]=e,s[Nh]={},s[Fh]={};for(let r=0;r<t.length;++r){const e=t[r];for(const t in e)s[t]=e[t]}return Object.freeze(s),s}(this,e),this.id=this.props.id,this.count=Hg++}clone(e){const{props:t}=this,n={};for(const i in t[Oh])i in t[Fh]?n[i]=t[Fh][i]:i in t[Nh]&&(n[i]=t[Nh][i]);return new this.constructor({...t,...n,...e})}}$g.componentName="Component",$g.defaultProps={};const Xg=$g,Yg=Object.freeze({});class Kg{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||Yg}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[Lh]||this.component;const t=e[Fh]||{},n=e[Nh]||e,i=e[Oh]||{};for(const s in t){const e=t[s];this._createAsyncPropData(s,i[s]),this._updateAsyncProp(s,e),t[s]=this.getAsyncProp(s)}for(const s in n){const e=n[s];this._createAsyncPropData(s,i[s]),this._updateAsyncProp(s,e)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){this._didAsyncInputValueChange(e,t)&&("string"==typeof t&&(t=this._fetch(e,t)),t instanceof Promise?this._watchPromise(e,t):Kp(t)?this._resolveAsyncIterable(e,t):this._setPropValue(e,t))}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const n=this.asyncProps[e];return t!==n.resolvedValue&&t!==n.lastValue&&(n.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const n=this.asyncProps[e];n&&(t=this._postProcessValue(n,t),n.resolvedValue=t,n.pendingLoadCount++,n.resolvedLoadCount=n.pendingLoadCount)}_setAsyncPropValue(e,t,n){const i=this.asyncProps[e];i&&n>=i.resolvedLoadCount&&void 0!==t&&(this._freezeAsyncOldProps(),i.resolvedValue=t,i.resolvedLoadCount=n,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const n=this.asyncProps[e];if(n){n.pendingLoadCount++;const i=n.pendingLoadCount;t.then((t=>{this.component&&(t=this._postProcessValue(n,t),this._setAsyncPropValue(e,t,i),this._onResolve(e,t))})).catch((t=>{this._onError(e,t)}))}}async _resolveAsyncIterable(e,t){if("data"!==e)return void this._setPropValue(e,t);const n=this.asyncProps[e];if(!n)return;n.pendingLoadCount++;const i=n.pendingLoadCount;let s=[],r=0;for await(const o of t){if(!this.component)return;const{dataTransform:t}=this.component.props;s=t?t(o,s):s.concat(o),Object.defineProperty(s,"__diff",{enumerable:!1,value:[{startRow:r,endRow:s.length}]}),r=s.length,this._setAsyncPropValue(e,s,i)}this._onResolve(e,s)}_postProcessValue(e,t){const n=e.type;return n&&this.component&&(n.release&&n.release(e.resolvedValue,n,this.component),n.transform)?n.transform(t,n,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const n=this.component&&this.component.props[Mh];this.asyncProps[e]={type:n&&n[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class qg extends Kg{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const n=this.layer,i=null==n?void 0:n.props.fetch;return i?i(t,{propName:e,layer:n}):super._fetch(e,t)}_onResolve(e,t){const n=this.layer;if(n){const i=n.props.onDataLoad;"data"===e&&i&&i(t,{propName:e,layer:n})}}_onError(e,t){const n=this.layer;n&&n.raiseError(t,`loading ${e} of ${this.layer}`)}}const Zg=2**24-1,Qg=Object.freeze([]),Jg=oc((({oldViewport:e,viewport:t})=>e.equals(t)));let em=new Uint8ClampedArray(0);const tm={data:{type:"data",value:Qg,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:e=>e&&e.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(e,{propName:t,layer:n,loaders:i,loadOptions:s,signal:r})=>{const{resourceManager:o}=n.context;s=s||n.getLoadOptions(),i=i||n.props.loaders,r&&(s={...s,fetch:{...null==s?void 0:s.fetch,signal:r}});let a=o.contains(e);return a||s||(o.add({resourceId:e,data:Gt(e,i),persistent:!1}),a=!0),a?o.subscribe({resourceId:e,onChange:e=>{var i;return null==(i=n.internalState)?void 0:i.reloadAsyncProp(t,e)},consumerId:n.id,requestId:t}):Gt(e,i,s)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:ec.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:e})=>[0,100*-e]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class nm extends Xg{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Ah,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){nd(this.internalState);const t=this.internalState.viewport||this.context.viewport,n=ju(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[i,s,r]=Wc(n,t.pixelProjectionMatrix);return 2===e.length?[i,s]:[i,s,r]}unproject(e){nd(this.internalState);return(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){nd(this.internalState);return Hu(e,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===ec.DEFAULT||e===ec.LNGLAT||e===ec.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){nd(e instanceof Uint8Array);const[t,n,i]=e;return t+256*n+65536*i-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&void 0!==this.state.numInstances?this.state.numInstances:Lg(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return null==(e=this.getAttributeManager())?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){e=Mg(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=Mg(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:n}=e.changeFlags;if(n&&t)if(Array.isArray(n))for(const i of n)t.invalidateAll(i);else t.invalidateAll();if(t){const{props:n}=e,i=this.internalState.hasPickingBuffer,s=Number.isInteger(n.highlightedObjectIndex)||n.pickable||n.extensions.some((e=>e.getNeedsPickingBuffer.call(this,e)));if(i!==s){this.internalState.hasPickingBuffer=s;const{pickingColors:e,instancePickingColors:n}=t.attributes,i=e||n;i&&(s&&i.constant&&(i.constant=!1,t.invalidate(i.id)),i.value||s||(i.constant=!0,i.value=[0,0,0]))}}}finalizeState(e){for(const n of this.getModels())n.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:n}){const{index:i}=e;return i>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[i]),e}raiseError(e,t){var n,i,s,r;t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),(null==(i=(n=this.props).onError)?void 0:i.call(n,e))||null==(r=null==(s=this.context)?void 0:s.onError)||r.call(s,e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){var e;return(null==(e=this.internalState)?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,t&&Jg({oldViewport:t,viewport:e})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&("all"===e?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const n in e)e[n].layoutChanged()&&(t=!0);for(const n of this.getModels())this._setModelAttributes(n,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,n=this.getNumInstances(),i=this.getStartIndices();e.update({data:t.data,numInstances:n,startIndices:i,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const s=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(s)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),n=Object.create(this.props);for(const e in t)Object.defineProperty(n,e,{value:t[e]});return n}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const n=Math.floor(em.length/4);if(this.internalState.usesPickingColorCache=!0,n<t){t>Zg&&ln.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),em=Pu.allocate(em,t,{size:4,copy:!0,maxCount:Math.max(t,Zg)});const e=Math.floor(em.length/4),i=[0,0,0];for(let t=n;t<e;t++)this.encodePickingColor(t,i),em[4*t+0]=i[0],em[4*t+1]=i[1],em[4*t+2]=i[2],em[4*t+3]=0}e.value=em.subarray(0,4*t)}_setModelAttributes(e,t,n=!1){var i;if(!Object.keys(t).length)return;if(n){const n=this.getAttributeManager();e.setBufferLayout(n.getBufferLayouts(e)),t=n.getAttributes()}const s=(null==(i=e.userData)?void 0:i.excludeAttributes)||{},r={},o={};for(const a in t){if(s[a])continue;const n=t[a].getValue();for(const i in n){const s=n[i];s instanceof ni?t[a].settings.isIndexed?e.setIndexBuffer(s):r[i]=s:s&&(o[i]=s)}}e.setAttributes(r),e.setConstantAttributes(o)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t))return void this._disablePickingIndex(e);const{pickingColors:n,instancePickingColors:i}=this.getAttributeManager().attributes,s=n||i,r=s&&t.attributes&&t.attributes[s.id];if(r&&r.value){const n=r.value,i=this.encodePickingColor(e);for(let e=0;e<t.length;e++){const t=s.getVertexOffset(e);n[t]===i[0]&&n[t+1]===i[1]&&n[t+2]===i[2]&&this._disablePickingIndex(e)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:n}=this.getAttributeManager().attributes,i=t||n;if(!i)return;const s=i.getVertexOffset(e),r=i.getVertexOffset(e+1);i.buffer.write(new Uint8Array(r-s),s)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,n=e||t;n&&(this.internalState.usesPickingColorCache&&n.value.buffer!==em.buffer&&(n.value=em.subarray(0,n.value.length)),n.updateSubBuffer({startOffset:0}))}_initialize(){nd(!this.internalState),nd(Number.isFinite(this.props.coordinateSystem)),hn("layer.initialize",this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new qg({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(ln.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new Tg(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){hn("layer.matched",this,this===e);const{state:t,internalState:n}=e;this!==e&&(this.internalState=n,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(hn("layer.update",this,e),!e)return;const t=this.props,n=this.context,i=this.internalState,s=n.viewport,r=this._updateUniformTransition();i.propsInTransition=r,n.viewport=i.viewport||s,this.props=r;try{const e=this._getUpdateParams(),t=this.getModels();if(n.device)this.updateState(e);else try{this.updateState(e)}catch(o){}for(const n of this.props.extensions)n.updateState.call(this,e,n);this.setNeedsRedraw(),this._updateAttributes();const i=this.getModels()[0]!==t[0];this._postUpdate(e,i)}finally{n.viewport=s,this.props=t,this._clearChangeFlags(),i.needsUpdate=!1,i.resetOldProps()}}_finalize(){hn("layer.finalize",this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:n={},parameters:i={}}){this._updateAttributeTransition();const s=this.props,r=this.context;this.props=this.internalState.propsInTransition||s;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:s}=this.props,o=s&&s(n)||[0,0];r.device instanceof Ip&&r.device.setParametersWebGL({polygonOffset:o});for(const e of this.getModels())"webgpu"===e.device.type?e.setParameters({...e.parameters,...i}):e.setParameters(i);if(r.device instanceof Ip)r.device.withParametersWebGL(i,(()=>{const s={renderPass:e,shaderModuleProps:t,uniforms:n,parameters:i,context:r};for(const e of this.props.extensions)e.draw.call(this,s,e);this.draw(s)}));else{const s={renderPass:e,shaderModuleProps:t,uniforms:n,parameters:i,context:r};for(const e of this.props.extensions)e.draw.call(this,s,e);this.draw(s)}}finally{this.props=s}}getChangeFlags(){var e;return null==(e=this.internalState)?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const i in e)if(e[i]){let n=!1;if("dataChanged"===i){const s=e[i],r=t[i];s&&Array.isArray(r)&&(t.dataChanged=Array.isArray(s)?r.concat(s):s,n=!0)}t[i]||(t[i]=e[i],n=!0),n&&hn("layer.changeFlag",this,i,e)}const n=Boolean(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=n,t.somethingChanged=n||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){var n;const i=Ag(e,t);if(i.updateTriggersChanged)for(const s in i.updateTriggersChanged)i.updateTriggersChanged[s]&&this.invalidateAttribute(s);if(i.transitionsChanged)for(const s in i.transitionsChanged)this.internalState.uniformTransitions.add(s,t[s],e[s],null==(n=e.transitions)?void 0:n[s]);return this.setChangeFlags(i)}validateProps(){!function(e){const t=e[Mh];for(const n in t){const i=t[n],{validate:s}=i;if(s&&!s(e[n],i))throw new Error(`Invalid prop ${n}: ${e[n]}`)}}(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:n}=this.props;e.picked&&"function"==typeof n&&(t.highlightColor=n(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new vg(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:n,oldProps:i}=e,s=this.state.model;(null==s?void 0:s.isInstanced)&&s.setInstanceCount(this.getNumInstances());const{autoHighlight:r,highlightedObjectIndex:o,highlightColor:a}=n;if(t||i.autoHighlight!==r||i.highlightedObjectIndex!==o||i.highlightColor!==a){const e={};Array.isArray(a)&&(e.highlightColor=a),(t||i.autoHighlight!==r||o!==i.highlightedObjectIndex)&&(e.highlightedObjectColor=Number.isFinite(o)&&o>=0?this.encodePickingColor(o):null),this.setShaderModuleProps({picking:e})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const n=this.getAttributeManager(),i=!!n&&n.getNeedsRedraw(e);if(t=t||i,t)for(const s of this.props.extensions)s.onNeedsRedraw.call(this,s);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}nm.defaultProps=tm,nm.layerName="Layer";const im=nm;class sm extends im{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every((e=>e.isLoaded))}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id?(e.object=t.__source.object,e.index=t.__source.index,e):e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){const{_subLayerProps:n}=this.props;return n&&n[e]&&n[e].type||t}getSubLayerRow(e,t,n){return e.__source={parent:this,object:t,index:n},e}getSubLayerAccessor(e){if("function"==typeof e){const t={index:-1,data:this.props.data,target:[]};return(n,i)=>n&&n.__source?(t.index=n.__source.index,e(n.__source.object,t)):e(n,i)}return e}getSubLayerProps(e={}){var t;const{opacity:n,pickable:i,visible:s,parameters:r,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:d,positionFormat:f,modelMatrix:p,extensions:g,fetch:m,operation:_,_subLayerProps:y}=this.props,v={id:"",updateTriggers:{},opacity:n,pickable:i,visible:s,parameters:r,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:d,positionFormat:f,modelMatrix:p,extensions:g,fetch:m,operation:_},b=y&&e.id&&y[e.id],E=b&&b.updateTriggers,x=e.id||"sublayer";if(b){const t=this.props[Mh],n=e.type?e.type._propTypes:{};for(const e in b){const i=n[e]||t[e];i&&"accessor"===i.type&&(b[e]=this.getSubLayerAccessor(b[e]))}}Object.assign(v,e,b),v.id=`${this.props.id}-${x}`,v.updateTriggers={all:null==(t=this.props.updateTriggers)?void 0:t.all,...e.updateTriggers,...E};for(const w of g){const e=w.getSubLayerProps.call(this,w);e&&Object.assign(v,e,{updateTriggers:Object.assign(v.updateTriggers,e.updateTriggers)})}return v}_updateAutoHighlight(e){for(const t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let n=this.internalState.subLayers;const i=!n||this.needsUpdate();if(i){n=Bh(this.renderLayers(),Boolean),this.internalState.subLayers=n}hn("compositeLayer.renderLayers",this,i,n);for(const s of n)s.parent=this}}sm.layerName="CompositeLayer";const rm=sm,om={bearing:0,pitch:0,position:[0,0,0]},am={speed:1.2,curve:1.414};class lm extends id{constructor(e={}){super({compare:["longitude","latitude","zoom","bearing","pitch","position"],extract:["width","height","longitude","latitude","zoom","bearing","pitch","position"],required:["width","height","latitude","longitude","zoom"]}),this.opts={...am,...e}}interpolateProps(e,t,n){const i=function(e,t,n,i){const{startZoom:s,startCenterXY:r,uDelta:o,w0:a,u1:l,S:c,rho:u,rho2:h,r0:d}=qc(e,t,i);if(l<.01){const i={};for(const s of Yc){const r=e[s],o=t[s];i[s]=(f=n)*o+(1-f)*r}return i}var f;const p=n*c,g=Math.cosh(d)/Math.cosh(d+u*p),m=a*((Math.cosh(d)*Math.tanh(d+u*p)-Math.sinh(d))/h)/l,_=s+Nc(1/g),y=(E=m,(v=[])[0]=(b=o)[0]*E,v[1]=b[1]*E,v);var v,b,E;oa(y,y,r);const x=Bc(y);return{longitude:x[0],latitude:x[1],zoom:_}}(e,t,n,this.opts);for(const s in om)i[s]=Zo(e[s]||om[s],t[s]||om[s],n);return i}getDuration(e,t){let{transitionDuration:n}=t;return"auto"===n&&(n=function(e,t,n){const i={...Kc,...n},{screenSpeed:s,speed:r,maxDuration:o}=i,{S:a,rho:l}=qc(e,t,i),c=1e3*a;let u;return u=Number.isFinite(s)?c/(s/l):c/r,Number.isFinite(o)&&u>o?0:u}(e,t,this.opts)),n}}class cm{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:t={}}=e;this.typedArrayManager=Pu,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:t,buffers:n={},getGeometry:i,geometryBuffer:s,positionFormat:r,dataChanged:o,normalize:a=!0}=this.opts;if(this.data=t,this.getGeometry=i,this.positionSize=s&&s.size||("XY"===r?2:3),this.buffers=n,this.normalize=a,s&&(nd(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(s),a||(n.vertexPositions=s)),this.geometryBuffer=n.vertexPositions,Array.isArray(o))for(const l of o)this._rebuildGeometry(l);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){const t=e.value||e;return ArrayBuffer.isView(t)?qp(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){const{attributes:n,buffers:i,_attributeDefs:s,typedArrayManager:r}=this;for(const o in s)if(o in i)r.release(n[o]),n[o]=null;else{const i=s[o];i.copy=t,n[o]=r.allocate(n[o],e,i)}}_forEachGeometry(e,t,n){const{data:i,getGeometry:s}=this,{iterable:r,objectInfo:o}=Yp(i,t,n);for(const a of r){o.index++;e(s?s(a,o):null,o.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:n,instanceCount:i}=this;const{data:s,geometryBuffer:r}=this,{startRow:o=0,endRow:a=1/0}=e||{},l={};if(e||(t=[0],n=[0]),this.normalize||!r)this._forEachGeometry(((e,t)=>{const i=e&&this.normalizeGeometry(e);l[t]=i,n[t+1]=n[t]+(i?this.getGeometrySize(i):0)}),o,a),i=n[n.length-1];else if(n=s.startIndices,i=n[s.length]||0,ArrayBuffer.isView(r))i=i||r.length/this.positionSize;else if(r instanceof ni){const e=4*this.positionSize;i=i||r.byteLength/e}else if(r.buffer){const e=r.stride||4*this.positionSize;i=i||r.buffer.byteLength/e}else if(r.value){const e=r.value,t=r.stride/e.BYTES_PER_ELEMENT||this.positionSize;i=i||e.length/t}this._allocate(i,Boolean(e)),this.indexStarts=t,this.vertexStarts=n,this.instanceCount=i;const c={};this._forEachGeometry(((e,s)=>{const r=l[s]||e;c.vertexStart=n[s],c.indexStart=t[s];const o=s<n.length-1?n[s+1]:i;c.geometrySize=o-n[s],c.geometryIndex=s,this.updateGeometryAttributes(r,c)}),o,a),this.vertexCount=t[t.length-1]}}const um="uniform iconUniforms {\n  float sizeScale;\n  vec2 iconsTextureDim;\n  float sizeMinPixels;\n  float sizeMaxPixels;\n  bool billboard;\n  highp int sizeUnits;\n  float alphaCutoff;\n} icon;\n",hm={name:"icon",vs:um,fs:um,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},dm=()=>{},fm={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},pm={x:0,y:0,width:0,height:0};function gm(e,t,n,i){const s=Math.min(n/t.width,i/t.height),r=Math.floor(t.width*s),o=Math.floor(t.height*s);return 1===s?{image:t,width:r,height:o}:(e.canvas.height=o,e.canvas.width=r,e.clearRect(0,0,r,o),e.drawImage(t,0,0,t.width,t.height,0,0,r,o),{image:e.canvas,width:r,height:o})}function mm(e){return e&&(e.id||e.url)}function _m(e,t,n){for(let i=0;i<t.length;i++){const{icon:s,xOffset:r}=t[i];e[mm(s)]={...s,x:r,y:n}}}class ym{constructor(e,{onUpdate:t=dm,onError:n=dm}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=4,this._canvasWidth=1024,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=t,this.onError=n}finalize(){var e;null==(e=this._texture)||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const t=this._autoPacking?mm(e):e;return this._mapping[t]||pm}setProps({loadOptions:e,autoPacking:t,iconAtlas:n,iconMapping:i,textureParameters:s}){var r;e&&(this._loadOptions=e),void 0!==t&&(this._autoPacking=t),i&&(this._mapping=i),n&&(null==(r=this._texture)||r.delete(),this._texture=null,this._externalTexture=n),s&&(this._samplerParameters=s)}get isLoaded(){return 0===this._pendingCount}packIcons(e,t){if(!this._autoPacking||"undefined"==typeof document)return;const n=Object.values(function(e,t,n){if(!e||!t)return null;n=n||{};const i={},{iterable:s,objectInfo:r}=Yp(e);for(const o of s){r.index++;const e=t(o,r),s=mm(e);if(!e)throw new Error("Icon is missing.");if(!e.url)throw new Error("Icon url is missing.");i[s]||n[s]&&e.url===n[s].url||(i[s]={...e,source:o,sourceIndex:r.index})}return i}(e,t,this._mapping)||{});if(n.length>0){const{mapping:e,xOffset:t,yOffset:i,rowHeight:s,canvasHeight:r}=function({icons:e,buffer:t,mapping:n={},xOffset:i=0,yOffset:s=0,rowHeight:r=0,canvasWidth:o}){let a=[];for(let c=0;c<e.length;c++){const l=e[c];if(!n[mm(l)]){const{height:e,width:c}=l;i+c+t>o&&(_m(n,a,s),i=0,s=r+s+t,r=0,a=[]),a.push({icon:l,xOffset:i}),i=i+c+t,r=Math.max(r,e)}}return a.length>0&&_m(n,a,s),{mapping:n,rowHeight:r,xOffset:i,yOffset:s,canvasWidth:o,canvasHeight:(l=r+s+t,Math.pow(2,Math.ceil(Math.log2(l))))};var l}({icons:n,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=s,this._mapping=e,this._xOffset=t,this._yOffset=i,this._canvasHeight=r,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||fm,mipmaps:!0})),this._texture.height!==this._canvasHeight&&(this._texture=function(e,t,n,i){const{width:s,height:r,device:o}=e,a=o.createTexture({format:"rgba8unorm",width:t,height:n,sampler:i,mipmaps:!0}),l=o.createCommandEncoder();return l.copyTextureToTexture({sourceTexture:e,destinationTexture:a,width:s,height:r}),l.finish(),e.destroy(),a}(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||fm)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(n)}}_loadIcons(e){const t=this._canvas.getContext("2d",{willReadFrequently:!0});for(const n of e)this._pendingCount++,Gt(n.url,this._loadOptions).then((e=>{var i;const s=mm(n),r=this._mapping[s],{x:o,y:a,width:l,height:c}=r,{image:u,width:h,height:d}=gm(t,e,l,c);null==(i=this._texture)||i.copyExternalImage({image:u,x:o+(l-h)/2,y:a+(c-d)/2,width:h,height:d}),r.width=h,r.height=d,this._texture.generateMipmap(),this.onUpdate()})).catch((e=>{this.onError({url:n.url,source:n.source,sourceIndex:n.sourceIndex,loadOptions:this._loadOptions,error:e})})).finally((()=>{this._pendingCount--}))}}const vm=[0,0,0,255],bm={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:e=>e.position},getIcon:{type:"accessor",value:e=>e.icon},getColor:{type:"accessor",value:vm},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class Em extends im{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME icon-layer-vertex-shader\nin vec2 positions;\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin float instanceSizes;\nin float instanceAngles;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin vec4 instanceIconFrames;\nin float instanceColorModes;\nin vec2 instanceOffsets;\nin vec2 instancePixelOffset;\nout float vColorMode;\nout vec4 vColor;\nout vec2 vTextureCoords;\nout vec2 uv;\nvec2 rotate_by_angle(vec2 vertex, float angle) {\nfloat angle_radian = angle * PI / 180.0;\nfloat cos_angle = cos(angle_radian);\nfloat sin_angle = sin(angle_radian);\nmat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\nreturn rotationMatrix * vertex;\n}\nvoid main(void) {\ngeometry.worldPosition = instancePositions;\ngeometry.uv = positions;\ngeometry.pickingColor = instancePickingColors;\nuv = positions;\nvec2 iconSize = instanceIconFrames.zw;\nfloat sizePixels = clamp(\nproject_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),\nicon.sizeMinPixels, icon.sizeMaxPixels\n);\nfloat instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;\nvec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;\npixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;\npixelOffset += instancePixelOffset;\npixelOffset.y *= -1.0;\nif (icon.billboard)  {\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\nvec3 offset = vec3(pixelOffset, 0.0);\nDECKGL_FILTER_SIZE(offset, geometry);\ngl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n} else {\nvec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\nDECKGL_FILTER_SIZE(offset_common, geometry);\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n}\nvTextureCoords = mix(\ninstanceIconFrames.xy,\ninstanceIconFrames.xy + iconSize,\n(positions.xy + 1.0) / 2.0\n) / icon.iconsTextureDim;\nvColor = instanceColors;\nDECKGL_FILTER_COLOR(vColor, geometry);\nvColorMode = instanceColorModes;\n}\n",fs:"#version 300 es\n#define SHADER_NAME icon-layer-fragment-shader\nprecision highp float;\nuniform sampler2D iconsTexture;\nin float vColorMode;\nin vec4 vColor;\nin vec2 vTextureCoords;\nin vec2 uv;\nout vec4 fragColor;\nvoid main(void) {\ngeometry.uv = uv;\nvec4 texColor = texture(iconsTexture, vTextureCoords);\nvec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);\nfloat a = texColor.a * layer.opacity * vColor.a;\nif (a < icon.alphaCutoff) {\ndiscard;\n}\nfragColor = vec4(color, a);\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[bc,ru,hm]})}initializeState(){this.state={iconManager:new ym(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})};this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:vm},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){var t;super.updateState(e);const{props:n,oldProps:i,changeFlags:s}=e,r=this.getAttributeManager(),{iconAtlas:o,iconMapping:a,data:l,getIcon:c,textureParameters:u}=n,{iconManager:h}=this.state;if("string"==typeof o)return;const d=o||this.internalState.isAsyncPropLoading("iconAtlas");h.setProps({loadOptions:n.loadOptions,autoPacking:!d,iconAtlas:o,iconMapping:d?a:null,textureParameters:u}),d?i.iconMapping!==n.iconMapping&&r.invalidate("getIcon"):(s.dataChanged||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getIcon))&&h.packIcons(l,c),s.extensionsChanged&&(null==(t=this.state.model)||t.destroy(),this.state.model=this._getModel(),r.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeMinPixels:n,sizeMaxPixels:i,sizeUnits:s,billboard:r,alphaCutoff:o}=this.props,{iconManager:a}=this.state,l=a.getTexture();if(l){const e=this.state.model,a={iconsTexture:l,iconsTextureDim:[l.width,l.height],sizeUnits:nc[s],sizeScale:t,sizeMinPixels:n,sizeMaxPixels:i,billboard:r,alphaCutoff:o};e.shaderInputs.setProps({icon:a}),e.draw(this.context.renderPass)}}_getModel(){return new mh(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Eh({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([-1,-1,1,-1,-1,1,1,1])}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var t;const n=null==(t=this.getCurrentLayer())?void 0:t.props.onIconError;n?n(e):ln.error(e.error.message)()}getInstanceOffset(e){const{width:t,height:n,anchorX:i=t/2,anchorY:s=n/2}=this.state.iconManager.getIconMapping(e);return[t/2-i,n/2-s]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:t,y:n,width:i,height:s}=this.state.iconManager.getIconMapping(e);return[t,n,i,s]}}Em.defaultProps=bm,Em.layerName="IconLayer";const xm=Em,wm="uniform scatterplotUniforms {\n  float radiusScale;\n  float radiusMinPixels;\n  float radiusMaxPixels;\n  float lineWidthScale;\n  float lineWidthMinPixels;\n  float lineWidthMaxPixels;\n  float stroked;\n  float filled;\n  bool antialiasing;\n  bool billboard;\n  highp int radiusUnits;\n  highp int lineWidthUnits;\n} scatterplot;\n",Tm={name:"scatterplot",vs:wm,fs:wm,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},Am=[0,0,0,255],Sm={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:e=>e.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:Am},getLineColor:{type:"accessor",value:Am},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class Rm extends im{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME scatterplot-layer-vertex-shader\nin vec3 positions;\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin float instanceRadius;\nin float instanceLineWidths;\nin vec4 instanceFillColors;\nin vec4 instanceLineColors;\nin vec3 instancePickingColors;\nout vec4 vFillColor;\nout vec4 vLineColor;\nout vec2 unitPosition;\nout float innerUnitRadius;\nout float outerRadiusPixels;\nvoid main(void) {\ngeometry.worldPosition = instancePositions;\nouterRadiusPixels = clamp(\nproject_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),\nscatterplot.radiusMinPixels, scatterplot.radiusMaxPixels\n);\nfloat lineWidthPixels = clamp(\nproject_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),\nscatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels\n);\nouterRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;\nfloat edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;\nunitPosition = edgePadding * positions.xy;\ngeometry.uv = unitPosition;\ngeometry.pickingColor = instancePickingColors;\ninnerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;\nif (scatterplot.billboard) {\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\nvec3 offset = edgePadding * positions * outerRadiusPixels;\nDECKGL_FILTER_SIZE(offset, geometry);\ngl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n} else {\nvec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);\nDECKGL_FILTER_SIZE(offset, geometry);\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n}\nvFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);\nDECKGL_FILTER_COLOR(vFillColor, geometry);\nvLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);\nDECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME scatterplot-layer-fragment-shader\nprecision highp float;\nin vec4 vFillColor;\nin vec4 vLineColor;\nin vec2 unitPosition;\nin float innerUnitRadius;\nin float outerRadiusPixels;\nout vec4 fragColor;\nvoid main(void) {\ngeometry.uv = unitPosition;\nfloat distToCenter = length(unitPosition) * outerRadiusPixels;\nfloat inCircle = scatterplot.antialiasing ?\nsmoothedge(distToCenter, outerRadiusPixels) :\nstep(distToCenter, outerRadiusPixels);\nif (inCircle == 0.0) {\ndiscard;\n}\nif (scatterplot.stroked > 0.5) {\nfloat isLine = scatterplot.antialiasing ?\nsmoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :\nstep(innerUnitRadius * outerRadiusPixels, distToCenter);\nif (scatterplot.filled > 0.5) {\nfragColor = mix(vFillColor, vLineColor, isLine);\n} else {\nif (isLine == 0.0) {\ndiscard;\n}\nfragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);\n}\n} else if (scatterplot.filled < 0.5) {\ndiscard;\n} else {\nfragColor = vFillColor;\n}\nfragColor.a *= inCircle;\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",source:'// TODO(ibgreen): Hack for Layer uniforms (move to new "color" module?)\n\nstruct LayerUniforms {\n  opacity: f32,\n};\n\nvar<private> layer: LayerUniforms = LayerUniforms(1.0);\n// @group(0) @binding(1) var<uniform> layer: LayerUniforms;\n\n// Main shaders\n\nstruct ScatterplotUniforms {\n  radiusScale: f32,\n  radiusMinPixels: f32,\n  radiusMaxPixels: f32,\n  lineWidthScale: f32,\n  lineWidthMinPixels: f32,\n  lineWidthMaxPixels: f32,\n  stroked: f32,\n  filled: i32,\n  antialiasing: i32,\n  billboard: i32,\n  radiusUnits: i32,\n  lineWidthUnits: i32,\n};\n\nstruct ConstantAttributeUniforms {\n instancePositions: vec3<f32>,\n instancePositions64Low: vec3<f32>,\n instanceRadius: f32,\n instanceLineWidths: f32,\n instanceFillColors: vec4<f32>,\n instanceLineColors: vec4<f32>,\n instancePickingColors: vec3<f32>,\n\n instancePositionsConstant: i32,\n instancePositions64LowConstant: i32,\n instanceRadiusConstant: i32,\n instanceLineWidthsConstant: i32,\n instanceFillColorsConstant: i32,\n instanceLineColorsConstant: i32,\n instancePickingColorsConstant: i32\n};\n\n@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;\n\nstruct ConstantAttributes {\n  instancePositions: vec3<f32>,\n  instancePositions64Low: vec3<f32>,\n  instanceRadius: f32,\n  instanceLineWidths: f32,\n  instanceFillColors: vec4<f32>,\n  instanceLineColors: vec4<f32>,\n  instancePickingColors: vec3<f32>\n};\n\nconst constants = ConstantAttributes(\n  vec3<f32>(0.0),\n  vec3<f32>(0.0),\n  0.0,\n  0.0,\n  vec4<f32>(0.0, 0.0, 0.0, 1.0),\n  vec4<f32>(0.0, 0.0, 0.0, 1.0),\n  vec3<f32>(0.0)\n);\n\nstruct Attributes {\n  @builtin(instance_index) instanceIndex : u32,\n  @builtin(vertex_index) vertexIndex : u32,\n  @location(0) positions: vec3<f32>,\n  @location(1) instancePositions: vec3<f32>,\n  @location(2) instancePositions64Low: vec3<f32>,\n  @location(3) instanceRadius: f32,\n  @location(4) instanceLineWidths: f32,\n  @location(5) instanceFillColors: vec4<f32>,\n  @location(6) instanceLineColors: vec4<f32>,\n  @location(7) instancePickingColors: vec3<f32>\n};\n\nstruct Varyings {\n  @builtin(position) position: vec4<f32>,\n  @location(0) vFillColor: vec4<f32>,\n  @location(1) vLineColor: vec4<f32>,\n  @location(2) unitPosition: vec2<f32>,\n  @location(3) innerUnitRadius: f32,\n  @location(4) outerRadiusPixels: f32,\n};\n\n@vertex\nfn vertexMain(attributes: Attributes) -> Varyings {\n  var varyings: Varyings;\n\n  // Draw an inline geometry constant array clip space triangle to verify that rendering works.\n  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));\n  // if (attributes.instanceIndex == 0) {\n  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);\n  //   return varyings;\n  // }\n\n  // var geometry: Geometry;\n  // geometry.worldPosition = instancePositions;\n\n  // Multiply out radius and clamp to limits\n  varyings.outerRadiusPixels = clamp(\n    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),\n    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels\n  );\n\n  // Multiply out line width and clamp to limits\n  let lineWidthPixels = clamp(\n    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),\n    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels\n  );\n\n  // outer radius needs to offset by half stroke width\n  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;\n  // Expand geometry to accommodate edge smoothing\n  let edgePadding = select(\n    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,\n    1.0,\n    scatterplot.antialiasing != 0\n  );\n\n  // position on the containing square in [-1, 1] space\n  varyings.unitPosition = edgePadding * attributes.positions.xy;\n  geometry.uv = varyings.unitPosition;\n  geometry.pickingColor = attributes.instancePickingColors;\n\n  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;\n\n  if (scatterplot.billboard != 0) {\n    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);\n    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);\n    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;\n    // DECKGL_FILTER_SIZE(offset, geometry);\n    let clipPixels = project_pixel_size_to_clipspace(offset.xy);\n    varyings.position.x = clipPixels.x;\n    varyings.position.y = clipPixels.y;\n  } else {\n    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);\n    // DECKGL_FILTER_SIZE(offset, geometry);\n    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);\n    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);\n  }\n\n  // Apply opacity to instance color, or return instance picking color\n  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * layer.opacity);\n  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);\n  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * layer.opacity);\n  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);\n\n  return varyings;\n}\n\n@fragment\nfn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {\n  // var geometry: Geometry;\n  // geometry.uv = unitPosition;\n\n  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;\n  let inCircle = select(\n    smoothedge(distToCenter, varyings.outerRadiusPixels),\n    step(distToCenter, varyings.outerRadiusPixels),\n    scatterplot.antialiasing != 0\n  );\n\n  if (inCircle == 0.0) {\n    // discard;\n  }\n\n  var fragColor: vec4<f32>;\n\n  if (scatterplot.stroked != 0) {\n    let isLine = select(\n      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),\n      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),\n      scatterplot.antialiasing != 0\n    );\n\n    if (scatterplot.filled != 0) {\n      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);\n    } else {\n      if (isLine == 0.0) {\n        // discard;\n      }\n      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);\n    }\n  } else if (scatterplot.filled == 0) {\n    // discard;\n  } else {\n    fragColor = varyings.vFillColor;\n  }\n\n  fragColor.a *= inCircle;\n  // DECKGL_FILTER_COLOR(fragColor, geometry);\n\n  return fragColor;\n  // return vec4<f32>(0, 0, 1, 1);\n}\n',modules:[bc,ru,Tm]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var t;super.updateState(e),e.changeFlags.extensionsChanged&&(null==(t=this.state.model)||t.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{radiusUnits:t,radiusScale:n,radiusMinPixels:i,radiusMaxPixels:s,stroked:r,filled:o,billboard:a,antialiasing:l,lineWidthUnits:c,lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d}=this.props,f={stroked:r,filled:o,billboard:a,antialiasing:l,radiusUnits:nc[t],radiusScale:n,radiusMinPixels:i,radiusMaxPixels:s,lineWidthUnits:nc[c],lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d},p=this.state.model;p.shaderInputs.setProps({scatterplot:f}),p.draw(this.context.renderPass)}_getModel(){return new mh(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Eh({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0])}}}),isInstanced:!0})}}Rm.defaultProps=Sm,Rm.layerName="ScatterplotLayer";const Pm=Rm,Cm=1,Im=-1;function Lm(e,t,n={}){const i=function(e,t={}){return Math.sign(function(e,t={}){const{start:n=0,end:i=e.length,plane:s="xy"}=t,r=t.size||2;let o=0;const a=Mm[s[0]],l=Mm[s[1]];for(let c=n,u=i-r;c<i;c+=r)o+=(e[c+a]-e[u+a])*(e[c+l]+e[u+l]),u=c;return o/2}(e,t))}(e,n);return i!==t&&(function(e,t){const{start:n=0,end:i=e.length,size:s=2}=t,r=(i-n)/s,o=Math.floor(r/2);for(let a=0;a<o;++a){const t=n+a*s,i=n+(r-1-a)*s;for(let n=0;n<s;++n){const s=e[t+n];e[t+n]=e[i+n],e[i+n]=s}}}(e,n),!0)}const Mm={x:0,y:1,z:2};function km(e,t){const n=t.length,i=e.length;if(i>0){let s=!0;for(let r=0;r<n;r++)if(e[i-n+r]!==t[r]){s=!1;break}if(s)return!1}for(let s=0;s<n;s++)e[i+s]=t[s];return!0}function Om(e,t){const n=t.length;for(let i=0;i<n;i++)e[i]=t[i]}function Nm(e,t,n,i,s=[]){const r=i+t*n;for(let o=0;o<n;o++)s[o]=e[r+o];return s}function Fm(e,t,n,i,s=[]){let r,o;if(8&n)r=(i[3]-e[1])/(t[1]-e[1]),o=3;else if(4&n)r=(i[1]-e[1])/(t[1]-e[1]),o=1;else if(2&n)r=(i[2]-e[0])/(t[0]-e[0]),o=2;else{if(!(1&n))return null;r=(i[0]-e[0])/(t[0]-e[0]),o=0}for(let a=0;a<e.length;a++)s[a]=(1&o)===a?i[o]:r*(t[a]-e[a])+e[a];return s}function Bm(e,t){let n=0;return e[0]<t[0]?n|=1:e[0]>t[2]&&(n|=2),e[1]<t[1]?n|=4:e[1]>t[3]&&(n|=8),n}function Dm(e,t){const{size:n=2,broken:i=!1,gridResolution:s=10,gridOffset:r=[0,0],startIndex:o=0,endIndex:a=e.length}=t||{},l=(a-o)/n;let c=[];const u=[c],h=Nm(e,0,n,o);let d,f;const p=zm(h,s,r,[]),g=[];km(c,h);for(let m=1;m<l;m++){for(d=Nm(e,m,n,o,d),f=Bm(d,p);f;){Fm(h,d,f,p,g);const e=Bm(g,p);e&&(Fm(h,g,e,p,g),f=e),km(c,g),Om(h,g),Vm(p,s,f),i&&c.length>n&&(c=[],u.push(c),km(c,h)),f=Bm(d,p)}km(c,d),Om(h,d)}return i?u:u[0]}function Um(e,t=null,n){if(!e.length)return[];const{size:i=2,gridResolution:s=10,gridOffset:r=[0,0],edgeTypes:o=!1}=n||{},a=[],l=[{pos:e,types:o?new Array(e.length/i).fill(1):null,holes:t||[]}],c=[[],[]];let u=[];for(;l.length;){const{pos:e,types:t,holes:n}=l.shift();Wm(e,i,n[0]||e.length,c),u=zm(c[0],s,r,u);const h=Bm(c[1],u);if(h){let s=Gm(e,t,i,0,n[0]||e.length,u,h);const r={pos:s[0].pos,types:s[0].types,holes:[]},a={pos:s[1].pos,types:s[1].types,holes:[]};l.push(r,a);for(let l=0;l<n.length;l++)s=Gm(e,t,i,n[l],n[l+1]||e.length,u,h),s[0]&&(r.holes.push(r.pos.length),r.pos=jm(r.pos,s[0].pos),o&&(r.types=jm(r.types,s[0].types))),s[1]&&(a.holes.push(a.pos.length),a.pos=jm(a.pos,s[1].pos),o&&(a.types=jm(a.types,s[1].types)))}else{const i={positions:e};o&&(i.edgeTypes=t),n.length&&(i.holeIndices=n),a.push(i)}}return a}function Gm(e,t,n,i,s,r,o){const a=(s-i)/n,l=[],c=[],u=[],h=[],d=[];let f,p,g;const m=Nm(e,a-1,n,i);let _=Math.sign(8&o?m[1]-r[3]:m[0]-r[2]),y=t&&t[a-1],v=0,b=0;for(let E=0;E<a;E++)f=Nm(e,E,n,i,f),p=Math.sign(8&o?f[1]-r[3]:f[0]-r[2]),g=t&&t[i/n+E],p&&_&&_!==p&&(Fm(m,f,o,r,d),km(l,d)&&u.push(y),km(c,d)&&h.push(y)),p<=0?(km(l,f)&&u.push(g),v-=p):u.length&&(u[u.length-1]=0),p>=0?(km(c,f)&&h.push(g),b+=p):h.length&&(h[h.length-1]=0),Om(m,f),_=p,y=g;return[v?{pos:l,types:t&&u}:null,b?{pos:c,types:t&&h}:null]}function zm(e,t,n,i){const s=Math.floor((e[0]-n[0])/t)*t+n[0],r=Math.floor((e[1]-n[1])/t)*t+n[1];return i[0]=s,i[1]=r,i[2]=s+t,i[3]=r+t,i}function Vm(e,t,n){8&n?(e[1]+=t,e[3]+=t):4&n?(e[1]-=t,e[3]-=t):2&n?(e[0]+=t,e[2]+=t):1&n&&(e[0]-=t,e[2]-=t)}function Wm(e,t,n,i){let s=1/0,r=-1/0,o=1/0,a=-1/0;for(let l=0;l<n;l+=t){const t=e[l],n=e[l+1];s=t<s?t:s,r=t>r?t:r,o=n<o?n:o,a=n>a?n:a}return i[0][0]=s,i[0][1]=o,i[1][0]=r,i[1][1]=a,i}function jm(e,t){for(let n=0;n<t.length;n++)e.push(t[n]);return e}function Hm(e,t,n,i){let s=-1,r=-1;for(let o=n+1;o<i;o+=t){const t=Math.abs(e[o]);t>s&&(s=t,r=o-1)}return r}function $m(e,t,n,i,s=85.051129){const r=e[n],o=e[i-t];if(Math.abs(r-o)>180){const i=Nm(e,0,t,n);i[0]+=360*Math.round((o-r)/360),km(e,i),i[1]=Math.sign(i[1])*s,km(e,i),i[0]=r,km(e,i)}}function Xm(e,t,n,i){let s,r=e[0];for(let o=n;o<i;o+=t){s=e[o];const t=s-r;(t>180||t<-180)&&(s-=360*Math.round(t/360)),e[o]=r=s}}function Ym(e,t){let n;const i=e.length/t;for(let r=0;r<i&&(n=e[r*t],(n+180)%360==0);r++);const s=360*-Math.round(n/360);if(0!==s)for(let r=0;r<i;r++)e[r*t]+=s}function Km(e,t,n,i){let s;if(Array.isArray(e[0])){const n=e.length*t;s=new Array(n);for(let i=0;i<e.length;i++)for(let n=0;n<t;n++)s[i*t+n]=e[i][n]||0}else s=e;return n?Dm(s,{size:t,gridResolution:n}):i?function(e,t){const{size:n=2,startIndex:i=0,endIndex:s=e.length,normalize:r=!0}=t||{},o=e.slice(i,s);Xm(o,n,0,s-i);const a=Dm(o,{size:n,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(r)for(const l of a)Ym(l,n);return a}(s,{size:t}):s}class qm extends cm{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?Km(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(Zm(e)){let t=0;for(const n of e)t+=this.getGeometrySize(n);return t}const t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(0!==t.geometrySize)if(e&&Zm(e))for(const n of e){const e=this.getGeometrySize(n);t.geometrySize=e,this.updateGeometryAttributes(n,t),t.vertexStart+=e}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){const n=this.attributes.segmentTypes,i=!!e&&this.isClosed(e),{vertexStart:s,geometrySize:r}=t;n.fill(0,s,s+r),i?(n[s]=4,n[s+r-2]=4):(n[s]+=1,n[s+r-2]+=2),n[s+r-1]=4}_updatePositions(e,t){const{positions:n}=this.attributes;if(!n||!e)return;const{vertexStart:i,geometrySize:s}=t,r=new Array(3);for(let o=i,a=0;a<s;o++,a++)this.getPointOnPath(e,a,r),n[3*o]=r[0],n[3*o+1]=r[1],n[3*o+2]=r[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,n=[]){const{positionSize:i}=this;t*i>=e.length&&(t+=1-e.length/i);const s=t*i;return n[0]=e[s],n[1]=e[s+1],n[2]=3===i&&e[s+2]||0,n}isClosed(e){if(!this.normalize)return Boolean(this.opts.loop);const{positionSize:t}=this,n=e.length-t;return e[0]===e[n]&&e[1]===e[n+1]&&(2===t||e[2]===e[n+2])}}function Zm(e){return Array.isArray(e[0])}const Qm="uniform pathUniforms {\n  float widthScale;\n  float widthMinPixels;\n  float widthMaxPixels;\n  float jointType;\n  float capType;\n  float miterLimit;\n  bool billboard;\n  highp int widthUnits;\n} path;\n",Jm={name:"path",vs:Qm,fs:Qm,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},e_=[0,0,0,255],t_={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:e=>e.path},getColor:{type:"accessor",value:e_},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},n_={enter:(e,t)=>t.length?t.subarray(t.length-e.length):e};class i_ extends im{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME path-layer-vertex-shader\nin vec2 positions;\nin float instanceTypes;\nin vec3 instanceStartPositions;\nin vec3 instanceEndPositions;\nin vec3 instanceLeftPositions;\nin vec3 instanceRightPositions;\nin vec3 instanceLeftPositions64Low;\nin vec3 instanceStartPositions64Low;\nin vec3 instanceEndPositions64Low;\nin vec3 instanceRightPositions64Low;\nin float instanceStrokeWidths;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nuniform float opacity;\nout vec4 vColor;\nout vec2 vCornerOffset;\nout float vMiterLength;\nout vec2 vPathPosition;\nout float vPathLength;\nout float vJointType;\nconst float EPSILON = 0.001;\nconst vec3 ZERO_OFFSET = vec3(0.0);\nfloat flipIfTrue(bool flag) {\nreturn -(float(flag) * 2. - 1.);\n}\nvec3 getLineJoinOffset(\nvec3 prevPoint, vec3 currPoint, vec3 nextPoint,\nvec2 width\n) {\nbool isEnd = positions.x > 0.0;\nfloat sideOfPath = positions.y;\nfloat isJoint = float(sideOfPath == 0.0);\nvec3 deltaA3 = (currPoint - prevPoint);\nvec3 deltaB3 = (nextPoint - currPoint);\nmat3 rotationMatrix;\nbool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);\nif (needsRotation) {\ndeltaA3 = deltaA3 * rotationMatrix;\ndeltaB3 = deltaB3 * rotationMatrix;\n}\nvec2 deltaA = deltaA3.xy / width;\nvec2 deltaB = deltaB3.xy / width;\nfloat lenA = length(deltaA);\nfloat lenB = length(deltaB);\nvec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);\nvec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);\nvec2 perpA = vec2(-dirA.y, dirA.x);\nvec2 perpB = vec2(-dirB.y, dirB.x);\nvec2 tangent = dirA + dirB;\ntangent = length(tangent) > 0. ? normalize(tangent) : perpA;\nvec2 miterVec = vec2(-tangent.y, tangent.x);\nvec2 dir = isEnd ? dirA : dirB;\nvec2 perp = isEnd ? perpA : perpB;\nfloat L = isEnd ? lenA : lenB;\nfloat sinHalfA = abs(dot(miterVec, perp));\nfloat cosHalfA = abs(dot(dirA, miterVec));\nfloat turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);\nfloat cornerPosition = sideOfPath * turnDirection;\nfloat miterSize = 1.0 / max(sinHalfA, EPSILON);\nmiterSize = mix(\nmin(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),\nmiterSize,\nstep(0.0, cornerPosition)\n);\nvec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))\n* (sideOfPath + isJoint * turnDirection);\nbool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));\nbool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));\nbool isCap = isStartCap || isEndCap;\nif (isCap) {\noffsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);\nvJointType = path.capType;\n} else {\nvJointType = path.jointType;\n}\nvPathLength = L;\nvCornerOffset = offsetVec;\nvMiterLength = dot(vCornerOffset, miterVec * turnDirection);\nvMiterLength = isCap ? isJoint : vMiterLength;\nvec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);\nvPathPosition = vec2(\ndot(offsetFromStartOfPath, perp),\ndot(offsetFromStartOfPath, dir)\n);\ngeometry.uv = vPathPosition;\nfloat isValid = step(instanceTypes, 3.5);\nvec3 offset = vec3(offsetVec * width * isValid, 0.0);\nif (needsRotation) {\noffset = rotationMatrix * offset;\n}\nreturn offset;\n}\nvoid clipLine(inout vec4 position, vec4 refPosition) {\nif (position.w < EPSILON) {\nfloat r = (EPSILON - refPosition.w) / (position.w - refPosition.w);\nposition = refPosition + (position - refPosition) * r;\n}\n}\nvoid main() {\ngeometry.pickingColor = instancePickingColors;\nvColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);\nfloat isEnd = positions.x;\nvec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);\nvec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);\nvec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);\nvec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);\nvec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);\nvec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);\ngeometry.worldPosition = currPosition;\nvec2 widthPixels = vec2(clamp(\nproject_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),\npath.widthMinPixels, path.widthMaxPixels) / 2.0);\nvec3 width;\nif (path.billboard) {\nvec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);\nvec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);\nvec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);\nclipLine(prevPositionScreen, currPositionScreen);\nclipLine(nextPositionScreen, currPositionScreen);\nclipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));\nwidth = vec3(widthPixels, 0.0);\nDECKGL_FILTER_SIZE(width, geometry);\nvec3 offset = getLineJoinOffset(\nprevPositionScreen.xyz / prevPositionScreen.w,\ncurrPositionScreen.xyz / currPositionScreen.w,\nnextPositionScreen.xyz / nextPositionScreen.w,\nproject_pixel_size_to_clipspace(width.xy)\n);\nDECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);\ngl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);\n} else {\nprevPosition = project_position(prevPosition, prevPosition64Low);\ncurrPosition = project_position(currPosition, currPosition64Low);\nnextPosition = project_position(nextPosition, nextPosition64Low);\nwidth = vec3(project_pixel_size(widthPixels), 0.0);\nDECKGL_FILTER_SIZE(width, geometry);\nvec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);\ngeometry.position = vec4(currPosition + offset, 1.0);\ngl_Position = project_common_position_to_clipspace(geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n}\nDECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME path-layer-fragment-shader\nprecision highp float;\nin vec4 vColor;\nin vec2 vCornerOffset;\nin float vMiterLength;\nin vec2 vPathPosition;\nin float vPathLength;\nin float vJointType;\nout vec4 fragColor;\nvoid main(void) {\ngeometry.uv = vPathPosition;\nif (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {\nif (vJointType > 0.5 && length(vCornerOffset) > 1.0) {\ndiscard;\n}\nif (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {\ndiscard;\n}\n}\nfragColor = vColor;\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[bc,ru,Jm]})}get wrapLongitude(){return!1}getBounds(){var e;return null==(e=this.getAttributeManager())?void 0:e.getBounds(["vertexPositions"])}initializeState(){const e=!0;this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:n_,accessor:"getPath",update:this.calculatePositions,noAlloc:e,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:e},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:n_,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:n_,defaultValue:e_},instancePickingColors:{size:4,type:"uint8",accessor:(e,{index:t,target:n})=>this.encodePickingColor(e&&e.__source?e.__source.index:t,n)}}),this.setState({pathTesselator:new qm({fp64:this.use64bitPositions()})})}updateState(e){var t;super.updateState(e);const{props:n,changeFlags:i}=e,s=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){const{pathTesselator:e}=this.state,t=n.data.attributes||{};e.updateGeometry({data:n.data,geometryBuffer:t.getPath,buffers:t,normalize:!n._pathType,loop:"loop"===n._pathType,getGeometry:n.getPath,positionFormat:n.positionFormat,wrapLongitude:n.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:e.instanceCount,startIndices:e.vertexStarts}),i.dataChanged||s.invalidateAll()}i.extensionsChanged&&(null==(t=this.state.model)||t.destroy(),this.state.model=this._getModel(),s.invalidateAll())}getPickingInfo(e){const t=super.getPickingInfo(e),{index:n}=t,i=this.props.data;return i[0]&&i[0].__source&&(t.object=i.find((e=>e.__source.index===n))),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let n=0;n<t.length;n++)t[n].__source.index===e&&this._disablePickingIndex(n);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:t,capRounded:n,billboard:i,miterLimit:s,widthUnits:r,widthScale:o,widthMinPixels:a,widthMaxPixels:l}=this.props,c=this.state.model,u={jointType:Number(t),capType:Number(n),billboard:i,widthUnits:nc[r],widthScale:o,miterLimit:s,widthMinPixels:a,widthMaxPixels:l};c.shaderInputs.setProps({path:u}),c.draw(this.context.renderPass)}_getModel(){return new mh(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Eh({topology:"triangle-list",attributes:{indices:new Uint16Array([0,1,2,1,4,2,1,3,4,3,5,4]),positions:{value:new Float32Array([0,0,0,-1,0,1,1,-1,1,1,1,0]),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}}i_.defaultProps=t_,i_.layerName="PathLayer";const s_=i_;var r_={exports:{}};function o_(e,t,n){n=n||2;var i,s,r,o,a,l,c,u=t&&t.length,h=u?t[0]*n:e.length,d=a_(e,0,h,n,!0),f=[];if(!d||d.next===d.prev)return f;if(u&&(d=function(e,t,n,i){var s,r,o,a=[];for(s=0,r=t.length;s<r;s++)(o=a_(e,t[s]*i,s<r-1?t[s+1]*i:e.length,i,!1))===o.next&&(o.steiner=!0),a.push(y_(o));for(a.sort(p_),s=0;s<a.length;s++)n=g_(a[s],n);return n}(e,t,d,n)),e.length>80*n){i=r=e[0],s=o=e[1];for(var p=n;p<h;p+=n)(a=e[p])<i&&(i=a),(l=e[p+1])<s&&(s=l),a>r&&(r=a),l>o&&(o=l);c=0!==(c=Math.max(r-i,o-s))?32767/c:0}return c_(d,f,n,i,s,c,0),f}function a_(e,t,n,i,s){var r,o;if(s===L_(e,t,n,i)>0)for(r=t;r<n;r+=i)o=P_(r,e[r],e[r+1],o);else for(r=n-i;r>=t;r-=i)o=P_(r,e[r],e[r+1],o);return o&&x_(o,o.next)&&(C_(o),o=o.next),o}function l_(e,t){if(!e)return e;t||(t=e);var n,i=e;do{if(n=!1,i.steiner||!x_(i,i.next)&&0!==E_(i.prev,i,i.next))i=i.next;else{if(C_(i),(i=t=i.prev)===i.next)break;n=!0}}while(n||i!==t);return t}function c_(e,t,n,i,s,r,o){if(e){!o&&r&&function(e,t,n,i){var s=e;do{0===s.z&&(s.z=__(s.x,s.y,t,n,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){var t,n,i,s,r,o,a,l,c=1;do{for(n=e,e=null,r=null,o=0;n;){for(o++,i=n,a=0,t=0;t<c&&(a++,i=i.nextZ);t++);for(l=c;a>0||l>0&&i;)0!==a&&(0===l||!i||n.z<=i.z)?(s=n,n=n.nextZ,a--):(s=i,i=i.nextZ,l--),r?r.nextZ=s:e=s,s.prevZ=r,r=s;n=i}r.nextZ=null,c*=2}while(o>1)}(s)}(e,i,s,r);for(var a,l,c=e;e.prev!==e.next;)if(a=e.prev,l=e.next,r?h_(e,i,s,r):u_(e))t.push(a.i/n|0),t.push(e.i/n|0),t.push(l.i/n|0),C_(e),e=l.next,c=l.next;else if((e=l)===c){o?1===o?c_(e=d_(l_(e),t,n),t,n,i,s,r,2):2===o&&f_(e,t,n,i,s,r):c_(l_(e),t,n,i,s,r,1);break}}}function u_(e){var t=e.prev,n=e,i=e.next;if(E_(t,n,i)>=0)return!1;for(var s=t.x,r=n.x,o=i.x,a=t.y,l=n.y,c=i.y,u=s<r?s<o?s:o:r<o?r:o,h=a<l?a<c?a:c:l<c?l:c,d=s>r?s>o?s:o:r>o?r:o,f=a>l?a>c?a:c:l>c?l:c,p=i.next;p!==t;){if(p.x>=u&&p.x<=d&&p.y>=h&&p.y<=f&&v_(s,a,r,l,o,c,p.x,p.y)&&E_(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function h_(e,t,n,i){var s=e.prev,r=e,o=e.next;if(E_(s,r,o)>=0)return!1;for(var a=s.x,l=r.x,c=o.x,u=s.y,h=r.y,d=o.y,f=a<l?a<c?a:c:l<c?l:c,p=u<h?u<d?u:d:h<d?h:d,g=a>l?a>c?a:c:l>c?l:c,m=u>h?u>d?u:d:h>d?h:d,_=__(f,p,t,n,i),y=__(g,m,t,n,i),v=e.prevZ,b=e.nextZ;v&&v.z>=_&&b&&b.z<=y;){if(v.x>=f&&v.x<=g&&v.y>=p&&v.y<=m&&v!==s&&v!==o&&v_(a,u,l,h,c,d,v.x,v.y)&&E_(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,b.x>=f&&b.x<=g&&b.y>=p&&b.y<=m&&b!==s&&b!==o&&v_(a,u,l,h,c,d,b.x,b.y)&&E_(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;v&&v.z>=_;){if(v.x>=f&&v.x<=g&&v.y>=p&&v.y<=m&&v!==s&&v!==o&&v_(a,u,l,h,c,d,v.x,v.y)&&E_(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;b&&b.z<=y;){if(b.x>=f&&b.x<=g&&b.y>=p&&b.y<=m&&b!==s&&b!==o&&v_(a,u,l,h,c,d,b.x,b.y)&&E_(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function d_(e,t,n){var i=e;do{var s=i.prev,r=i.next.next;!x_(s,r)&&w_(s,i,i.next,r)&&S_(s,r)&&S_(r,s)&&(t.push(s.i/n|0),t.push(i.i/n|0),t.push(r.i/n|0),C_(i),C_(i.next),i=e=r),i=i.next}while(i!==e);return l_(i)}function f_(e,t,n,i,s,r){var o=e;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&b_(o,a)){var l=R_(o,a);return o=l_(o,o.next),l=l_(l,l.next),c_(o,t,n,i,s,r,0),void c_(l,t,n,i,s,r,0)}a=a.next}o=o.next}while(o!==e)}function p_(e,t){return e.x-t.x}function g_(e,t){var n=function(e,t){var n,i=t,s=e.x,r=e.y,o=-1/0;do{if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){var a=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=s&&a>o&&(o=a,n=i.x<i.next.x?i:i.next,a===s))return n}i=i.next}while(i!==t);if(!n)return null;var l,c=n,u=n.x,h=n.y,d=1/0;i=n;do{s>=i.x&&i.x>=u&&s!==i.x&&v_(r<h?s:o,r,u,h,r<h?o:s,r,i.x,i.y)&&(l=Math.abs(r-i.y)/(s-i.x),S_(i,e)&&(l<d||l===d&&(i.x>n.x||i.x===n.x&&m_(n,i)))&&(n=i,d=l)),i=i.next}while(i!==c);return n}(e,t);if(!n)return t;var i=R_(n,e);return l_(i,i.next),l_(n,n.next)}function m_(e,t){return E_(e.prev,e,t.prev)<0&&E_(t.next,e,e.next)<0}function __(e,t,n,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function y_(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function v_(e,t,n,i,s,r,o,a){return(s-o)*(t-a)>=(e-o)*(r-a)&&(e-o)*(i-a)>=(n-o)*(t-a)&&(n-o)*(r-a)>=(s-o)*(i-a)}function b_(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&w_(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(S_(e,t)&&S_(t,e)&&function(e,t){var n=e,i=!1,s=(e.x+t.x)/2,r=(e.y+t.y)/2;do{n.y>r!=n.next.y>r&&n.next.y!==n.y&&s<(n.next.x-n.x)*(r-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)&&(E_(e.prev,e,t.prev)||E_(e,t.prev,t))||x_(e,t)&&E_(e.prev,e,e.next)>0&&E_(t.prev,t,t.next)>0)}function E_(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function x_(e,t){return e.x===t.x&&e.y===t.y}function w_(e,t,n,i){var s=A_(E_(e,t,n)),r=A_(E_(e,t,i)),o=A_(E_(n,i,e)),a=A_(E_(n,i,t));return s!==r&&o!==a||(!(0!==s||!T_(e,n,t))||(!(0!==r||!T_(e,i,t))||(!(0!==o||!T_(n,e,i))||!(0!==a||!T_(n,t,i)))))}function T_(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function A_(e){return e>0?1:e<0?-1:0}function S_(e,t){return E_(e.prev,e,e.next)<0?E_(e,t,e.next)>=0&&E_(e,e.prev,t)>=0:E_(e,t,e.prev)<0||E_(e,e.next,t)<0}function R_(e,t){var n=new I_(e.i,e.x,e.y),i=new I_(t.i,t.x,t.y),s=e.next,r=t.prev;return e.next=t,t.prev=e,n.next=s,s.prev=n,i.next=n,n.prev=i,r.next=i,i.prev=r,i}function P_(e,t,n,i){var s=new I_(e,t,n);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function C_(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function I_(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function L_(e,t,n,i){for(var s=0,r=t,o=n-i;r<n;r+=i)s+=(e[o]-e[r])*(e[r+1]+e[o+1]),o=r;return s}r_.exports=o_,r_.exports.default=o_,o_.deviation=function(e,t,n,i){var s=t&&t.length,r=s?t[0]*n:e.length,o=Math.abs(L_(e,0,r,n));if(s)for(var a=0,l=t.length;a<l;a++){var c=t[a]*n,u=a<l-1?t[a+1]*n:e.length;o-=Math.abs(L_(e,c,u,n))}var h=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,p=i[a+2]*n;h+=Math.abs((e[d]-e[p])*(e[f+1]-e[d+1])-(e[d]-e[f])*(e[p+1]-e[d+1]))}return 0===o&&0===h?0:Math.abs((h-o)/o)},o_.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},i=0,s=0;s<e.length;s++){for(var r=0;r<e[s].length;r++)for(var o=0;o<t;o++)n.vertices.push(e[s][r][o]);s>0&&(i+=e[s-1].length,n.holes.push(i))}return n};const M_=r(r_.exports),k_=Cm,O_=Im,N_={isClosed:!0};function F_(e){return"positions"in e?e.positions:e}function B_(e){return"holeIndices"in e?e.holeIndices:null}function D_(e,t,n,i,s){let r=t;const o=n.length;for(let a=0;a<o;a++)for(let t=0;t<i;t++)e[r++]=n[a][t]||0;if(!function(e){const t=e[0],n=e[e.length-1];return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]}(n))for(let a=0;a<i;a++)e[r++]=n[0][a]||0;return N_.start=t,N_.end=r,N_.size=i,Lm(e,s,N_),r}function U_(e,t,n,i,s=0,r,o){const a=(r=r||n.length)-s;if(a<=0)return t;let l=t;for(let c=0;c<a;c++)e[l++]=n[s+c];if(!function(e,t,n,i){for(let s=0;s<t;s++)if(e[n+s]!==e[i-t+s])return!1;return!0}(n,i,s,r))for(let c=0;c<i;c++)e[l++]=n[s+c];return N_.start=t,N_.end=l,N_.size=i,Lm(e,o,N_),l}function G_(e,t){!function(e){if(e=e&&e.positions||e,!Array.isArray(e)&&!ArrayBuffer.isView(e))throw new Error("invalid polygon")}(e);const n=[],i=[];if("positions"in e){const{positions:s,holeIndices:r}=e;if(r){let e=0;for(let o=0;o<=r.length;o++)e=U_(n,e,s,t,r[o-1],r[o],0===o?k_:O_),i.push(e);return i.pop(),{positions:n,holeIndices:i}}e=s}if(!function(e){return Array.isArray(e[0])}(e))return U_(n,0,e,t,0,n.length,k_),n;if(!function(e){return e.length>=1&&e[0].length>=2&&Number.isFinite(e[0][0])}(e)){let s=0;for(const[r,o]of e.entries())s=D_(n,s,o,t,0===r?k_:O_),i.push(s);return i.pop(),{positions:n,holeIndices:i}}return D_(n,0,e,t,k_),n}function z_(e,t,n){const i=e.length/3;let s=0;for(let r=0;r<i;r++){const o=(r+1)%i;s+=e[3*r+t]*e[3*o+n],s-=e[3*o+t]*e[3*r+n]}return Math.abs(s/2)}function V_(e,t,n,i){const s=e.length/3;for(let r=0;r<s;r++){const s=3*r,o=e[s+0],a=e[s+1],l=e[s+2];e[s+t]=o,e[s+n]=a,e[s+i]=l}}class W_ extends cm{constructor(e){const{fp64:t,IndexType:n=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:n,size:1}}})}get(e){const{attributes:t}=this;return"indices"===e?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);const t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const t=G_(e,this.positionSize);return this.opts.resolution?Um(F_(t),B_(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?function(e,t=null,n){const{size:i=2,normalize:s=!0,edgeTypes:r=!1}=n||{};t=t||[];const o=[],a=[];let l=0,c=0;for(let h=0;h<=t.length;h++){const s=t[h]||e.length,r=c,u=Hm(e,i,l,s);for(let t=u;t<s;t++)o[c++]=e[t];for(let t=l;t<u;t++)o[c++]=e[t];Xm(o,i,r,c),$m(o,i,r,c,null==n?void 0:n.maxLatitude),l=s,a[h]=c}a.pop();const u=Um(o,a,{size:i,gridResolution:360,gridOffset:[-180,-180],edgeTypes:r});if(s)for(const h of u)Ym(h.positions,i);return u}(F_(t),B_(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(j_(e)){let t=0;for(const n of e)t+=this.getGeometrySize(n);return t}return F_(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&j_(e))for(const n of e){const e=this.getGeometrySize(n);t.geometrySize=e,this.updateGeometryAttributes(n,t),t.vertexStart+=e,t.indexStart=this.indexStarts[t.geometryIndex+1]}else{const n=e;this._updateIndices(n,t),this._updatePositions(n,t),this._updateVertexValid(n,t)}}_updateIndices(e,{geometryIndex:t,vertexStart:n,indexStart:i}){const{attributes:s,indexStarts:r,typedArrayManager:o}=this;let a=s.indices;if(!a||!e)return;let l=i;const c=function(e,t,n,i){let s=B_(e);s&&(s=s.map((e=>e/t)));let r=F_(e);const o=i&&3===t;if(n){const e=r.length;r=r.slice();const i=[];for(let s=0;s<e;s+=t){i[0]=r[s],i[1]=r[s+1],o&&(i[2]=r[s+2]);const e=n(i);r[s]=e[0],r[s+1]=e[1],o&&(r[s+2]=e[2])}}if(o){const e=z_(r,0,1),t=z_(r,0,2),i=z_(r,1,2);if(!e&&!t&&!i)return[];e>t&&e>i||(t>i?(n||(r=r.slice()),V_(r,0,2,1)):(n||(r=r.slice()),V_(r,2,0,1)))}return M_(r,s,t)}(e,this.positionSize,this.opts.preproject,this.opts.full3d);a=o.allocate(a,i+c.length,{copy:!0});for(let u=0;u<c.length;u++)a[l++]=c[u]+n;r[t+1]=i+c.length,s.indices=a}_updatePositions(e,{vertexStart:t,geometrySize:n}){const{attributes:{positions:i},positionSize:s}=this;if(!i||!e)return;const r=F_(e);for(let o=t,a=0;a<n;o++,a++){const e=r[a*s],t=r[a*s+1],n=s>2?r[a*s+2]:0;i[3*o]=e,i[3*o+1]=t,i[3*o+2]=n}}_updateVertexValid(e,{vertexStart:t,geometrySize:n}){const{positionSize:i}=this,s=this.attributes.vertexValid,r=e&&B_(e);if(e&&e.edgeTypes?s.set(e.edgeTypes,t):s.fill(1,t,t+n),r)for(let o=0;o<r.length;o++)s[t+r[o]/i-1]=0;s[t+n-1]=0}}function j_(e){return Array.isArray(e)&&e.length>0&&!Number.isFinite(e[0])}const H_="uniform solidPolygonUniforms {\n  bool extruded;\n  bool isWireframe;\n  float elevationScale;\n} solidPolygon;\n",$_={name:"solidPolygon",vs:H_,fs:H_,uniformTypes:{extruded:"f32",isWireframe:"f32",elevationScale:"f32"}},X_="in vec4 fillColors;\nin vec4 lineColors;\nin vec3 pickingColors;\nout vec4 vColor;\nstruct PolygonProps {\nvec3 positions;\nvec3 positions64Low;\nvec3 normal;\nfloat elevations;\n};\nvec3 project_offset_normal(vec3 vector) {\nif (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\nproject.coordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {\nreturn normalize(vector * project.commonUnitsPerWorldUnit);\n}\nreturn project_normal(vector);\n}\nvoid calculatePosition(PolygonProps props) {\nvec3 pos = props.positions;\nvec3 pos64Low = props.positions64Low;\nvec3 normal = props.normal;\nvec4 colors = solidPolygon.isWireframe ? lineColors : fillColors;\ngeometry.worldPosition = props.positions;\ngeometry.pickingColor = pickingColors;\nif (solidPolygon.extruded) {\npos.z += props.elevations * solidPolygon.elevationScale;\n}\ngl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\nif (solidPolygon.extruded) {\n#ifdef IS_SIDE_VERTEX\nnormal = project_offset_normal(normal);\n#else\nnormal = project_normal(normal);\n#endif\ngeometry.normal = normal;\nvec3 lightColor = lighting_getLightColor(colors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);\nvColor = vec4(lightColor, colors.a * layer.opacity);\n} else {\nvColor = vec4(colors.rgb, colors.a * layer.opacity);\n}\nDECKGL_FILTER_COLOR(vColor, geometry);\n}\n",Y_=`#version 300 es\n#define SHADER_NAME solid-polygon-layer-vertex-shader\nin vec3 vertexPositions;\nin vec3 vertexPositions64Low;\nin float elevations;\n${X_}\nvoid main(void) {\nPolygonProps props;\nprops.positions = vertexPositions;\nprops.positions64Low = vertexPositions64Low;\nprops.elevations = elevations;\nprops.normal = vec3(0.0, 0.0, 1.0);\ncalculatePosition(props);\n}\n`,K_=`#version 300 es\n#define SHADER_NAME solid-polygon-layer-vertex-shader-side\n#define IS_SIDE_VERTEX\nin vec2 positions;\nin vec3 vertexPositions;\nin vec3 nextVertexPositions;\nin vec3 vertexPositions64Low;\nin vec3 nextVertexPositions64Low;\nin float elevations;\nin float instanceVertexValid;\n${X_}\nvoid main(void) {\nif(instanceVertexValid < 0.5){\ngl_Position = vec4(0.);\nreturn;\n}\nPolygonProps props;\nvec3 pos;\nvec3 pos64Low;\nvec3 nextPos;\nvec3 nextPos64Low;\n#if RING_WINDING_ORDER_CW == 1\npos = vertexPositions;\npos64Low = vertexPositions64Low;\nnextPos = nextVertexPositions;\nnextPos64Low = nextVertexPositions64Low;\n#else\npos = nextVertexPositions;\npos64Low = nextVertexPositions64Low;\nnextPos = vertexPositions;\nnextPos64Low = vertexPositions64Low;\n#endif\nprops.positions = mix(pos, nextPos, positions.x);\nprops.positions64Low = mix(pos64Low, nextPos64Low, positions.x);\nprops.normal = vec3(\npos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),\nnextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),\n0.0);\nprops.elevations = elevations * positions.y;\ncalculatePosition(props);\n}\n`,q_=[0,0,0,255],Z_={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:e=>e.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:q_},getLineColor:{type:"accessor",value:q_},material:!0},Q_={enter:(e,t)=>t.length?t.subarray(t.length-e.length):e};class J_ extends im{getShaders(e){return super.getShaders({vs:"top"===e?Y_:K_,fs:"#version 300 es\n#define SHADER_NAME solid-polygon-layer-fragment-shader\nprecision highp float;\nin vec4 vColor;\nout vec4 fragColor;\nvoid main(void) {\nfragColor = vColor;\ngeometry.uv = vec2(0.);\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",defines:{RING_WINDING_ORDER_CW:this.props._normalize||"CCW"!==this.props._windingOrder?1:0},modules:[bc,Ka,ru,$_]})}get wrapLongitude(){return!1}getBounds(){var e;return null==(e=this.getAttributeManager())?void 0:e.getBounds(["vertexPositions"])}initializeState(){const{viewport:e}=this.context;let{coordinateSystem:t}=this.props;const{_full3d:n}=this.props;let i;e.isGeospatial&&t===ec.DEFAULT&&(t=ec.LNGLAT),t===ec.LNGLAT&&(i=n?e.projectPosition.bind(e):e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new W_({preproject:i,fp64:this.use64bitPositions(),IndexType:Uint32Array})});const s=this.getAttributeManager(),r=!0;s.remove(["instancePickingColors"]),s.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:r},vertexPositions:{size:3,type:"float64",stepMode:"dynamic",fp64:this.use64bitPositions(),transition:Q_,accessor:"getPolygon",update:this.calculatePositions,noAlloc:r,shaderAttributes:{nextVertexPositions:{vertexOffset:1}}},instanceVertexValid:{size:1,type:"uint16",stepMode:"instance",update:this.calculateVertexValid,noAlloc:r},elevations:{size:1,stepMode:"dynamic",transition:Q_,accessor:"getElevation"},fillColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:Q_,accessor:"getFillColor",defaultValue:q_},lineColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:Q_,accessor:"getLineColor",defaultValue:q_},pickingColors:{size:4,type:"uint8",stepMode:"dynamic",accessor:(e,{index:t,target:n})=>this.encodePickingColor(e&&e.__source?e.__source.index:t,n)}})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:n}=t,i=this.props.data;return i[0]&&i[0].__source&&(t.object=i.find((e=>e.__source.index===n))),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let n=0;n<t.length;n++)t[n].__source.index===e&&this._disablePickingIndex(n);else super.disablePickingIndex(e)}draw({uniforms:e}){const{extruded:t,filled:n,wireframe:i,elevationScale:s}=this.props,{topModel:r,sideModel:o,wireframeModel:a,polygonTesselator:l}=this.state,c={extruded:Boolean(t),elevationScale:s,isWireframe:!1};a&&i&&(a.setInstanceCount(l.instanceCount-1),a.shaderInputs.setProps({solidPolygon:{...c,isWireframe:!0}}),a.draw(this.context.renderPass)),o&&n&&(o.setInstanceCount(l.instanceCount-1),o.shaderInputs.setProps({solidPolygon:c}),o.draw(this.context.renderPass)),r&&n&&(r.setVertexCount(l.vertexCount),r.shaderInputs.setProps({solidPolygon:c}),r.draw(this.context.renderPass))}updateState(e){var t;super.updateState(e),this.updateGeometry(e);const{props:n,oldProps:i,changeFlags:s}=e,r=this.getAttributeManager();(s.extensionsChanged||n.filled!==i.filled||n.extruded!==i.extruded)&&(null==(t=this.state.models)||t.forEach((e=>e.destroy())),this.setState(this._getModels()),r.invalidateAll())}updateGeometry({props:e,oldProps:t,changeFlags:n}){if(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPolygon)){const{polygonTesselator:t}=this.state,i=e.data.attributes||{};t.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:i.getPolygon,buffers:i,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:n.dataChanged,full3d:e._full3d}),this.setState({numInstances:t.instanceCount,startIndices:t.vertexStarts}),n.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){const{id:e,filled:t,extruded:n}=this.props;let i,s,r;if(t){const t=this.getShaders("top");t.defines.NON_INSTANCED_MODEL=1;const n=this.getAttributeManager().getBufferLayouts({isInstanced:!1});i=new mh(this.context.device,{...t,id:`${e}-top`,topology:"triangle-list",bufferLayout:n,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}if(n){const t=this.getAttributeManager().getBufferLayouts({isInstanced:!0});s=new mh(this.context.device,{...this.getShaders("side"),id:`${e}-side`,bufferLayout:t,geometry:new Eh({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),r=new mh(this.context.device,{...this.getShaders("side"),id:`${e}-wireframe`,bufferLayout:t,geometry:new Eh({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})}return{models:[s,r,i].filter(Boolean),topModel:i,sideModel:s,wireframeModel:r}}calculateIndices(e){const{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){const{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}J_.defaultProps=Z_,J_.layerName="SolidPolygonLayer";const ey=J_;function ty({data:e,getIndex:t,dataRange:n,replace:i}){const{startRow:s=0,endRow:r=1/0}=n,o=e.length;let a=o,l=o;for(let h=0;h<o;h++){const n=t(e[h]);if(a>h&&n>=s&&(a=h),n>=r){l=h;break}}let c=a;const u=l-a!==i.length?e.slice(l):void 0;for(let h=0;h<i.length;h++)e[c++]=i[h];if(u){for(let t=0;t<u.length;t++)e[c++]=u[t];e.length=c}return{startRow:a,endRow:a+i.length}}const ny="uniform sdfUniforms {\n  float gamma;\n  bool enabled;\n  float buffer;\n  float outlineBuffer;\n  vec4 outlineColor;\n} sdf;\n",iy={name:"sdf",vs:ny,fs:ny,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},sy=.75,ry=[];class oy extends xm{getShaders(){const e=super.getShaders();return{...e,modules:[...e.modules,iy],fs:"#version 300 es\n#define SHADER_NAME multi-icon-layer-fragment-shader\nprecision highp float;\nuniform sampler2D iconsTexture;\nin vec4 vColor;\nin vec2 vTextureCoords;\nin vec2 uv;\nout vec4 fragColor;\nvoid main(void) {\ngeometry.uv = uv;\nif (!bool(picking.isActive)) {\nfloat alpha = texture(iconsTexture, vTextureCoords).a;\nvec4 color = vColor;\nif (sdf.enabled) {\nfloat distance = alpha;\nalpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);\nif (sdf.outlineBuffer > 0.0) {\nfloat inFill = alpha;\nfloat inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);\ncolor = mix(sdf.outlineColor, vColor, inFill);\nalpha = inBorder;\n}\n}\nfloat a = alpha * color.a;\nif (a < icon.alphaCutoff) {\ndiscard;\n}\nfragColor = vec4(color.rgb, a * layer.opacity);\n}\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n"}}initializeState(){super.initializeState();this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(e,{index:t,target:n})=>this.encodePickingColor(t,n)}})}updateState(e){super.updateState(e);const{props:t,oldProps:n}=e;let{outlineColor:i}=t;i!==n.outlineColor&&(i=i.map((e=>e/255)),i[3]=Number.isFinite(i[3])?i[3]:1,this.setState({outlineColor:i})),!t.sdf&&t.outlineWidth&&ln.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){const{sdf:t,smoothing:n,outlineWidth:i}=this.props,{outlineColor:s}=this.state,r=i?Math.max(n,sy*(1-i)):-1,o=this.state.model,a={buffer:sy,outlineBuffer:r,gamma:n,enabled:Boolean(t),outlineColor:s};if(o.shaderInputs.setProps({sdf:a}),super.draw(e),t&&i){const{iconManager:e}=this.state;e.getTexture()&&(o.shaderInputs.setProps({sdf:{...a,outlineBuffer:sy}}),o.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap((e=>super.getInstanceOffset(e))):ry}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap((e=>super.getInstanceIconFrame(e))):ry}}oy.defaultProps={getIconOffsets:{type:"accessor",value:e=>e.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},oy.layerName="MultiIconLayer";const ay=oy,ly=1e20;class cy{constructor({fontSize:e=24,buffer:t=3,radius:n=8,cutoff:i=.25,fontFamily:s="sans-serif",fontWeight:r="normal",fontStyle:o="normal"}={}){this.buffer=t,this.cutoff=i,this.radius=n;const a=this.size=e+4*t,l=this._createCanvas(a),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${o} ${r} ${e}px ${s}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:n,actualBoundingBoxDescent:i,actualBoundingBoxLeft:s,actualBoundingBoxRight:r}=this.ctx.measureText(e),o=Math.ceil(n),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(r-s))),l=Math.min(this.size-this.buffer,o+Math.ceil(i)),c=a+2*this.buffer,u=l+2*this.buffer,h=Math.max(c*u,0),d=new Uint8ClampedArray(h),f={data:d,width:c,height:u,glyphWidth:a,glyphHeight:l,glyphTop:o,glyphLeft:0,glyphAdvance:t};if(0===a||0===l)return f;const{ctx:p,buffer:g,gridInner:m,gridOuter:_}=this;p.clearRect(g,g,a,l),p.fillText(e,g,g+o);const y=p.getImageData(g,g,a,l);_.fill(ly,0,h),m.fill(0,0,h);for(let v=0;v<l;v++)for(let e=0;e<a;e++){const t=y.data[4*(v*a+e)+3]/255;if(0===t)continue;const n=(v+g)*c+e+g;if(1===t)_[n]=0,m[n]=ly;else{const e=.5-t;_[n]=e>0?e*e:0,m[n]=e<0?e*e:0}}uy(_,0,0,c,u,c,this.f,this.v,this.z),uy(m,g,g,a,l,c,this.f,this.v,this.z);for(let v=0;v<h;v++){const e=Math.sqrt(_[v])-Math.sqrt(m[v]);d[v]=Math.round(255-255*(e/this.radius+this.cutoff))}return f}}function uy(e,t,n,i,s,r,o,a,l){for(let c=t;c<t+i;c++)hy(e,n*r+c,r,s,o,a,l);for(let c=n;c<n+s;c++)hy(e,c*r+t,1,i,o,a,l)}function hy(e,t,n,i,s,r,o){r[0]=0,o[0]=-ly,o[1]=ly,s[0]=e[t];for(let a=1,l=0,c=0;a<i;a++){s[a]=e[t+a*n];const i=a*a;do{const e=r[l];c=(s[a]-s[e]+i-e*e)/(a-e)/2}while(c<=o[l]&&--l>-1);l++,r[l]=a,o[l]=c,o[l+1]=ly}for(let a=0,l=0;a<i;a++){for(;o[l+1]<a;)l++;const i=r[l],c=a-i;e[t+a*n]=s[i]+c*c}}const dy=[];function fy(e,t,n,i){var s;let r=0;for(let o=t;o<n;o++){r+=(null==(s=i[e[o]])?void 0:s.layoutWidth)||0}return r}function py(e,t,n,i,s,r){let o=t,a=0;for(let l=t;l<n;l++){const t=fy(e,l,l+1,s);a+t>i&&(o<l&&r.push(l),o=l,a=0),a+=t}return a}function gy(e,t,n,i,s=0,r){void 0===r&&(r=e.length);const o=[];return"break-all"===t?py(e,s,r,n,i,o):function(e,t,n,i,s,r){let o=t,a=t,l=t,c=0;for(let u=t;u<n;u++)if(" "===e[u]?l=u+1:" "!==e[u+1]&&u+1!==n||(l=u+1),l>a){let t=fy(e,a,l,s);c+t>i&&(o<a&&(r.push(a),o=a,c=0),t>i&&(t=py(e,a,l,i,s,r),o=r[r.length-1])),a=l,c+=t}}(e,s,r,n,i,o),o}function my(e,t,n,i,s,r){let o=0,a=0;for(let l=t;l<n;l++){const t=e[l],n=i[t];n?(a||(a=n.layoutHeight),s[l]=o+n.layoutWidth/2,o+=n.layoutWidth):(ln.warn(`Missing character: ${t} (${t.codePointAt(0)})`)(),s[l]=o,o+=32)}r[0]=o,r[1]=a}class _y{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){const t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}const yy={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:function(){const e=[];for(let t=32;t<128;t++)e.push(String.fromCharCode(t));return e}(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1};let vy=new _y(3);function by(e,t){for(let n=0;n<e.length;n++)t.data[4*n+3]=e[n]}function Ey(e,t,n,i){e.font=`${i} ${n}px ${t}`,e.fillStyle="#000",e.textBaseline="alphabetic",e.textAlign="left"}class xy{constructor(){this.props={...yy}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:t}=this.props;return(1.2*e+2*t)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const t=function(e,t){let n;n="string"==typeof t?new Set(Array.from(t)):new Set(t);const i=vy.get(e);if(!i)return n;for(const s in i.mapping)n.has(s)&&n.delete(s);return n}(this._key,this.props.characterSet),n=vy.get(this._key);if(n&&0===t.size)return void(this._atlas!==n&&(this._atlas=n));const i=this._generateFontAtlas(t,n);this._atlas=i,vy.set(this._key,i)}_generateFontAtlas(e,t){const{fontFamily:n,fontWeight:i,fontSize:s,buffer:r,sdf:o,radius:a,cutoff:l}=this.props;let c=t&&t.data;c||(c=document.createElement("canvas"),c.width=1024);const u=c.getContext("2d",{willReadFrequently:!0});Ey(u,n,s,i);const{mapping:h,canvasHeight:d,xOffset:f,yOffset:p}=function({characterSet:e,getFontWidth:t,fontHeight:n,buffer:i,maxCanvasWidth:s,mapping:r={},xOffset:o=0,yOffset:a=0}){let l=0,c=o;const u=n+2*i;for(const d of e)if(!r[d]){const e=t(d);c+e+2*i>s&&(c=0,l++),r[d]={x:c+i,y:a+l*u+i,width:e,height:u,layoutWidth:e,layoutHeight:n},c+=e+2*i}return{mapping:r,xOffset:c,yOffset:a+l*u,canvasHeight:(h=a+(l+1)*u,Math.pow(2,Math.ceil(Math.log2(h))))};var h}({getFontWidth:e=>u.measureText(e).width,fontHeight:1.2*s,buffer:r,characterSet:e,maxCanvasWidth:1024,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(c.height!==d){const e=u.getImageData(0,0,c.width,c.height);c.height=d,u.putImageData(e,0,0)}if(Ey(u,n,s,i),o){const t=new cy({fontSize:s,buffer:r,radius:a,cutoff:l,fontFamily:n,fontWeight:`${i}`});for(const n of e){const{data:e,width:i,height:r,glyphTop:o}=t.draw(n);h[n].width=i,h[n].layoutOffsetY=.9*s-o;const a=u.createImageData(i,r);by(e,a),u.putImageData(a,h[n].x,h[n].y)}}else for(const g of e)u.fillText(g,h[g].x,h[g].y+r+.9*s);return{xOffset:f,yOffset:p,mapping:h,data:c,width:c.width,height:c.height}}_getKey(){const{fontFamily:e,fontWeight:t,fontSize:n,buffer:i,sdf:s,radius:r,cutoff:o}=this.props;return s?`${e} ${t} ${n} ${i} ${r} ${o}`:`${e} ${t} ${n} ${i}`}}const wy="uniform textBackgroundUniforms {\n  bool billboard;\n  float sizeScale;\n  float sizeMinPixels;\n  float sizeMaxPixels;\n  vec4 padding;\n  highp int sizeUnits;\n  bool stroked;\n} textBackground;\n",Ty={name:"textBackground",vs:wy,fs:wy,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},Ay={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:e=>e.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class Sy extends im{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME text-background-layer-vertex-shader\nin vec2 positions;\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin vec4 instanceRects;\nin float instanceSizes;\nin float instanceAngles;\nin vec2 instancePixelOffsets;\nin float instanceLineWidths;\nin vec4 instanceFillColors;\nin vec4 instanceLineColors;\nin vec3 instancePickingColors;\nout vec4 vFillColor;\nout vec4 vLineColor;\nout float vLineWidth;\nout vec2 uv;\nout vec2 dimensions;\nvec2 rotate_by_angle(vec2 vertex, float angle) {\nfloat angle_radian = radians(angle);\nfloat cos_angle = cos(angle_radian);\nfloat sin_angle = sin(angle_radian);\nmat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\nreturn rotationMatrix * vertex;\n}\nvoid main(void) {\ngeometry.worldPosition = instancePositions;\ngeometry.uv = positions;\ngeometry.pickingColor = instancePickingColors;\nuv = positions;\nvLineWidth = instanceLineWidths;\nfloat sizePixels = clamp(\nproject_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),\ntextBackground.sizeMinPixels, textBackground.sizeMaxPixels\n);\ndimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;\nvec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);\npixelOffset = rotate_by_angle(pixelOffset, instanceAngles);\npixelOffset += instancePixelOffsets;\npixelOffset.y *= -1.0;\nif (textBackground.billboard)  {\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\nvec3 offset = vec3(pixelOffset, 0.0);\nDECKGL_FILTER_SIZE(offset, geometry);\ngl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n} else {\nvec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\nDECKGL_FILTER_SIZE(offset_common, geometry);\ngl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n}\nvFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);\nDECKGL_FILTER_COLOR(vFillColor, geometry);\nvLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);\nDECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME text-background-layer-fragment-shader\nprecision highp float;\nin vec4 vFillColor;\nin vec4 vLineColor;\nin float vLineWidth;\nin vec2 uv;\nin vec2 dimensions;\nout vec4 fragColor;\nvoid main(void) {\ngeometry.uv = uv;\nvec2 pixelPosition = uv * dimensions;\nif (textBackground.stroked) {\nfloat distToEdge = min(\nmin(pixelPosition.x, dimensions.x - pixelPosition.x),\nmin(pixelPosition.y, dimensions.y - pixelPosition.y)\n);\nfloat isBorder = smoothedge(distToEdge, vLineWidth);\nfragColor = mix(vFillColor, vLineColor, isBorder);\n} else {\nfragColor = vFillColor;\n}\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[bc,ru,Ty]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){var t;super.updateState(e);const{changeFlags:n}=e;n.extensionsChanged&&(null==(t=this.state.model)||t.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{billboard:t,sizeScale:n,sizeUnits:i,sizeMinPixels:s,sizeMaxPixels:r,getLineWidth:o}=this.props;let{padding:a}=this.props;a.length<4&&(a=[a[0],a[1],a[0],a[1]]);const l=this.state.model,c={billboard:t,stroked:Boolean(o),padding:a,sizeUnits:nc[i],sizeScale:n,sizeMinPixels:s,sizeMaxPixels:r};l.shaderInputs.setProps({textBackground:c}),l.draw(this.context.renderPass)}_getModel(){return new mh(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Eh({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array([0,0,1,0,0,1,1,1])}}}),isInstanced:!0})}}Sy.defaultProps=Ay,Sy.layerName="TextBackgroundLayer";const Ry=Sy,Py={start:1,middle:0,end:-1},Cy={top:1,center:0,bottom:-1},Iy=[0,0,0,255],Ly={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:Iy},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:yy.characterSet},fontFamily:yy.fontFamily,fontWeight:yy.fontWeight,lineHeight:1,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:Iy},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:e=>e.text},getPosition:{type:"accessor",value:e=>e.position},getColor:{type:"accessor",value:Iy},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class My extends rm{constructor(){super(...arguments),this.getBoundingRect=(e,t)=>{let{size:[n,i]}=this.transformParagraph(e,t);const{fontSize:s}=this.state.fontAtlasManager.props;n/=s,i/=s;const{getTextAnchor:r,getAlignmentBaseline:o}=this.props;return[(Py["function"==typeof r?r(e,t):r]-1)*n/2,(Cy["function"==typeof o?o(e,t):o]-1)*i/2,n,i]},this.getIconOffsets=(e,t)=>{const{getTextAnchor:n,getAlignmentBaseline:i}=this.props,{x:s,y:r,rowWidth:o,size:[a,l]}=this.transformParagraph(e,t),c=Py["function"==typeof n?n(e,t):n],u=Cy["function"==typeof i?i(e,t):i],h=s.length,d=new Array(2*h);let f=0;for(let p=0;p<h;p++){const e=(1-c)*(a-o[p])/2;d[f++]=(c-1)*a/2+e+s[p],d[f++]=(u-1)*l/2+r[p]}return d}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new xy},this.props.maxWidth>0&&ln.warn("v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:t,oldProps:n,changeFlags:i}=e;(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getText))&&this._updateText();(this._updateFontAtlas()||t.lineHeight!==n.lineHeight||t.wordBreak!==n.wordBreak||t.maxWidth!==n.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:t,fontWeight:n}=this.props,{fontAtlasManager:i,characterSet:s}=this.state,r={...e,characterSet:s,fontFamily:t,fontWeight:n};if(!i.mapping)return i.setProps(r),!0;for(const o in r)if(r[o]!==i.props[o])return i.setProps(r),!0;return!1}_updateText(){var e;const{data:t,characterSet:n}=this.props,i=null==(e=t.attributes)?void 0:e.getText;let s,{getText:r}=this.props,o=t.startIndices;const a="auto"===n&&new Set;if(i&&o){const{texts:e,characterCount:n}=function({value:e,length:t,stride:n,offset:i,startIndices:s,characterSet:r}){const o=e.BYTES_PER_ELEMENT,a=n?n/o:1,l=i?i/o:0,c=s[t]||Math.ceil((e.length-l)/a),u=r&&new Set,h=new Array(t);let d=e;if(a>1||l>0){d=new(0,e.constructor)(c);for(let t=0;t<c;t++)d[t]=e[t*a+l]}for(let f=0;f<t;f++){const e=s[f],t=s[f+1]||c,n=d.subarray(e,t);h[f]=String.fromCodePoint.apply(null,n),u&&n.forEach(u.add,u)}if(u)for(const f of u)r.add(String.fromCodePoint(f));return{texts:h,characterCount:c}}({...ArrayBuffer.isView(i)?{value:i}:i,length:t.length,startIndices:o,characterSet:a});s=n,r=(t,{index:n})=>e[n]}else{const{iterable:e,objectInfo:n}=Yp(t);o=[0],s=0;for(const t of e){n.index++;const e=Array.from(r(t,n)||"");a&&e.forEach(a.add,a),s+=e.length,o.push(s)}}this.setState({getText:r,startIndices:o,numInstances:s,characterSet:a||n})}transformParagraph(e,t){const{fontAtlasManager:n}=this.state,i=n.mapping,s=this.state.getText,{wordBreak:r,lineHeight:o,maxWidth:a}=this.props;return function(e,t,n,i,s){var r;const o=Array.from(e),a=o.length,l=new Array(a),c=new Array(a),u=new Array(a),h=("break-word"===n||"break-all"===n)&&isFinite(i)&&i>0,d=[0,0],f=[0,0];let p=0,g=0,m=0;for(let _=0;_<=a;_++){const e=o[_];if("\n"!==e&&_!==a||(m=_),m>g){const e=h?gy(o,n,i,s,g,m):dy;for(let n=0;n<=e.length;n++){const i=0===n?g:e[n-1],a=n<e.length?e[n]:m;my(o,i,a,s,l,f);for(let e=i;e<a;e++){const t=(null==(r=s[o[e]])?void 0:r.layoutOffsetY)||0;c[e]=p+f[1]/2+t,u[e]=f[0]}p+=f[1]*t,d[0]=Math.max(d[0],f[0])}g=m}"\n"===e&&(l[g]=0,c[g]=0,u[g]=0,g++)}return d[1]=p,{x:l,y:c,rowWidth:u,size:d}}(s(e,t)||"",o,r,a*n.props.fontSize,i)}renderLayers(){const{startIndices:e,numInstances:t,getText:n,fontAtlasManager:{scale:i,atlas:s,mapping:r},styleVersion:o}=this.state,{data:a,_dataDiff:l,getPosition:c,getColor:u,getSize:h,getAngle:d,getPixelOffset:f,getBackgroundColor:p,getBorderColor:g,getBorderWidth:m,backgroundPadding:_,background:y,billboard:v,fontSettings:b,outlineWidth:E,outlineColor:x,sizeScale:w,sizeUnits:T,sizeMinPixels:A,sizeMaxPixels:S,transitions:R,updateTriggers:P}=this.props,C=this.getSubLayerClass("characters",ay),I=this.getSubLayerClass("background",Ry);return[y&&new I({getFillColor:p,getLineColor:g,getLineWidth:m,padding:_,getPosition:c,getSize:h,getAngle:d,getPixelOffset:f,billboard:v,sizeScale:w,sizeUnits:T,sizeMinPixels:A,sizeMaxPixels:S,transitions:R&&{getPosition:R.getPosition,getAngle:R.getAngle,getSize:R.getSize,getFillColor:R.getBackgroundColor,getLineColor:R.getBorderColor,getLineWidth:R.getBorderWidth,getPixelOffset:R.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:P.getPosition,getAngle:P.getAngle,getSize:P.getSize,getFillColor:P.getBackgroundColor,getLineColor:P.getBorderColor,getLineWidth:P.getBorderWidth,getPixelOffset:P.getPixelOffset,getBoundingRect:{getText:P.getText,getTextAnchor:P.getTextAnchor,getAlignmentBaseline:P.getAlignmentBaseline,styleVersion:o}}}),{data:a.attributes&&a.attributes.background?{length:a.length,attributes:a.attributes.background}:a,_dataDiff:l,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new C({sdf:b.sdf,smoothing:Number.isFinite(b.smoothing)?b.smoothing:yy.smoothing,outlineWidth:E/(b.radius||yy.radius),outlineColor:x,iconAtlas:s,iconMapping:r,getPosition:c,getColor:u,getSize:h,getAngle:d,getPixelOffset:f,billboard:v,sizeScale:w*i,sizeUnits:T,sizeMinPixels:A*i,sizeMaxPixels:S*i,transitions:R&&{getPosition:R.getPosition,getAngle:R.getAngle,getColor:R.getColor,getSize:R.getSize,getPixelOffset:R.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:P.getText,getPosition:P.getPosition,getAngle:P.getAngle,getColor:P.getColor,getSize:P.getSize,getPixelOffset:P.getPixelOffset,getIconOffsets:{getTextAnchor:P.getTextAnchor,getAlignmentBaseline:P.getAlignmentBaseline,styleVersion:o}}}),{data:a,_dataDiff:l,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:n})]}static set fontAtlasCacheLimit(e){!function(e){ln.assert(Number.isFinite(e)&&e>=3,"Invalid cache limit"),vy=new _y(e)}(e)}}My.defaultProps=Ly,My.layerName="TextLayer";const ky=My,Oy={circle:{type:Pm,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:xm,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:ky,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},Ny={type:s_,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},Fy={type:ey,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function By({type:e,props:t}){const n={};for(const i in t)n[i]=e.defaultProps[t[i]];return n}function Dy(e,t){const{transitions:n,updateTriggers:i}=e.props,s={updateTriggers:{},transitions:n&&{getPosition:n.geometry}};for(const r in t){const o=t[r];let a=e.props[r];r.startsWith("get")&&(a=e.getSubLayerAccessor(a),s.updateTriggers[o]=i[r],n&&(s.transitions[o]=n[r])),s[o]=a}return s}function Uy(e,t,n={}){const i={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:s=0,endRow:r=e.length}=n;for(let o=s;o<r;o++){const n=e[o],{geometry:s}=n;if(s)if("GeometryCollection"===s.type){ln.assert(Array.isArray(s.geometries),"GeoJSON does not have geometries array");const{geometries:e}=s;for(let s=0;s<e.length;s++){Gy(e[s],i,t,n,o)}}else Gy(s,i,t,n,o)}return i}function Gy(e,t,n,i,s){const{type:r,coordinates:o}=e,{pointFeatures:a,lineFeatures:l,polygonFeatures:c,polygonOutlineFeatures:u}=t;if(function(e,t){let n=zy[e];ln.assert(n,`Unknown GeoJSON type ${e}`);for(;t&&--n>0;)t=t[0];return t&&Number.isFinite(t[0])}(r,o))switch(r){case"Point":a.push(n({geometry:e},i,s));break;case"MultiPoint":o.forEach((e=>{a.push(n({geometry:{type:"Point",coordinates:e}},i,s))}));break;case"LineString":l.push(n({geometry:e},i,s));break;case"MultiLineString":o.forEach((e=>{l.push(n({geometry:{type:"LineString",coordinates:e}},i,s))}));break;case"Polygon":c.push(n({geometry:e},i,s)),o.forEach((e=>{u.push(n({geometry:{type:"LineString",coordinates:e}},i,s))}));break;case"MultiPolygon":o.forEach((e=>{c.push(n({geometry:{type:"Polygon",coordinates:e}},i,s)),e.forEach((e=>{u.push(n({geometry:{type:"LineString",coordinates:e}},i,s))}))}))}else ln.warn(`${r} coordinates are malformed`)()}const zy={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function Vy(e){return e.geometry.coordinates}function Wy(e,t){const n={points:{},lines:{},polygons:{},polygonsOutline:{}},{points:i,lines:s,polygons:r}=e,o=function(e,t){const n={points:null,lines:null,polygons:null};for(const i in n){const s=e[i].globalFeatureIds.value;n[i]=new Uint8ClampedArray(4*s.length);const r=[];for(let e=0;e<s.length;e++)t(s[e],r),n[i][4*e+0]=r[0],n[i][4*e+1]=r[1],n[i][4*e+2]=r[2],n[i][4*e+3]=255}return n}(e,t);return n.points.data={length:i.positions.value.length/i.positions.size,attributes:{...i.attributes,getPosition:i.positions,instancePickingColors:{size:4,value:o.points}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},n.lines.data={length:s.pathIndices.value.length-1,startIndices:s.pathIndices.value,attributes:{...s.attributes,getPath:s.positions,instancePickingColors:{size:4,value:o.lines}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},n.lines._pathType="open",n.polygons.data={length:r.polygonIndices.value.length-1,startIndices:r.polygonIndices.value,attributes:{...r.attributes,getPolygon:r.positions,pickingColors:{size:4,value:o.polygons}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},n.polygons._normalize=!1,r.triangles&&(n.polygons.data.attributes.indices=r.triangles.value),n.polygonsOutline.data={length:r.primitivePolygonIndices.value.length-1,startIndices:r.primitivePolygonIndices.value,attributes:{...r.attributes,getPath:r.positions,instancePickingColors:{size:4,value:o.polygons}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},n.polygonsOutline._pathType="open",n}const jy=["points","linestrings","polygons"],Hy={...By(Oy.circle),...By(Oy.icon),...By(Oy.text),...By(Ny),...By(Fy),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:e=>e.properties.icon},getText:{type:"accessor",value:e=>e.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class $y extends rm{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;const{data:n}=this.props,i=n&&"points"in n&&"polygons"in n&&"lines"in n;this.setState({binary:i}),i?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){const n=Wy(e.data,this.encodePickingColor);this.setState({layerProps:n})}_updateStateJSON({props:e,changeFlags:t}){const n=function(e){if(Array.isArray(e))return e;switch(ln.assert(e.type,"GeoJSON does not have type"),e.type){case"Feature":return[e];case"FeatureCollection":return ln.assert(Array.isArray(e.features),"GeoJSON does not have features array"),e.features;default:return[{geometry:e}]}}(e.data),i=this.getSubLayerRow.bind(this);let s={};const r={};if(Array.isArray(t.dataChanged)){const e=this.state.features;for(const t in e)s[t]=e[t].slice(),r[t]=[];for(const o of t.dataChanged){const t=Uy(n,i,o);for(const n in e)r[n].push(ty({data:s[n],getIndex:e=>e.__source.index,dataRange:o,replace:t[n]}))}}else s=Uy(n,i);const o=function(e,t){const n={points:{},lines:{},polygons:{},polygonsOutline:{}},{pointFeatures:i,lineFeatures:s,polygonFeatures:r,polygonOutlineFeatures:o}=e;return n.points.data=i,n.points._dataDiff=t.pointFeatures&&(()=>t.pointFeatures),n.points.getPosition=Vy,n.lines.data=s,n.lines._dataDiff=t.lineFeatures&&(()=>t.lineFeatures),n.lines.getPath=Vy,n.polygons.data=r,n.polygons._dataDiff=t.polygonFeatures&&(()=>t.polygonFeatures),n.polygons.getPolygon=Vy,n.polygonsOutline.data=o,n.polygonsOutline._dataDiff=t.polygonOutlineFeatures&&(()=>t.polygonOutlineFeatures),n.polygonsOutline.getPath=Vy,n}(s,r);this.setState({features:s,featuresDiff:r,layerProps:o})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:n,sourceLayer:i}=t;return t.featureType=jy.find((e=>i.id.startsWith(`${this.id}-${e}-`))),n>=0&&i.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[n]),t}_updateAutoHighlight(e){const t=`${this.id}-points-`,n="points"===e.featureType;for(const i of this.getSubLayers())i.id.startsWith(t)===n&&i.updateAutoHighlight(e)}_renderPolygonLayer(){var e;const{extruded:t,wireframe:n}=this.props,{layerProps:i}=this.state,s="polygons-fill",r=this.shouldRenderSubLayer(s,null==(e=i.polygons)?void 0:e.data)&&this.getSubLayerClass(s,Fy.type);if(r){const e=Dy(this,Fy.props),o=t&&n;return o||delete e.getLineColor,e.updateTriggers.lineColors=o,new r(e,this.getSubLayerProps({id:s,updateTriggers:e.updateTriggers}),i.polygons)}return null}_renderLineLayers(){var e,t;const{extruded:n,stroked:i}=this.props,{layerProps:s}=this.state,r="polygons-stroke",o="linestrings",a=!n&&i&&this.shouldRenderSubLayer(r,null==(e=s.polygonsOutline)?void 0:e.data)&&this.getSubLayerClass(r,Ny.type),l=this.shouldRenderSubLayer(o,null==(t=s.lines)?void 0:t.data)&&this.getSubLayerClass(o,Ny.type);if(a||l){const e=Dy(this,Ny.props);return[a&&new a(e,this.getSubLayerProps({id:r,updateTriggers:e.updateTriggers}),s.polygonsOutline),l&&new l(e,this.getSubLayerProps({id:o,updateTriggers:e.updateTriggers}),s.lines)]}return null}_renderPointLayers(){var e;const{pointType:t}=this.props,{layerProps:n,binary:i}=this.state;let{highlightedObjectIndex:s}=this.props;!i&&Number.isFinite(s)&&(s=n.points.data.findIndex((e=>e.__source.index===s)));const r=new Set(t.split("+")),o=[];for(const a of r){const t=`points-${a}`,r=Oy[a],l=r&&this.shouldRenderSubLayer(t,null==(e=n.points)?void 0:e.data)&&this.getSubLayerClass(t,r.type);if(l){const e=Dy(this,r.props);let c=n.points;if("text"===a&&i){const{instancePickingColors:e,...t}=c.data.attributes;c={...c,data:{...c.data,attributes:t}}}o.push(new l(e,this.getSubLayerProps({id:t,updateTriggers:e.updateTriggers,highlightedObjectIndex:s}),c))}}return o}renderLayers(){const{extruded:e}=this.props,t=this._renderPolygonLayer();return[!e&&t,this._renderLineLayers(),this._renderPointLayers(),e&&t]}getSubLayerAccessor(e){const{binary:t}=this.state;return t&&"function"==typeof e?(t,n)=>{const{data:i,index:s}=n,r=function(e,t){if(!e)return null;const n="startIndices"in e?e.startIndices[t]:t,i=e.featureIds.value[n];return-1!==n?function(e,t,n){const i={properties:{...e.properties[t]}};for(const s in e.numericProps)i.properties[s]=e.numericProps[s].value[n];return i}(e,i,n):null}(i,s);return e(r,n)}:super.getSubLayerAccessor(e)}}$y.layerName="GeoJsonLayer",$y.defaultProps=Hy;const Xy=$y,Yy="undefined"!=typeof window?V.useLayoutEffect:V.useEffect;function Ky(e,t){for(;e;){if(e===t)return!0;e=Object.getPrototypeOf(e)}return!1}const qy={position:"absolute",zIndex:-1};function Zy(e,t){if("function"==typeof e)return e(t);if(Array.isArray(e))return e.map((e=>Zy(e,t)));if(Qy(e)){if(function(e){var t;return null==(t=e.props)?void 0:t.mapStyle}(e))return t.style=qy,V.cloneElement(e,t);if(function(e){const t=e.type;return t&&t.deckGLViewProps}(e))return V.cloneElement(e,t)}return e}function Qy(e){return e&&"object"==typeof e&&"type"in e||!1}function Jy(e){if("function"==typeof e)return V.createElement(Yh,{},e);if(Array.isArray(e))return e.map(Jy);if(Qy(e)){if(e.type===V.Fragment)return Jy(e.props.children);if(Ky(e.type,Yh))return e}return e}const ev=V.createContext();const tv={mixBlendMode:null};function nv(e){e.redrawReason&&(e.deck._drawLayers(e.redrawReason),e.redrawReason=null)}const iv=V.forwardRef((function(e,t){const[n,i]=V.useState(0),s=V.useRef({control:null,version:n,forceUpdate:()=>i((e=>e+1))}).current,r=V.useRef(null),o=V.useRef(null),a=V.useMemo((()=>function({children:e,layers:t=[],views:n=null}){const i=[],s=[],r={};return V.Children.forEach(Jy(e),(e=>{if(Qy(e)){const t=e.type;if(Ky(t,im)){const n=function(e,t){const n={},i=e.defaultProps||{};for(const s in t)i[s]!==t[s]&&(n[s]=t[s]);return new e(n)}(t,e.props);s.push(n)}else i.push(e);if(Ky(t,Yh)&&t!==Yh&&e.props.id){const n=new t(e.props);r[n.id]=n}}else e&&i.push(e)})),Object.keys(r).length>0&&(Array.isArray(n)?n.forEach((e=>{r[e.id]=e})):n&&(r[n.id]=n),n=Object.values(r)),{layers:t=s.length>0?[...s,...t]:t,children:i,views:n}}(e)),[e.layers,e.views,e.children]);let l=!0;const c=t=>{var n;return l&&e.viewState?(s.viewStateUpdateRequested=t,null):(s.viewStateUpdateRequested=null,null==(n=e.onViewStateChange)?void 0:n.call(e,t))},u=t=>{var n;l?s.interactionStateUpdateRequested=t:(s.interactionStateUpdateRequested=null,null==(n=e.onInteractionStateChange)||n.call(e,t))},h=V.useMemo((()=>{const t={widgets:[],...e,style:null,width:"100%",height:"100%",parent:r.current,canvas:o.current,layers:a.layers,views:a.views,onViewStateChange:c,onInteractionStateChange:u};return delete t._customRender,s.deck&&s.deck.setProps(t),t}),[e]);V.useEffect((()=>{const t=e.Deck||Gp;return s.deck=function(e,t,n){var i,s,r;const o=new t({...n,_customRender:"webgpu"===(null==(r=null==(s=null==(i=n.deviceProps)?void 0:i.adapters)?void 0:s[0])?void 0:r.type)?void 0:t=>{e.redrawReason=t;const n=o.getViewports();e.lastRenderedViewports!==n?e.forceUpdate():nv(e)}});return o}(s,t,{...h,parent:r.current,canvas:o.current}),()=>{var e;return null==(e=s.deck)?void 0:e.finalize()}}),[]),Yy((()=>{nv(s);const{viewStateUpdateRequested:e,interactionStateUpdateRequested:t}=s;e&&c(e),t&&u(t)})),V.useImperativeHandle(t,(()=>function(e){return{get deck(){return e.deck},pickObject:t=>e.deck.pickObject(t),pickMultipleObjects:t=>e.deck.pickMultipleObjects(t),pickObjects:t=>e.deck.pickObjects(t)}}(s)),[]);const d=s.deck&&s.deck.isInitialized?s.deck.getViewports():void 0,{ContextProvider:f,width:p="100%",height:g="100%",id:m,style:_}=e,{containerStyle:y,canvasStyle:v}=V.useMemo((()=>function({width:e,height:t,style:n}){const i={position:"absolute",zIndex:0,left:0,top:0,width:e,height:t},s={left:0,top:0};if(n)for(const r in n)r in tv?s[r]=n[r]:i[r]=n[r];return{containerStyle:i,canvasStyle:s}}({width:p,height:g,style:_})),[p,g,_]);if(!s.viewStateUpdateRequested&&s.lastRenderedViewports===d||s.version!==n){s.lastRenderedViewports=d,s.version=n;const e=function({children:e,deck:t,ContextProvider:n=ev.Provider}){const{viewManager:i}=t||{};if(!i||!i.views.length)return[];const s={},r=i.views[0].id;for(const o of e){let e=r,t=o;Qy(o)&&Ky(o.type,Yh)&&(e=o.props.id||r,t=o.props.children);const n=i.getViewport(e),a=i.getViewState(e);if(n){a.padding=n.padding;const{x:i,y:r,width:o,height:l}=n;t=Zy(t,{x:i,y:r,width:o,height:l,viewport:n,viewState:a}),s[e]||(s[e]={viewport:n,children:[]}),s[e].children.push(t)}}return Object.keys(s).map((e=>{const{viewport:i,children:r}=s[e],{x:o,y:a,width:l,height:c}=i,u={position:"absolute",left:o,top:a,width:l,height:c},h=`view-${e}`,d=V.createElement("div",{key:h,id:h,style:u},...r),f={deck:t,viewport:i,container:t.canvas.offsetParent,eventManager:t.eventManager,onViewStateChange:n=>{n.viewId=e,t._onViewStateChange(n)},widgets:[]},p=`view-${e}-context`;return V.createElement(n,{key:p,value:f},d)}))}({children:a.children,deck:s.deck,ContextProvider:f}),t=V.createElement("canvas",{key:"canvas",id:m||"deckgl-overlay",ref:o,style:v});s.control=V.createElement("div",{id:`${m||"deckgl"}-wrapper`,ref:r,style:y},[t,e])}return l=!1,s.control})),sv=iv;export{rm as C,sv as D,lm as F,Xy as G,xm as I,W as R,ky as T,s as c,r as g,V as r};
